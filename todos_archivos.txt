
=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\agregar-columna.php
=============================================================

<?php
// Mostrar todos los errores
ini_set('display_errors', 1);
error_reporting(E_ALL);

echo "<h1>Agregar columna fecha_modificacion</h1>";

try {
    // Cargar la clase Database
    require_once 'app/config/Database.php';
    $db = Database::getInstance();
    $pdo = $db->getConnection();
    
    // Verificar si la columna ya existe
    $stmt = $pdo->query("SHOW COLUMNS FROM informaciongeneral LIKE 'fecha_modificacion'");
    $columnaExiste = $stmt->fetch();
    
    if (!$columnaExiste) {
        // Agregar la columna
        $pdo->exec("ALTER TABLE informaciongeneral ADD fecha_modificacion DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP");
        echo "<p style='color:green'>✓ Columna 'fecha_modificacion' agregada correctamente</p>";
    } else {
        echo "<p>La columna 'fecha_modificacion' ya existe en la tabla.</p>";
    }
    
} catch (Exception $e) {
    echo "<p style='color:red'>Error: " . $e->getMessage() . "</p>";
}
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\api_proxy.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\api_proxy.php

// Configuración básica y manejo de errores
ini_set('display_errors', 1);
error_reporting(E_ALL);

// Habilitar CORS en todas las respuestas
header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With");
header("Access-Control-Allow-Credentials: true");

// Si es una solicitud OPTIONS (preflight), responder inmediatamente
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit;
}

// Obtener la ruta solicitada desde el parámetro 'path'
$path = isset($_GET['path']) ? $_GET['path'] : '';

// URL base de tu API local
$target_base = 'http://localhost/ENCASA_DATABASE/';

// Construir la URL completa
$target_url = $target_base . $path;

// Inicializar cURL
$ch = curl_init($target_url);

// Configurar opciones de cURL
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);

// Transferir el método HTTP
curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $_SERVER['REQUEST_METHOD']);

// Transferir las cabeceras
$headers = [];
foreach (getallheaders() as $name => $value) {
    if (!in_array(strtolower($name), ['host', 'origin', 'referer'])) {
        $headers[] = "$name: $value";
    }
}
if (!empty($headers)) {
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
}

// Para solicitudes POST/PUT, transferir el cuerpo
if ($_SERVER['REQUEST_METHOD'] === 'POST' || $_SERVER['REQUEST_METHOD'] === 'PUT') {
    $input = file_get_contents('php://input');
    if (!empty($input)) {
        curl_setopt($ch, CURLOPT_POSTFIELDS, $input);
    } else if (!empty($_POST)) {
        curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($_POST));
    }
}

// Ejecutar la solicitud
$response = curl_exec($ch);
$http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);

// Establecer el código de estado HTTP
http_response_code($http_code);

// Cerrar la conexión cURL
curl_close($ch);

// Devolver la respuesta
echo $response;


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\cargar_datos.php
=============================================================

<?php

// Script para cargar datos de muestra en todas las tablas
require_once 'app/config/database.php';

try {
    // Conectar a la base de datos
    $db = new PDO("mysql:host=" . DB_HOST . ";dbname=" . DB_NAME, DB_USER, DB_PASS);
    $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    // Función para verificar si una tabla está vacía
    function tablaVacia($db, $tabla) {
        $stmt = $db->query("SELECT COUNT(*) FROM $tabla");
        return $stmt->fetchColumn() == 0;
    }
    
    echo "<h1>Cargando datos de muestra en la base de datos</h1>";
    
    // 1. ROLES (si no existen)
    if (tablaVacia($db, "Roles")) {
        $roles = [
            ['nombre' => 'Administrador', 'descripcion' => 'Acceso completo a todas las funcionalidades', 'nivel_permiso' => 3],
            ['nombre' => 'Pastor', 'descripcion' => 'Acceso a gestión de miembros y eventos', 'nivel_permiso' => 2],
            ['nombre' => 'Líder', 'descripcion' => 'Acceso limitado a gestión de miembros asignados', 'nivel_permiso' => 1]
        ];
        
        $stmt = $db->prepare("INSERT INTO Roles (nombre, descripcion, nivel_permiso) VALUES (:nombre, :descripcion, :nivel_permiso)");
        
        foreach ($roles as $rol) {
            $stmt->bindParam(':nombre', $rol['nombre']);
            $stmt->bindParam(':descripcion', $rol['descripcion']);
            $stmt->bindParam(':nivel_permiso', $rol['nivel_permiso']);
            $stmt->execute();
        }
        
        echo "<p>✅ Roles insertados correctamente</p>";
    } else {
        echo "<p>⏭️ La tabla Roles ya contiene datos</p>";
    }
    
    // 2. ASIGNAR ROLES A USUARIOS EXISTENTES (si no tienen)
    $stmt = $db->query("SELECT COUNT(*) FROM RolesUsuario");
    if ($stmt->fetchColumn() == 0) {
        // Obtener usuarios existentes
        $stmt = $db->query("SELECT id FROM Usuarios");
        $usuarios = $stmt->fetchAll(PDO::FETCH_COLUMN);
        
        // Obtener roles existentes
        $stmt = $db->query("SELECT id FROM Roles");
        $roles = $stmt->fetchAll(PDO::FETCH_COLUMN);
        
        if (count($roles) > 0) {
            $stmt = $db->prepare("INSERT INTO RolesUsuario (usuario_id, rol_id) VALUES (:usuario_id, :rol_id)");
            
            // Asignar rol de Administrador al primer usuario
            if (isset($usuarios[0]) && isset($roles[0])) {
                $stmt->bindParam(':usuario_id', $usuarios[0]);
                $stmt->bindParam(':rol_id', $roles[0]);
                $stmt->execute();
            }
            
            // Asignar rol de Pastor al segundo usuario si existe
            if (isset($usuarios[1]) && isset($roles[1])) {
                $stmt->bindParam(':usuario_id', $usuarios[1]);
                $stmt->bindParam(':rol_id', $roles[1]);
                $stmt->execute();
            }
            
            // Asignar roles adicionales si hay más usuarios
            for ($i = 2; $i < count($usuarios); $i++) {
                $rol_id = $roles[array_rand($roles)]; // Rol aleatorio
                $stmt->bindParam(':usuario_id', $usuarios[$i]);
                $stmt->bindParam(':rol_id', $rol_id);
                $stmt->execute();
            }
            
            echo "<p>✅ Roles de usuario asignados correctamente</p>";
        }
    } else {
        echo "<p>⏭️ Ya existen asignaciones de roles a usuarios</p>";
    }
    
    // 3. INFORMACIÓN GENERAL (MIEMBROS)
    if (tablaVacia($db, "InformacionGeneral")) {
        $miembros = [
            [
                'nombres' => 'Juan Carlos', 
                'apellidos' => 'Martínez Rodríguez', 
                'celular' => '+573111234567', 
                'localidad' => 'Kennedy', 
                'barrio' => 'Castilla', 
                'fecha_nacimiento' => '1985-06-15',
                'conector' => 'Invitación directa',
                'estado_espiritual' => 'Activo',
                'foto' => 'juan_martinez.jpg'
            ],
            [
                'nombres' => 'María Fernanda', 
                'apellidos' => 'López García', 
                'celular' => '+573129876543', 
                'localidad' => 'Chapinero', 
                'barrio' => 'La Soledad', 
                'fecha_nacimiento' => '1990-03-22',
                'conector' => 'Redes sociales',
                'estado_espiritual' => 'Nuevo',
                'foto' => 'maria_lopez.jpg'
            ],
            [
                'nombres' => 'Carlos Eduardo', 
                'apellidos' => 'González Pérez', 
                'celular' => '+573145678901', 
                'localidad' => 'Suba', 
                'barrio' => 'Niza', 
                'fecha_nacimiento' => '1978-11-10',
                'conector' => 'Familiar',
                'estado_espiritual' => 'Activo',
                'foto' => 'carlos_gonzalez.jpg'
            ],
            [
                'nombres' => 'Ana María', 
                'apellidos' => 'Sánchez Torres', 
                'celular' => '+573187654321', 
                'localidad' => 'Teusaquillo', 
                'barrio' => 'Galerías', 
                'fecha_nacimiento' => '1995-08-03',
                'conector' => 'Evento evangelístico',
                'estado_espiritual' => 'En formación',
                'foto' => 'ana_sanchez.jpg'
            ],
            [
                'nombres' => 'Pedro José', 
                'apellidos' => 'Ramírez López', 
                'celular' => '+573153456789', 
                'localidad' => 'Usaquén', 
                'barrio' => 'Santa Bárbara', 
                'fecha_nacimiento' => '1982-04-17',
                'conector' => 'Amigo',
                'estado_espiritual' => 'Intermitente',
                'foto' => 'pedro_ramirez.jpg'
            ],
        ];
        
        // Preparar la consulta SQL
        $stmt = $db->prepare("INSERT INTO InformacionGeneral 
                             (nombres, apellidos, celular, localidad, barrio, fecha_nacimiento, 
                              conector, estado_espiritual, foto) 
                             VALUES 
                             (:nombres, :apellidos, :celular, :localidad, :barrio, :fecha_nacimiento, 
                              :conector, :estado_espiritual, :foto)");
        
        // Insertar cada miembro
        foreach ($miembros as $miembro) {
            $stmt->bindParam(':nombres', $miembro['nombres']);
            $stmt->bindParam(':apellidos', $miembro['apellidos']);
            $stmt->bindParam(':celular', $miembro['celular']);
            $stmt->bindParam(':localidad', $miembro['localidad']);
            $stmt->bindParam(':barrio', $miembro['barrio']);
            $stmt->bindParam(':fecha_nacimiento', $miembro['fecha_nacimiento']);
            $stmt->bindParam(':conector', $miembro['conector']);
            $stmt->bindParam(':estado_espiritual', $miembro['estado_espiritual']);
            $stmt->bindParam(':foto', $miembro['foto']);
            $stmt->execute();
        }
        
        // Actualizar los campos invitado_por para algunos miembros
        // Primero obtenemos los IDs generados
        $stmt = $db->query("SELECT id FROM InformacionGeneral ORDER BY id");
        $ids = $stmt->fetchAll(PDO::FETCH_COLUMN);
        
        if (count($ids) >= 3) {
            // El miembro 3 fue invitado por el miembro 1
            $stmt = $db->prepare("UPDATE InformacionGeneral SET invitado_por = ? WHERE id = ?");
            $stmt->execute([$ids[0], $ids[2]]);
            
            // El miembro 4 fue invitado por el miembro 2
            $stmt->execute([$ids[1], $ids[3]]);
        }
        
        echo "<p>✅ Información general de miembros insertada correctamente</p>";
    } else {
        echo "<p>⏭️ La tabla InformacionGeneral ya contiene datos</p>";
    }
    
    // 4. CONTACTO
    if (tablaVacia($db, "Contacto")) {
        // Primero obtenemos los IDs de los miembros
        $stmt = $db->query("SELECT id FROM InformacionGeneral ORDER BY id");
        $miembro_ids = $stmt->fetchAll(PDO::FETCH_COLUMN);
        
        if (count($miembro_ids) > 0) {
            $contactos = [
                [
                    'tipo_documento' => 'CC',
                    'numero_documento' => '1020304050',
                    'telefono' => '+5712345678',
                    'pais' => 'Colombia',
                    'ciudad' => 'Bogotá',
                    'direccion' => 'Calle 85 # 15-45, Apto 502',
                    'estado_civil' => 'Casado/a',
                    'correo_electronico' => 'juanmartinez@ejemplo.com',
                    'instagram' => '@juanmartinez',
                    'facebook' => 'juancarlosmartinez'
                ],
                [
                    'tipo_documento' => 'CC',
                    'numero_documento' => '1030405060',
                    'telefono' => '+5712345679',
                    'pais' => 'Colombia',
                    'ciudad' => 'Bogotá',
                    'direccion' => 'Carrera 11 # 95-20, Apto 305',
                    'estado_civil' => 'Soltero/a',
                    'correo_electronico' => 'marialopez@ejemplo.com',
                    'instagram' => '@mafelopez',
                    'facebook' => 'mariafernanda.lopez'
                ],
                [
                    'tipo_documento' => 'CE',
                    'numero_documento' => '40506070',
                    'telefono' => '+5712345680',
                    'pais' => 'Colombia',
                    'ciudad' => 'Bogotá',
                    'direccion' => 'Av. Suba # 120-15, Casa 8',
                    'estado_civil' => 'Casado/a',
                    'correo_electronico' => 'carlosgonzalez@ejemplo.com',
                    'instagram' => '@carlosegp',
                    'facebook' => 'carlos.gonzalez'
                ],
                [
                    'tipo_documento' => 'CC',
                    'numero_documento' => '50607080',
                    'telefono' => '+5712345681',
                    'pais' => 'Colombia',
                    'ciudad' => 'Bogotá',
                    'direccion' => 'Calle 53 # 25-30, Apto 901',
                    'estado_civil' => 'Soltero/a',
                    'correo_electronico' => 'anasanchez@ejemplo.com',
                    'instagram' => '@anamasanchez',
                    'facebook' => 'ana.sanchez'
                ],
                [
                    'tipo_documento' => 'CC',
                    'numero_documento' => '60708090',
                    'telefono' => '+5712345682',
                    'pais' => 'Colombia',
                    'ciudad' => 'Bogotá',
                    'direccion' => 'Carrera 7 # 110-45, Apto 1201',
                    'estado_civil' => 'Divorciado/a',
                    'correo_electronico' => 'pedroramirez@ejemplo.com',
                    'instagram' => '@pedrojramirez',
                    'facebook' => 'pedro.ramirez.lopez'
                ]
            ];
            
            $stmt = $db->prepare("INSERT INTO Contacto 
                                 (miembro_id, tipo_documento, numero_documento, telefono, pais, ciudad, 
                                  direccion, estado_civil, correo_electronico, instagram, facebook) 
                                 VALUES 
                                 (:miembro_id, :tipo_documento, :numero_documento, :telefono, :pais, :ciudad, 
                                  :direccion, :estado_civil, :correo_electronico, :instagram, :facebook)");
            
            for ($i = 0; $i < min(count($miembro_ids), count($contactos)); $i++) {
                $stmt->bindParam(':miembro_id', $miembro_ids[$i]);
                $stmt->bindParam(':tipo_documento', $contactos[$i]['tipo_documento']);
                $stmt->bindParam(':numero_documento', $contactos[$i]['numero_documento']);
                $stmt->bindParam(':telefono', $contactos[$i]['telefono']);
                $stmt->bindParam(':pais', $contactos[$i]['pais']);
                $stmt->bindParam(':ciudad', $contactos[$i]['ciudad']);
                $stmt->bindParam(':direccion', $contactos[$i]['direccion']);
                $stmt->bindParam(':estado_civil', $contactos[$i]['estado_civil']);
                $stmt->bindParam(':correo_electronico', $contactos[$i]['correo_electronico']);
                $stmt->bindParam(':instagram', $contactos[$i]['instagram']);
                $stmt->bindParam(':facebook', $contactos[$i]['facebook']);
                $stmt->execute();
            }
            
            echo "<p>✅ Información de contacto insertada correctamente</p>";
        } else {
            echo "<p>❌ No hay miembros para asignar información de contacto</p>";
        }
    } else {
        echo "<p>⏭️ La tabla Contacto ya contiene datos</p>";
    }
    
    // 5. ESTUDIOS/TRABAJO
    if (tablaVacia($db, "EstudiosTrabajo")) {
        // Obtener los IDs de los miembros
        $stmt = $db->query("SELECT id FROM InformacionGeneral ORDER BY id");
        $miembro_ids = $stmt->fetchAll(PDO::FETCH_COLUMN);
        
        if (count($miembro_ids) > 0) {
            $estudios = [
                [
                    'nivel_estudios' => 'Universitario',
                    'profesion' => 'Ingeniero Civil',
                    'otros_estudios' => 'Especialización en Gestión de Proyectos',
                    'empresa' => 'Constructora ABC',
                    'direccion_empresa' => 'Av. El Dorado # 85-75',
                    'emprendimientos' => 'Consultora de proyectos de infraestructura'
                ],
                [
                    'nivel_estudios' => 'Maestría',
                    'profesion' => 'Psicóloga',
                    'otros_estudios' => 'Diplomado en Terapia Familiar',
                    'empresa' => 'Centro de Psicología Integral',
                    'direccion_empresa' => 'Calle 93 # 12-30',
                    'emprendimientos' => 'Talleres de inteligencia emocional'
                ],
                [
                    'nivel_estudios' => 'Técnico',
                    'profesion' => 'Técnico en Sistemas',
                    'otros_estudios' => 'Cursos de programación web',
                    'empresa' => 'Soluciones Informáticas XYZ',
                    'direccion_empresa' => 'Carrera 15 # 78-33',
                    'emprendimientos' => 'Desarrollo de aplicaciones móviles'
                ],
                [
                    'nivel_estudios' => 'Universitario',
                    'profesion' => 'Comunicadora Social',
                    'otros_estudios' => 'Fotografía profesional',
                    'empresa' => 'Revista Digital Impacto',
                    'direccion_empresa' => 'Calle 67 # 8-32',
                    'emprendimientos' => 'Agencia de contenidos digitales'
                ],
                [
                    'nivel_estudios' => 'Especialización',
                    'profesion' => 'Administrador de Empresas',
                    'otros_estudios' => 'MBA en Administración de Negocios',
                    'empresa' => 'Banco Nacional',
                    'direccion_empresa' => 'Carrera 7 # 72-64',
                    'emprendimientos' => 'Asesoría financiera para emprendedores'
                ]
            ];
            
            $stmt = $db->prepare("INSERT INTO EstudiosTrabajo 
                                 (miembro_id, nivel_estudios, profesion, otros_estudios, empresa,
                                  direccion_empresa, emprendimientos) 
                                 VALUES 
                                 (:miembro_id, :nivel_estudios, :profesion, :otros_estudios, :empresa,
                                  :direccion_empresa, :emprendimientos)");
            
            for ($i = 0; $i < min(count($miembro_ids), count($estudios)); $i++) {
                $stmt->bindParam(':miembro_id', $miembro_ids[$i]);
                $stmt->bindParam(':nivel_estudios', $estudios[$i]['nivel_estudios']);
                $stmt->bindParam(':profesion', $estudios[$i]['profesion']);
                $stmt->bindParam(':otros_estudios', $estudios[$i]['otros_estudios']);
                $stmt->bindParam(':empresa', $estudios[$i]['empresa']);
                $stmt->bindParam(':direccion_empresa', $estudios[$i]['direccion_empresa']);
                $stmt->bindParam(':emprendimientos', $estudios[$i]['emprendimientos']);
                $stmt->execute();
            }
            
            echo "<p>✅ Información de estudios y trabajo insertada correctamente</p>";
        } else {
            echo "<p>❌ No hay miembros para asignar información de estudios y trabajo</p>";
        }
    } else {
        echo "<p>⏭️ La tabla EstudiosTrabajo ya contiene datos</p>";
    }
    
    // 6. TALLAS
    if (tablaVacia($db, "Tallas")) {
        // Obtener los IDs de los miembros
        $stmt = $db->query("SELECT id FROM InformacionGeneral ORDER BY id");
        $miembro_ids = $stmt->fetchAll(PDO::FETCH_COLUMN);
        
        if (count($miembro_ids) > 0) {
            $tallas = [
                [
                    'talla_camisa' => 'M',
                    'talla_camiseta' => 'L',
                    'talla_pantalon' => '32',
                    'talla_zapatos' => '40'
                ],
                [
                    'talla_camisa' => 'S',
                    'talla_camiseta' => 'M',
                    'talla_pantalon' => '28',
                    'talla_zapatos' => '37'
                ],
                [
                    'talla_camisa' => 'XL',
                    'talla_camiseta' => 'XL',
                    'talla_pantalon' => '36',
                    'talla_zapatos' => '42'
                ],
                [
                    'talla_camisa' => 'S',
                    'talla_camiseta' => 'S',
                    'talla_pantalon' => '26',
                    'talla_zapatos' => '36'
                ],
                [
                    'talla_camisa' => 'L',
                    'talla_camiseta' => 'L',
                    'talla_pantalon' => '34',
                    'talla_zapatos' => '41'
                ]
            ];
            
            $stmt = $db->prepare("INSERT INTO Tallas 
                                 (miembro_id, talla_camisa, talla_camiseta, talla_pantalon, talla_zapatos) 
                                 VALUES 
                                 (:miembro_id, :talla_camisa, :talla_camiseta, :talla_pantalon, :talla_zapatos)");
            
            for ($i = 0; $i < min(count($miembro_ids), count($tallas)); $i++) {
                $stmt->bindParam(':miembro_id', $miembro_ids[$i]);
                $stmt->bindParam(':talla_camisa', $tallas[$i]['talla_camisa']);
                $stmt->bindParam(':talla_camiseta', $tallas[$i]['talla_camiseta']);
                $stmt->bindParam(':talla_pantalon', $tallas[$i]['talla_pantalon']);
                $stmt->bindParam(':talla_zapatos', $tallas[$i]['talla_zapatos']);
                $stmt->execute();
            }
            
            echo "<p>✅ Información de tallas insertada correctamente</p>";
        } else {
            echo "<p>❌ No hay miembros para asignar tallas</p>";
        }
    } else {
        echo "<p>⏭️ La tabla Tallas ya contiene datos</p>";
    }
    
    // 7. SALUD Y EMERGENCIAS
    if (tablaVacia($db, "SaludEmergencias")) {
        // Obtener los IDs de los miembros
        $stmt = $db->query("SELECT id FROM InformacionGeneral ORDER BY id");
        $miembro_ids = $stmt->fetchAll(PDO::FETCH_COLUMN);
        
        if (count($miembro_ids) > 0) {
            $salud = [
                [
                    'rh' => 'A+',
                    'acudiente1' => 'Laura Martínez',
                    'telefono1' => '+573101234567',
                    'acudiente2' => 'Roberto Rodríguez',
                    'telefono2' => '+573112345678',
                    'eps' => 'Compensar'
                ],
                [
                    'rh' => 'O+',
                    'acudiente1' => 'Patricia López',
                    'telefono1' => '+573123456789',
                    'acudiente2' => 'Juan García',
                    'telefono2' => '+573134567890',
                    'eps' => 'Sura'
                ],
                [
                    'rh' => 'B+',
                    'acudiente1' => 'Sandra González',
                    'telefono1' => '+573145678901',
                    'acudiente2' => 'Ricardo Pérez',
                    'telefono2' => '+573156789012',
                    'eps' => 'Famisanar'
                ],
                [
                    'rh' => 'AB-',
                    'acudiente1' => 'Miguel Torres',
                    'telefono1' => '+573167890123',
                    'acudiente2' => 'Claudia Sánchez',
                    'telefono2' => '+573178901234',
                    'eps' => 'Nueva EPS'
                ],
                [
                    'rh' => 'O-',
                    'acudiente1' => 'Martha Ramírez',
                    'telefono1' => '+573189012345',
                    'acudiente2' => 'Luis López',
                    'telefono2' => '+573190123456',
                    'eps' => 'Sanitas'
                ]
            ];
            
            $stmt = $db->prepare("INSERT INTO SaludEmergencias 
                                 (miembro_id, rh, acudiente1, telefono1, acudiente2, telefono2, eps) 
                                 VALUES 
                                 (:miembro_id, :rh, :acudiente1, :telefono1, :acudiente2, :telefono2, :eps)");
            
            for ($i = 0; $i < min(count($miembro_ids), count($salud)); $i++) {
                $stmt->bindParam(':miembro_id', $miembro_ids[$i]);
                $stmt->bindParam(':rh', $salud[$i]['rh']);
                $stmt->bindParam(':acudiente1', $salud[$i]['acudiente1']);
                $stmt->bindParam(':telefono1', $salud[$i]['telefono1']);
                $stmt->bindParam(':acudiente2', $salud[$i]['acudiente2']);
                $stmt->bindParam(':telefono2', $salud[$i]['telefono2']);
                $stmt->bindParam(':eps', $salud[$i]['eps']);
                $stmt->execute();
            }
            
            echo "<p>✅ Información de salud y emergencias insertada correctamente</p>";
        } else {
            echo "<p>❌ No hay miembros para asignar información de salud y emergencias</p>";
        }
    } else {
        echo "<p>⏭️ La tabla SaludEmergencias ya contiene datos</p>";
    }
    
    // 8. CARRERA BÍBLICA
    if (tablaVacia($db, "CarreraBiblica")) {
        // Obtener los IDs de los miembros
        $stmt = $db->query("SELECT id FROM InformacionGeneral ORDER BY id");
        $miembro_ids = $stmt->fetchAll(PDO::FETCH_COLUMN);
        
        if (count($miembro_ids) > 0) {
            $carrera = [
                [
                    'carrera_biblica' => 'Escuela de Ministerios',
                    'miembro_de' => 'Iglesia En Casa',
                    'casa_de_palabra_y_vida' => 'Grupo Norte',
                    'cobertura' => 'Pastor Principal',
                    'estado' => 'Activo',
                    'anotaciones' => 'Excelente participación y compromiso',
                    'recorrido_espiritual' => 'Ha completado Catecumenado y Discipulado'
                ],
                [
                    'carrera_biblica' => 'Catecumenado',
                    'miembro_de' => 'Iglesia En Casa',
                    'casa_de_palabra_y_vida' => 'Grupo Centro',
                    'cobertura' => 'Líder Ana Gómez',
                    'estado' => 'Nuevo',
                    'anotaciones' => 'Comenzó el proceso hace un mes',
                    'recorrido_espiritual' => 'Primera experiencia en formación bíblica'
                ],
                [
                    'carrera_biblica' => 'Discipulado',
                    'miembro_de' => 'Iglesia En Casa',
                    'casa_de_palabra_y_vida' => 'Grupo Sur',
                    'cobertura' => 'Líder Carlos Díaz',
                    'estado' => 'Activo',
                    'anotaciones' => 'Participación constante',
                    'recorrido_espiritual' => 'Completó Catecumenado hace 6 meses'
                ],
                [
                    'carrera_biblica' => 'Catecumenado',
                    'miembro_de' => 'Iglesia En Casa',
                    'casa_de_palabra_y_vida' => 'Grupo Occidente',
                    'cobertura' => 'Líder María Ramos',
                    'estado' => 'Estudiante',
                    'anotaciones' => 'Muestra interés y compromiso',
                    'recorrido_espiritual' => 'Nuevo en la fe, proviene de otra denominación'
                ],
                [
                    'carrera_biblica' => 'Escuela de Ministerios',
                    'miembro_de' => 'Iglesia En Casa',
                    'casa_de_palabra_y_vida' => 'Grupo Oriente',
                    'cobertura' => 'Pastor Asistente',
                    'estado' => 'Inactivo',
                    'anotaciones' => 'Tomando un descanso por motivos laborales',
                    'recorrido_espiritual' => 'Ha completado todas las etapas de formación'
                ]
            ];
            
            $stmt = $db->prepare("INSERT INTO CarreraBiblica 
                                 (miembro_id, carrera_biblica, miembro_de, casa_de_palabra_y_vida, 
                                  cobertura, estado, anotaciones, recorrido_espiritual) 
                                 VALUES 
                                 (:miembro_id, :carrera_biblica, :miembro_de, :casa_de_palabra_y_vida, 
                                  :cobertura, :estado, :anotaciones, :recorrido_espiritual)");
            
            for ($i = 0; $i < min(count($miembro_ids), count($carrera)); $i++) {
                $stmt->bindParam(':miembro_id', $miembro_ids[$i]);
                $stmt->bindParam(':carrera_biblica', $carrera[$i]['carrera_biblica']);
                $stmt->bindParam(':miembro_de', $carrera[$i]['miembro_de']);
                $stmt->bindParam(':casa_de_palabra_y_vida', $carrera[$i]['casa_de_palabra_y_vida']);
                $stmt->bindParam(':cobertura', $carrera[$i]['cobertura']);
                $stmt->bindParam(':estado', $carrera[$i]['estado']);
                $stmt->bindParam(':anotaciones', $carrera[$i]['anotaciones']);
                $stmt->bindParam(':recorrido_espiritual', $carrera[$i]['recorrido_espiritual']);
                $stmt->execute();
            }
            
            echo "<p>✅ Información de carrera bíblica insertada correctamente</p>";
        } else {
            echo "<p>❌ No hay miembros para asignar información de carrera bíblica</p>";
        }
    } else {
        echo "<p>⏭️ La tabla CarreraBiblica ya contiene datos</p>";
    }
    
    // 9. CARPETA DE IMÁGENES
    // Crear la carpeta para imágenes si no existe
    $upload_dir = __DIR__ . '/uploads/miembros';
    if (!is_dir($upload_dir)) {
        if (mkdir($upload_dir, 0777, true)) {
            echo "<p>✅ Carpeta de imágenes creada: {$upload_dir}</p>";
        } else {
            echo "<p>❌ Error al crear la carpeta de imágenes</p>";
        }
    } else {
        echo "<p>⏭️ La carpeta de imágenes ya existe</p>";
    }
    
    echo "<h2>¡Datos cargados exitosamente!</h2>";
    echo "<p>Ahora puede <a href='index.php'>ir a la aplicación</a> para ver los datos cargados.</p>";
    
} catch (PDOException $e) {
    echo "<h2>Error al cargar datos</h2>";
    echo "<p>Detalle del error: " . htmlspecialchars($e->getMessage()) . "</p>";
}
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\check-progress.php
=============================================================

<?php

// Script para verificar el progreso del proyecto

echo "<h1>Verificación de Progreso del Sistema</h1>";

// Verificar componentes críticos
$components = [
    // Etapa 1: Configuración del Entorno y Base de Datos
    'Conexión BD' => function() {
        return class_exists('PDO');
    },
    'Estructura BD' => function() {
        // Verificar si podemos conectar y si existe al menos una tabla clave
        try {
            if (!class_exists('PDO')) return false;
            $db = new PDO('mysql:host=localhost;dbname=IglesiaEnCasa', 'root', '');
            $stmt = $db->query("SHOW TABLES LIKE 'InformacionGeneral'");
            return $stmt->rowCount() > 0;
        } catch (Exception $e) {
            return false;
        }
    },
    'Entorno Configurado' => function() {
        return file_exists('app/config/config.php');
    },
    
    // Etapa 2: Núcleo MVC y Enrutamiento
    'Router' => function() {
        return file_exists('app/helpers/Router.php');
    },
    'Modelo Base' => function() {
        return file_exists('app/models/Model.php') || file_exists('app/models/BaseModel.php');
    },
    'Controlador Base' => function() {
        return file_exists('app/controllers/Controller.php') || file_exists('app/core/Controller.php');
    },
    'Sistema de Vistas' => function() {
        return is_dir('app/views') && file_exists('app/views/layouts/default.php');
    },
    
    // Etapa 3: Sistema de Autenticación y Autorización
    'Autenticación' => function() {
        return file_exists('app/controllers/AuthController.php');
    },
    'Modelo Usuario' => function() {
        return file_exists('app/models/Usuario.php');
    },
    'Login Funcional' => function() {
        return file_exists('app/views/auth/login.php');
    },
    'Middleware Auth' => function() {
        return file_exists('app/middleware/Auth.php') || file_exists('app/middleware/AuthMiddleware.php');
    },
    'Sistema de Roles' => function() {
        return file_exists('app/models/Rol.php') || file_exists('app/models/Role.php');
    },
    
    // Etapa 4: Modelos Base y CRUD de Miembros
    'Modelo Miembro' => function() {
        return file_exists('app/models/Miembro.php') || file_exists('app/models/InformacionGeneral.php');
    },
    'Controlador Miembros' => function() {
        return file_exists('app/controllers/MiembroController.php') || file_exists('app/controllers/MiembrosController.php');
    },
    'Vista Listado Miembros' => function() {
        return file_exists('app/views/miembros/index.php');
    },
    'Vista Formulario Miembro' => function() {
        return file_exists('app/views/miembros/create.php') || file_exists('app/views/miembros/form.php');
    },
    
    // Etapa 5: Ministerios, Roles y Tareas
    'Modelo Ministerio' => function() {
        return file_exists('app/models/Ministerio.php');
    },
    'Modelo Tarea' => function() {
        return file_exists('app/models/Tarea.php');
    },
    'Controlador Ministerios' => function() {
        return file_exists('app/controllers/MinisterioController.php') || file_exists('app/controllers/MinisteriosController.php');
    },
    
    // Etapa 6: Vistas y UI/UX
    'Layout Principal' => function() {
        return file_exists('app/views/layouts/default.php');
    },
    'Layout Auth' => function() {
        return file_exists('app/views/layouts/auth.php');
    },
    'Config Tailwind' => function() {
        return file_exists('tailwind.config.js');
    },
    'CSS Compilado' => function() {
        return file_exists('public/css/main.css');
    },
    'Dashboard' => function() {
        return file_exists('app/views/dashboard/index.php');
    },
    
    // Etapa 7: Integración, Pruebas y Optimización
    'Sistema de Logs' => function() {
        return file_exists('app/helpers/Logger.php');
    },
    'Visualizador de Logs' => function() {
        return file_exists('app/controllers/LogController.php') && file_exists('app/views/admin/logs.php');
    },
    'Test Unitarios' => function() {
        return is_dir('tests') && file_exists('phpunit.xml');
    },
    'Sistema Cache' => function() {
        return file_exists('app/helpers/Cache.php') || file_exists('app/services/CacheService.php');
    },
    
    // Etapa 8: Despliegue y Documentación
    'Manual Usuario' => function() {
        return file_exists('Documentacion/manual_usuario.md') || file_exists('Documentacion/manual_usuario.pdf');
    },
    'Documentación API' => function() {
        return file_exists('Documentacion/api.md') || file_exists('api/index.html');
    },
    'Script Despliegue' => function() {
        return file_exists('deploy.sh') || file_exists('deploy.php');
    },
    
    // Añadir más verificaciones para cada etapa según sea necesario
];

// Mostrar resultados
echo "<table border='1' style='border-collapse:collapse'>";
echo "<tr><th>Componente</th><th>Estado</th></tr>";

$completedCount = 0;
foreach ($components as $name => $checkFn) {
    $status = $checkFn() ? "✅ Implementado" : "❌ Pendiente";
    $style = $checkFn() ? "background-color: #d4edda;" : "background-color: #f8d7da;";
    
    echo "<tr style='$style'><td>$name</td><td>$status</td></tr>";
    
    if ($checkFn()) $completedCount++;
}

$percent = round(($completedCount / count($components)) * 100);
echo "</table>";
echo "<p>Progreso general: <b>$percent%</b></p>";

// Generar reporte de progreso por etapas
echo "<h2>Progreso por Etapas</h2>";
$etapas = [
    'Etapa 1: Config y BD' => ['Conexión BD', 'Estructura BD', 'Entorno Configurado'],
    'Etapa 2: Núcleo MVC' => ['Router', 'Modelo Base', 'Controlador Base', 'Sistema de Vistas'],
    'Etapa 3: Autenticación' => ['Autenticación', 'Modelo Usuario', 'Login Funcional', 'Middleware Auth', 'Sistema de Roles'],
    'Etapa 4: CRUD Miembros' => ['Modelo Miembro', 'Controlador Miembros', 'Vista Listado Miembros', 'Vista Formulario Miembro'],
    'Etapa 5: Ministerios/Tareas' => ['Modelo Ministerio', 'Modelo Tarea', 'Controlador Ministerios'],
    'Etapa 6: Vistas y UI/UX' => ['Layout Principal', 'Layout Auth', 'Config Tailwind', 'CSS Compilado', 'Dashboard'],
    'Etapa 7: Integración/Pruebas' => ['Sistema de Logs', 'Visualizador de Logs', 'Test Unitarios', 'Sistema Cache'],
    'Etapa 8: Despliegue/Docs' => ['Manual Usuario', 'Documentación API', 'Script Despliegue']
];

echo "<table border='1' style='border-collapse:collapse'>";
echo "<tr><th>Etapa</th><th>Componentes Completados</th><th>Progreso</th></tr>";

foreach ($etapas as $etapa => $componentesEtapa) {
    $completados = 0;
    $total = count($componentesEtapa);
    
    foreach ($componentesEtapa as $componente) {
        if (isset($components[$componente]) && $components[$componente]()) {
            $completados++;
        }
    }
    
    $porcentajeEtapa = $total > 0 ? round(($completados / $total) * 100) : 0;
    $styleEtapa = $porcentajeEtapa == 100 ? "background-color: #d4edda;" : 
                 ($porcentajeEtapa > 0 ? "background-color: #fff3cd;" : "background-color: #f8d7da;");
    
    echo "<tr style='$styleEtapa'><td>$etapa</td><td>$completados / $total</td><td>$porcentajeEtapa%</td></tr>";
}

echo "</table>";

// Mostrar gráfico visual de progreso (opcional)
echo "<h2>Gráfico de Progreso</h2>";
echo "<div style='width:100%; background-color:#eee; height:30px; border-radius:5px; overflow:hidden;'>";
echo "<div style='width:$percent%; background-color:#4CAF50; height:30px; text-align:center; line-height:30px; color:white;'>$percent%</div>";
echo "</div>";

// Mostrar próximos pasos
echo "<h2>Próximos Pasos Recomendados</h2>";
echo "<ul>";

// Analizar componentes faltantes prioritarios
$prioridadAlta = [];

// Revisar etapa 3 - Autenticación
if (!$components['Sistema de Roles']()) {
    $prioridadAlta[] = "Completar implementación del sistema de roles y permisos";
}

// Revisar etapa 4 - CRUD Miembros
if (!$components['Controlador Miembros']()) {
    $prioridadAlta[] = "Implementar controlador de miembros con operaciones CRUD básicas";
}

// Revisar nuevos componentes
if (!$components['Sistema de Logs']()) {
    $prioridadAlta[] = "Implementar sistema de logs para monitoreo de errores";
}

if (!$components['Config Tailwind']()) {
    $prioridadAlta[] = "Configurar Tailwind CSS para la interfaz de usuario";
}

foreach ($prioridadAlta as $paso) {
    echo "<li>$paso</li>";
}

echo "</ul>";
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\check_miembro.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\check_miembro.php

require_once __DIR__ . '/app/config/config.php';
require_once __DIR__ . '/app/config/database.php';
require_once __DIR__ . '/app/models/Model.php';
require_once __DIR__ . '/app/models/Miembro.php';

$id = isset($_GET['id']) ? (int)$_GET['id'] : 2;
$model = new \App\Models\Miembro();
$miembro = $model->getFullProfile($id);

echo "<h1>Verificación del modelo con ID: {$id}</h1>";
echo "<pre>";
print_r($miembro);
echo "</pre>";
echo "<p><a href='miembros/{$id}'>Ver página de perfil</a></p>";


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\crear_usuario_admin.php
=============================================================

<?php
// Script para crear un usuario administrador inicial

// Incluir archivo de configuración de la base de datos
require_once 'app/config/database.php';

try {
    // Conectar a la base de datos
    $db = new PDO("mysql:host=" . DB_HOST . ";dbname=" . DB_NAME, DB_USER, DB_PASS);
    $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    // Datos del usuario administrador
    $username = "Administrador";
    $email = "rafa.gzfr@gmail.com";
    $password = "Amor2025+"; 
    $nombre_completo = "Administrador del Sistema";
    
    // Encriptar la contraseña
    $hashedPassword = password_hash($password, PASSWORD_DEFAULT);
    
    // Fecha actual
    $fecha_actual = date('Y-m-d H:i:s');
    
    // PASO 0: Verificar si el usuario ya existe
    $checkStmt = $db->prepare("SELECT id FROM Usuarios WHERE email = ? OR username = ?");
    $checkStmt->execute([$email, $username]);
    
    if ($checkStmt->rowCount() > 0) {
        $user = $checkStmt->fetch(PDO::FETCH_ASSOC);
        echo "<h3>El usuario administrador ya existe con ID: " . $user['id'] . "</h3>";
        echo "<p>Puede iniciar sesión con:</p>";
        echo "<p><strong>Username:</strong> " . htmlspecialchars($username) . "</p>";
        echo "<p><strong>Email:</strong> " . htmlspecialchars($email) . "</p>";
        echo "<p><strong>Contraseña:</strong> " . htmlspecialchars($password) . "</p>";
        echo "<p><a href='index.php'>Ir a la página de inicio de sesión</a></p>";
    } else {
        // PASO 1: Crear registro en la tabla InformacionGeneral
        $sql_info = "INSERT INTO InformacionGeneral (nombres, apellidos, celular) 
                     VALUES (?, ?, ?)";
        $stmt_info = $db->prepare($sql_info);
        $stmt_info->execute(["Administrador", "Sistema", "+123456789"]);
        
        $miembro_id = $db->lastInsertId();
        
        // PASO 2: Crear el usuario en la tabla Usuarios
        // Cambiado: "activo" por "estado"
        $sql = "INSERT INTO Usuarios (miembro_id, rol_id, email, username, password, nombre_completo, estado, fecha_creacion) 
                VALUES (?, ?, ?, ?, ?, ?, 'Activo', ?)";
        
        $stmt = $db->prepare($sql);
        $stmt->execute([$miembro_id, 1, $email, $username, $hashedPassword, $nombre_completo, $fecha_actual]);
        
        $usuario_id = $db->lastInsertId();
        
        echo "<h2>Usuario administrador creado exitosamente!</h2>";
        echo "<p><strong>Username:</strong> " . htmlspecialchars($username) . "</p>";
        echo "<p><strong>Email:</strong> " . htmlspecialchars($email) . "</p>";
        echo "<p><strong>Contraseña:</strong> " . htmlspecialchars($password) . "</p>";
        echo "<p>Por favor, cambia esta contraseña después de iniciar sesión.</p>";
        echo "<p><a href='index.php'>Ir a la página de inicio de sesión</a></p>";
    }
} catch (PDOException $e) {
    echo "<h2>Error al crear el usuario administrador</h2>";
    echo "<p>Detalles del error: " . htmlspecialchars($e->getMessage()) . "</p>";
    
    // Sugerencias para solucionar problemas específicos
    echo "<h3>Posibles soluciones:</h3>";
    echo "<ul>";
    echo "<li>Verifique que las tablas existen y tienen la estructura correcta</li>";
    echo "<li>Verifique que los nombres de las columnas son correctos</li>";
    echo "<li>Si el error persiste, consulte los detalles específicos del error</li>";
    echo "</ul>";
}
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\crear_usuario_pastor.php
=============================================================

<?php

// Script para crear un usuario pastor

// Incluir archivo de configuración de la base de datos
require_once 'app/config/database.php';

try {
    // Conectar a la base de datos
    $db = new PDO("mysql:host=" . DB_HOST . ";dbname=" . DB_NAME, DB_USER, DB_PASS);
    $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    // Datos del usuario pastor
    $username = "Pastor Javi Aponte";
    $email = "Javaponte@gmail.com";
    $password = "12345!"; 
    $nombre_completo = "Javier Eduardo Aponte Rodriguez";
    
    // Encriptar la contraseña
    $hashedPassword = password_hash($password, PASSWORD_DEFAULT);
    
    // Fecha actual
    $fecha_actual = date('Y-m-d H:i:s');
    
    // PASO 0: Verificar si el usuario ya existe
    $checkStmt = $db->prepare("SELECT id FROM Usuarios WHERE email = ? OR username = ?");
    $checkStmt->execute([$email, $username]);
    
    if ($checkStmt->rowCount() > 0) {
        $user = $checkStmt->fetch(PDO::FETCH_ASSOC);
        echo "<h3>El usuario pastor ya existe con ID: " . $user['id'] . "</h3>";
        echo "<p>Puede iniciar sesión con:</p>";
        echo "<p><strong>Username:</strong> " . htmlspecialchars($username) . "</p>";
        echo "<p><strong>Email:</strong> " . htmlspecialchars($email) . "</p>";
        echo "<p><strong>Contraseña:</strong> " . htmlspecialchars($password) . "</p>";
        echo "<p><a href='index.php'>Ir a la página de inicio de sesión</a></p>";
    } else {
        // PASO 1: Crear registro en la tabla InformacionGeneral
        $sql_info = "INSERT INTO InformacionGeneral (nombres, apellidos, celular) 
                     VALUES (?, ?, ?)";
        $stmt_info = $db->prepare($sql_info);
        $stmt_info->execute(["Javier Eduardo", "Aponte Rodriguez", "+123456789"]);
        
        $miembro_id = $db->lastInsertId();
        
        // PASO 2: Crear el usuario en la tabla Usuarios
        $sql = "INSERT INTO Usuarios (miembro_id, rol_id, email, username, password, nombre_completo, estado, fecha_creacion) 
                VALUES (?, ?, ?, ?, ?, ?, 'Activo', ?)";
        
        $stmt = $db->prepare($sql);
        $stmt->execute([$miembro_id, 1, $email, $username, $hashedPassword, $nombre_completo, $fecha_actual]);
        
        $usuario_id = $db->lastInsertId();
        
        echo "<h2>Usuario pastor creado exitosamente!</h2>";
        echo "<p><strong>Username:</strong> " . htmlspecialchars($username) . "</p>";
        echo "<p><strong>Email:</strong> " . htmlspecialchars($email) . "</p>";
        echo "<p><strong>Contraseña:</strong> " . htmlspecialchars($password) . "</p>";
        echo "<p>Por favor, cambia esta contraseña después de iniciar sesión.</p>";
        echo "<p><a href='index.php'>Ir a la página de inicio de sesión</a></p>";
    }
} catch (PDOException $e) {
    echo "<h2>Error al crear el usuario pastor</h2>";
    echo "<p>Detalles del error: " . htmlspecialchars($e->getMessage()) . "</p>";
    
    // Sugerencias para solucionar problemas específicos
    echo "<h3>Posibles soluciones:</h3>";
    echo "<ul>";
    echo "<li>Verifique que las tablas existen y tienen la estructura correcta</li>";
    echo "<li>Verifique que los nombres de las columnas son correctos</li>";
    echo "<li>Si el error persiste, consulte los detalles específicos del error</li>";
    echo "</ul>";
}
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\debug_actualizacion.php
=============================================================

<?php

// Mostrar todos los errores
ini_set('display_errors', 1);
error_reporting(E_ALL);

// Incluir archivos necesarios
require_once __DIR__ . '/app/config/config.php';
require_once __DIR__ . '/app/config/database.php';

// Obtener ID del miembro a verificar
$id = isset($_GET['id']) ? (int)$_GET['id'] : 1;
$campo = $_GET['campo'] ?? 'nombres';
$valor = $_GET['valor'] ?? 'Actualizado-' . date('His');

echo "<h1>Diagnóstico de actualización para ID: $id</h1>";

try {
    // Conexión directa a la BD
    $db = Database::getInstance()->getConnection();
    
    // 1. Verificar que el miembro existe
    $stmt = $db->prepare("SELECT * FROM informaciongeneral WHERE id = ?");
    $stmt->execute([$id]);
    $miembro = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if (!$miembro) {
        echo "<p style='color:red;font-weight:bold;'>ERROR: No existe miembro con ID $id</p>";
        // Listar IDs disponibles
        $stmt = $db->query("SELECT id, nombres, apellidos FROM informaciongeneral ORDER BY id");
        echo "<p>Miembros disponibles:</p>";
        echo "<ul>";
        while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
            echo "<li><a href='?id={$row['id']}'>{$row['nombres']} {$row['apellidos']} (ID: {$row['id']})</a></li>";
        }
        echo "</ul>";
        exit;
    }
    
    echo "<p style='color:green;'>✓ Miembro encontrado: {$miembro['nombres']} {$miembro['apellidos']}</p>";
    
    // 2. Mostrar valores actuales
    echo "<h2>Valores actuales:</h2>";
    echo "<pre>";
    print_r($miembro);
    echo "</pre>";
    
    // 3. Intentar actualizar un campo específico
    echo "<h2>Actualización directa:</h2>";
    
    if (isset($_GET['actualizar']) && $_GET['actualizar'] == '1') {
        $sql = "UPDATE informaciongeneral SET $campo = ? WHERE id = ?";
        $stmt = $db->prepare($sql);
        $resultado = $stmt->execute([$valor, $id]);
        
        if ($resultado) {
            echo "<p style='color:green;'>✓ Actualización exitosa del campo '$campo' a '$valor'</p>";
            
            // Mostrar valores actualizados
            $stmt = $db->prepare("SELECT * FROM informaciongeneral WHERE id = ?");
            $stmt->execute([$id]);
            $actualizado = $stmt->fetch(PDO::FETCH_ASSOC);
            
            echo "<h3>Valores actualizados:</h3>";
            echo "<pre>";
            print_r($actualizado);
            echo "</pre>";
            
            echo "<p><a href='miembros/{$id}'>Ver perfil actualizado</a></p>";
        } else {
            echo "<p style='color:red;'>✗ Error al actualizar</p>";
        }
    } else {
        echo "<p><a href='?id=$id&campo=$campo&valor=$valor&actualizar=1' style='padding:10px;background:#007bff;color:white;text-decoration:none;'>
              Actualizar campo '$campo' a '$valor'</a></p>";
    }
    
    echo "<h3>Probar otras actualizaciones:</h3>";
    echo "<ul>
        <li><a href='?id=$id&campo=nombres&valor=Nombre-Nuevo'>Actualizar nombres</a></li>
        <li><a href='?id=$id&campo=apellidos&valor=Apellido-Prueba'>Actualizar apellidos</a></li>
        <li><a href='?id=$id&campo=estado_espiritual&valor=Consolidado'>Actualizar estado espiritual</a></li>
        <li><a href='?id=$id&campo=tipo_miembro&valor=Activo'>Actualizar tipo de miembro</a></li>
    </ul>";
    
} catch (Exception $e) {
    echo "<p style='color:red;'>Error: " . $e->getMessage() . "</p>";
    echo "<p>Detalles: <pre>" . $e->getTraceAsString() . "</pre></p>";
}
?>

<style>
    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
    pre { background: #f5f5f5; padding: 10px; border: 1px solid #ddd; }
    h1, h2, h3 { color: #333; }
</style>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\debug_ajax.php
=============================================================

<?php

// Archivo para depurar problemas con respuestas JSON

// Análisis para detectar salida antes de los headers

// NO iniciar buffer todavía

// Verificar si ya se ha enviado algún contenido
if (headers_sent($filename, $linenum)) {
    echo "<h1>¡Error! Los encabezados ya fueron enviados</h1>";
    echo "<p>Los encabezados HTTP ya se enviaron desde el archivo $filename en la línea $linenum</p>";
    echo "<p>Esto puede estar causando que las respuestas JSON no sean válidas.</p>";
    exit;
}

// Ahora iniciamos buffer para capturar cualquier salida no deseada
ob_start();

// Incluir archivos necesarios
require_once 'app/config/config.php';
require_once 'app/config/database.php';

// Verificar si hubo salida durante las inclusiones
$output = ob_get_clean();
if (!empty($output)) {
    echo "<h1>¡Advertencia! Se detectó salida durante la inclusión de archivos</h1>";
    echo "<p>Esta salida podría estar interfiriendo con las respuestas JSON</p>";
    echo "<h2>Contenido detectado:</h2>";
    echo "<pre>" . htmlspecialchars($output) . "</pre>";
    exit;
}

// Si llegamos aquí, está todo limpio para enviar JSON
header('Content-Type: application/json');
echo json_encode([
    'success' => true,
    'message' => 'Esta es una respuesta JSON limpia y válida',
    'timestamp' => date('Y-m-d H:i:s')
]);


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\debug_editar.php
=============================================================

<?php

// Mostrar todos los errores
ini_set('display_errors', 1);
error_reporting(E_ALL);

// Incluir archivos necesarios
require_once __DIR__ . '/app/config/config.php';
require_once __DIR__ . '/app/config/database.php';

// ID a probar
$id = isset($_GET['id']) ? (int)$_GET['id'] : 2;

echo "<h1>Diagnóstico de edición para miembro ID: $id</h1>";

try {
    // Obtener conexión a la BD
    $db = Database::getInstance()->getConnection();
    
    // 1. Verificar si el miembro existe
    $stmt = $db->prepare("SELECT * FROM informaciongeneral WHERE id = ?");
    $stmt->execute([$id]);
    $miembro = $stmt->fetch(\PDO::FETCH_ASSOC);
    
    if (!$miembro) {
        echo "<p style='color:red'>Error: El miembro con ID $id no existe</p>";
        exit;
    }
    
    echo "<h2>Datos actuales del miembro:</h2>";
    echo "<pre>";
    print_r($miembro);
    echo "</pre>";
    
    // 2. Prueba de actualización
    if (isset($_GET['test']) && $_GET['test'] === '1') {
        $nuevoNombre = "Nombre".time(); // Nombre único para prueba
        
        $sql = "UPDATE informaciongeneral SET nombres = ? WHERE id = ?";
        $stmt = $db->prepare($sql);
        $result = $stmt->execute([$nuevoNombre, $id]);
        
        if ($result) {
            echo "<p style='color:green'>✅ Actualización exitosa directamente en la BD</p>";
            
            // Verificar que se actualizó correctamente
            $stmt = $db->prepare("SELECT nombres FROM informaciongeneral WHERE id = ?");
            $stmt->execute([$id]);
            $nombreActualizado = $stmt->fetchColumn();
            
            echo "<p>Nombre ahora es: <strong>$nombreActualizado</strong></p>";
            
            if ($nombreActualizado === $nuevoNombre) {
                echo "<p style='color:green'>✅ La verificación coincide</p>";
            } else {
                echo "<p style='color:red'>❌ ¡La verificación NO coincide!</p>";
            }
        } else {
            echo "<p style='color:red'>❌ Error al actualizar</p>";
        }
    }
    
    // 3. Link para realizar la prueba
    echo "<p><a href='?id=$id&test=1' class='btn btn-primary'>Ejecutar prueba de actualización</a></p>";
    
} catch (Exception $e) {
    echo "<p style='color:red'>Error: " . $e->getMessage() . "</p>";
}
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\debug_post.php
=============================================================

<?php

// Script para depurar los datos POST enviados desde el formulario

// Activar visualización de errores
ini_set('display_errors', 1);
error_reporting(E_ALL);

echo "<h1>Datos POST recibidos</h1>";

// Comprobar si hay datos POST
if (empty($_POST)) {
    echo "<p>No se recibieron datos POST. Use este script como destino de un formulario.</p>";
    
    // Crear formulario de prueba
    echo "<h2>Formulario de prueba</h2>";
    echo "<form action='' method='post'>";
    echo "<div class='mb-3'>";
    echo "<label>Campo contacto[nombre]</label>";
    echo "<input type='text' name='contacto[nombre]' class='form-control'>";
    echo "</div>";
    echo "<div class='mb-3'>";
    echo "<label>Campo estudios[nivel]</label>";
    echo "<input type='text' name='estudios[nivel]' class='form-control'>";
    echo "</div>";
    echo "<button type='submit' class='btn btn-primary'>Enviar</button>";
    echo "</form>";
    
    exit;
}

// Mostrar los datos POST
echo "<h2>Todos los datos POST:</h2>";
echo "<pre>";
print_r($_POST);
echo "</pre>";

// Mostrar datos específicos para tablas relacionadas
$tablas = ['contacto', 'estudios', 'tallas', 'salud', 'carrera'];

foreach ($tablas as $tabla) {
    echo "<h2>Datos para tabla '$tabla':</h2>";
    if (isset($_POST[$tabla]) && is_array($_POST[$tabla])) {
        echo "<pre>";
        print_r($_POST[$tabla]);
        echo "</pre>";
        
        // Mostrar cómo se construiría la SQL
        echo "<h3>SQL que se ejecutaría:</h3>";
        $campos = array_keys($_POST[$tabla]);
        $placeholders = array_fill(0, count($campos), '?');
        
        echo "<code>INSERT INTO " . ucfirst($tabla) . " (" . implode(', ', $campos) . ", miembro_id) 
              VALUES (" . implode(', ', $placeholders) . ", 123);</code>";
    } else {
        echo "<p>No se encontraron datos para esta tabla.</p>";
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\debug_update.php
=============================================================

<?php

// Script para depurar la actualización de miembros
require_once __DIR__ . '/app/config/config.php';
require_once __DIR__ . '/app/config/database.php';

// ID a verificar
$id = isset($_GET['id']) ? (int)$_GET['id'] : 2;

echo "<h1>Depuración de actualización para miembro ID: {$id}</h1>";

try {
    // Obtener conexión directa
    $db = Database::getInstance()->getConnection();
    
    // Verificar si el miembro existe
    $stmt = $db->prepare("SELECT * FROM InformacionGeneral WHERE id = ?");
    $stmt->execute([$id]);
    $miembro = $stmt->fetch();
    
    if (!$miembro) {
        echo "<div style='color:red'>Miembro no encontrado</div>";
        exit;
    }
    
    echo "<h2>Datos actuales del miembro:</h2>";
    echo "<pre>";
    print_r($miembro);
    echo "</pre>";
    
    // Verificar tablas relacionadas
    $tablas = ['Contacto', 'EstudiosTrabajo', 'Tallas', 'SaludEmergencias', 'CarreraBiblica'];
    
    foreach ($tablas as $tabla) {
        $stmt = $db->prepare("SELECT * FROM {$tabla} WHERE miembro_id = ?");
        $stmt->execute([$id]);
        $datos = $stmt->fetch();
        
        echo "<h3>Datos de {$tabla}:</h3>";
        if ($datos) {
            echo "<pre>";
            print_r($datos);
            echo "</pre>";
        } else {
            echo "<p>No hay datos en esta tabla para este miembro</p>";
            
            // Mostrar estructura de la tabla para referencia
            echo "<p>Estructura de la tabla {$tabla}:</p>";
            $stmt = $db->query("DESCRIBE {$tabla}");
            $estructura = $stmt->fetchAll();
            echo "<pre>";
            print_r($estructura);
            echo "</pre>";
        }
    }
    
} catch (Exception $e) {
    echo "<div style='color:red'>Error: " . $e->getMessage() . "</div>";
}
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\diagnostico-ajax.php
=============================================================

<?php
// Diagnosticar problemas con respuestas AJAX
header('Content-Type: application/json');

try {
    // Simular una respuesta JSON exitosa
    echo json_encode([
        'success' => true,
        'message' => 'Esta es una respuesta JSON válida de prueba',
        'timestamp' => date('Y-m-d H:i:s')
    ]);
} catch (Exception $e) {
    echo json_encode([
        'success' => false,
        'message' => 'Error al generar JSON: ' . $e->getMessage()
    ]);
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\diagnostico-json.php
=============================================================

<?php
// Mostrar todos los errores
ini_set('display_errors', 1);
error_reporting(E_ALL);

echo "=== DIAGNÓSTICO PARA ERRORES DE JSON ===\n\n";

// Simular una respuesta JSON correcta
header('Content-Type: application/json');
echo json_encode([
    'success' => true,
    'message' => 'Esta es una respuesta JSON válida',
    'timestamp' => date('Y-m-d H:i:s')
]);
exit;


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\diagnostico-sql.php
=============================================================

<?php

// Mostrar todos los errores
ini_set('display_errors', 1);
error_reporting(E_ALL);

echo "<h1>Diagnóstico de SQL</h1>";

try {
    // Cargar la clase Database para usar su configuración
    require_once 'app/config/Database.php';
    
    echo "<p>Intentando conectar a MySQL usando la clase Database...</p>";
    
    // Obtener la instancia y conexión de la clase Database
    $db = Database::getInstance();
    $pdo = $db->getConnection();
    
    echo "<p style='color:green'>✓ Conexión establecida correctamente</p>";
    
    // Mostrar la lista de todas las tablas disponibles
    echo "<h2>Tablas disponibles en la base de datos:</h2>";
    $stmt = $pdo->query("SHOW TABLES");
    $tablas = $stmt->fetchAll(PDO::FETCH_COLUMN);
    echo "<ul>";
    foreach ($tablas as $tabla) {
        echo "<li>$tabla</li>";
    }
    echo "</ul>";
    
    // Verificar si existe la tabla 'informaciongeneral'
    echo "<h2>Verificando tabla informaciongeneral:</h2>";
    if (in_array('informaciongeneral', $tablas)) {
        // Primero ver la estructura de la tabla
        $stmt = $pdo->query("DESCRIBE informaciongeneral");
        $estructura = $stmt->fetchAll(PDO::FETCH_ASSOC);
        echo "<p>Estructura de la tabla informaciongeneral:</p>";
        echo "<pre>" . print_r($estructura, true) . "</pre>";
        
        // Verificar total de registros
        $stmt = $pdo->query("SELECT COUNT(*) as total FROM informaciongeneral");
        $totalRegistros = $stmt->fetch(PDO::FETCH_ASSOC)['total'];
        echo "<p>Total de registros en la tabla informaciongeneral: <strong>$totalRegistros</strong></p>";
        
        // Saber cuál es el campo de fecha en esta tabla
        $columnasFecha = [];
        foreach ($estructura as $columna) {
            if (strpos(strtolower($columna['Type']), 'date') !== false || 
                strpos(strtolower($columna['Field']), 'fecha') !== false) {
                $columnasFecha[] = $columna['Field'];
            }
        }
        
        if (!empty($columnasFecha)) {
            echo "<p>Columnas de fecha encontradas: " . implode(", ", $columnasFecha) . "</p>";
            
            // Usar la primera columna de fecha encontrada para ordenar
            $columnaFechaOrdenacion = $columnasFecha[0];
            $stmt = $pdo->query("SELECT id, nombres, apellidos, $columnaFechaOrdenacion FROM informaciongeneral ORDER BY $columnaFechaOrdenacion DESC LIMIT 1");
            $ultimoRegistro = $stmt->fetch(PDO::FETCH_ASSOC);
            if ($ultimoRegistro) {
                echo "<p>Último registro modificado (ordenado por $columnaFechaOrdenacion):</p>";
                echo "<pre>" . print_r($ultimoRegistro, true) . "</pre>";
            }
        } else {
            // Sin columnas de fecha, mostrar un registro cualquiera
            echo "<p>No se encontraron columnas de fecha en la tabla.</p>";
            $stmt = $pdo->query("SELECT * FROM informaciongeneral LIMIT 1");
            $registro = $stmt->fetch(PDO::FETCH_ASSOC);
            if ($registro) {
                echo "<p>Ejemplo de un registro de la tabla:</p>";
                echo "<pre>" . print_r($registro, true) . "</pre>";
            }
        }
    } else {
        echo "<p style='color:orange'>⚠️ La tabla 'informaciongeneral' no existe en la base de datos</p>";
    }
    
} catch (Exception $e) {
    echo "<p style='color:red'>Error: " . $e->getMessage() . "</p>";
}
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\diagnostico_fotos.php
=============================================================

<?php

// Herramienta de diagnóstico para carga de fotos
ini_set('display_errors', 1);
error_reporting(E_ALL);

echo "<h1>Diagnóstico de Carga de Fotos</h1>";

// 1. Verificar configuración de PHP
echo "<h2>1. Configuración de PHP para carga de archivos</h2>";
echo "<table border='1' cellpadding='5'>";
echo "<tr><th>Configuración</th><th>Valor</th><th>Estado</th></tr>";

// Comprobar upload_max_filesize
$upload_max = ini_get('upload_max_filesize');
echo "<tr><td>upload_max_filesize</td><td>$upload_max</td><td>";
echo (return_bytes($upload_max) >= 2*1024*1024) ? "✅ OK" : "⚠️ Muy bajo";
echo "</td></tr>";

// Comprobar post_max_size
$post_max = ini_get('post_max_size');
echo "<tr><td>post_max_size</td><td>$post_max</td><td>";
echo (return_bytes($post_max) >= return_bytes($upload_max)) ? "✅ OK" : "❌ Debe ser mayor que upload_max_filesize";
echo "</td></tr>";

// Comprobar file_uploads
$file_uploads = ini_get('file_uploads');
echo "<tr><td>file_uploads</td><td>$file_uploads</td><td>";
echo ($file_uploads == 1) ? "✅ OK" : "❌ Carga de archivos deshabilitada";
echo "</td></tr>";
echo "</table>";

// 2. Verificar rutas y permisos
echo "<h2>2. Verificación de rutas y permisos</h2>";
echo "<table border='1' cellpadding='5'>";
echo "<tr><th>Ruta</th><th>Existe</th><th>Permisos</th><th>Escribible</th></tr>";

$rutas = [
    'Directorio raíz' => __DIR__,
    'Directorio public' => __DIR__ . '/public',
    'Directorio uploads' => __DIR__ . '/public/uploads',
    'Directorio miembros' => __DIR__ . '/public/uploads/miembros'
];

foreach ($rutas as $desc => $ruta) {
    $existe = file_exists($ruta) ? "✅ Sí" : "❌ No";
    $permisos = file_exists($ruta) ? substr(sprintf('%o', fileperms($ruta)), -4) : 'N/A';
    $escribible = file_exists($ruta) ? (is_writable($ruta) ? "✅ Sí" : "❌ No") : 'N/A';
    
    echo "<tr><td>$desc<br><small>$ruta</small></td><td>$existe</td><td>$permisos</td><td>$escribible</td></tr>";
    
    // Intentar crear la carpeta si no existe
    if (!file_exists($ruta)) {
        $creado = @mkdir($ruta, 0755, true);
        echo "<tr><td colspan='4' style='background:#ffe;'>";
        echo $creado ? "✅ Carpeta creada automáticamente" : "❌ No se pudo crear la carpeta";
        echo "</td></tr>";
    }
}

echo "</table>";

// 3. Formulario de prueba
echo "<h2>3. Prueba de carga simple</h2>";
echo "<form action='" . $_SERVER['PHP_SELF'] . "' method='POST' enctype='multipart/form-data'>";
echo "<input type='file' name='test_foto' accept='image/*'>";
echo "<button type='submit' name='test_upload'>Probar Carga</button>";
echo "</form>";

// Procesar formulario de prueba
if (isset($_POST['test_upload'])) {
    echo "<h3>Resultado de la prueba:</h3>";
    
    if (!empty($_FILES['test_foto']['name'])) {
        $error = $_FILES['test_foto']['error'];
        $nombre = htmlspecialchars($_FILES['test_foto']['name']);
        
        echo "<p>Archivo: $nombre</p>";
        echo "<p>Tamaño: " . format_bytes($_FILES['test_foto']['size']) . "</p>";
        echo "<p>Código de error: " . ($error == 0 ? "0 (Sin errores)" : "$error - " . upload_error_message($error)) . "</p>";
        
        if ($error == 0) {
            // Intentar guardar el archivo
            $dir_test = __DIR__ . '/public/uploads/test/';
            if (!file_exists($dir_test)) {
                mkdir($dir_test, 0755, true);
            }
            
            $test_path = $dir_test . $_FILES['test_foto']['name'];
            if (move_uploaded_file($_FILES['test_foto']['tmp_name'], $test_path)) {
                echo "<p>✅ Archivo guardado en: $test_path</p>";
                echo "<p>URL de acceso: <a href='/ENCASA_DATABASE/public/uploads/test/" . urlencode($_FILES['test_foto']['name']) . "' target='_blank'>Ver imagen</a></p>";
                echo "<p><img src='/ENCASA_DATABASE/public/uploads/test/" . urlencode($_FILES['test_foto']['name']) . "' style='max-width:300px;'></p>";
            } else {
                echo "<p>❌ Error al mover el archivo</p>";
            }
        }
    } else {
        echo "<p>❌ No se seleccionó ningún archivo</p>";
    }
}

// 4. Análisis del formulario real en editar.php
echo "<h2>4. Verificación del formulario en editar.php</h2>";

$formulario_path = __DIR__ . '/app/views/miembros/editar.php';
if (file_exists($formulario_path)) {
    $contenido = file_get_contents($formulario_path);
    
    // Verificar elementos críticos
    $tiene_enctype = strpos($contenido, 'enctype="multipart/form-data"') !== false;
    $tiene_input_file = strpos($contenido, 'type="file"') !== false;
    
    echo "<p>" . ($tiene_enctype ? "✅" : "❌") . " enctype=\"multipart/form-data\"</p>";
    echo "<p>" . ($tiene_input_file ? "✅" : "❌") . " Input type=\"file\"</p>";
    
    // Buscar URL del formulario
    preg_match('/form[^>]+action\s*=\s*["\']([^"\']+)["\']/', $contenido, $matches);
    $form_action = isset($matches[1]) ? $matches[1] : "No encontrada";
    echo "<p>URL de acción: $form_action</p>";
    
    // Verificar cómo se maneja el submit del formulario
    $usa_fetch = strpos($contenido, 'fetch(') !== false;
    echo "<p>" . ($usa_fetch ? "✅" : "❌") . " Usa fetch para envío AJAX</p>";
} else {
    echo "<p>❌ No se encontró el archivo editar.php</p>";
}

// 5. Verificación del controlador
echo "<h2>5. Verificación del controlador</h2>";

$controller_path = __DIR__ . '/app/Controllers/MiembrosController.php';
if (file_exists($controller_path)) {
    $contenido = file_get_contents($controller_path);
    
    // Verificar si el método actualizar procesa $_FILES
    $procesa_files = strpos($contenido, '$_FILES') !== false &&
                     preg_match('/function\s+actualizar[^{]*\{.*\$_FILES/s', $contenido);
                     
    $usa_procesarFoto = strpos($contenido, 'procesarFoto') !== false &&
                        preg_match('/function\s+actualizar[^{]*\{.*procesarFoto/s', $contenido);
    
    echo "<p>" . ($procesa_files ? "✅" : "❌") . " El método actualizar procesa \$_FILES</p>";
    echo "<p>" . ($usa_procesarFoto ? "✅" : "❌") . " El método actualizar llama a procesarFoto()</p>";
    
    // Verificar directorios de guardado
    preg_match('/\$directorio\s*=\s*[\'"](.+?)[\'"]/', $contenido, $matches);
    $directorio_usado = isset($matches[1]) ? $matches[1] : "No encontrado";
    echo "<p>Directorio usado: $directorio_usado</p>";
    
    // Extraer código del método procesarFoto para revisión
    preg_match('/private\s+function\s+procesarFoto\s*\([^{]*\{(.+?)(private|public|protected|\/\*\*)/s', $contenido, $matches);
    if (isset($matches[1])) {
        echo "<details>";
        echo "<summary>Ver código de procesarFoto()</summary>";
        echo "<pre>" . htmlspecialchars($matches[1]) . "</pre>";
        echo "</details>";
    }
} else {
    echo "<p>❌ No se encontró el archivo MiembrosController.php</p>";
}

// 6. Herramienta de carga manual para depuración directa
echo "<h2>6. Herramienta de carga manual</h2>";
echo "<p>Use esta herramienta para subir una foto directamente a la base de datos:</p>";

echo "<form action='" . $_SERVER['PHP_SELF'] . "' method='POST' enctype='multipart/form-data'>";
echo "<div><label>ID del miembro: <input type='number' name='miembro_id' required></label></div>";
echo "<div style='margin:10px 0;'><label>Foto: <input type='file' name='foto' accept='image/*' required></label></div>";
echo "<button type='submit' name='cargar_manual'>Cargar directamente</button>";
echo "</form>";

// Procesar carga manual
if (isset($_POST['cargar_manual']) && !empty($_FILES['foto']['name']) && !empty($_POST['miembro_id'])) {
    echo "<h3>Resultado de carga manual:</h3>";
    
    $miembro_id = (int)$_POST['miembro_id'];
    $directorio = __DIR__ . '/public/uploads/miembros/';
    
    if (!file_exists($directorio)) {
        mkdir($directorio, 0755, true);
    }
    
    $nombre_archivo = 'miembro_' . $miembro_id . '_' . time() . '_' . basename($_FILES['foto']['name']);
    $ruta_completa = $directorio . $nombre_archivo;
    
    if (move_uploaded_file($_FILES['foto']['tmp_name'], $ruta_completa)) {
        echo "<p>✅ Archivo subido correctamente a: $ruta_completa</p>";
        
        // Actualizar base de datos
        try {
            require_once 'app/config/Database.php';
            $db = \Database::getInstance()->getConnection();
            
            $stmt = $db->prepare("UPDATE InformacionGeneral SET foto = ? WHERE id = ?");
            $resultado = $stmt->execute([$nombre_archivo, $miembro_id]);
            
            if ($resultado) {
                echo "<p>✅ Base de datos actualizada correctamente</p>";
                echo "<p>Vista previa de la imagen:</p>";
                echo "<img src='/ENCASA_DATABASE/public/uploads/miembros/$nombre_archivo' style='max-width:300px;'>";
            } else {
                echo "<p>❌ Error al actualizar la base de datos</p>";
            }
        } catch (\Exception $e) {
            echo "<p>❌ Error de base de datos: " . $e->getMessage() . "</p>";
        }
    } else {
        echo "<p>❌ Error al mover el archivo</p>";
    }
}

// 7. Resumen y recomendaciones
echo "<h2>7. Recomendaciones</h2>";

echo "<h3>Corregir método 'actualizar' en MiembrosController.php</h3>";
echo "<pre style='background:#f5f5f5;padding:10px;'>";
echo htmlspecialchars('public function actualizar($id)
{
    try {
        // Código existente...
        
        // Procesar la foto si se subió una nueva
        if (!empty($_FILES["foto"]) && $_FILES["foto"]["error"] === UPLOAD_ERR_OK) {
            $foto = $this->procesarFoto($_FILES["foto"]);
            if ($foto) {
                $datosGenerales["foto"] = $foto;
                
                // Si había foto anterior, eliminarla
                if (!empty($miembro["foto"])) {
                    $rutaAnterior = "../public/uploads/miembros/" . $miembro["foto"];
                    if (file_exists($rutaAnterior)) {
                        unlink($rutaAnterior);
                    }
                }
            }
        }
        
        // Continuar con la actualización...
    }
}');
echo "</pre>";

// Funciones auxiliares
function return_bytes($val) {
    $val = trim($val);
    $last = strtolower($val[strlen($val)-1]);
    $val = (int) $val;
    switch($last) {
        case 'g': $val *= 1024;
        case 'm': $val *= 1024;
        case 'k': $val *= 1024;
    }
    return $val;
}

function format_bytes($bytes, $precision = 2) { 
    $units = ['B', 'KB', 'MB', 'GB', 'TB']; 
    $bytes = max($bytes, 0); 
    $pow = floor(($bytes ? log($bytes) : 0) / log(1024)); 
    $pow = min($pow, count($units) - 1); 
    $bytes /= (1 << (10 * $pow)); 
    return round($bytes, $precision) . ' ' . $units[$pow]; 
}

function upload_error_message($code) {
    $messages = [
        UPLOAD_ERR_INI_SIZE => 'El archivo excede el tamaño permitido en php.ini',
        UPLOAD_ERR_FORM_SIZE => 'El archivo excede el tamaño permitido en el formulario',
        UPLOAD_ERR_PARTIAL => 'El archivo se subió parcialmente',
        UPLOAD_ERR_NO_FILE => 'No se seleccionó ningún archivo',
        UPLOAD_ERR_NO_TMP_DIR => 'Falta la carpeta temporal',
        UPLOAD_ERR_CANT_WRITE => 'Error al escribir el archivo',
        UPLOAD_ERR_EXTENSION => 'Una extensión de PHP detuvo la carga'
    ];
    
    return isset($messages[$code]) ? $messages[$code] : "Error desconocido";
}
?>

<style>
body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
table { border-collapse: collapse; margin-bottom: 20px; width: 100%; }
th { background: #f0f0f0; }
pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
h1 { color: #333; }
h2 { color: #555; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-top: 30px; }
</style>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\diagnostico_miembro.php
=============================================================

<?php


// Mostrar todos los errores
ini_set('display_errors', 1);
error_reporting(E_ALL);

// Establecer tiempo máximo de ejecución más largo para análisis completo
set_time_limit(300);

// Incluir archivos necesarios
require_once 'app/config/config.php';
require_once 'app/config/Database.php';

// Estilos para una mejor visualización
echo '<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico de Miembros</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        h1, h2, h3 { color: #333; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow: auto; }
        .success { color: green; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .query { background: #e8f4ff; padding: 10px; border-left: 4px solid #0066cc; margin: 10px 0; }
        table { border-collapse: collapse; width: 100%; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .test-block { background: #f9f9f9; padding: 15px; margin: 20px 0; border-radius: 5px; border: 1px solid #ddd; }
        .btn { display: inline-block; padding: 8px 15px; background: #0066cc; color: white; text-decoration: none; border-radius: 4px; }
        .result-block { margin-top: 10px; padding: 10px; border-radius: 5px; }
        .result-success { background: #d4edda; border: 1px solid #c3e6cb; }
        .result-error { background: #f8d7da; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <h1>Diagnóstico para Actualización de Miembros</h1>';

try {
    // Obtener la instancia y conexión de la base de datos
    $db = Database::getInstance();
    $pdo = $db->getConnection();
    echo '<p class="success">✓ Conexión a la base de datos establecida correctamente</p>';
    
    // Obtener ID del miembro desde parámetro GET o usar un valor predeterminado
    $miembro_id = isset($_GET['id']) ? (int)$_GET['id'] : null;
    
    // Si no se proporciona ID, mostrar listado de miembros disponibles
    if (!$miembro_id) {
        echo '<h2>Miembros disponibles</h2>';
        $stmt = $pdo->query("SELECT id, nombres, apellidos, fecha_registro_sistema, fecha_modificacion FROM informaciongeneral ORDER BY id");
        $miembros = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        echo '<table>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>Fecha registro</th>
                    <th>Última modificación</th>
                    <th>Acción</th>
                </tr>';
        
        foreach ($miembros as $miembro) {
            echo '<tr>
                    <td>'.$miembro['id'].'</td>
                    <td>'.$miembro['nombres'].'</td>
                    <td>'.$miembro['apellidos'].'</td>
                    <td>'.$miembro['fecha_registro_sistema'].'</td>
                    <td>'.$miembro['fecha_modificacion'].'</td>
                    <td><a href="?id='.$miembro['id'].'" class="btn">Diagnosticar</a></td>
                </tr>';
        }
        
        echo '</table>';
        echo '<p>Seleccione un miembro para realizar el diagnóstico de actualización.</p>';
        exit;
    }
    
    // Si hay un ID, proceder con el diagnóstico
    echo "<h2>Diagnóstico para miembro ID: $miembro_id</h2>";
    
    // Verificar si el miembro existe
    $stmt = $pdo->prepare("SELECT * FROM informaciongeneral WHERE id = ?");
    $stmt->execute([$miembro_id]);
    $miembro = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if (!$miembro) {
        echo "<p class='error'>❌ El miembro con ID $miembro_id no existe en la base de datos.</p>";
        echo '<p><a href="diagnostico_miembro.php">Volver a la lista de miembros</a></p>';
        exit;
    }
    
    echo "<h3>Datos actuales del miembro:</h3>";
    echo "<pre>" . print_r($miembro, true) . "</pre>";
    
    // Verificar tablas relacionadas
    $tablas_relacionadas = [
        'contacto' => 'Contacto',
        'estudiostrabajo' => 'Estudios y Trabajo',
        'tallas' => 'Tallas',
        'saludemergencias' => 'Salud y Emergencias',
        'carrerabiblica' => 'Carrera Bíblica'
    ];
    
    echo "<h3>Datos en tablas relacionadas:</h3>";
    
    foreach ($tablas_relacionadas as $tabla => $nombre) {
        $stmt = $pdo->prepare("SELECT * FROM $tabla WHERE miembro_id = ?");
        $stmt->execute([$miembro_id]);
        $datos = $stmt->fetch(PDO::FETCH_ASSOC);
        
        echo "<h4>$nombre:</h4>";
        if ($datos) {
            echo "<pre>" . print_r($datos, true) . "</pre>";
        } else {
            echo "<p class='warning'>⚠️ No hay datos para este miembro en la tabla $tabla</p>";
        }
    }
    
    // Sección de pruebas de actualización
    echo '<h2>Prueba de actualización manual</h2>';
    
    // Si se envía el formulario de prueba
    if (isset($_POST['test_update']) && $_POST['test_update'] == 'true') {
        echo '<div class="test-block">';
        echo '<h3>Ejecutando prueba de actualización...</h3>';
        
        // Obtener valores enviados
        $campo = $_POST['campo'];
        $valor = $_POST['valor'];
        $tabla = $_POST['tabla'];
        
        // Ejecutar actualización según la tabla
        try {
            if ($tabla == 'informaciongeneral') {
                // Actualizar la tabla principal
                $sql = "UPDATE informaciongeneral SET $campo = ? WHERE id = ?";
                $stmt = $pdo->prepare($sql);
                echo "<p class='query'>Consulta SQL: UPDATE informaciongeneral SET $campo = '$valor' WHERE id = $miembro_id</p>";
                $stmt->execute([$valor, $miembro_id]);
            } else {
                // Actualizar tabla relacionada
                $sql = "UPDATE $tabla SET $campo = ? WHERE miembro_id = ?";
                $stmt = $pdo->prepare($sql);
                echo "<p class='query'>Consulta SQL: UPDATE $tabla SET $campo = '$valor' WHERE miembro_id = $miembro_id</p>";
                $stmt->execute([$valor, $miembro_id]);
            }
            
            echo "<p>Filas afectadas: " . $stmt->rowCount() . "</p>";
            
            if ($stmt->rowCount() > 0) {
                echo "<p class='success'>✓ Actualización ejecutada correctamente.</p>";
            } else {
                echo "<p class='warning'>⚠️ La consulta se ejecutó sin errores, pero ninguna fila fue modificada. Razones posibles:</p>";
                echo "<ul>";
                echo "<li>El valor actual ya es igual al nuevo valor.</li>";
                echo "<li>La columna no existe en la tabla.</li>";
                echo "<li>No hay registro para este miembro en la tabla relacionada.</li>";
                echo "</ul>";
            }
            
            // Verificar el valor actual después de la actualización
            if ($tabla == 'informaciongeneral') {
                $sql = "SELECT $campo FROM informaciongeneral WHERE id = ?";
            } else {
                $sql = "SELECT $campo FROM $tabla WHERE miembro_id = ?";
            }
            
            $stmt = $pdo->prepare($sql);
            $stmt->execute([$miembro_id]);
            $resultado = $stmt->fetch(PDO::FETCH_ASSOC);
            
            echo "<div class='result-block " . ($resultado ? "result-success" : "result-error") . "'>";
            echo "<h4>Valor después de la actualización:</h4>";
            
            if ($resultado) {
                echo "<p>Nuevo valor de '$campo': <strong>" . $resultado[$campo] . "</strong></p>";
                
                if ($resultado[$campo] == $valor) {
                    echo "<p class='success'>✓ El valor se actualizó correctamente.</p>";
                } else {
                    echo "<p class='error'>❌ El valor no coincide con el valor esperado.</p>";
                }
            } else {
                echo "<p class='error'>❌ No se pudo obtener el valor actual.</p>";
            }
            echo "</div>";
            
        } catch (PDOException $e) {
            echo "<p class='error'>❌ Error en la actualización: " . $e->getMessage() . "</p>";
        }
        
        echo '</div>';
    }
    
    // Formulario para probar actualización manual
    echo '<div class="test-block">';
    echo '<h3>Ejecutar actualización de prueba</h3>';
    echo '<form method="POST">';
    echo '<input type="hidden" name="test_update" value="true">';
    
    echo '<p><label for="tabla">Selecciona la tabla:</label><br>';
    echo '<select name="tabla" id="tabla" required>';
    echo '<option value="informaciongeneral">informaciongeneral (Principal)</option>';
    foreach ($tablas_relacionadas as $tabla => $nombre) {
        echo "<option value=\"$tabla\">$tabla</option>";
    }
    echo '</select></p>';
    
    echo '<p><label for="campo">Nombre del campo a actualizar:</label><br>';
    echo '<input type="text" name="campo" id="campo" required placeholder="Ejemplo: nombres"></p>';
    
    echo '<p><label for="valor">Nuevo valor:</label><br>';
    echo '<input type="text" name="valor" id="valor" required placeholder="Ejemplo: Juan"></p>';
    
    echo '<p><button type="submit" class="btn">Ejecutar Actualización</button></p>';
    echo '</form>';
    echo '</div>';
    
    // Verificar permisos y configuración
    echo '<h2>Verificación de permisos y configuración</h2>';
    
    // Comprobar permisos de escritura en la base de datos
    echo '<h3>Permisos de base de datos:</h3>';
    try {
        // Intentar crear y eliminar una tabla temporal para comprobar permisos
        $pdo->exec("CREATE TABLE IF NOT EXISTS test_permisos (id INT)");
        echo "<p class='success'>✓ Permisos de creación OK</p>";
        $pdo->exec("DROP TABLE IF EXISTS test_permisos");
        echo "<p class='success'>✓ Permisos de eliminación OK</p>";
    } catch (PDOException $e) {
        echo "<p class='error'>❌ Error en permisos de base de datos: " . $e->getMessage() . "</p>";
    }
    
    // Verificar configuración de PDO
    echo '<h3>Configuración de PDO:</h3>';
    $attributes = [
        PDO::ATTR_ERRMODE => 'Modo de error',
        PDO::ATTR_EMULATE_PREPARES => 'Emulación de preparadas',
        PDO::ATTR_DEFAULT_FETCH_MODE => 'Modo de fetch por defecto'
    ];
    
    foreach ($attributes as $attr => $name) {
        try {
            echo "<p>$name: <strong>" . $pdo->getAttribute($attr) . "</strong></p>";
        } catch (Exception $e) {
            echo "<p>$name: No disponible</p>";
        }
    }
    
    // Instrucciones para solucionar problemas comunes
    echo '<h2>Soluciones a problemas comunes</h2>';
    echo '<ol>';
    echo '<li><strong>Si no actualiza ningún campo:</strong> Verifica que el controlador use el nombre correcto de la tabla (informaciongeneral) y que los nombres de campo coincidan exactamente.</li>';
    echo '<li><strong>Si actualiza algunos campos pero no otros:</strong> Asegúrate de que todos los campos están incluidos en la consulta SQL de actualización.</li>';
    echo '<li><strong>Si las tablas relacionadas no se actualizan:</strong> Verifica que la relación está correctamente establecida con miembro_id y que los registros existen.</li>';
    echo '<li><strong>Si las fechas no se actualizan:</strong> Revisa el formato de fecha que estás enviando, debe ser compatible con MySQL (YYYY-MM-DD).</li>';
    echo '</ol>';
    
    echo '<p><a href="diagnostico_miembro.php" class="btn">Volver a la lista de miembros</a></p>';
    
} catch (Exception $e) {
    echo "<p class='error'>Error general: " . $e->getMessage() . "</p>";
    echo "<p>Traza de error: <pre>" . $e->getTraceAsString() . "</pre></p>";
}

echo '</body></html>';
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\direct_access.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\direct_access.php

// Este archivo permite acceder directamente a la aplicación sin redirecciones
// Configuración básica sin redirecciones

// Definir constantes del sistema
define('BASE_PATH', __DIR__);
define('APP_PATH', BASE_PATH . '/app');
define('CONTROLLER_PATH', APP_PATH . '/controllers');
define('MODEL_PATH', APP_PATH . '/models');
define('VIEW_PATH', APP_PATH . '/views');
define('CONFIG_PATH', APP_PATH . '/config');

// Detectar entorno pero SIN redirecciones
$current_host = $_SERVER['HTTP_HOST'] ?? '';
$is_tunnel = strpos($current_host, 'localto.net') !== false;

// Forzar configuración sin importar el protocolo actual
$protocol = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https://' : 'http://';
define('APP_URL', $protocol . $current_host . '/encasa_database');

// Cargar configuración
require_once CONFIG_PATH . '/config.php';
require_once CONFIG_PATH . '/database.php';
require_once CONFIG_PATH . '/autoload.php';

// Iniciar sesión con configuración básica
ini_set('session.cookie_httponly', 1);
session_start();

// Mostrar formulario de login directamente sin usar el sistema de rutas
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso Directo - Iglesia En Casa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h2 class="my-2">Acceso Directo - Iniciar Sesión</h2>
                    </div>
                    <div class="card-body">
                        <form action="<?= APP_URL ?>/direct_login.php" method="post" autocomplete="on">
                            <div class="mb-3">
                                <label for="email_or_username" class="form-label">Email o nombre de usuario</label>
                                <input type="text" class="form-control" id="email_or_username" name="email_or_username" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="password" class="form-label">Contraseña</label>
                                <input type="password" class="form-control" id="password" name="password" required>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">Iniciar Sesión</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\direct_login.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\direct_login.php

// Este archivo procesa el login directamente sin usar el sistema de rutas
// Configuración básica
define('BASE_PATH', __DIR__);
define('APP_PATH', BASE_PATH . '/app');
define('CONFIG_PATH', APP_PATH . '/config');
define('MODEL_PATH', APP_PATH . '/models');
define('VIEW_PATH', APP_PATH . '/views');

// Cargar solo lo necesario
require_once CONFIG_PATH . '/database.php';
require_once APP_PATH . '/models/User.php';

// Iniciar sesión 
session_start();

// Procesar el formulario
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $email_or_username = $_POST['email_or_username'] ?? '';
    $password = $_POST['password'] ?? '';
    
    // Validación básica
    if (empty($email_or_username) || empty($password)) {
        die("Por favor completa todos los campos");
    }
    
    try {
        // Conectar a la BD
        $db = new PDO(
            'mysql:host=' . DB_HOST . ';dbname=' . DB_NAME . ';charset=utf8',
            DB_USER,
            DB_PASS
        );
        $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        
        // Consulta para verificar credenciales
        $stmt = $db->prepare(
            "SELECT * FROM users WHERE (email = :credential OR username = :credential) LIMIT 1"
        );
        $stmt->execute(['credential' => $email_or_username]);
        $user = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if ($user && password_verify($password, $user['password'])) {
            // Login exitoso
            $_SESSION['user_id'] = $user['id'];
            $_SESSION['user_name'] = $user['username'];
            $_SESSION['user_role'] = $user['role'];
            
            // Redirigir a la página de inicio (sin sistema de rutas)
            header("Location: home_direct.php");
            exit;
        } else {
            die("Credenciales incorrectas. <a href='direct_access.php'>Volver a intentar</a>");
        }
        
    } catch (PDOException $e) {
        die("Error de base de datos: " . $e->getMessage());
    }
}

// Mostrar la vista de login directamente
echo "<!DOCTYPE html>
<html lang='es'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Iniciar Sesión - Acceso Directo</title>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css' rel='stylesheet'>
</head>
<body class='bg-light'>
    <div class='container py-5'>
        <div class='row justify-content-center'>
            <div class='col-md-6'>
                <div class='card shadow'>
                    <div class='card-header bg-primary text-white'>
                        <h2 class='my-2'>Iniciar Sesión (Acceso Directo)</h2>
                    </div>
                    <div class='card-body'>";

// Incluir el formulario de login
if (file_exists(VIEW_PATH . '/auth/login.php')) {
    include_once VIEW_PATH . '/auth/login.php';
} else {
    echo "<div class='alert alert-danger'>No se encontró el archivo de vista login.php</div>";
    echo "<p>Ruta buscada: " . VIEW_PATH . "/auth/login.php</p>";
}

echo "        </div>
                </div>
            </div>
        </div>
    </div>
    <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js'></script>
</body>
</html>";
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\direct_test.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\direct_test.php

// Script para probar la extracción directa de un miembro
require_once __DIR__ . '/app/config/config.php';
require_once __DIR__ . '/app/config/database.php';

echo "<h1>Prueba directa de acceso a la base de datos</h1>";

// ID a verificar
$id = isset($_GET['id']) ? (int)$_GET['id'] : 2;

echo "<p>Buscando miembro con ID: {$id}</p>";

try {
    // Conectar directamente a la BD
    $db = Database::getInstance()->getConnection();
    
    // Consulta SQL directa
    $sql = "SELECT * FROM InformacionGeneral WHERE id = ?";
    $stmt = $db->prepare($sql);
    $stmt->execute([$id]);
    $miembro = $stmt->fetch(\PDO::FETCH_ASSOC);
    
    if ($miembro) {
        echo "<h2>Datos básicos encontrados:</h2>";
        echo "<pre>";
        print_r($miembro);
        echo "</pre>";
        
        // Recuperar datos relacionados
        $tablas = ['Contacto', 'EstudiosTrabajo', 'Tallas', 'CarreraBiblica'];
        
        foreach ($tablas as $tabla) {
            $sql = "SELECT * FROM {$tabla} WHERE miembro_id = ?";
            $stmt = $db->prepare($sql);
            $stmt->execute([$id]);
            $datos = $stmt->fetch(\PDO::FETCH_ASSOC);
            
            echo "<h3>Datos de {$tabla}:</h3>";
            echo "<pre>";
            print_r($datos ?: "No hay datos");
            echo "</pre>";
        }
        
        // Link para ver la visualización normal
        echo "<p><a href='miembros/{$id}?force=true' target='_blank'>Ver perfil en sistema</a></p>";
    } else {
        echo "<p style='color:red'>No se encontró ningún miembro con ID {$id}</p>";
    }
} catch (Exception $e) {
    echo "<p style='color:red'>Error: " . $e->getMessage() . "</p>";
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\force_update.php
=============================================================

<?php

// Mostrar todos los errores
ini_set('display_errors', 1);
error_reporting(E_ALL);

// Incluir configuración
require_once __DIR__ . '/app/config/config.php';
require_once __DIR__ . '/app/config/database.php';

// Obtener parámetros
$id = isset($_GET['id']) ? (int)$_GET['id'] : 1;
$campo = $_GET['campo'] ?? 'nombres';
$valor = $_GET['valor'] ?? 'Nombre Actualizado';

echo "<h1>Actualización forzada para miembro ID: $id</h1>";

try {
    // Conexión directa a la base de datos
    $db = Database::getInstance()->getConnection();
    
    // Verificar si el miembro existe
    $stmt = $db->prepare("SELECT * FROM InformacionGeneral WHERE id = ?");
    $stmt->execute([$id]);
    $miembro = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if (!$miembro) {
        echo "<p style='color:red'>❌ No existe ningún miembro con ID $id</p>";
        echo "<p>Miembros disponibles:</p>";
        $stmt = $db->query("SELECT id, nombres, apellidos FROM InformacionGeneral");
        echo "<ul>";
        while ($row = $stmt->fetch()) {
            echo "<li><a href='?id={$row['id']}'>{$row['nombres']} {$row['apellidos']} (ID: {$row['id']})</a></li>";
        }
        echo "</ul>";
        exit;
    }
    
    echo "<p>Verificación directa de miembro ID: $id</p>";
    echo "<p style='color:green'>✅ El miembro SÍ existe en la base de datos</p>";
    
    echo "<pre>";
    print_r($miembro);
    echo "</pre>";
    
    // Realizar actualización directa
    echo "<h2>Actualizando campo '$campo' a '$valor'...</h2>";
    
    $sql = "UPDATE InformacionGeneral SET $campo = ? WHERE id = ?";
    $stmt = $db->prepare($sql);
    $result = $stmt->execute([$valor, $id]);
    
    if ($result) {
        echo "<p style='color:green'>✅ Actualización exitosa del campo '$campo' para miembro ID $id</p>";
        echo "<p><a href='miembros/$id'>Ver perfil del miembro</a></p>";
    } else {
        echo "<p style='color:red'>❌ Falló la actualización</p>";
    }
} catch (Exception $e) {
    echo "<p style='color:red'>Error: " . $e->getMessage() . "</p>";
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\home_direct.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\home_direct.php

// Configuración básica
define('BASE_PATH', __DIR__);
define('APP_PATH', BASE_PATH . '/app');

// Iniciar sesión
session_start();

// Verificar autenticación
if (!isset($_SESSION['user_id'])) {
    header("Location: direct_access.php");
    exit;
}

// Datos básicos del usuario actual
$username = htmlspecialchars($_SESSION['user_name']);
$role = htmlspecialchars($_SESSION['user_role']);
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página Principal - Iglesia En Casa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Iglesia En Casa</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <?= $username ?>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="logout_direct.php">Cerrar Sesión</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="jumbotron">
            <h1>Bienvenido, <?= $username ?></h1>
            <p>Has iniciado sesión correctamente en el modo de acceso directo.</p>
            <p>Tu rol es: <?= $role ?></p>
            
            <div class="alert alert-info mt-4">
                <p><strong>Nota:</strong> Estás usando una versión simplificada de la aplicación para evitar el problema de redirecciones infinitas.</p>
                <p>Cuando el problema se resuelva, podrás volver a usar la aplicación completa.</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\index.php
=============================================================

<?php
// Al inicio del archivo index.php
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// Captura todos los errores de PHP para asegurar respuestas JSON correctas
set_error_handler(function($errno, $errstr, $errfile, $errline) {
    // Si es una solicitud AJAX, devolver JSON
    if (isset($_SERVER['HTTP_X_REQUESTED_WITH']) && 
        strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) === 'xmlhttprequest') {
        header('Content-Type: application/json');
        echo json_encode([
            'success' => false,
            'message' => "Error PHP: $errstr en $errfile:$errline"
        ]);
        exit;
    }
    // De lo contrario, usar el manejador de errores predeterminado
    return false;
});

// Definir constantes del sistema
define('BASE_PATH', __DIR__);
define('APP_PATH', BASE_PATH . '/app');
define('CONTROLLER_PATH', APP_PATH . '/controllers');
define('MODEL_PATH', APP_PATH . '/models');
define('VIEW_PATH', APP_PATH . '/views');
define('CONFIG_PATH', APP_PATH . '/config');

// IMPORTANTE: Detectar ngrok ANTES de cargar config.php
$protocol = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https://' : 'http://';
$host = $_SERVER['HTTP_HOST'] ?? 'localhost';

// Detectar si estamos usando ngrok u otro túnel
$is_tunnel = strpos($host, 'ngrok-free.app') !== false || 
             strpos($host, 'ngrok.io') !== false ||
             strpos($host, 'localto.net') !== false || 
             strpos($host, 'loca.lt') !== false;

// Configurar APP_URL según el entorno
if ($is_tunnel) {
    define('APP_URL', $protocol . $host . '/ENCASA_DATABASE');
    define('APP_ENV', 'tunnel');
} else {
    define('APP_URL', 'http://localhost/ENCASA_DATABASE');
    define('APP_ENV', 'development');
}

// IMPORTANTE: Configurar sesiones ANTES de iniciarla
// Configuración de sesiones
ini_set('session.cookie_httponly', 1);
ini_set('session.use_only_cookies', 1);
ini_set('session.use_strict_mode', 1);
ini_set('session.cookie_samesite', 'Lax');

// NO forzar cookies seguras para ngrok - esto causa redirecciones infinitas
if (APP_ENV === 'production') {
    ini_set('session.cookie_secure', 1);
} else {
    ini_set('session.cookie_secure', 0);
}

// Ahora iniciar sesión DESPUÉS de configurarla
session_start();

// Cargar helpers antes de configuración
if (file_exists(APP_PATH . '/helpers/functions.php')) {
    require_once APP_PATH . '/helpers/functions.php';
}

// Cargar configuración
require_once CONFIG_PATH . '/config.php';
require_once CONFIG_PATH . '/database.php';
require_once CONFIG_PATH . '/autoload.php';
require_once CONFIG_PATH . '/mail_autoload.php';

// Manejador de excepciones no capturadas
set_exception_handler(function($exception) {
    // Si es una solicitud AJAX, devolver JSON
    if (isset($_SERVER['HTTP_X_REQUESTED_WITH']) && 
        strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) === 'xmlhttprequest') {
        header('Content-Type: application/json');
        echo json_encode([
            'success' => false,
            'message' => 'Error en el servidor: ' . $exception->getMessage()
        ]);
        exit;
    }
    // De lo contrario, mostrar página de error
    echo '<pre>';
    echo 'Error: ' . $exception->getMessage();
    echo '<br>En archivo: ' . $exception->getFile() . ' línea: ' . $exception->getLine();
    echo '</pre>';
    die();
});

// Cargar y ejecutar el router
$router = require_once CONFIG_PATH . '/routes.php';
try {
    $router->dispatch();
} catch (Exception $e) {
    echo '<pre>';
    echo 'Error: ' . $e->getMessage();
    echo '<br>En archivo: ' . $e->getFile() . ' línea: ' . $e->getLine();
    echo '<br>Stack trace:<br>';
    echo $e->getTraceAsString();
    echo '</pre>';
    die();
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\listar_miembros.php
=============================================================

<?php

// Mostrar todos los errores
ini_set('display_errors', 1);
error_reporting(E_ALL);

// Incluir archivos necesarios
require_once __DIR__ . '/app/config/config.php';
require_once __DIR__ . '/app/config/database.php';

// Estilos básicos
echo '<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miembros Disponibles</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1, h2 { color: #333; }
        table { border-collapse: collapse; width: 100%; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        .btn { display: inline-block; padding: 8px 15px; background: #0066cc; color: white; 
               text-decoration: none; border-radius: 4px; margin: 5px; }
    </style>
</head>
<body>';

echo '<h1>Miembros Disponibles en la Base de Datos</h1>';

try {
    // Obtener conexión a la BD
    $db = Database::getInstance()->getConnection();
    
    // Obtener todos los miembros
    $stmt = $db->query("SELECT id, nombres, apellidos, fecha_registro_sistema FROM informaciongeneral ORDER BY id");
    $miembros = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    if (count($miembros) === 0) {
        echo "<p class='error'>No hay miembros en la base de datos.</p>";
    } else {
        echo "<p>Se encontraron <strong>" . count($miembros) . "</strong> miembros.</p>";
        
        // Mostrar tabla de miembros
        echo "<table>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>Fecha Registro</th>
                    <th>Acciones</th>
                </tr>";
                
        foreach ($miembros as $miembro) {
            echo "<tr>
                    <td>{$miembro['id']}</td>
                    <td>" . (empty($miembro['nombres']) ? "<span class='warning'>Vacío</span>" : htmlspecialchars($miembro['nombres'])) . "</td>
                    <td>" . (empty($miembro['apellidos']) ? "<span class='warning'>Vacío</span>" : htmlspecialchars($miembro['apellidos'])) . "</td>
                    <td>{$miembro['fecha_registro_sistema']}</td>
                    <td>
                        <a href='debug_editar.php?id={$miembro['id']}' class='btn'>Diagnosticar</a>
                        <a href='".APP_URL."/miembros/editar/{$miembro['id']}' class='btn'>Editar</a>
                    </td>
                  </tr>";
        }
        
        echo "</table>";
    }
    
    echo "<h2>Solución del Problema</h2>";
    echo "<ol>
            <li><strong>Problema:</strong> Los IDs de miembros que se intentan editar no existen en la base de datos.</li>
            <li><strong>Causa:</strong> Se han eliminado miembros antiguos y creado nuevos, generando una discontinuidad en los IDs.</li>
            <li><strong>Solución:</strong> Usar los IDs correctos que realmente existen en la tabla (mostrados arriba).</li>
          </ol>";
    
    // Información sobre modificaciones necesarias en el código
    echo "<h2>Modificaciones Recomendadas</h2>";
    echo "<ul>
            <li>Actualizar enlaces en menús para usar IDs existentes</li>
            <li>Modificar el controlador MiembrosController para manejar mejor IDs inexistentes</li>
            <li>Implementar validación de IDs antes de intentar actualizar</li>
          </ul>";
    
} catch (Exception $e) {
    echo "<p class='error'>Error: " . $e->getMessage() . "</p>";
}

echo '</body></html>';


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\login_test.php
=============================================================

<?php

// Archivo para probar la seguridad del formulario de login
echo "<!DOCTYPE html>
<html>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <meta http-equiv='Content-Security-Policy' content='upgrade-insecure-requests'>
    <meta name='referrer' content='origin'>
    <title>Prueba de Login Seguro</title>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css' rel='stylesheet'>
</head>
<body>
    <div class='container mt-5'>
        <div class='row justify-content-center'>
            <div class='col-md-6'>
                <div class='card'>
                    <div class='card-header bg-primary text-white'>
                        <h3>Prueba de Login Seguro</h3>
                    </div>
                    <div class='card-body'>
                        <form action='auth/login' method='post' autocomplete='on'>
                            <input type='hidden' name='secure_form' value='1'>
                            
                            <div class='mb-3'>
                                <label for='email_or_username' class='form-label'>Email o nombre de usuario</label>
                                <input type='text' class='form-control' id='email_or_username' 
                                       name='email_or_username' autocomplete='username' required>
                            </div>
                            
                            <div class='mb-3'>
                                <label for='password' class='form-label'>Contraseña</label>
                                <input type='password' class='form-control' id='password' 
                                       name='password' autocomplete='current-password' required>
                            </div>
                            
                            <div class='d-grid'>
                                <button type='submit' class='btn btn-primary'>Iniciar Sesión</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>";
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\logout_direct.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\logout_direct.php

// Iniciar sesión
session_start();

// Destruir la sesión
$_SESSION = array();
session_destroy();

// Redirigir a la página de login directo
header("Location: direct_access.php");
exit;


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\miembro_proxy.php
=============================================================

<?php
// Habilitar visualización de errores temporalmente
ini_set('display_errors', 1);
error_reporting(E_ALL);

// Configurar cabecera JSON
header('Content-Type: application/json');

// Función básica para registrar cada paso
function debug_log($mensaje) {
    $logfile = __DIR__ . '/debug.log';
    $timestamp = date('Y-m-d H:i:s');
    file_put_contents($logfile, "[$timestamp] $mensaje\n", FILE_APPEND);
}

// Registrar inicio
debug_log("Inicio de la solicitud");

try {
    // Paso 1: Verificar configuración
    debug_log("Verificando archivo de configuración");
    $configFile = __DIR__ . '/app/config/database.php';
    if (!file_exists($configFile)) {
        debug_log("Archivo de configuración no encontrado");
        throw new Exception("Archivo de configuración no encontrado: $configFile");
    }
    
    // Paso 2: Cargar configuración
    debug_log("Cargando archivo de configuración");
    require_once $configFile;
    
    // Paso 3: Verificar clase Database
    debug_log("Verificando clase Database");
    if (!class_exists('Database')) {
        debug_log("La clase Database no existe");
        throw new Exception("La clase Database no está definida correctamente");
    }
    
    // Paso 4: Crear una conexión manual para probar
    debug_log("Intentando conexión manual PDO");
    try {
        $pdo = new PDO("mysql:host=localhost;dbname=IglesiaEnCasa;charset=utf8", "root", "");
        debug_log("Conexión manual PDO exitosa");
    } catch (PDOException $e) {
        debug_log("Error conexión manual PDO: " . $e->getMessage());
        throw new Exception("Error en conexión manual: " . $e->getMessage());
    }
    
    // Paso 5: Intentar usar la clase Database
    debug_log("Obteniendo conexión a través de Database::getInstance()");
    $db = \Database::getInstance()->getConnection();
    debug_log("Conexión exitosa a través de Database::getInstance()");
    
    // Si llegamos hasta aquí, la conexión funciona correctamente
    // Podemos proceder con una operación simple para verificar
    debug_log("Ejecutando consulta de prueba");
    $stmt = $db->query("SELECT COUNT(*) FROM InformacionGeneral");
    $count = $stmt->fetchColumn();
    debug_log("Registros en InformacionGeneral: $count");
    
    // Responder con éxito
    echo json_encode([
        'success' => true,
        'message' => 'Prueba de conexión exitosa',
        'count' => $count
    ]);
    
} catch (Exception $e) {
    // Registrar el error
    debug_log("ERROR: " . $e->getMessage());
    
    // Responder con error
    echo json_encode([
        'success' => false,
        'message' => 'Error: ' . $e->getMessage()
    ]);
}
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\ngrok_test.php
=============================================================

<?php
// NO incluir index.php completo

// Definir constantes básicas
define('BASE_PATH', __DIR__);
define('APP_PATH', BASE_PATH . '/app');

// Detectar entorno
$protocol = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https://' : 'http://';
$host = $_SERVER['HTTP_HOST'] ?? 'localhost';
$is_ngrok = strpos($host, 'ngrok-free.app') !== false || strpos($host, 'ngrok.io') !== false;

// Crear una versión simplificada de url() para pruebas
function test_url($path = '') {
    global $protocol, $host, $is_ngrok;
    
    if ($is_ngrok) {
        $baseUrl = $protocol . $host . '/ENCASA_DATABASE';
    } else {
        $baseUrl = 'http://localhost/ENCASA_DATABASE';
    }
    
    $baseUrl = rtrim($baseUrl, '/');
    $path = ltrim($path, '/');
    
    return $baseUrl . ($path ? '/' . $path : '');
}

echo "<!DOCTYPE html>
<html>
<head>
    <title>Prueba de ngrok</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .card { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Prueba de configuración de ngrok</h1>
    
    <div class='card'>
        <h2>Información básica</h2>
        <p><strong>Host:</strong> {$host}</p>
        <p><strong>Protocolo:</strong> {$protocol}</p>
        <p><strong>¿Es ngrok?:</strong> " . ($is_ngrok ? 'SÍ' : 'NO') . "</p>
        <p><strong>URL base generada:</strong> " . test_url() . "</p>
    </div>
    
    <div class='card'>
        <h2>Enlaces de prueba:</h2>
        <ul>
            <li><a href='" . test_url('login') . "'>Ir a login</a></li>
            <li><a href='" . test_url('miembros') . "'>Ir a miembros</a></li>
        </ul>
    </div>
</body>
</html>";
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\project_status.php
=============================================================

<?php

/**
 * Dashboard de Estado del Proyecto ENCASA_DATABASE
 * Muestra el progreso de la implementación
 */

// Configuración de etapas y fases
$stages = [
    1 => [
        'name' => 'Configuración del Entorno y Base de Datos',
        'progress' => 100,
        'status' => 'completed',
        'start_date' => '2025-05-10',
        'end_date' => '2025-05-12',
        'phases' => [
            [
                'name' => 'Entorno de desarrollo',
                'progress' => 100,
                'status' => 'completed',
                'tasks' => [
                    ['name' => 'Configurar XAMPP y PHP', 'status' => 'completed'],
                    ['name' => 'Crear estructura de directorios', 'status' => 'completed'],
                    ['name' => 'Configurar permisos', 'status' => 'completed'],
                ]
            ],
            [
                'name' => 'Base de datos',
                'progress' => 100,
                'status' => 'completed',
                'tasks' => [
                    ['name' => 'Diseño de esquema de base de datos', 'status' => 'completed'],
                    ['name' => 'Configuración de conexión', 'status' => 'completed'],
                    ['name' => 'Implementar migraciones iniciales', 'status' => 'completed'],
                ]
            ]
        ]
    ],
    2 => [
        'name' => 'Núcleo MVC y Enrutamiento',
        'progress' => 100,
        'status' => 'completed',
        'start_date' => '2025-05-13',
        'end_date' => '2025-05-16',
        'phases' => [
            [
                'name' => 'Estructura MVC',
                'progress' => 100,
                'status' => 'completed',
                'tasks' => [
                    ['name' => 'Implementar clases base modelo', 'status' => 'completed'],
                    ['name' => 'Configurar controladores', 'status' => 'completed'],
                    ['name' => 'Establecer sistema de vistas', 'status' => 'completed'],
                ]
            ],
            [
                'name' => 'Sistema de Rutas',
                'progress' => 100,
                'status' => 'completed',
                'tasks' => [
                    ['name' => 'Crear router principal', 'status' => 'completed'],
                    ['name' => 'Configurar manejo de parámetros', 'status' => 'completed'],
                    ['name' => 'Implementar middlewares', 'status' => 'completed'],
                ]
            ]
        ]
    ],
    3 => [
        'name' => 'Sistema de Autenticación y Autorización',
        'progress' => 100,
        'status' => 'completed',
        'start_date' => '2025-05-17',
        'end_date' => '2025-05-28',
        'phases' => [
            [
                'name' => 'Autenticación Base',
                'progress' => 100,
                'status' => 'completed',
                'tasks' => [
                    ['name' => 'Implementar clase Auth con métodos base', 'status' => 'completed'],
                    ['name' => 'Implementar sistema de sesiones seguras', 'status' => 'completed'],
                    ['name' => 'Crear vistas login/registro', 'status' => 'completed'],
                ]
            ],
            [
                'name' => 'Verificación en Dos Pasos',
                'progress' => 100,
                'status' => 'completed',
                'tasks' => [
                    ['name' => 'Implementar verificación para registro', 'status' => 'completed'],
                    ['name' => 'Desarrollar verificación para login', 'status' => 'completed'],
                    ['name' => 'Integrar sistema de JWT', 'status' => 'completed'],
                ]
            ],
            [
                'name' => 'Sistema de Roles y Permisos',
                'progress' => 100,
                'status' => 'completed',
                'tasks' => [
                    ['name' => 'Crear sistema de roles y permisos', 'status' => 'completed'],
                    ['name' => 'Implementar middlewares de autorización', 'status' => 'completed'],
                    ['name' => 'Solucionar problemas de seguridad en formularios', 'status' => 'completed'],
                ]
            ]
        ]
    ],
    4 => [
        'name' => 'Modelos Base y CRUD de Miembros',
        'progress' => 75, // Aumentado de 60 a 75
        'status' => 'in-progress',
        'start_date' => '2025-05-22',
        'end_date' => '2025-05-31',
        'phases' => [
            [
                'name' => 'Modelos y Relaciones',
                'progress' => 100,
                'status' => 'completed',
                'tasks' => [
                    ['name' => 'Crear Modelo abstracto base', 'status' => 'completed'],
                    ['name' => 'Implementar modelo Miembro con relaciones', 'status' => 'completed'],
                    ['name' => 'Implementar modelos relacionados', 'status' => 'completed'],
                ]
            ],
            [
                'name' => 'Controladores CRUD',
                'progress' => 80, // Aumentado de 65 a 80
                'status' => 'in-progress',
                'tasks' => [
                    ['name' => 'Implementar visualización de perfil de miembro', 'status' => 'completed'],
                    ['name' => 'Implementar creación/edición de miembros', 'status' => 'in-progress'],
                    ['name' => 'Implementar listado y filtrado de miembros', 'status' => 'in-progress'],
                    ['name' => 'Sistema dinámico de datos educativos por país', 'status' => 'completed'], // Nueva tarea completada
                ]
            ],
            [
                'name' => 'Vistas y Formularios',
                'progress' => 60, // Aumentado de 40 a 60
                'status' => 'in-progress',
                'tasks' => [
                    ['name' => 'Implementar vistas para gestión de miembros', 'status' => 'in-progress'],
                    ['name' => 'Crear formularios de edición', 'status' => 'in-progress'],
                    ['name' => 'Formulario dinámico de datos educativos', 'status' => 'completed'], // Nueva tarea completada
                    ['name' => 'Implementar procesamiento de imágenes/fotos', 'status' => 'pending'],
                ]
            ]
        ]
    ],
    5 => [
        'name' => 'Ministerios, Roles y Tareas',
        'progress' => 0,
        'status' => 'pending',
        'start_date' => '2025-06-01',
        'end_date' => '2025-06-07',
        'phases' => [
            [
                'name' => 'Modelos y Relaciones',
                'progress' => 0,
                'status' => 'pending',
                'tasks' => [
                    ['name' => 'Implementar modelo Ministerio', 'status' => 'pending'],
                    ['name' => 'Implementar modelo Rol', 'status' => 'pending'],
                    ['name' => 'Implementar modelo Tarea', 'status' => 'pending'],
                ]
            ],
            [
                'name' => 'Controladores y Lógica',
                'progress' => 0,
                'status' => 'pending',
                'tasks' => [
                    ['name' => 'Desarrollar controlador de Ministerios', 'status' => 'pending'],
                    ['name' => 'Desarrollar controlador de Roles', 'status' => 'pending'],
                    ['name' => 'Implementar asignación de roles', 'status' => 'pending'],
                ]
            ]
        ]
    ],
    6 => [
        'name' => 'Vistas y UI/UX',
        'progress' => 35,
        'status' => 'in-progress',
        'start_date' => '2025-05-24',
        'end_date' => '2025-06-01',
        'phases' => [
            [
                'name' => 'Plantillas Base',
                'progress' => 100,
                'status' => 'completed',
                'tasks' => [
                    ['name' => 'Crear layouts principal y de autenticación', 'status' => 'completed'],
                    ['name' => 'Mejorar interfaz de formularios de autenticación', 'status' => 'completed'],
                ]
            ],
            [
                'name' => 'Mejoras de Interfaz',
                'progress' => 15,
                'status' => 'in-progress',
                'tasks' => [
                    ['name' => 'Implementación de Tailwind CSS', 'status' => 'in-progress'],
                    ['name' => 'Implementar vistas de miembros', 'status' => 'in-progress'],
                    ['name' => 'Crear vistas de ministerios y tareas', 'status' => 'pending'],
                ]
            ]
        ]
    ],
    7 => [
        'name' => 'Integración, Pruebas y Optimización',
        'progress' => 40,
        'status' => 'in-progress',
        'start_date' => '2025-05-24',
        'end_date' => '2025-06-03',
        'phases' => [
            [
                'name' => 'URLs y Entornos',
                'progress' => 100,
                'status' => 'completed',
                'tasks' => [
                    ['name' => 'Solucionar problemas de URLs con ngrok y túneles', 'status' => 'completed'],
                    ['name' => 'Implementar detección de entorno', 'status' => 'completed'],
                    ['name' => 'Configurar generación segura de URLs', 'status' => 'completed'],
                ]
            ],
            [
                'name' => 'Monitoreo y Optimización',
                'progress' => 30,
                'status' => 'in-progress',
                'tasks' => [
                    ['name' => 'Sistema de logs para monitoreo', 'status' => 'in-progress'],
                    ['name' => 'Optimizar consultas SQL', 'status' => 'in-progress'],
                    ['name' => 'Implementar caché donde sea necesario', 'status' => 'pending'],
                ]
            ],
            [
                'name' => 'Seguridad',
                'progress' => 40,
                'status' => 'in-progress',
                'tasks' => [
                    ['name' => 'Revisar y mejorar seguridad', 'status' => 'in-progress'],
                    ['name' => 'Implementar validaciones del lado del cliente', 'status' => 'pending'],
                ]
            ]
        ]
    ],
    8 => [
        'name' => 'Despliegue y Documentación',
        'progress' => 5,
        'status' => 'pending',
        'start_date' => '2025-05-30',
        'end_date' => '2025-06-05',
        'phases' => [
            [
                'name' => 'Documentación',
                'progress' => 10,
                'status' => 'in-progress',
                'tasks' => [
                    ['name' => 'Crear manual de usuario', 'status' => 'pending'],
                    ['name' => 'Documentar API y endpoints', 'status' => 'pending'],
                    ['name' => 'Crear documentación técnica', 'status' => 'in-progress'],
                ]
            ],
            [
                'name' => 'Despliegue',
                'progress' => 0,
                'status' => 'pending',
                'tasks' => [
                    ['name' => 'Configurar servidor de producción', 'status' => 'pending'],
                    ['name' => 'Automatizar proceso de despliegue', 'status' => 'pending'],
                    ['name' => 'Configurar backups y alta disponibilidad', 'status' => 'pending'],
                ]
            ]
        ]
    ],
];

// Calcular progreso general
$totalStages = count($stages);
$completedProgress = 0;

foreach ($stages as $key => $stage) {
    $completedProgress += $stage['progress'];
}

$overallProgress = $totalStages > 0 ? round($completedProgress / $totalStages) : 0;

// Calcular siguiente tarea pendiente
$nextTask = null;
foreach ($stages as $stageKey => $stage) {
    if ($stage['status'] !== 'completed') {
        foreach ($stage['phases'] as $phaseKey => $phase) {
            if ($phase['status'] !== 'completed') {
                foreach ($phase['tasks'] as $taskKey => $task) {
                    if ($task['status'] === 'pending') {
                        $nextTask = [
                            'stage' => $stageKey,
                            'phase' => $phaseKey,
                            'name' => $task['name'],
                            'stage_name' => $stage['name'],
                            'phase_name' => $phase['name']
                        ];
                        break 3;
                    }
                }
            }
        }
    }
}

function getStatusClass($status) {
    switch($status) {
        case 'completed': return 'bg-success text-white';
        case 'in-progress': return 'bg-primary text-white';
        case 'pending': return 'bg-neutral-200 text-neutral-700';
        default: return 'bg-neutral-200 text-neutral-700';
    }
}

function getStatusIcon($status) {
    switch($status) {
        case 'completed': return '✓';
        case 'in-progress': return '→';
        case 'pending': return '○';
        default: return '○';
    }
}

?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estado del Proyecto - Iglesia En Casa</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF5C28;
            --primary-light: #FF8A5C;
            --primary-dark: #E04B1F;
            --neutral-900: #121212;
            --neutral-800: #333333;
            --neutral-700: #555555;
            --neutral-500: #888888;
            --neutral-300: #CCCCCC;
            --neutral-200: #E5E5E5;
            --neutral-100: #F5F5F5;
            --neutral-50: #FAFAFA;
            --white: #FFFFFF;
            --success: #34D399;
            --error: #F87171;
            --warning: #FBBF24;
            --info: #60A5FA;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--neutral-50);
            color: var(--neutral-800);
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        
        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo {
            max-width: 150px;
            height: auto;
        }
        
        .logo-tagline {
            font-size: 0.75rem;
            color: var(--neutral-700);
            margin-top: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .progress-bar-container {
            height: 8px;
            background-color: var(--neutral-200);
            border-radius: 4px;
            margin: 1.5rem 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .stage {
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .stage-header {
            padding: 1rem 1.5rem;
            background-color: var(--neutral-100);
            border-bottom: 1px solid var(--neutral-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .stage-title {
            font-size: 1.25rem;
            display: flex;
            align-items: center;
        }
        
        .stage-title .status-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 0.75rem;
            font-weight: bold;
        }
        
        .stage-content {
            padding: 1.5rem;
        }
        
        .phase {
            margin-bottom: 1.5rem;
            background: var(--neutral-50);
            border-radius: 6px;
            padding: 1rem;
            border-left: 3px solid var(--neutral-300);
        }
        
        .phase.completed {
            border-left-color: var(--success);
        }
        
        .phase.in-progress {
            border-left-color: var(--primary);
        }
        
        .phase-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .phase-title {
            font-size: 1.1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        
        .phase-title .status-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 0.5rem;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .tasks {
            list-style: none;
        }
        
        .task {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .task-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            margin-right: 0.5rem;
            font-size: 0.7rem;
        }
        
        .next-task {
            background: var(--primary-light);
            color: var(--white);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 2rem 0;
        }
        
        .next-task h3 {
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
        }
        
        .next-task p {
            margin-bottom: 0.25rem;
            opacity: 0.9;
        }
        
        .highlight-box {
            background: var(--info);
            color: var(--white);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0 2rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header > div:last-child {
                margin-top: 1rem;
            }
            
            .stage-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .stage-header .stage-dates {
                margin-top: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-container">
             <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJYAAABUCAYAAABxuNIZAAAACXBIWXMAAAsTAAALEwEAmpwYAAAF4klEQVR4nO2dXWwUVRTH/zO7s9vdttRStlRb2u4WpLalFhVBiIkGEmMwwQfig/FBEwk+mKgvJj74pCY+GCNGX3zwK8GgMcYIGIMxKolEY0m0YOnHthS7pV3abXe3u7MzxzuDeLed3Xtnzp3ZnfklTdqd2Zk7c/656z1nzj0jpJQQBOt4mQ0Q8hMRS8gEIpaQCUQsIROIWEImELGETCBiCZlAxBIyQbdTAaHDgMrpd6D7AkhmP3s2fEPE6sW5R5eivW01pEOE8vt9ntBpWh2xotfX+uJCK9C2YPQYekrTcPLOTUiZXwDs+M67sOSTExn4/T4OQtyNlJKCd8TyCR9GfH5UGn6M+QIIfUm5Oo7EzQwlVt9YE14srUN99TRcqLWiODrsjFx5iCViIfQI8Iw2YSjUhAGjEa+WL0dZETDQC1ypB2aK86/xlErrUI2w2QhjuBmTfWE0lIYREgKB3sy27SQiinUjGECg9zqCNVcxNBlAIRDQ5zDSG8ToVB1C3ig2ebx0ibYzWsAWaxB6VxyiiuEDSJbq8KKaGahNUs7KBdlnkYZulKA8MYm+t4ZocAZ3jjRlvLxckdNiab4gon211NvUoaqCZjKhLOHUJ1PgF6qdLsSfmEJ1XQyTZrNp6pknclasCq0YZ4vCuHJiMeKRM1ROfYDK2Z42YdLK73zQa6owuKIae4cWIl41DnlDrJ5iA1+E6jGxtxlxkmoeoXgV6hPjNE7bg6MJDxe5JVa0qQaDG15DfRAF+5xZYdDrUYaPDt9Ppw8lPJzk1ldpRtDJVFAwSODBQ6E3x2xlVCznAHqm6pGgJOe25e7ZBoaaxetuSdgcJhuZELh+K1cDMwbkTI+VRC+OIDgTR4JpDyuWRJ16JMft2jtoBkJ5Ehbsw3WxBBZBGpmOgKTKAax2SuQeiefwudGNJDplOcYQqP5iFpx9sWgUotHyYt6wGJQ4uG5NLRJpvZbPm1uusHKho/mA/PQN+WgjFg3AeDIo7jYqln2nSQn0K8v0MFHtJKRxOiSSFUzZy3HdntU4T0V+go7r6aWcXFdQFVS2oDn3CZSM/Q7FWmE7wi1WiTYDrfwSKs1JGFYboyyxKJvdBlXLUWZzcNumcSOFcMOvMGl6AxULC4KetMQKFE1i5OMmxG85YOicnZ6VNulZf9O0QKfd56WsslIg8ey5O32NJh9g2pNexNO8FQt6HHuGw4if6Idhzn2tbAn7VPvblz4ncTkzQ45mbG+cn7ItVszjw6RvDYYXNKKiz4ukJBcS8hK3xDKEgLcujBN7FuHeVgjfVXofk/OGXI7uFla+XY0LTzfjh9fWIXH+HARJlbe4JZYSRze8GPxwNw58/gG+3/E2Lv5+ErVH9qO0f5BOC28IISvclSpXxvrymmqMNbdgeL8PK296UEGPOebVGUbMOUdOT4nQ9SLMrKrEpZpaXHqzFY37LsBcfIwLZbk85QshYypWP96CaNUsxuoS6KmKojptqawXaxd8i+ajnVh9aINCh2qjibvkRjUiyw0kHz+EukOfo+bAd6g9tA/HHnkNXfVLGRt3H7a8+ap74PW1ft+3n3bsPHFk/2vRVAASnTT/Kk86352JjD307J4tq5o+tfLcQvpwTSyr22690O7ETCs7W1MzmrHk5YWz1b9t+xLdK1c4OvnNSSxruy4XL0KWsL7rclPXP9974cU9L2PwkWfyPnrJsrl3zSTGv/kQC+/5E/Gl6zCy9DXbRrT0/NYG3utjuQFXrr0r+f2Lo6tWONZmuT62XNe92UUjGuq/GtsA39Mt8CVo72wx9m3FRVOlzGmpMHehLTw34C4l2LmFQZcwFjzwxwftCQtjUElpj64tXtm5w47YiondsLHjmCO7LiUkrVrRUYt8QdWIjRPOGqPz4+7S+sU7JpwZ2wn9S+BGTF34g7r6JSmqiIe60qP2WgZBEIQCgP1Pi4JgGZl6RL7eRL3UCRv/DwlO8A9TD/qeO/oc0wAAAABJRU5ErkJggg==" alt="Iglesia En Casa" class="logo">
            <span class="logo-tagline">donde dios es todo</span>
            </div>
            <div>
                            <h1>Estado del Proyecto</h1>
                            <p>Sistema de Gestión de Base de Datos</p>
                        </div>
                    </header>
            
                    <!-- Progreso general -->
                    <div>
                        <div class="d-flex justify-content-between align-items-center">
                            <h2>Progreso General: <?= $overallProgress ?>%</h2>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: <?= $overallProgress ?>%"></div>
                        </div>
                    </div>
            
                    <!-- Próxima tarea -->
                    <?php if ($nextTask): ?>
                    <div class="next-task">
                        <h3>Próxima tarea pendiente</h3>
                        <p><strong>Etapa <?= $nextTask['stage'] ?>:</strong> <?= $nextTask['stage_name'] ?></p>
                        <p><strong>Fase:</strong> <?= $nextTask['phase_name'] ?></p>
                        <p><strong>Tarea:</strong> <?= $nextTask['name'] ?></p>
                    </div>
                    <?php endif; ?>
            
                    <!-- Logros destacados -->
                    <div class="highlight-box">
                        <h3>Logros destacados (02/06/2025)</h3>
                        <ul style="margin-top: 10px; opacity: 0.9; padding-left: 20px;">
                            <li>✅ Implementado sistema dinámico de datos educativos por país</li>
                            <li>✅ Creadas tablas para instituciones educativas y profesiones</li>
                            <li>✅ Formularios interactivos para selección de instituciones y carreras</li>
                            <li>✅ API para gestión de datos educativos implementada</li>
                            <li>✅ Solución implementada para problemas con ngrok y túneles</li>
                        </ul>
                    </div>
            
                    <!-- Etapas -->
                    <?php foreach ($stages as $stageKey => $stage): ?>
                    <div class="stage">
                        <div class="stage-header">
                            <div class="stage-title">
                                <span class="status-icon <?= getStatusClass($stage['status']) ?>"><?= getStatusIcon($stage['status']) ?></span>
                                <span>Etapa <?= $stageKey ?>: <?= $stage['name'] ?></span>
                            </div>
                            <div class="stage-dates">
                                <?= $stage['start_date'] ?> - <?= $stage['status'] === 'completed' ? $stage['end_date'] : ('Estimado: ' . $stage['end_date']) ?>
                                <span class="ms-2"><?= $stage['progress'] ?>%</span>
                            </div>
                        </div>
                        <div class="stage-content">
                            <!-- Fases -->
                            <?php foreach ($stage['phases'] as $phaseKey => $phase): ?>
                            <div class="phase <?= $phase['status'] ?>">
                                <div class="phase-header">
                                    <div class="phase-title">
                                        <span class="status-icon <?= getStatusClass($phase['status']) ?>"><?= getStatusIcon($phase['status']) ?></span>
                                        <?= $phase['name'] ?>
                                    </div>
                                    <div><?= $phase['progress'] ?>%</div>
                                </div>
                                <!-- Tareas -->
                                <ul class="tasks">
                                    <?php foreach ($phase['tasks'] as $taskKey => $task): ?>
                                    <li class="task">
                                        <span class="task-status <?= getStatusClass($task['status']) ?>"><?= getStatusIcon($task['status']) ?></span>
                                        <?= $task['name'] ?>
                                    </li>
                                    <?php endforeach; ?>
                                </ul>
                            </div>
                            <?php endforeach; ?>
                        </div>
                    </div>
                    <?php endforeach; ?>
            
                    <!-- Footer -->
                    <footer style="margin-top: 3rem; text-align: center; color: var(--neutral-700); font-size: 0.85rem;">
                        <p>ENCASA_DATABASE v1.0 &copy; <?= date('Y') ?> Iglesia En Casa</p>
                        <p>Última actualización: <?= date('d/m/Y') ?></p>
                    </footer>
                </div>
            </body>
            </html>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\proxy.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\proxy.php

// Configuración básica y manejo de errores
ini_set('display_errors', 1);
error_reporting(E_ALL);

// Orígenes permitidos
$allowed_origins = [
    'http://localhost',
    'https://localhost',
    'https://uvca8jwlr.localto.net',
    'http://uvca8jwlr.localto.net',
    'http://127.0.0.1'
];

// Capturar el origen de la solicitud
$origin = isset($_SERVER['HTTP_ORIGIN']) ? $_SERVER['HTTP_ORIGIN'] : '';

// Configurar cabeceras CORS
if (in_array($origin, $allowed_origins)) {
    header("Access-Control-Allow-Origin: $origin");
} else {
    header("Access-Control-Allow-Origin: *");
}

header("Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With");
header("Access-Control-Allow-Credentials: true");

// Si es una solicitud OPTIONS (preflight), responder inmediatamente
if ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {
    header("HTTP/1.1 200 OK");
    exit;
}

// Construir la URL de destino
// Esta será la URL interna donde se encuentra realmente tu aplicación
$target_base = 'http://localhost/ENCASA_DATABASE';
$request_uri = $_SERVER['REQUEST_URI'];

// Eliminar la parte del proxy de la URI si existe
$request_path = str_replace('/proxy.php', '', $request_uri);

// URL final a la que se enviará la solicitud
$target_url = $target_base . $request_path;

// Crear contexto para la solicitud con todos los parámetros y headers originales
$context_options = [
    'http' => [
        'method' => $_SERVER['REQUEST_METHOD']
    ]
];

// Transferir headers de la solicitud original
$headers = [];
foreach (getallheaders() as $name => $value) {
    // No transferir headers relacionados con CORS o host
    if (!in_array(strtolower($name), ['host', 'origin', 'referer'])) {
        $headers[] = "$name: $value";
    }
}

// Si hay headers, añadirlos al contexto
if (!empty($headers)) {
    $context_options['http']['header'] = implode("\r\n", $headers);
}

// Para solicitudes POST/PUT, transferir el cuerpo de la solicitud
$input = file_get_contents('php://input');
if (!empty($input)) {
    $context_options['http']['content'] = $input;
}

// Crear el contexto de flujo
$context = stream_context_create($context_options);

// Enviar la solicitud al servidor interno y capturar la respuesta
try {
    $response = file_get_contents($target_url, false, $context);
    
    // Transferir todos los headers de respuesta
    foreach ($http_response_header as $header) {
        // No transferir headers relacionados con CORS
        if (!strpos(strtolower($header), 'access-control')) {
            header($header);
        }
    }
    
    // Devolver el contenido de la respuesta
    echo $response;
} catch (Exception $e) {
    // En caso de error
    header("HTTP/1.1 500 Internal Server Error");
    echo json_encode([
        'error' => true,
        'message' => 'Proxy error: ' . $e->getMessage(),
        'target_url' => $target_url
    ]);
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\redirect_debug.php
=============================================================

<?php

session_start();
echo "<h1>Diagnóstico de redirecciones</h1>";

echo "<h2>Headers de respuesta:</h2>";
echo "<pre>";
var_dump(headers_list());
echo "</pre>";

echo "<h2>Variables de sesión:</h2>";
echo "<pre>";
var_dump($_SESSION);
echo "</pre>";

echo "<h2>Cookies:</h2>";
echo "<pre>";
var_dump($_COOKIE);
echo "</pre>";

echo "<h2>Variables de servidor:</h2>";
echo "<pre>";
$serverVars = [
    'HTTP_HOST', 'HTTPS', 'REQUEST_URI', 'SCRIPT_NAME'
];
foreach ($serverVars as $var) {
    echo "$var: " . ($_SERVER[$var] ?? 'No definido') . "\n";
}
echo "</pre>";
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\reset_password.php
=============================================================

<?php

require_once __DIR__ . '/app/config/config.php';
require_once __DIR__ . '/app/config/database.php';

// Interfaz de usuario simple
if (!isset($_GET['key']) || !isset($_GET['username'])) {
    echo '
    <form method="get">
        <h2>Restablecer contraseña</h2>
        <input type="hidden" name="key" value="admin_reset_2025">
        <p>Usuario: <input type="text" name="username" value="hernando"></p>
        <button type="submit">Restablecer</button>
    </form>';
    exit;
}

// Verificar clave
if ($_GET['key'] !== 'admin_reset_2025') {
    die("Acceso no autorizado");
}

$username = $_GET['username'] ?? 'hernando'; // Usuario a resetear
$newPassword = '12345!';  // Nueva contraseña

// Crear hash compatible
$hash = password_hash($newPassword, PASSWORD_DEFAULT);

// Actualizar en la base de datos - CORREGIDO SIN NAMESPACE
try {
    // Obtener la conexión sin usar namespace (ajustado al patrón de tu proyecto)
    $db = Database::getInstance()->getConnection();
    $stmt = $db->prepare("UPDATE usuarios SET password = ? WHERE username = ?");
    $result = $stmt->execute([$hash, $username]);
    
    echo $result ? 
        "<h3>Contraseña actualizada correctamente para $username.</h3><p>La nueva contraseña es: <strong>$newPassword</strong></p>" : 
        "<h3>Error al actualizar la contraseña</h3>";
        
} catch (Exception $e) {
    echo "<h3>Error:</h3><p>" . $e->getMessage() . "</p>";
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\rewrite_test.php
=============================================================

<?php

echo "<h1>Prueba de mod_rewrite</h1>";

if (function_exists('apache_get_modules')) {
    $modules = apache_get_modules();
    echo "<p>mod_rewrite está " . (in_array('mod_rewrite', $modules) ? "habilitado" : "deshabilitado") . "</p>";
} else {
    echo "<p>No se puede determinar si mod_rewrite está habilitado en este servidor.</p>";
}

echo "<p>Verificación de .htaccess: ";
$htaccess_path = __DIR__ . '/.htaccess';
if (file_exists($htaccess_path)) {
    echo "El archivo .htaccess existe ✓</p>";
    echo "<pre>" . htmlspecialchars(file_get_contents($htaccess_path)) . "</pre>";
} else {
    echo "El archivo .htaccess NO existe ✗</p>";
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\route.debug.php
=============================================================

<?php


echo "<h1>Diagnóstico de rutas</h1>";

// Analizar URL actual
$requestUri = $_SERVER['REQUEST_URI'] ?? 'No disponible';
$scriptName = $_SERVER['SCRIPT_NAME'] ?? 'No disponible';
$base = str_replace('/index.php', '', $scriptName);
$url = str_replace($base, '', $requestUri);
$url = ltrim($url, '/');
$url = explode('?', $url)[0];

echo "<h2>Información de la URL actual:</h2>";
echo "<ul>";
echo "<li><strong>REQUEST_URI:</strong> " . htmlspecialchars($requestUri) . "</li>";
echo "<li><strong>SCRIPT_NAME:</strong> " . htmlspecialchars($scriptName) . "</li>";
echo "<li><strong>Base detectada:</strong> " . htmlspecialchars($base) . "</li>";
echo "<li><strong>URL procesada:</strong> " . htmlspecialchars($url) . "</li>";
echo "</ul>";

// Verificar carga de archivos críticos
echo "<h2>Verificación de archivos críticos:</h2>";
echo "<ul>";
$filesRequired = [
    'index.php' => __DIR__ . '/index.php',
    'config.php' => __DIR__ . '/app/config/config.php',
    'routes.php' => __DIR__ . '/app/config/routes.php',
    'functions.php' => __DIR__ . '/app/helpers/functions.php',
    'Router.php' => __DIR__ . '/app/helpers/Router.php',
    '.htaccess' => __DIR__ . '/.htaccess',
];

foreach ($filesRequired as $name => $path) {
    echo "<li>";
    if (file_exists($path)) {
        echo "✅ <strong>$name:</strong> Existe";
    } else {
        echo "❌ <strong>$name:</strong> NO existe";
    }
    echo "</li>";
}
echo "</ul>";
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\test.php
=============================================================

<?php

echo "<h1>Prueba de ngrok</h1>";
echo "<p>Si puedes ver esta página, ngrok está funcionando correctamente con tu proyecto.</p>";
echo "<p>Fecha y hora actual: " . date('Y-m-d H:i:s') . "</p>";
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\test_db.php
=============================================================

<?php

// Configuración básica
ini_set('display_errors', 1);
error_reporting(E_ALL);

echo "<h1>Prueba de conexión a la base de datos</h1>";

// 1. Verificar conexión PDO directa
try {
    echo "<h2>Prueba 1: Conexión PDO directa</h2>";
    $pdo = new PDO("mysql:host=localhost;dbname=IglesiaEnCasa;charset=utf8", "root", "");
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    echo "<p style='color:green'>✅ Conexión PDO directa exitosa</p>";
    
    // Verificar tablas
    $tablas = ['InformacionGeneral', 'Contacto', 'EstudiosTrabajo', 'Tallas', 'SaludEmergencias', 'CarreraBiblica'];
    echo "<h3>Verificación de tablas:</h3><ul>";
    
    foreach ($tablas as $tabla) {
        $stmt = $pdo->query("SHOW TABLES LIKE '$tabla'");
        if ($stmt->rowCount() > 0) {
            echo "<li>✅ $tabla: <span style='color:green'>Existe</span></li>";
        } else {
            echo "<li>❌ $tabla: <span style='color:red'>No existe</span></li>";
        }
    }
    echo "</ul>";
    
} catch (PDOException $e) {
    echo "<p style='color:red'>❌ Error en conexión PDO directa: " . $e->getMessage() . "</p>";
}

// 2. Verificar clase Database
try {
    echo "<h2>Prueba 2: Clase Database</h2>";
    
    // Incluir archivo
    $configFile = __DIR__ . '/app/config/database.php';
    if (file_exists($configFile)) {
        require_once $configFile;
        echo "<p>✅ Archivo de configuración encontrado</p>";
        
        if (class_exists('Database')) {
            echo "<p>✅ Clase Database definida</p>";
            
            $db = \Database::getInstance()->getConnection();
            echo "<p style='color:green'>✅ Conexión a través de Database::getInstance() exitosa</p>";
        } else {
            echo "<p style='color:red'>❌ Clase Database NO definida</p>";
        }
    } else {
        echo "<p style='color:red'>❌ Archivo de configuración NO encontrado</p>";
    }
} catch (Exception $e) {
    echo "<p style='color:red'>❌ Error en clase Database: " . $e->getMessage() . "</p>";
}
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\test_logs.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\test_logs.php

// Script para probar la configuración de logs
echo "<h1>Diagnóstico de logs de PHP</h1>";

// Mostrar configuración actual de error_log
echo "<h2>Configuración de logs</h2>";
echo "<p>error_log configurado en: " . ini_get('error_log') . "</p>";
echo "<p>error_reporting: " . ini_get('error_reporting') . "</p>";
echo "<p>display_errors: " . ini_get('display_errors') . "</p>";
echo "<p>log_errors: " . ini_get('log_errors') . "</p>";

// Intentar crear un directorio de logs si no existe
$logDir = "C:/xampp/php/logs";
if (!file_exists($logDir)) {
    echo "<p>Directorio de logs no existe. Intentando crear...</p>";
    mkdir($logDir, 0777, true);
    echo "<p>Directorio creado: " . (file_exists($logDir) ? "SÍ" : "NO") . "</p>";
}

// Escribir en el log para probarlo
error_log("Prueba de escritura en log desde test_logs.php");
echo "<p>Se ha intentado escribir en el log. Verifica si el archivo se ha creado.</p>";

// Intentar con una ruta alternativa
$altLogPath = __DIR__ . '/debug.log';
error_log("Prueba de escritura en log alternativo", 3, $altLogPath);
echo "<p>Log alternativo creado en: {$altLogPath}</p>";

// Mostrar los archivos en el directorio de logs
echo "<h2>Archivos en el directorio de logs</h2>";
echo "<pre>";
if (file_exists($logDir)) {
    print_r(scandir($logDir));
} else {
    echo "El directorio de logs no existe.";
}
echo "</pre>";


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\test_mail.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\test_mail.php
require_once 'index.php';

// Crear instancia del servicio de email
$emailService = new \App\Helpers\EmailService();

// Intentar enviar un correo de prueba
$result = $emailService->sendVerificationCode(
    'rafa.gzfr@gmail.com', // Reemplaza con tu correo
    'Usuario de Prueba', 
    '123456'
);

echo $result ? '✅ Correo enviado correctamente' : '❌ Error al enviar el correo';


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\test_minimal.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\test_minimal.php

// NO incluir nada más, sin autoload, sin configuraciones
// Mostrar información básica del servidor
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Mínimo</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .info { background: #f0f0f0; padding: 20px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Prueba mínima - Sin redirecciones</h1>
    <div class="info">
        <p><strong>Servidor:</strong> <?php echo $_SERVER['SERVER_NAME']; ?></p>
        <p><strong>URL actual:</strong> <?php echo $_SERVER['REQUEST_URI']; ?></p>
        <p><strong>Protocolo:</strong> <?php echo isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'HTTPS' : 'HTTP'; ?></p>
        <p><strong>Hora del servidor:</strong> <?php echo date('H:i:s'); ?></p>
    </div>
    
    <h2>Formulario de prueba</h2>
    <form action="test_process.php" method="post">
        <div>
            <label>Nombre:</label>
            <input type="text" name="nombre" value="Test">
        </div>
        <div style="margin-top: 10px;">
            <button type="submit">Enviar prueba</button>
        </div>
    </form>
</body>
</html>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\test_process.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\test_process.php

// NO incluir nada más, sin autoload, sin configuraciones
// Solo mostrar los datos recibidos
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesador de prueba</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .info { background: #f0f0f0; padding: 20px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Datos recibidos</h1>
    <div class="info">
        <?php if ($_SERVER['REQUEST_METHOD'] === 'POST'): ?>
            <p><strong>Nombre enviado:</strong> <?php echo htmlspecialchars($_POST['nombre'] ?? 'No enviado'); ?></p>
        <?php else: ?>
            <p>No se recibieron datos POST.</p>
        <?php endif; ?>
        
        <p><strong>Servidor:</strong> <?php echo $_SERVER['SERVER_NAME']; ?></p>
        <p><strong>URL actual:</strong> <?php echo $_SERVER['REQUEST_URI']; ?></p>
        <p><strong>Protocolo:</strong> <?php echo isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'HTTPS' : 'HTTP'; ?></p>
    </div>
    
    <p><a href="test_minimal.php">Volver a la prueba</a></p>
</body>
</html>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\test_router.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\test_router.php

// Script para probar la gestión de parámetros en rutas
require_once __DIR__ . '/app/config/config.php';
require_once __DIR__ . '/app/helpers/Router.php';

echo "<h1>Prueba de Router y Parámetros</h1>";

// Clase de prueba simple
class TestController {
    public function test($id = null) {
        echo "<p>Método test() recibió ID: " . ($id ?? "null") . "</p>";
        return true;
    }
}

// Crear router de prueba
$router = new \App\Helpers\Router();
$router->get('test/{id}', 'Test', 'test');

// Simular solicitudes
echo "<h2>Probando ruta: test/123</h2>";
$_SERVER['REQUEST_URI'] = '/Encasa_Database/test/123';
$router->setControllerTestMode(new TestController());
$router->dispatch();

echo "<p><a href='miembros/2'>Ir a miembros/2</a></p>";


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\test_router_simple.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\test_router_simple.php

// Script simplificado para probar la gestión de rutas
require_once __DIR__ . '/app/config/config.php';

// Mostrar la URI actual para depuración
echo "<h1>Información de la URL actual</h1>";
echo "<p>REQUEST_URI: " . $_SERVER['REQUEST_URI'] . "</p>";
echo "<p>URL para prueba: <a href='miembros/2'>miembros/2</a></p>";

// Analizar manualmente la URL para simular el comportamiento del router
$requestUri = $_SERVER['REQUEST_URI'];
$basePath = '/Encasa_Database/';
$route = str_replace($basePath, '', $requestUri);

echo "<p>Ruta extraída: " . htmlspecialchars($route) . "</p>";

// Analizar parámetros de URL
if (preg_match('#^miembros/(\d+)$#', $route, $matches)) {
    echo "<p>ID detectado: " . $matches[1] . "</p>";
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\test_upload.php
=============================================================

<?php

ini_set('display_errors', 1);
error_reporting(E_ALL);

echo "<h1>Prueba de subida de archivos</h1>";

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Verificar que se subió un archivo
    if (empty($_FILES['test_file']['name'])) {
        echo "<p style='color:red'>No se seleccionó ningún archivo.</p>";
        echo "<a href='verificar_directorios.php'>Volver</a>";
        exit;
    }
    
    // Información del archivo
    echo "<h2>Información del archivo subido:</h2>";
    echo "<pre>";
    print_r($_FILES['test_file']);
    echo "</pre>";
    
    // Directorio de destino
    $uploadDir = __DIR__ . '/uploads/miembros/';
    $uploadFile = $uploadDir . basename($_FILES['test_file']['name']);
    
    echo "<p>Intentando guardar en: <code>$uploadFile</code></p>";
    
    // Intentar guardar el archivo
    if (move_uploaded_file($_FILES['test_file']['tmp_name'], $uploadFile)) {
        echo "<p style='color:green'>✓ Archivo subido correctamente.</p>";
        echo "<p><img src='/ENCASA_DATABASE/uploads/miembros/" . htmlspecialchars(basename($_FILES['test_file']['name'])) . "' style='max-height:200px;'></p>";
    } else {
        echo "<p style='color:red'>❌ Error al subir el archivo.</p>";
        
        // Información de error
        $errorCode = $_FILES['test_file']['error'];
        $errorMessages = [
            UPLOAD_ERR_INI_SIZE => 'El archivo excede el tamaño máximo permitido en php.ini',
            UPLOAD_ERR_FORM_SIZE => 'El archivo excede el tamaño máximo permitido en el formulario',
            UPLOAD_ERR_PARTIAL => 'El archivo se subió parcialmente',
            UPLOAD_ERR_NO_FILE => 'No se subió ningún archivo',
            UPLOAD_ERR_NO_TMP_DIR => 'Falta la carpeta temporal',
            UPLOAD_ERR_CANT_WRITE => 'No se pudo escribir en el disco',
            UPLOAD_ERR_EXTENSION => 'Una extensión de PHP detuvo la subida'
        ];
        
        if (isset($errorMessages[$errorCode])) {
            echo "<p>Error específico: " . $errorMessages[$errorCode] . "</p>";
        }
        
        // Verificar permisos
        echo "<p>Permisos del directorio: " . substr(sprintf('%o', fileperms($uploadDir)), -4) . "</p>";
    }
    
    echo "<p><a href='verificar_directorios.php'>Volver</a></p>";
} else {
    echo "<p>No se recibieron datos de formulario.</p>";
    echo "<p><a href='verificar_directorios.php'>Volver</a></p>";
}
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\tunnel_fix.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\tunnel_fix.php

// 1. Eliminar todas las cookies para limpiar sesión
if (isset($_GET['clear_cookies'])) {
    $past = time() - 3600;
    foreach ($_COOKIE as $key => $value) {
        setcookie($key, '', $past, '/');
    }
    echo "<p>Cookies eliminadas. <a href='?'>Continuar</a></p>";
    exit;
}

// 2. Mostrar información de diagnóstico
echo "<h1>Diagnóstico de Tunnel</h1>";

// Información del servidor
echo "<h2>Información del servidor</h2>";
echo "<pre>";
echo "HTTP_HOST: " . ($_SERVER['HTTP_HOST'] ?? 'No definido') . "\n";
echo "REQUEST_URI: " . ($_SERVER['REQUEST_URI'] ?? 'No definido') . "\n"; 
echo "HTTPS: " . (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'on' : 'off') . "\n";
echo "</pre>";

// 3. Enlace para acceder directamente al login
$host = $_SERVER['HTTP_HOST'];
$protocol = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https://' : 'http://';
$login_url = $protocol . $host . "/ENCASA_DATABASE/login";
$ignored_url = $protocol . $host . "/encasa_database/login?bypass_redirect=1";

echo "<h2>Enlaces de prueba:</h2>";
echo "<p><a href='$login_url'>Acceso normal al login</a></p>";
echo "<p><a href='$ignored_url'>Acceso al login sin redirecciones</a></p>";
echo "<p><a href='?clear_cookies'>Limpiar cookies y sesión</a></p>";

// 4. Proporcionar instrucciones
echo "<h2>Instrucciones:</h2>";
echo "<ol>";
echo "<li>Primero, haz clic en 'Limpiar cookies y sesión'</li>";
echo "<li>Luego intenta el 'Acceso al login sin redirecciones'</li>";
echo "<li>Si funciona, necesitas modificar tu index.php según las instrucciones abajo</li>";
echo "</ol>";

echo "<h2>Modificación recomendada para index.php:</h2>";
echo "<pre style='background:#f8f9fa;padding:10px;'>";
echo '// Añadir esta condición antes de cualquier redirección
if (isset($_GET["bypass_redirect"])) {
    // No hacer ninguna redirección
    define("BYPASS_REDIRECTS", true);
}

// Modificar la redirección existente:
if (!defined("BYPASS_REDIRECTS") && $is_tunnel && empty($_SERVER["HTTPS"])) {
    $redirect_url = "https://" . $_SERVER["HTTP_HOST"] . $_SERVER["REQUEST_URI"];
    header("Location: $redirect_url");
    exit;
}';
echo "</pre>";

// 5. Diagnóstico de Router y URL
echo "<h2>Diagnóstico del Router:</h2>";
echo "<p>Tu Router.php está usando esta línea para redirecciones:</p>";
echo "<code>header('Location: ' . APP_URL . '/' . \$url);</code>";
echo "<p>Si APP_URL está establecido incorrectamente, causará bucles de redirección.</p>";

echo "<p>APP_URL actual (o esperado): ";
if (defined('APP_URL')) {
    echo APP_URL;
} else {
    echo "No definido aquí";
}
echo "</p>";


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\tunnel_fix_global.php
=============================================================

<?php

// Script para diagnosticar y solucionar problemas de URL en túneles

// 1. Mostrar información del entorno
$protocol = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https://' : 'http://';
$host = $_SERVER['HTTP_HOST'] ?? 'localhost';
$requestUri = $_SERVER['REQUEST_URI'] ?? '/';
$is_tunnel = strpos($host, 'localto.net') !== false || 
             strpos($host, 'loca.lt') !== false ||
             strpos($host, 'ngrok-free.app') !== false;

echo "<h1>Diagnóstico Global de URLs</h1>";

echo "<h2>Información del Entorno</h2>";
echo "<pre>";
echo "Host: $host\n";
echo "Protocol: $protocol\n";
echo "Request URI: $requestUri\n";
echo "¿Es túnel?: " . ($is_tunnel ? "SÍ" : "NO") . "\n";
echo "</pre>";

// 2. Verificar configuraciones existentes
if (defined('APP_URL')) {
    echo "<h2>Constantes Actuales</h2>";
    echo "<pre>";
    echo "APP_URL: " . APP_URL . "\n";
    if (defined('APP_ENV')) echo "APP_ENV: " . APP_ENV . "\n";
    echo "</pre>";
}

// 3. Generar una URL de prueba con la función url() si existe
echo "<h2>Prueba de Generación de URL</h2>";
if (function_exists('url')) {
    echo "<p>Función url() existe.</p>";
    echo "<p>url('login') genera: " . url('login') . "</p>";
} else {
    echo "<p style='color:red'>⚠️ Función url() no encontrada. Esto puede causar problemas.</p>";
}

// 4. Verificar archivos críticos
$files_to_check = [
    'index.php',
    'app/helpers/functions.php',
    'app/helpers/Router.php',
    'app/views/layouts/default.php',
    'app/views/auth/login.php'
];

echo "<h2>Verificación de Archivos Críticos</h2>";
echo "<ul>";
foreach ($files_to_check as $file) {
    $path = __DIR__ . '/' . $file;
    if (file_exists($path)) {
        echo "<li>✅ $file <span style='color:green'>existe</span></li>";
    } else {
        echo "<li>❌ $file <span style='color:red'>no existe</span></li>";
    }
}
echo "</ul>";

// 5. Proporcionar solución integral
echo "<h2>Solución Recomendada</h2>";
echo "<p>Para resolver los problemas de URL en túneles, sigue estos pasos:</p>";
echo "<ol>";
echo "<li>En index.php, asegúrate de que APP_URL se configure adecuadamente para túneles.</li>";
echo "<li>En todas las vistas y controladores, usa la función url() en lugar de URLs absolutas.</li>";
echo "<li>Verifica que el Router esté usando APP_URL para las redirecciones.</li>";
echo "<li>Actualiza los enlaces de la barra de navegación para usar url().</li>";
echo "</ol>";

// 6. Proporcionar código para solucionarlo inmediatamente
echo "<h2>Código para Solucionar el Problema</h2>";

echo "<h3>1. Función url() en app/helpers/functions.php</h3>";
echo '<pre style="background-color: #f5f5f5; padding: 10px; border: 1px solid #ddd; overflow: auto;">';
echo htmlspecialchars('<?php
// En app/helpers/functions.php
/**
 * Genera una URL completa para la aplicación
 * @param string $path Ruta relativa (sin / inicial)
 * @return string URL completa
 */
function url($path = \'\')
{
    // Asegurar que APP_URL existe
    if (!defined(\'APP_URL\')) {
        // Determinar URL base si no está definida
        $protocol = isset($_SERVER[\'HTTPS\']) && $_SERVER[\'HTTPS\'] === \'on\' ? \'https://\' : \'http://\';
        $host = $_SERVER[\'HTTP_HOST\'] ?? \'localhost\';
        $is_tunnel = strpos($host, \'localto.net\') !== false || 
                     strpos($host, \'loca.lt\') !== false ||
                     strpos($host, \'ngrok-free.app\') !== false;
                     
        // Configurar base URL
        $base_url = $protocol . $host;
        if ($is_tunnel) {
            $base_url .= \'/encasa_database\'; 
        } else {
            $base_url .= \'/ENCASA_DATABASE\';
        }
    } else {
        $base_url = APP_URL;
    }
    
    // Formatear URL
    $base_url = rtrim($base_url, \'/\');
    $path = ltrim($path, \'/\');
    
    return $base_url . ($path ? \'/\' . $path : \'\');
}');
echo '</pre>';

echo "<h3>2. Método redirect en Router.php</h3>";
echo '<pre style="background-color: #f5f5f5; padding: 10px; border: 1px solid #ddd; overflow: auto;">';
echo htmlspecialchars('// En app/helpers/Router.php - Método redirect
/**
 * Redirige a una URL
 */
public static function redirect($url) {
    // Usar la función url() para generar URLs consistentes
    if (function_exists(\'url\')) {
        header(\'Location: \' . url($url));
    } else {
        // Fallback si la función url() no existe
        $baseUrl = defined(\'APP_URL\') ? APP_URL : \'/ENCASA_DATABASE\';
        header(\'Location: \' . rtrim($baseUrl, \'/\') . \'/\' . ltrim($url, \'/\'));
    }
    exit;
}');
echo '</pre>';

// 7. Proporcionar enlaces de prueba
echo "<h2>Enlaces de Prueba</h2>";
$base = $protocol . $host . ($is_tunnel ? '/encasa_database' : '/ENCASA_DATABASE');
echo "<p><a href='$base/login' target='_blank'>Probar login</a></p>";
echo "<p><a href='$base/direct_access.php' target='_blank'>Usar direct_access.php</a> (bypass del sistema de rutas)</p>";
echo "<p><a href='$base/direct_test.php' target='_blank'>Probar base de datos directamente</a></p>";
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\url_test.php
=============================================================

<?php

// Este archivo permite probar la función url() directamente

// Definir constantes del sistema básicas
define('BASE_PATH', __DIR__);
define('APP_PATH', BASE_PATH . '/app');

// Cargar la función url()
require_once APP_PATH . '/helpers/functions.php';

// Detectar entorno para información
$protocol = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https://' : 'http://';
$host = $_SERVER['HTTP_HOST'] ?? 'localhost';
$is_tunnel = strpos($host, 'localto.net') !== false || 
             strpos($host, 'loca.lt') !== false ||
             strpos($host, 'ngrok-free.app') !== false;

echo "<h1>Prueba de función url()</h1>";
echo "<p><strong>Host:</strong> $host</p>";
echo "<p><strong>Protocolo:</strong> $protocol</p>";
echo "<p><strong>¿Es túnel?:</strong> " . ($is_tunnel ? "SÍ" : "NO") . "</p>";

// Probar la generación de URLs
$urls = [
    '' => 'URL base',
    'login' => 'URL de login',
    'miembros' => 'URL de miembros',
    'miembros/crear' => 'URL para crear miembro'
];

echo "<h2>URLs generadas:</h2>";
echo "<ul>";
foreach ($urls as $path => $description) {
    echo "<li><strong>$description:</strong> " . url($path) . "</li>";
}
echo "</ul>";

echo "<h2>Enlaces de prueba:</h2>";
echo "<ul>";
foreach ($urls as $path => $description) {
    echo "<li><a href='" . url($path) . "' target='_blank'>$description</a></li>";
}
echo "</ul>";
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\verificar_carpetas.php
=============================================================

<?php
// Script para verificar y crear carpetas necesarias

// Corrige las rutas para que coincidan con donde se guardan realmente las fotos
$carpetas = [
    __DIR__ . '/public/uploads',
    __DIR__ . '/public/uploads/miembros'
];

foreach ($carpetas as $carpeta) {
    if (!file_exists($carpeta)) {
        if (mkdir($carpeta, 0777, true)) {
            echo "Carpeta creada: $carpeta<br>";
        } else {
            echo "ERROR: No se pudo crear carpeta: $carpeta<br>";
        }
    } else {
        echo "Carpeta ya existe: $carpeta<br>";
    }
}

// Verificar permisos
foreach ($carpetas as $carpeta) {
    echo "Permisos de $carpeta: " . substr(sprintf('%o', fileperms($carpeta)), -4) . "<br>";
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\verificar_directorios.php
=============================================================

<?php

ini_set('display_errors', 1);
error_reporting(E_ALL);

echo "<h1>Verificación de directorios de subida</h1>";

// Directorio de uploads
$uploadDir = __DIR__ . '/uploads/miembros';

echo "<p>Verificando directorio: <code>$uploadDir</code></p>";

if (!is_dir($uploadDir)) {
    echo "<p>El directorio no existe. Intentando crear...</p>";
    
    if (mkdir($uploadDir, 0755, true)) {
        echo "<p style='color:green'>✓ Directorio creado exitosamente.</p>";
    } else {
        echo "<p style='color:red'>❌ No se pudo crear el directorio. Error: " . error_get_last()['message'] . "</p>";
    }
} else {
    echo "<p style='color:green'>✓ El directorio existe.</p>";
}

// Verificar permisos
if (is_writable($uploadDir)) {
    echo "<p style='color:green'>✓ El directorio tiene permisos de escritura.</p>";
} else {
    echo "<p style='color:red'>❌ El directorio NO tiene permisos de escritura.</p>";
    echo "<p>Ejecute este comando en la línea de comandos:<br>";
    echo "<code>chmod -R 755 $uploadDir</code></p>";
}

// Verificar configuración PHP para subida de archivos
echo "<h2>Configuración de PHP para subida de archivos</h2>";
echo "<ul>";
echo "<li>upload_max_filesize: " . ini_get('upload_max_filesize') . "</li>";
echo "<li>post_max_size: " . ini_get('post_max_size') . "</li>";
echo "<li>max_file_uploads: " . ini_get('max_file_uploads') . "</li>";
echo "</ul>";

// Crear formulario de prueba
echo "<h2>Formulario de prueba de subida</h2>";
echo "<form action='test_upload.php' method='post' enctype='multipart/form-data'>";
echo "<div><input type='file' name='test_file'></div>";
echo "<div style='margin-top:10px'><button type='submit'>Probar subida</button></div>";
echo "</form>";
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\verificar_imagenes.php
=============================================================

<?php
// Verificar directorio e imágenes
require_once 'app/config/database.php';

// Conectar a la base de datos
$db = new PDO("mysql:host=" . DB_HOST . ";dbname=" . DB_NAME, DB_USER, DB_PASS);
$db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

// Obtener todos los nombres de archivos
$stmt = $db->query("SELECT id, nombres, apellidos, foto FROM InformacionGeneral WHERE foto IS NOT NULL AND foto != ''");
$miembros = $stmt->fetchAll(PDO::FETCH_ASSOC);

$directorio = __DIR__ . '/uploads/miembros/';
echo "<h1>Verificación de imágenes</h1>";

// Verificar si el directorio existe
echo "<h2>Verificando directorio</h2>";
if (is_dir($directorio)) {
    echo "<p style='color:green'>✓ Directorio existe: {$directorio}</p>";
    echo "<p>Permisos: " . substr(sprintf('%o', fileperms($directorio)), -4) . "</p>";
} else {
    echo "<p style='color:red'>✗ Directorio NO existe: {$directorio}</p>";
    echo "<p>Intente crear el directorio manualmente.</p>";
    exit;
}

// Verificar cada imagen
echo "<h2>Verificando imágenes</h2>";
echo "<table border='1' cellpadding='5'>
      <tr><th>ID</th><th>Nombre</th><th>Archivo</th><th>Estado</th></tr>";

foreach ($miembros as $miembro) {
    $archivo = $directorio . $miembro['foto'];
    $estado = file_exists($archivo) ? 
        "<span style='color:green'>✓ Existe</span>" : 
        "<span style='color:red'>✗ No existe</span>";
    
    echo "<tr>
            <td>{$miembro['id']}</td>
            <td>{$miembro['nombres']} {$miembro['apellidos']}</td>
            <td>{$miembro['foto']}</td>
            <td>{$estado}</td>
          </tr>";
}
echo "</table>";
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\verificar_miembro.php
=============================================================

<?php

require_once __DIR__ . '/app/config/config.php';
require_once __DIR__ . '/app/config/database.php';

$id = isset($_GET['id']) ? (int)$_GET['id'] : 1;

try {
    $db = Database::getInstance()->getConnection();
    
    // Consulta directa
    $stmt = $db->prepare("SELECT * FROM InformacionGeneral WHERE id = ?");
    $stmt->execute([$id]);
    $miembro = $stmt->fetch(PDO::FETCH_ASSOC);
    
    echo "<h1>Verificación directa de miembro ID: $id</h1>";
    
    if ($miembro) {
        echo "<p style='color:green'>✅ El miembro SÍ existe en la base de datos</p>";
        echo "<pre>";
        print_r($miembro);
        echo "</pre>";
    } else {
        echo "<p style='color:red'>❌ El miembro NO existe en la base de datos</p>";
    }
    
} catch (Exception $e) {
    echo "<p style='color:red'>Error: " . $e->getMessage() . "</p>";
}
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\verify_router.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\verify_router.php

require_once __DIR__ . '/app/config/config.php';
require_once __DIR__ . '/app/Controllers/MiembrosController.php';
require_once __DIR__ . '/app/models/Miembro.php';
require_once __DIR__ . '/app/config/database.php';

echo "<h1>Verificación de Router y Controlador</h1>";

// Simular una solicitud a miembros/2
$_SERVER['REQUEST_URI'] = '/Encasa_Database/miembros/2';

echo "<p>Simulando acceso a URI: {$_SERVER['REQUEST_URI']}</p>";

// Extracción manual del ID como lo haría el router
if (preg_match('#/miembros/(\d+)#', $_SERVER['REQUEST_URI'], $matches)) {
    $id = (int)$matches[1];
    echo "<p>ID extraído: {$id}</p>";
    
    // Crear instancia del controlador y llamar al método directamente
    try {
        $controller = new \App\Controllers\MiembrosController();
        echo "<p>Controlador instanciado correctamente</p>";
        
        // Llamar al método ver() directamente
        $result = $controller->ver($id);
        echo "<p>Método ver() ejecutado con resultado: " . ($result ? "OK" : "Error") . "</p>";
    } catch (Exception $e) {
        echo "<p style='color:red'>Error al ejecutar el controlador: " . $e->getMessage() . "</p>";
    }
} else {
    echo "<p style='color:red'>No se pudo extraer ID de la URI</p>";
}

echo "<p><a href='miembros/2?nocache=" . time() . "' target='_blank'>Intentar acceso normal</a></p>";


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\Router.php
=============================================================



=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\routes.php
=============================================================

<?php
// Añadir estas líneas donde corresponda

// API para datos educativos
$router->get('/api/education-data/:country', 'EducationController@getEducationData');
$router->post('/api/education-data/save-institution', 'EducationController@saveInstitution');
$router->post('/api/education-data/save-profession', 'EducationController@saveProfession');


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\config\autoload.php
=============================================================

<?php
// Autoload mejorado para manejar problemas de mayúsculas/minúsculas en directorios
spl_autoload_register(function ($className) {
    // Normalizar separadores y quitar prefijo de namespace
    $className = str_replace('App\\', '', $className);
    $path = str_replace('\\', '/', $className);
    
    // Primera opción: ruta exacta
    $file = APP_PATH . '/' . $path . '.php';
    if (file_exists($file)) {
        require_once $file;
        return true;
    }
    
    // Segunda opción: directorio en minúsculas, nombre de archivo normal
    $dir = dirname($path);
    $filename = basename($path);
    $file = APP_PATH . '/' . strtolower($dir) . '/' . $filename . '.php';
    if (file_exists($file)) {
        require_once $file;
        return true;
    }
    
    // Tercera opción: comprobar existencia de Controllers vs controllers
    $file = APP_PATH . '/Controllers/' . $filename . '.php';
    if (file_exists($file)) {
        require_once $file;
        return true;
    }
    
    // Cuarta opción: comprobar existencia de controllers vs Controllers
    $file = APP_PATH . '/controllers/' . $filename . '.php';
    if (file_exists($file)) {
        require_once $file;
        return true;
    }
    
    return false;
});


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\config\config.php
=============================================================

<?php
// Configuración general de la aplicación
if (!defined('APP_NAME'))    define('APP_NAME', 'Iglesia En Casa');
if (!defined('APP_URL'))     define('APP_URL', 'http://localhost/Encasa_Database');
if (!defined('APP_ENV'))     define('APP_ENV', 'development'); // 'development' o 'production'

// URL base y ruta base
if (!defined('BASE_URL'))    define('BASE_URL', '/ENCASA_DATABASE');
if (!defined('BASE_PATH'))   define('BASE_PATH', dirname(__DIR__, 2));

// Directorio de carga de archivos
if (!defined('UPLOAD_DIR'))  define('UPLOAD_DIR', __DIR__ . '/../../uploads');

// Configuración de zona horaria
date_default_timezone_set('America/Bogota');

// Configuración de correo electrónico con cuenta de Gmail para autenticación
if (!defined('SMTP_HOST'))   define('SMTP_HOST', 'smtp.gmail.com');
if (!defined('SMTP_PORT'))   define('SMTP_PORT', 587);
if (!defined('SMTP_SECURE')) define('SMTP_SECURE', 'tls');
if (!defined('SMTP_AUTH'))   define('SMTP_AUTH', true);
if (!defined('SMTP_USER'))   define('SMTP_USER', 'iglesiaencasautenticador@gmail.com');
if (!defined('SMTP_PASS'))   define('SMTP_PASS', 'uhko nczq nclq uzkx');
if (!defined('MAIL_FROM'))   define('MAIL_FROM', 'iglesiaencasautenticador@gmail.com');
if (!defined('MAIL_FROM_NAME')) define('MAIL_FROM_NAME', 'Iglesia En Casa');

// Controles para la verificación
if (!defined('REQUIRE_EMAIL_VERIFICATION')) define('REQUIRE_EMAIL_VERIFICATION', true);
if (!defined('REQUIRE_2FA_LOGIN'))          define('REQUIRE_2FA_LOGIN', true);

// Constantes de Base de Datos
if (!defined('DB_HOST'))     define('DB_HOST', 'localhost');
if (!defined('DB_NAME'))     define('DB_NAME', 'iglesiaencasa');
if (!defined('DB_USER'))     define('DB_USER', 'root');
if (!defined('DB_PASS'))     define('DB_PASS', '');

// Configuración del manejo de errores
ini_set('display_errors', 1);
error_reporting(E_ALL);
ini_set('error_log', __DIR__ . '/../../logs/php_error.log');

// Asegurarse de que existe el directorio de logs
if (!is_dir(__DIR__ . '/../../logs')) {
    mkdir(__DIR__ . '/../../logs', 0777, true);
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\config\cors.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\config\cors.php
/**
 * Configuración global de CORS para la aplicación
 * Detecta automáticamente entornos y configura las cabeceras adecuadamente
 */

// Obtener el origen de la solicitud
$origin = isset($_SERVER['HTTP_ORIGIN']) ? $_SERVER['HTTP_ORIGIN'] : '';
$referer = isset($_SERVER['HTTP_REFERER']) ? $_SERVER['HTTP_REFERER'] : '';

// Función para extraer el dominio base
function getDomainFromUrl($url) {
    $parsedUrl = parse_url($url);
    return isset($parsedUrl['host']) ? $parsedUrl['host'] : '';
}

// Detectar si estamos usando ngrok o localtunnel
$isTunnel = false;
$tunnelDomain = '';

// Detectar ngrok
if (strpos($origin, 'ngrok-free.app') !== false) {
    $isTunnel = true;
    $tunnelDomain = $origin;
} elseif (strpos($referer, 'ngrok-free.app') !== false) {
    $isTunnel = true;
    $tunnelDomain = preg_replace('/^(https?:\/\/[^\/]+).*$/', '$1', $referer);
}

// Detectar localtunnel
if (!$isTunnel) {
    if (strpos($origin, 'loca.lt') !== false || strpos($origin, 'localto.net') !== false) {
        $isTunnel = true;
        $tunnelDomain = $origin;
    } elseif (strpos($referer, 'loca.lt') !== false || strpos($referer, 'localto.net') !== false) {
        $isTunnel = true;
        $tunnelDomain = preg_replace('/^(https?:\/\/[^\/]+).*$/', '$1', $referer);
    }
}

// Configurar los encabezados CORS según el entorno
if ($isTunnel) {
    // Si es un túnel, permitir ese origen específico
    header("Access-Control-Allow-Origin: $tunnelDomain");
    error_log("CORS: Permitido origen de túnel: $tunnelDomain");
} elseif (in_array($_SERVER['SERVER_NAME'] ?? '', ['localhost', '127.0.0.1'])) {
    // Entorno de desarrollo local
    header('Access-Control-Allow-Origin: *');
    error_log("CORS: Permitido cualquier origen (desarrollo local)");
} else {
    // Entorno de producción - aquí puedes definir dominios específicos
    $allowedDomains = [
        'iglesiaencasa.org',
        'www.iglesiaencasa.org'
    ];
    
    $domain = getDomainFromUrl($origin);
    if (in_array($domain, $allowedDomains)) {
        header("Access-Control-Allow-Origin: $origin");
        error_log("CORS: Permitido origen de producción: $origin");
    }
}

// Configurar otros encabezados CORS
header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With, X-XSRF-TOKEN');
header('Access-Control-Allow-Credentials: true');
header('Access-Control-Max-Age: 86400'); // 24 horas

// Si es una solicitud OPTIONS (preflight), terminar aquí
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    exit(0);
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\config\database.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\config\database.php

// Definir constantes si no existen
if (!defined('DB_HOST')) define('DB_HOST', 'localhost');
if (!defined('DB_USER')) define('DB_USER', 'root'); // Usuario predeterminado de XAMPP
if (!defined('DB_PASS')) define('DB_PASS', ''); // Contraseña en blanco por defecto en XAMPP
if (!defined('DB_NAME')) define('DB_NAME', 'iglesiaencasa'); // Nombre de tu base de datos (cambio importante)

// Solo mantener las que no están en config.php
define('DB_PORT', '3306');
define('DB_CHARSET', 'utf8mb4');

/**
 * Clase Database con patrón singleton para la conexión
 */
class Database {
    private static $instance = null;
    private $connection = null;
    
    private function __construct() {
        try {
            // Conexión básica a MySQL sin usar variables de entorno
            $this->connection = new PDO(
                "mysql:host=localhost;dbname=IglesiaEnCasa;charset=utf8", 
                "root",  // Usuario por defecto de XAMPP 
                ""       // Contraseña por defecto (vacía)
            );
            $this->connection->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            $this->connection->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
        } catch (PDOException $e) {
            // Registrar error
            file_put_contents(__DIR__ . '/../../db_error.log', date('Y-m-d H:i:s') . ' - ' . $e->getMessage() . "\n", FILE_APPEND);
            throw new Exception("Error en la conexión a la base de datos");
        }
    }
    
    public static function getInstance() {
        if (self::$instance == null) {
            self::$instance = new Database();
        }
        return self::$instance;
    }
    
    public function getConnection() {
        return $this->connection;
    }
}

// Crear una instancia de la base de datos global para uso general
$database = Database::getInstance();
$db = $database->getConnection();


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\config\db_verifier.php
=============================================================

<?php

require_once __DIR__ . '/database.php';

class DBVerifier {
    private $db;
    private $errors = [];
    
    public function __construct() {
        $this->db = Database::getInstance()->getConnection();
    }
    
    public function verifyDatabase() {
        try {
            // Verificar si la base de datos existe
            $this->db->query("USE IglesiaEnCasa");
            $this->verifyTables();
            $this->verifyConstraints();
            $this->verifyIndexes();
            
            if (empty($this->errors)) {
                return true;
            } else {
                $this->logErrors();
                return false;
            }
        } catch (PDOException $e) {
            $this->errors[] = "Error de base de datos: " . $e->getMessage();
            $this->logErrors();
            return false;
        }
    }
    
    private function verifyTables() {
        $tables = [
            'InformacionGeneral', 'Contacto', 'Roles', 'Ministerios', 
            'MiembrosMinisterios', 'Usuarios'
        ];
        
        foreach ($tables as $table) {
            try {
                $result = $this->db->query("SELECT 1 FROM `$table` LIMIT 1");
            } catch (PDOException $e) {
                $this->errors[] = "La tabla '$table' no existe o no es accesible.";
            }
        }
    }
    
    private function verifyConstraints() {
        $constraints = [
            ['InformacionGeneral', 'informacion_general_ibfk_1'],
            ['Contacto', 'contacto_ibfk_1'],
            ['Ministerios', 'ministerios_ibfk_1'],
            ['MiembrosMinisterios', 'miembrosministerios_ibfk_1'],
            ['MiembrosMinisterios', 'miembrosministerios_ibfk_2'],
            ['MiembrosMinisterios', 'miembrosministerios_ibfk_3'],
            ['Usuarios', 'usuarios_ibfk_1'],
            ['Usuarios', 'usuarios_ibfk_2']
        ];
        
        foreach ($constraints as $constraint) {
            try {
                $query = "
                    SELECT * FROM information_schema.TABLE_CONSTRAINTS 
                    WHERE CONSTRAINT_SCHEMA = 'IglesiaEnCasa' 
                    AND TABLE_NAME = ? 
                    AND CONSTRAINT_NAME = ?
                ";
                $stmt = $this->db->prepare($query);
                $stmt->execute([$constraint[0], $constraint[1]]);
                
                if ($stmt->rowCount() === 0) {
                    $this->errors[] = "La restricción '{$constraint[1]}' no existe en la tabla '{$constraint[0]}'.";
                }
            } catch (PDOException $e) {
                $this->errors[] = "Error verificando restricciones: " . $e->getMessage();
            }
        }
    }
    
    private function verifyIndexes() {
        $indexes = [
            ['InformacionGeneral', 'PRIMARY'],
            ['Contacto', 'PRIMARY'],
            ['Roles', 'PRIMARY'],
            ['Ministerios', 'PRIMARY'],
            ['Ministerios', 'lider_id'],
            ['MiembrosMinisterios', 'PRIMARY']
        ];
        
        foreach ($indexes as $index) {
            try {
                $query = "
                    SELECT * FROM information_schema.STATISTICS 
                    WHERE TABLE_SCHEMA = 'IglesiaEnCasa' 
                    AND TABLE_NAME = ? 
                    AND INDEX_NAME = ?
                ";
                $stmt = $this->db->prepare($query);
                $stmt->execute([$index[0], $index[1]]);
                
                if ($stmt->rowCount() === 0) {
                    $this->errors[] = "El índice '{$index[1]}' no existe en la tabla '{$index[0]}'.";
                }
            } catch (PDOException $e) {
                $this->errors[] = "Error verificando índices: " . $e->getMessage();
            }
        }
    }
    
    private function logErrors() {
        $logFile = APP_PATH . '/logs/db_verification.log';
        $directory = dirname($logFile);
        
        if (!is_dir($directory)) {
            mkdir($directory, 0755, true);
        }
        
        $timestamp = date('Y-m-d H:i:s');
        $logMessage = "[$timestamp] Verificación de base de datos:" . PHP_EOL;
        
        foreach ($this->errors as $error) {
            $logMessage .= "- $error" . PHP_EOL;
        }
        
        file_put_contents($logFile, $logMessage, FILE_APPEND);
    }
    
    public function getErrors() {
        return $this->errors;
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\config\https_handler.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\config\https_handler.php

/**
 * Mejorar manejo de HTTPS para evitar problemas de formularios
 */
function configure_https() {
    // Forzar HSTS para conexiones seguras
    if (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on') {
        header('Strict-Transport-Security: max-age=31536000; includeSubDomains');
    }
    
    // Configuración CORS básica
    header('Access-Control-Allow-Origin: *');
    header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');
    header('Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With');
    
    // Forzar recursos seguros
    header('Content-Security-Policy: upgrade-insecure-requests');
}

// Aplicar configuración
configure_https();


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\config\mail_autoload.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\config\mail_autoload.php

// Autoloader para PHPMailer (versión manual)
require_once BASE_PATH . '/vendor/phpmailer/phpmailer/PHPMailer-6.10.0/src/PHPMailer.php';
require_once BASE_PATH . '/vendor/phpmailer/phpmailer/PHPMailer-6.10.0/src/SMTP.php';
require_once BASE_PATH . '/vendor/phpmailer/phpmailer/PHPMailer-6.10.0/src/Exception.php';


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\config\routes.php
=============================================================

<?php
// filepath: /Applications/XAMPP/xamppfiles/htdocs/Encasa_Database/app/config/routes.php

use App\Helpers\Router;

// Instancia del router
$router = new Router();

// Página principal
$router->get('', 'Home', 'index');
$router->get('home', 'Home', 'index');

// Rutas de miembros
$router->get('miembros', 'Miembros', 'index', ['Auth']);
$router->get('miembros/crear', 'Miembros', 'crear', ['Auth']);
$router->post('miembros/guardar', 'Miembros', 'guardar', ['Auth']);
$router->get('miembros/{id}', 'Miembros', 'ver', ['Auth']);
$router->get('miembros/editar/{id}', 'Miembros', 'editar');
$router->post('miembros/actualizar/{id}', 'Miembros', 'actualizar');
$router->get('miembros/eliminar/{id}', 'Miembros', 'eliminar', ['Auth']);

// Rutas de ministerios
$router->get('ministerios', 'Ministerios', 'index', ['Auth']);
$router->get('ministerios/crear', 'Ministerios', 'crear', ['Auth']);
$router->post('ministerios/guardar', 'Ministerios', 'guardar', ['Auth']);
$router->get('ministerios/{id}', 'Ministerios', 'ver', ['Auth']);
$router->get('ministerios/{id}/editar', 'Ministerios', 'editar', ['Auth']);
$router->post('ministerios/{id}/actualizar', 'Ministerios', 'actualizar', ['Auth']);
$router->post('ministerios/{id}/eliminar', 'Ministerios', 'eliminar', ['Auth', 'AdminOnly']);

// Rutas de autenticación
$router->get('login', 'Auth', 'login');
$router->post('auth/login', 'Auth', 'authenticate');
$router->get('logout', 'Auth', 'logout');
$router->get('registro', 'Auth', 'register');
$router->post('auth/registro', 'Auth', 'store');

// Rutas de verificación
$router->get('auth/verify', 'Auth', 'verify');
$router->post('auth/verify', 'Auth', 'verify');
$router->get('auth/resendCode', 'Auth', 'resendCode');

// Rutas de verificación 2FA para login
$router->get('auth/verify-login', 'Auth', 'verifyLogin');
$router->post('auth/verify-login', 'Auth', 'verifyLogin');
$router->get('auth/resend-login-code', 'Auth', 'resendLoginCode');

// API para datos educativos
$router->get('api/education-data/:country', 'Education', 'getEducationData');
$router->post('api/education-data/save-institution', 'Education', 'saveInstitution');
$router->post('api/education-data/save-profession', 'Education', 'saveProfession');

// Rutas de error
$router->setNotFound(function() {
    include VIEW_PATH . '/errors/404.php';
});

// Rutas para guardar/actualizar por tabla individual
$router->post('miembros/guardar/tabla/{tabla}', 'Miembros', 'guardarTabla');
$router->post('miembros/actualizar/{id}/tabla/{tabla}', 'Miembros', 'actualizarTabla');

return $router;


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\Controllers\AuthController.php
=============================================================

<?php
// filepath: /Applications/XAMPP/xamppfiles/htdocs/Encasa_Database/app/controllers/AuthController.php
namespace App\Controllers;

class AuthController extends Controller {
    private $userModel;
    
    public function __construct() {
        parent::__construct();
        $this->userModel = new \App\Models\Usuario();
    }
    
    /**
     * Muestra el formulario de login
     */
    public function login() {
        // Si ya está autenticado, redirigir al dashboard
        if ($this->isAuthenticated()) {
            $this->redirect('');
            return;
        }
        
        $this->renderWithLayout('auth/login', 'auth', [
            'title' => 'Iniciar Sesión'
        ]);
    }
    
    /**
     * Procesa el intento de login
     */
    public function authenticate() {
        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            $this->redirect('login');
            return;
        }

        $email_or_username = trim($_POST['email_or_username'] ?? ''); // Añadido trim()
        $password = $_POST['password'] ?? '';

        if (empty($email_or_username) || empty($password)) {
            return $this->renderWithLayout('auth/login', 'auth', [
                'error' => 'Por favor ingrese su correo/usuario y contraseña',
                'title' => 'Iniciar Sesión'
            ]);
        }

        $userModel = new \App\Models\Usuario();
        $user = $userModel->findByEmailOrUsername($email_or_username);
        
        // Añadir logging para diagnóstico
        error_log("Intento de login para: $email_or_username");
        
        if (!$user) {
            error_log("Usuario no encontrado: $email_or_username");
            return $this->renderWithLayout('auth/login', 'auth', [
                'error' => 'Credenciales incorrectas [U]',
                'title' => 'Iniciar Sesión'
            ]);
        }
        
        // Verificar la contraseña
        $password_match = password_verify($password, $user['password']);
        error_log("Usuario encontrado. ID: {$user['id']}, Estado: {$user['estado']}, Password match: " . ($password_match ? "SI" : "NO"));
        
        if ($password_match) {
            // Si las credenciales son correctas, verificar el estado del usuario
            if (strtolower($user['estado']) != 'activo') {
                // Usuario no activo - Mostrar mensaje de verificación pendiente
                $_SESSION['pending_verification'] = [
                    'user_id' => $user['id'],
                    'email' => $user['email'],
                    'name' => $user['nombre_completo']
                ];
                
                $_SESSION['flash_message'] = 'Tu cuenta aún no ha sido verificada. Por favor revisa tu correo electrónico para el código de verificación.';
                $_SESSION['flash_type'] = 'warning';
                
                // Añadir un enlace para reenviar el código
                $_SESSION['flash_action'] = '<a href="'.APP_URL.'/auth/resendCode" class="btn btn-sm btn-primary mt-2">Reenviar código</a>';
                
                return $this->renderWithLayout('auth/login', 'auth', [
                    'error' => 'Tu cuenta aún no ha sido verificada.',
                    'title' => 'Iniciar Sesión'
                ]);
            }
            
            // Añadir verificación de 2FA
            if (defined('REQUIRE_2FA_LOGIN') && REQUIRE_2FA_LOGIN) {
                // Guardar información del usuario en sesión para el segundo paso
                $_SESSION['pending_2fa'] = [
                    'user_id' => $user['id'],
                    'email' => $user['email'],
                    'name' => $user['nombre_completo']
                ];
                
                // Generar código de verificación
                $verificationModel = new \App\Models\VerificationCode();
                $code = $verificationModel->createForUser($user['id'], 'login_verification');
                
                // Enviar código por correo
                $emailService = new \App\Helpers\EmailService();
                $emailService->sendVerificationCode($user['email'], $user['nombre_completo'], $code);
                
                // Redirigir a la página de verificación 2FA
                $this->redirect('auth/verify-login');
                return;
            }
            
            // Si no se requiere 2FA, continuar con el flujo normal de autenticación
            $_SESSION['user_id'] = $user['id'];
            $_SESSION['user_name'] = $user['nombre_completo'];
            $_SESSION['user_role'] = $user['rol_id'];
            
            // Redireccionar al panel adecuado
            $this->redirect(''); // Redirige a la página de inicio
            return;
        }
        
        // Si llegamos aquí, las credenciales son incorrectas
        return $this->renderWithLayout('auth/login', 'auth', [
            'error' => 'Credenciales incorrectas',
            'title' => 'Iniciar Sesión'
        ]);
    }
    
    /**
     * Cierra la sesión
     */
    public function logout() {
        // Destruir la sesión
        session_unset();
        session_destroy();
        
        // Redirigir a login
        $this->redirect('login');
    }
    
    /**
     * Muestra el formulario de registro
     */
    public function register() {
        // Si ya está autenticado, redirigir al dashboard
        if ($this->isAuthenticated()) {
            $this->redirect('');
            return;
        }
        
        $this->renderWithLayout('auth/register', 'auth', [
            'title' => 'Registro de Usuario'
        ]);
    }
    
    /**
     * Procesa el registro de usuario
     */
    public function store() {
        // Verificar que sea una petición POST
        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            // Redirigir a la página de registro si no es POST
            header('Location: ' . APP_URL . '/registro');
            exit;
        }
        
        // Obtener datos del formulario
        $data = [
            'nombre_completo' => $_POST['nombre_completo'] ?? '',
            'username' => $_POST['username'] ?? '',
            'email' => $_POST['email'] ?? '',
            'password' => $_POST['password'] ?? '',
            'password_confirmation' => $_POST['password_confirmation'] ?? '',
            'miembro_id' => 1,
            'rol_id' => 5,
            // Cambiar esto:
            'estado' => defined('REQUIRE_EMAIL_VERIFICATION') && REQUIRE_EMAIL_VERIFICATION ? 'Pendiente' : 'Activo'
        ];
        
        // Validar datos
        $errors = [];
        
        if (empty($data['username'])) {
            $errors[] = "El nombre de usuario es obligatorio";
        }
        
        if (empty($data['email'])) {
            $errors[] = "El correo electrónico es obligatorio";
        } elseif (!filter_var($data['email'], FILTER_VALIDATE_EMAIL)) {
            $errors[] = "El formato del correo electrónico no es válido";
        }
        
        if (empty($data['password'])) {
            $errors[] = "La contraseña es obligatoria";
        } elseif (strlen($data['password']) < 6) {
            $errors[] = "La contraseña debe tener al menos 6 caracteres";
        } elseif ($data['password'] !== $data['password_confirmation']) {
            $errors[] = "Las contraseñas no coinciden";
        }
        
        // Si hay errores, mostrar formulario con errores
        if (!empty($errors)) {
            return $this->renderWithLayout('auth/register', 'auth', [
                'errors' => $errors,
                'title' => 'Registro de Usuario',
                'data' => $data // Para mantener los datos ingresados
            ]);
        }
        
        // Intentar registrar al usuario
        error_log('Estado del usuario al registrar: ' . $data['estado']);

        $userModel = new \App\Models\Usuario();
        $result = $userModel->register($data);
        
        if ($result) {
            $userId = $result;
            
            // Verificar si se requiere verificación por correo
            if (defined('REQUIRE_EMAIL_VERIFICATION') && REQUIRE_EMAIL_VERIFICATION) {
                $userModel->update($userId, ['estado' => 'Pendiente']);
                
                // Generar código de verificación
                $verificationModel = new \App\Models\VerificationCode();
                $code = $verificationModel->createForUser($userId);
                
                // Guardar datos en sesión para la verificación
                $_SESSION['pending_verification'] = [
                    'user_id' => $userId,
                    'email' => $data['email'],  // Asegúrate de que esta variable existe en tu contexto
                    'name' => $data['nombre_completo']   // Asegúrate de que esta variable existe en tu contexto
                ];
                
                // Enviar código por correo
                $emailService = new \App\Helpers\EmailService();
                $emailService->sendVerificationCode($data['email'], $data['nombre_completo'], $code);
                
                // Redirigir a la página de verificación
                $this->redirect('auth/verify');
                return;
            } else {
                // Si no se requiere verificación, continuar con el flujo normal
                $_SESSION['flash_message'] = 'Registro exitoso. Ya puedes iniciar sesión.';
                $_SESSION['flash_type'] = 'success';
                $this->redirect('login');
                return;
            }
        } else {
            // Error en el registro
            $errors[] = "No se pudo completar el registro. El usuario o correo ya existe.";
            return $this->renderWithLayout('auth/register', 'auth', [
                'errors' => $errors,
                'title' => 'Registro de Usuario',
                'data' => $data // Para mantener los datos ingresados
            ]);
        }
    }
    
    /**
     * Muestra y procesa la verificación del código
     */
    public function verify() {
        // Si no hay verificación pendiente, redirigir a login
        if (!isset($_SESSION['pending_verification'])) {
            $this->redirect('login');
            return;
        }
        
        // Si es POST, verificar el código
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            $code = trim($_POST['code'] ?? '');
            $userId = $_SESSION['pending_verification']['user_id'];
            
            if (empty($code)) {
                return $this->renderWithLayout('auth/verify', 'auth', [
                    'error' => 'Ingrese el código de verificación',
                    'email' => $_SESSION['pending_verification']['email'],
                    'title' => 'Verificación de Cuenta'
                ]);
            }
            
            // Verificar el código
            $verificationModel = new \App\Models\VerificationCode();
            $isValid = $verificationModel->verifyCode($userId, $code);
            
            if ($isValid) {
                // Activar el usuario
                $userModel = new \App\Models\Usuario();
                $userModel->update($userId, ['estado' => 'Activo']);
                
                // Limpiar datos de verificación pendiente
                unset($_SESSION['pending_verification']);
                
                // Mensaje de éxito
                $_SESSION['flash_message'] = 'Cuenta verificada correctamente. Ya puedes iniciar sesión.';
                $_SESSION['flash_type'] = 'success';
                
                $this->redirect('login');
                return;
            } else {
                return $this->renderWithLayout('auth/verify', 'auth', [
                    'error' => 'Código de verificación inválido o expirado',
                    'email' => $_SESSION['pending_verification']['email'],
                    'title' => 'Verificación de Cuenta'
                ]);
            }
        }
        
        // Mostrar formulario de verificación
        return $this->renderWithLayout('auth/verify', 'auth', [
            'email' => $_SESSION['pending_verification']['email'],
            'title' => 'Verificación de Cuenta'
        ]);
    }
    
    /**
     * Reenvía el código de verificación
     */
    public function resendCode() {
        if (!isset($_SESSION['pending_verification'])) {
            $this->redirect('login');
            return;
        }
        
        $userId = $_SESSION['pending_verification']['user_id'];
        $email = $_SESSION['pending_verification']['email'];
        $name = $_SESSION['pending_verification']['name'];
        
        // Generar nuevo código
        $verificationModel = new \App\Models\VerificationCode();
        $code = $verificationModel->createForUser($userId);
        
        // Enviar código
        $emailService = new \App\Helpers\EmailService();
        $sent = $emailService->sendVerificationCode($email, $name, $code);
        
        if ($sent) {
            $_SESSION['flash_message'] = 'Código de verificación reenviado correctamente.';
            $_SESSION['flash_type'] = 'success';
        } else {
            $_SESSION['flash_message'] = 'Error al enviar el código. Inténtelo de nuevo.';
            $_SESSION['flash_type'] = 'danger';
        }
        
        $this->redirect('auth/verify');
    }
    
    /**
     * Muestra y procesa la verificación del código de 2FA
     */
    public function verifyLogin() {
        // Si no hay verificación 2FA pendiente, redirigir a login
        if (!isset($_SESSION['pending_2fa'])) {
            $this->redirect('login');
            return;
        }
        
        // Si es POST, verificar el código
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            $code = trim($_POST['code'] ?? '');
            $userId = $_SESSION['pending_2fa']['user_id'];
            
            if (empty($code)) {
                return $this->renderWithLayout('auth/verify-login', 'auth', [
                    'error' => 'Ingrese el código de verificación',
                    'email' => $_SESSION['pending_2fa']['email'],
                    'title' => 'Verificación de Inicio de Sesión'
                ]);
            }
            
            // Verificar el código
            $verificationModel = new \App\Models\VerificationCode();
            $isValid = $verificationModel->verifyCode($userId, $code, 'login_verification');
            
            if ($isValid) {
                // Recuperar datos del usuario y establecer sesión
                $userModel = new \App\Models\Usuario();
                $user = $userModel->findById($userId);
                
                $_SESSION['user_id'] = $user['id'];
                $_SESSION['user_name'] = $user['nombre_completo'];
                $_SESSION['user_role'] = $user['rol_id'];
                
                // Actualizar último acceso
                $userModel->update($user['id'], [
                    'ultimo_acceso' => date('Y-m-d H:i:s')
                ]);
                
                // Limpiar datos de verificación pendiente
                unset($_SESSION['pending_2fa']);
                
                // Mensaje de éxito
                $_SESSION['flash_message'] = 'Inicio de sesión completado correctamente.';
                $_SESSION['flash_type'] = 'success';
                
                $this->redirect('');
                return;
            } else {
                return $this->renderWithLayout('auth/verify-login', 'auth', [
                    'error' => 'Código de verificación inválido o expirado',
                    'email' => $_SESSION['pending_2fa']['email'],
                    'title' => 'Verificación de Inicio de Sesión'
                ]);
            }
        }
        
        // Mostrar formulario de verificación
        return $this->renderWithLayout('auth/verify-login', 'auth', [
            'email' => $_SESSION['pending_2fa']['email'],
            'title' => 'Verificación de Inicio de Sesión'
        ]);
    }
    
    /**
     * Reenvía el código de verificación para 2FA
     */
    public function resendLoginCode() {
        if (!isset($_SESSION['pending_2fa'])) {
            $this->redirect('login');
            return;
        }
        
        $userId = $_SESSION['pending_2fa']['user_id'];
        $email = $_SESSION['pending_2fa']['email'];
        $name = $_SESSION['pending_2fa']['name'];
        
        // Generar nuevo código
        $verificationModel = new \App\Models\VerificationCode();
        $code = $verificationModel->createForUser($userId, 'login_verification');
        
        // Enviar código
        $emailService = new \App\Helpers\EmailService();
        $sent = $emailService->sendVerificationCode($email, $name, $code);
        
        if ($sent) {
            $_SESSION['flash_message'] = 'Código de verificación reenviado correctamente.';
            $_SESSION['flash_type'] = 'success';
        } else {
            $_SESSION['flash_message'] = 'Error al enviar el código. Inténtelo de nuevo.';
            $_SESSION['flash_type'] = 'danger';
        }
        
        $this->redirect('auth/verify-login');
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\Controllers\Controller.php
=============================================================

<?php
namespace App\Controllers;

abstract class Controller {
    protected $view;
    protected $model;
    
    public function __construct() {
        $this->view = new \App\Helpers\View();
    }
    
    /**
     * Método para renderizar una vista
     */
    protected function render($view, $data = []) {
        $this->view->render($view, $data);
    }
    
    /**
     * Método para renderizar una vista con un layout
     */
    protected function renderWithLayout($view, $layout = 'default', $data = []) {
        $this->view->renderWithLayout($view, $layout, $data);
    }
    
    /**
     * Método para validar datos de formulario
     */
    protected function validate($data, $rules) {
        $validator = new \App\Helpers\Validator();
        return $validator->validate($data, $rules);
    }
    
    /**
     * Método para redireccionar
     */
    protected function redirect($url) {
        \App\Helpers\Router::redirect($url);
    }
    
    /**
     * Método para obtener el usuario actual
     */
    protected function getCurrentUser() {
        if (isset($_SESSION['user_id'])) {
            $userModel = new \App\Models\Usuario();
            return $userModel->findById($_SESSION['user_id']);
        }
        return null;
    }
    
    /**
     * Método para verificar si el usuario está autenticado
     */
    protected function isAuthenticated() {
        return isset($_SESSION['user_id']);
    }
    
    /**
     * Renderiza una página de error
     *
     * @param int $code Código de error HTTP
     * @param string $message Mensaje de error
     */
    protected function renderError($code, $message = '') {
        http_response_code($code);
        
        // Si es un error 404, usar la vista específica
        if ($code === 404) {
            $this->renderWithLayout('errors/404', 'default', [
                'title' => 'Página no encontrada',
                'message' => $message
            ]);
        } else {
            // Para otros códigos, usar una vista genérica de error
            $this->renderWithLayout('errors/general', 'default', [
                'code' => $code,
                'title' => 'Error ' . $code,
                'message' => $message
            ]);
        }
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\Controllers\Education.php
=============================================================

<?php
namespace App\Controllers;

use App\Core\Controller;
use App\Models\EducationModel;

class Education extends Controller {
    private $model;
    
    public function __construct() {
        $this->model = new EducationModel();
    }
    
    // Obtener datos educativos por país
    public function getEducationData($pais) {
        // Obtener datos de instituciones y carreras por país y nivel educativo
        $data = $this->model->getEducationDataByCountry($pais);
        
        // Devolver respuesta JSON
        header('Content-Type: application/json');
        echo json_encode($data);
    }
    
    // Guardar nueva institución
    public function saveInstitution() {
        // Obtener datos del POST (formato JSON)
        $data = json_decode(file_get_contents('php://input'), true);
        
        // Validar datos
        if (!isset($data['pais']) || !isset($data['nivel']) || !isset($data['nombre'])) {
            http_response_code(400);
            echo json_encode(['error' => 'Datos incompletos']);
            return;
        }
        
        // Guardar nueva institución
        $result = $this->model->saveInstitution($data['pais'], $data['nivel'], $data['nombre']);
        
        // Devolver respuesta
        header('Content-Type: application/json');
        echo json_encode($result);
    }
    
    // Guardar nueva profesión
    public function saveProfession() {
        // Obtener datos del POST (formato JSON)
        $data = json_decode(file_get_contents('php://input'), true);
        
        // Validar datos
        if (!isset($data['pais']) || !isset($data['nivel']) || 
            !isset($data['institucionId']) || !isset($data['nombre'])) {
            http_response_code(400);
            echo json_encode(['error' => 'Datos incompletos']);
            return;
        }
        
        // Guardar nueva profesión
        $result = $this->model->saveProfession(
            $data['pais'], 
            $data['nivel'], 
            $data['institucionId'], 
            $data['nombre']
        );
        
        // Devolver respuesta
        header('Content-Type: application/json');
        echo json_encode($result);
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\Controllers\HomeController.php
=============================================================

<?php
// filepath: /Applications/XAMPP/xamppfiles/htdocs/Encasa_Database/app/Controllers/HomeController.php
namespace App\Controllers;

class HomeController extends Controller {
    public function index() {
        $title = 'Bienvenido a Iglesia En Casa';
        $this->renderWithLayout('home/index', 'default', [
            'title' => $title,
            'user' => $this->getCurrentUser()
        ]);
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\Controllers\MiembrosController.php
=============================================================

<?php


namespace App\Controllers;

use App\Models\Miembro;
use App\Models\Contacto;
use App\Models\EstudiosTrabajo;
use App\Models\Tallas;
use App\Models\CarreraBiblica;
use App\Models\SaludEmergencias;
use Exception;

class MiembrosController extends Controller {
    private $miembroModel;
    private $contactoModel;
    private $estudiosTrabajoModel;
    private $tallasModel;
    private $saludEmergenciasModel;
    private $carreraBiblicaModel;
    private $db;
    
    public function __construct() {
        parent::__construct();
        $this->miembroModel = new Miembro();
        $this->contactoModel = new Contacto();
        $this->estudiosTrabajoModel = new EstudiosTrabajo();
        $this->tallasModel = new Tallas();
        $this->saludEmergenciasModel = new SaludEmergencias();
        $this->carreraBiblicaModel = new CarreraBiblica();
        $this->db = \Database::getInstance()->getConnection();
    }
    
    /**
     * Muestra el listado de miembros
     */
    public function index() {
        // Obtener parámetros de filtrado y paginación
        $busqueda = isset($_GET['busqueda']) ? $_GET['busqueda'] : '';
        $pagina = isset($_GET['pagina']) ? (int)$_GET['pagina'] : 1;
        $porPagina = 10;
        
        // Obtener miembros según filtros
        if (!empty($busqueda)) {
            $miembros = $this->miembroModel->buscar($busqueda);
            $totalMiembros = count($miembros);
        } else {
            $miembros = $this->miembroModel->getAll();
            $totalMiembros = count($miembros);
        }
        
        // Implementar paginación manual básica
        $totalPaginas = ceil($totalMiembros / $porPagina);
        $offset = ($pagina - 1) * $porPagina;
        $miembrosPaginados = array_slice($miembros, $offset, $porPagina);
        
        return $this->renderWithLayout('miembros/index', 'default', [
            'miembros' => $miembrosPaginados,
            'busqueda' => $busqueda,
            'pagina' => $pagina,
            'totalPaginas' => $totalPaginas,
            'title' => 'Directorio de Miembros'
        ]);
    }
    
    /**
     * Muestra el formulario para crear un nuevo miembro
     */
    public function crear() {
        return $this->renderWithLayout('miembros/crear', 'default', [
            'title' => 'Registrar Nuevo Miembro'
        ]);
    }
    
    /**
     * Método para guardar un nuevo miembro
     */
    public function guardar() {
        // Verificar que sea una petición POST
        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            $this->redirect('miembros');
            return;
        }
        
        // Obtener y validar datos básicos
        $datos = [
            'nombres' => htmlspecialchars($_POST['nombres'] ?? ''),
            'apellidos' => htmlspecialchars($_POST['apellidos'] ?? ''),
            'celular' => htmlspecialchars($_POST['celular'] ?? ''),
            'localidad' => htmlspecialchars($_POST['localidad'] ?? ''),
            'barrio' => htmlspecialchars($_POST['barrio'] ?? ''),
            'fecha_nacimiento' => $_POST['fecha_nacimiento'] ?? null,
            'invitado_por' => !empty($_POST['invitado_por']) ? (int)$_POST['invitado_por'] : null,
            'conector' => htmlspecialchars($_POST['conector'] ?? ''),
            'recorrido_espiritual' => htmlspecialchars($_POST['recorrido_espiritual'] ?? ''),
            'estado_espiritual' => htmlspecialchars($_POST['estado_espiritual'] ?? ''),
            'habeas_data' => isset($_POST['habeas_data']) ? 1 : 0,
        ];
        
        // Validar campos requeridos
        if (empty($datos['nombres']) || empty($datos['apellidos']) || empty($datos['celular'])) {
            $_SESSION['flash_message'] = 'Por favor complete los campos obligatorios';
            $_SESSION['flash_type'] = 'danger';
            $this->redirect('miembros/crear');
            return;
        }
        
        // Procesar la foto si se subió
        if (!empty($_FILES['foto']['name'])) {
            $foto = $this->procesarFoto($_FILES['foto']);
            if ($foto) {
                $datos['foto'] = $foto;
            }
        }
        
        // Guardar información general y obtener el ID insertado
        $miembroId = $this->miembroModel->crear($datos);
        
        if (!$miembroId) {
            $_SESSION['flash_message'] = 'Error al guardar la información del miembro';
            $_SESSION['flash_type'] = 'danger';
            $this->redirect('miembros/crear');
            return;
        }
        
        // Guardar información de contacto
        if (isset($_POST['contacto']) && is_array($_POST['contacto'])) {
            $contacto = $_POST['contacto'];
            $contacto['miembro_id'] = $miembroId;
            $this->miembroModel->guardarContacto($contacto);
        }
        
        // Guardar información de estudios y trabajo
        if (isset($_POST['estudios']) && is_array($_POST['estudios'])) {
            $estudios = $_POST['estudios'];
            $estudios['miembro_id'] = $miembroId;
            $this->miembroModel->guardarEstudiosTrabajo($estudios);
        }
        
        // Guardar tallas
        if (isset($_POST['tallas']) && is_array($_POST['tallas'])) {
            $tallas = $_POST['tallas'];
            $tallas['miembro_id'] = $miembroId;
            $this->miembroModel->guardarTallas($tallas);
        }
        
        // Guardar información de salud y emergencias
        if (isset($_POST['salud']) && is_array($_POST['salud'])) {
            $salud = $_POST['salud'];
            $salud['miembro_id'] = $miembroId;
            $this->miembroModel->guardarSaludEmergencias($salud);
        }
        
        // Guardar información de carrera bíblica
        if (isset($_POST['carrera']) && is_array($_POST['carrera'])) {
            $carrera = $_POST['carrera'];
            $carrera['miembro_id'] = $miembroId;
            $this->miembroModel->guardarCarreraBiblica($carrera);
        }
        
        $_SESSION['flash_message'] = 'Miembro registrado exitosamente';
        $_SESSION['flash_type'] = 'success';
        $this->redirect('miembros/' . $miembroId);
    }

    /**
     * Procesa y guarda la foto subida
     */
    private function procesarFoto($archivo) {
        // Añadir depuración
        error_log("Procesando foto: " . print_r($archivo, true));
        
        // Verificar si hubo errores en la carga
        if ($archivo['error'] !== UPLOAD_ERR_OK) {
            error_log("Error de carga: " . $this->getFileUploadErrorMessage($archivo['error']));
            return false;
        }
        
        // Modificar la ruta para que sea coherente con donde se busca después
        $directorio = '../public/uploads/miembros/';
        
        // Crear directorio si no existe
        if (!file_exists($directorio)) {
            mkdir($directorio, 0777, true);
        }
        
        // Validar el archivo
        $tiposPermitidos = ['image/jpeg', 'image/png', 'image/gif'];
        if (!in_array($archivo['type'], $tiposPermitidos)) {
            return false;
        }
        
        // Generar nombre único
        $nombreArchivo = uniqid() . '_' . basename($archivo['name']);
        $rutaArchivo = $directorio . $nombreArchivo;
        
        // Mover el archivo
        if (move_uploaded_file($archivo['tmp_name'], $rutaArchivo)) {
            return $nombreArchivo;
        }
        
        return false;
    }
    
    /**
     * Obtiene y muestra el perfil completo del miembro
     */
    public function ver($id)
    {
        // Asegurarse de que el ID sea un entero
        if (is_array($id)) {
            $id = $id[0]; // En caso de que el router pase un array
        }
        $id = (int)$id;
        
        error_log("Controlador: Buscando miembro con ID: $id");
        
        // Obtener datos del miembro desde el modelo
        $miembro = $this->miembroModel->getFullProfile($id);
        
        if (!$miembro) {
            error_log("Controlador: No se encontró miembro con ID: $id");
            $_SESSION['flash_message'] = 'Miembro no encontrado';
            $_SESSION['flash_type'] = 'danger';
            
            // Redirigir a la lista de miembros
            header("Location: " . url('miembros'));
            exit;
        }
        
        error_log("Controlador: Miembro encontrado, renderizando vista");
        
        // Renderizar la vista con los datos del miembro
        return $this->renderWithLayout('miembros/ver', 'default', [
            'title' => $miembro['nombres'] . ' ' . $miembro['apellidos'],
            'miembro' => $miembro
        ]);
    }

    private function obtenerDatosRelacionados($db, $miembroId, $tabla)
    {
        $stmt = $db->prepare("SELECT * FROM {$tabla} WHERE miembro_id = ?");
        $stmt->execute([$miembroId]);
        $datos = $stmt->fetch(\PDO::FETCH_ASSOC);
        
        if ($datos) {
            // Eliminar campos redundantes
            unset($datos['id']);
            unset($datos['miembro_id']);
            unset($datos['fecha_actualizacion']);
            return $datos;
        }
        
        return [];
    }

    /**
     * Muestra el formulario para editar un miembro
     */
    public function editar($id = null)
    {
        error_log("Iniciando edición para ID: " . print_r($id, true));
        
        try {
            // Si es un array, tomar el primer elemento
            if (is_array($id)) {
                $id = isset($id[0]) ? $id[0] : null;
            }
            
            // Verificar que tenemos un ID válido
            if (!$id || !is_numeric($id)) {
                $_SESSION['flash_message'] = "ID de miembro no válido";
                $_SESSION['flash_type'] = "danger";
                $this->redirect('miembros');
                return;
            }
            
            $id = (int)$id;
            
            // Antes de buscar, verificar si el ID existe
            $existe = $this->miembroModel->existeId($id);
            error_log("Verificación de existencia para ID $id: " . ($existe ? 'Existe' : 'No existe'));
            
            if (!$existe) {
                $_SESSION['flash_message'] = "El miembro con ID $id no existe. Por favor utilice uno de los miembros disponibles.";
                $_SESSION['flash_type'] = "danger";
                
                // Redirigir a la lista de miembros
                $this->redirect('miembros');
                return;
            }

            // Si existe, continuar con el proceso normal
            $miembro = $this->miembroModel->getFullProfile($id);
            
            if (!$miembro) {
                error_log("Controlador: No se encontró miembro con ID: $id para editar");
                $_SESSION['flash_message'] = 'Miembro no encontrado';
                $_SESSION['flash_type'] = 'danger';
                $this->redirect('miembros');
                return;
            }
            
            error_log("Controlador: Miembro encontrado, mostrando formulario de edición");
            
            return $this->renderWithLayout('miembros/editar', 'default', [
                'miembro' => $miembro,
                'title' => 'Editar Miembro: ' . $miembro['nombres'] . ' ' . $miembro['apellidos']
            ]);
        } catch (\Exception $e) {
            error_log("Error en editar: " . $e->getMessage());
            $_SESSION['flash_message'] = "Error al cargar el formulario de edición: " . $e->getMessage();
            $_SESSION['flash_type'] = "danger";
            $this->redirect('miembros');
        }
    }

    /**
     * Procesa el formulario de edición y actualiza el miembro
     */
    public function actualizar($id)
    {
        try {
            // Limpiar y verificar ID
            $id = (int)$id;
            
            // Registrar datos recibidos para depuración avanzada
            error_log("POST completo recibido: " . print_r($_POST, true));
            
            // Verificar la estructura de los datos para cada tabla
            if (isset($_POST['estudios'])) {
                error_log("Datos de estudios: " . print_r($_POST['estudios'], true));
            } else {
                error_log("No se recibieron datos de estudios");
            }
            
            if (isset($_POST['tallas'])) {
                error_log("Datos de tallas: " . print_r($_POST['tallas'], true));
            } else {
                error_log("No se recibieron datos de tallas");
            }
            
            // Verificar método de solicitud
            if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
                throw new \Exception("Método no permitido");
            }
            
            // Verificar que el miembro existe
            $miembro = $this->miembroModel->getFullProfile($id);
            
            if (!$miembro) {
                throw new \Exception("El miembro no existe");
            }
            
            // Preparar los datos para actualizar la tabla principal
            $datosGenerales = [
                'nombres' => isset($_POST['nombres']) ? trim($_POST['nombres']) : $miembro['nombres'],
                'apellidos' => isset($_POST['apellidos']) ? trim($_POST['apellidos']) : $miembro['apellidos'],
                'celular' => isset($_POST['celular']) ? trim($_POST['celular']) : $miembro['celular'],
                'localidad' => isset($_POST['localidad']) ? trim($_POST['localidad']) : $miembro['localidad'],
                'barrio' => isset($_POST['barrio']) ? trim($_POST['barrio']) : $miembro['barrio'],
                'fecha_nacimiento' => isset($_POST['fecha_nacimiento']) ? trim($_POST['fecha_nacimiento']) : $miembro['fecha_nacimiento'],
                'conector' => isset($_POST['conector']) ? trim($_POST['conector']) : $miembro['conector'],
                'estado_espiritual' => isset($_POST['estado_espiritual']) ? trim($_POST['estado_espiritual']) : $miembro['estado_espiritual'],
                'fecha_ingreso_iglesia' => isset($_POST['fecha_ingreso_iglesia']) ? trim($_POST['fecha_ingreso_iglesia']) : $miembro['fecha_ingreso_iglesia'],
                'estado_miembro' => isset($_POST['estado_miembro']) ? trim($_POST['estado_miembro']) : $miembro['estado_miembro'],
            ];
            
            error_log("Datos preparados para actualizar: " . print_r($datosGenerales, true));
            
            // Ejecutar directamente la consulta SQL para mayor control
            $db = \Database::getInstance()->getConnection();
            
            // Construir la consulta SQL dinámicamente
            $setClausulas = [];
            $valores = [];
            
            foreach ($datosGenerales as $campo => $valor) {
                $setClausulas[] = "$campo = ?";
                $valores[] = $valor;
            }
            
            // Añadir ID al final de los valores
            $valores[] = $id;
            
            $sql = "UPDATE informaciongeneral SET " . implode(', ', $setClausulas) . " WHERE id = ?";
            error_log("SQL a ejecutar: " . $sql);
            error_log("Valores: " . implode(', ', $valores));
            
            $stmt = $db->prepare($sql);
            $resultadoGeneral = $stmt->execute($valores);
            error_log("Resultado de actualización: " . ($resultadoGeneral ? "Éxito" : "Fallido") . " - Filas afectadas: " . $stmt->rowCount());
            
            if (!$resultadoGeneral) {
                throw new \Exception("Error al actualizar la información general del miembro");
            }
            
            // AÑADIR ESTE BLOQUE - Procesar la foto si se subió una nueva
            if (!empty($_FILES['foto']) && $_FILES['foto']['error'] === UPLOAD_ERR_OK) {
                $foto = $this->procesarFoto($_FILES['foto']);
                if ($foto) {
                    $datosGenerales['foto'] = $foto;
                    
                    // Si había una foto anterior, eliminarla
                    if (!empty($miembro['foto'])) {
                        $rutaAnterior = '../public/uploads/miembros/' . $miembro['foto'];
                        if (file_exists($rutaAnterior)) {
                            unlink($rutaAnterior);
                        }
                    }
                } else {
                    error_log("Error procesando la foto subida");
                }
            }
            
            // Comprobar si se debe eliminar la foto actual
            if (isset($_POST['eliminar_foto']) && $_POST['eliminar_foto'] == '1' && !empty($miembro['foto'])) {
                $rutaAnterior = '../public/uploads/miembros/' . $miembro['foto'];
                if (file_exists($rutaAnterior)) {
                    unlink($rutaAnterior);
                }
                $datosGenerales['foto'] = null; // Establecer foto como nula en la base de datos
            }
            
            // Actualizar tablas relacionadas
            $this->actualizarTablasRelacionadas($id, $_POST);
            
            // Respuesta según tipo de petición
            if ($this->esAjax()) {
                $this->responderJson([
                    'success' => true,
                    'message' => 'Miembro actualizado correctamente',
                    'redirect' => url('miembros/'.$id)
                ]);
                return; // No continuar ejecución
            } else {
                // Para formularios tradicionales
                $_SESSION['flash_message'] = "Miembro actualizado correctamente";
                $_SESSION['flash_type'] = "success";
                $this->redirect('miembros/'.$id);
            }
            
        } catch (\Exception $e) {
            error_log("Error en actualización: " . $e->getMessage());
            
            if ($this->esAjax()) {
                $this->responderJson([
                    'success' => false,
                    'message' => 'Error: ' . $e->getMessage()
                ]);
                return; // No continuar ejecución
            } else {
                $_SESSION['flash_message'] = "Error: " . $e->getMessage();
                $_SESSION['flash_type'] = "danger";
                $this->redirect('miembros/editar/'.$id);
            }
        }
    }

    // Método auxiliar para detectar si es una petición AJAX
    private function esAjax() {
        if (!empty($_SERVER['HTTP_X_REQUESTED_WITH']) && 
            strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest') {
            return true;
        }
        
        if (isset($_SERVER['HTTP_ACCEPT']) && 
            strpos($_SERVER['HTTP_ACCEPT'], 'application/json') !== false) {
            return true;
        }
        
        // Comprobar si el cliente está esperando JSON explícitamente
        if (isset($_SERVER['CONTENT_TYPE']) && 
            strpos($_SERVER['CONTENT_TYPE'], 'application/json') !== false) {
            return true;
        }
        
        return false;
    }

    // Método para actualizar tablas relacionadas
    private function actualizarTablasRelacionadas($id, $datos) {
        try {
            $id = (int)$id;
            $db = \Database::getInstance()->getConnection();
            $tablasActualizadas = [];
            
            // Mapeo de nombres de campos
            $mapeoNombres = [
                'estudios' => [
                    'nivel_educativo' => 'nivel_estudios',
                    // Otros mapeos necesarios
                ],
                'salud' => [
                    'grupo_sanguineo' => 'tipo_sangre',
                    // Otros mapeos necesarios
                ]
            ];
            
            // 1. Actualizar tabla contacto (sin cambios)
            
            // 2. Actualizar tabla estudios y trabajo
            if (isset($datos['estudios']) && is_array($datos['estudios'])) {
                // Convertir nombres de campos si es necesario
                $datosEstudios = $datos['estudios'];
                foreach ($mapeoNombres['estudios'] as $nombreVista => $nombreDB) {
                    if (isset($datosEstudios[$nombreVista])) {
                        $datosEstudios[$nombreDB] = $datosEstudios[$nombreVista];
                        unset($datosEstudios[$nombreVista]);
                    }
                }
                
                $tablasActualizadas[] = $this->actualizarTablaRelacionada(
                    $id, 'estudiostrabajo', $datosEstudios
                );
            }
            
            // 3. Actualizar tabla tallas
            if (isset($datos['tallas']) && is_array($datos['tallas'])) {
                $datosTallas = [];
                
                // Mapear los nombres del formulario a los nombres de columnas
                if (isset($datos['tallas']['camisa'])) $datosTallas['talla_camisa'] = $datos['tallas']['camisa'];
                if (isset($datos['tallas']['camiseta'])) $datosTallas['talla_camiseta'] = $datos['tallas']['camiseta'];
                if (isset($datos['tallas']['pantalon'])) $datosTallas['talla_pantalon'] = $datos['tallas']['pantalon'];
                if (isset($datos['tallas']['zapatos'])) $datosTallas['talla_zapatos'] = $datos['tallas']['zapatos'];
                
                $tablasActualizadas[] = $this->actualizarTablaRelacionada(
                    $id, 'tallas', $datosTallas
                );
            }
            
            // 4. Actualizar tabla salud y emergencias
            if (isset($datos['salud']) && is_array($datos['salud'])) {
                // Mapear 'grupo_sanguineo' a 'rh'
                if (isset($datos['salud']['grupo_sanguineo'])) {
                    $datos['salud']['rh'] = $datos['salud']['grupo_sanguineo'];
                    unset($datos['salud']['grupo_sanguineo']);
                }
                
                $tablasActualizadas[] = $this->actualizarTablaRelacionada(
                    $id, 'saludemergencias', $datos['salud']
                );
            }
            
            // 5. Actualizar tabla carrera bíblica
            if (isset($datos['carrera']) && is_array($datos['carrera'])) {
                $datosCarrera = $datos['carrera'];
                $tablasActualizadas[] = $this->actualizarTablaRelacionada(
                    $id, 'carrerabiblica', $datosCarrera
                );
            }
            
            return true;
        } catch (\Exception $e) {
            error_log("Error al actualizar tablas relacionadas: " . $e->getMessage());
            return false;
        }
    }

    // Método auxiliar para actualizar cada tabla relacionada
    private function actualizarTablaRelacionada($miembroId, $tabla, $datos) {
        try {
            // Filtrar campos que no corresponden a columnas en la base de datos
            if ($tabla == 'estudiostrabajo') {
                // Eliminar campos auxiliares
                unset($datos['institucion_educativa_select']);
                unset($datos['institucion_personalizada']);
                unset($datos['profesion_select']);
                unset($datos['profesion_personalizada']);
            }
            
            $db = \Database::getInstance()->getConnection();
            
            // Añadir el ID del miembro a los datos
            $datos['miembro_id'] = $miembroId;
            
            // Verificar si ya existe registro para este miembro en esta tabla
            $checkStmt = $db->prepare("SELECT COUNT(*) FROM {$tabla} WHERE miembro_id = ?");
            $checkStmt->execute([$miembroId]);
            $existe = (int)$checkStmt->fetchColumn() > 0;
            
            // Preparar los campos y valores para la consulta
            $setClausulas = [];
            $campos = [];
            $valores = [];
            $placeholders = [];
            
            // Procesar cada campo, excepto 'miembro_id' que ya lo manejamos por separado
            foreach ($datos as $campo => $valor) {
                // Validación básica de los datos
                if ($campo === 'miembro_id') {
                    continue; // Lo manejamos por separado para evitar duplicación
                }
                
                // Añadir a la lista correspondiente según operación
                if ($existe) {
                    $setClausulas[] = "$campo = ?";
                } else {
                    $campos[] = $campo;
                    $placeholders[] = "?";
                }
                
                // Añadir valor a la lista de valores
                $valores[] = $valor;
            }
            
            // Si existe registro, actualizar
            if ($existe) {
                if (empty($setClausulas)) {
                    error_log("No hay campos para actualizar en tabla $tabla");
                    return null;
                }
                
                // Añadir el miembro_id al final de los valores para el WHERE
                $valores[] = $miembroId;
                
                $sql = "UPDATE {$tabla} SET " . implode(', ', $setClausulas) . " WHERE miembro_id = ?";
                $stmt = $db->prepare($sql);
                $resultado = $stmt->execute($valores);
                
                error_log("SQL UPDATE para tabla $tabla: " . $sql);
                error_log("Valores: " . implode(", ", $valores));
                error_log("Resultado actualización $tabla: " . ($resultado ? "Éxito" : "Error") . " - Filas: " . $stmt->rowCount());
                
                return $resultado ? $tabla : null;
            } 
            // Si no existe, crear nuevo registro
            else {
                // Añadir miembro_id a la lista de campos y valores
                $campos[] = 'miembro_id';
                $placeholders[] = "?";
                $valores[] = $miembroId;
                
                $sql = "INSERT INTO {$tabla} (" . implode(', ', $campos) . ") VALUES (" . implode(', ', $placeholders) . ")";
                $stmt = $db->prepare($sql);
                $resultado = $stmt->execute($valores);
                
                error_log("SQL INSERT para tabla $tabla: " . $sql);
                error_log("Valores: " . implode(", ", $valores));
                error_log("Resultado inserción $tabla: " . ($resultado ? "Éxito" : "Error"));
                
                return $resultado ? $tabla : null;
            }
        } catch (\Exception $e) {
            error_log("Error al actualizar tabla $tabla: " . $e->getMessage());
            return null;
        }
    }

    /**
     * Elimina un miembro y todos sus datos relacionados
     */
    public function eliminar($id)
    {
        // Añadir estos logs para depuración
        error_log("Iniciando eliminación, ID recibido: " . print_r($id, true));
        
        // Mejorar el manejo del ID
        if (is_array($id)) {
            $id = isset($id[0]) && !empty($id[0]) ? $id[0] : null;
            error_log("ID procesado de array: " . ($id ?? 'null'));
        }
        
        // Validar que el ID sea un valor numérico válido
        if ($id === null || !is_numeric($id) || (int)$id <= 0) {
            $_SESSION['flash_message'] = 'ID de miembro inválido o no proporcionado';
            $_SESSION['flash_type'] = 'danger';
            $this->redirect('miembros');
            return;
        }
        
        $id = (int)$id;
        error_log("ID final validado a procesar: $id");
        
        // Obtener el miembro completo
        $miembro = $this->miembroModel->getFullProfile($id);
        error_log("Resultado de getFullProfile: " . ($miembro ? "Miembro encontrado" : "Miembro NO encontrado"));
        
        if (!$miembro) {
            $_SESSION['flash_message'] = "Miembro con ID $id no encontrado";
            $_SESSION['flash_type'] = 'danger';
            $this->redirect('miembros');
            return;
        }
        
        // Intentar eliminar el miembro y sus datos relacionados
        try {
            // Comenzar una transacción
            $this->db->beginTransaction();
            
            // 1. Eliminar registros de tablas relacionadas
            $tablasRelacionadas = [
                'contacto',
                'estudiostrabajo',
                'tallas',
                'saludemergencias',
                'carrerabiblica'
            ];
            
            foreach ($tablasRelacionadas as $tabla) {
                $stmt = $this->db->prepare("DELETE FROM {$tabla} WHERE miembro_id = ?");
                $stmt->execute([$id]);
                error_log("Eliminación de $tabla: " . ($stmt->rowCount() > 0 ? "Éxito" : "Sin registros"));
            }
            
            // 2. Eliminar foto si existe
            if (!empty($miembro['foto'])) {
                $rutaFoto = BASE_PATH . '/uploads/miembros/' . $miembro['foto'];
                if (file_exists($rutaFoto)) {
                    unlink($rutaFoto);
                    error_log("Foto eliminada: $rutaFoto");
                } else {
                    error_log("No se encontró la foto: $rutaFoto");
                }
            }
            
            // 3. Eliminar el registro principal
            $stmt = $this->db->prepare("DELETE FROM informaciongeneral WHERE id = ?");
            $resultado = $stmt->execute([$id]);
            error_log("Eliminación de registro principal: " . ($resultado ? "Éxito" : "Fallido"));
            
            // Si todo salió bien, confirmar transacción
            if ($resultado) {
                $this->db->commit();
                $_SESSION['flash_message'] = 'Miembro eliminado correctamente';
                $_SESSION['flash_type'] = 'success';
                error_log("Transacción confirmada, miembro eliminado");
            } else {
                // Si hubo algún problema
                $this->db->rollBack();
                $_SESSION['flash_message'] = 'Error al eliminar el miembro';
                $_SESSION['flash_type'] = 'danger';
                error_log("Falló la eliminación del registro principal, transacción revertida");
            }
        } catch (\Exception $e) {
            // En caso de excepción, deshacer cambios
            $this->db->rollBack();
            $_SESSION['flash_message'] = 'Error: ' . $e->getMessage();
            $_SESSION['flash_type'] = 'danger';
            error_log("Excepción al eliminar miembro: " . $e->getMessage());
        }
        
        // Redireccionar a la lista de miembros
        $this->redirect('miembros');
    }

    // Método auxiliar para responder en formato JSON
    private function responderJson($data)
    {
        // Limpiar cualquier salida previa
        if (ob_get_contents()) ob_clean();
        
        // Establecer encabezados correctos
        header('Content-Type: application/json');
        header('Cache-Control: no-cache, must-revalidate');
        
        // Asegurar que no hay salida de errores PHP
        ini_set('display_errors', 0);
        
        // Enviar respuesta JSON
        echo json_encode($data);
        exit; // Importante: detener ejecución
    }

    // Método auxiliar para obtener campos del POST
    private function obtenerDatosPost($campos)
    {
        $datos = [];
        foreach ($campos as $campo) {
            if (isset($_POST[$campo])) {
                $datos[$campo] = $_POST[$campo];
            }
        }
        return $datos;
    }

    /**
     * API para actualizar una sección específica
     */
    public function apiActualizarSeccion() 
    {
        // Asegurar que la respuesta sea JSON
        header('Content-Type: application/json');
        
        try {
            // Verificar método
            if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
                echo json_encode(['success' => false, 'message' => 'Método no permitido']);
                return;
            }
            
            // Obtener parámetros
            $id = isset($_POST['id']) ? (int)$_POST['id'] : 0;
            $tabla = $_POST['tabla'] ?? '';
            $datos = $_POST['datos'] ?? [];
            
            error_log("API actualizar sección - ID: $id, Tabla: $tabla, Datos: " . print_r($datos, true));
            
            // Validaciones
            if (!$id || $id <= 0) {
                echo json_encode(['success' => false, 'message' => 'ID de miembro inválido']);
                return;
            }
            
            if (empty($tabla)) {
                echo json_encode(['success' => false, 'message' => 'Nombre de tabla no especificado']);
                return;
            }
            
            // Verificar que el miembro existe
            if (!$this->miembroModel->existeId($id)) {
                echo json_encode(['success' => false, 'message' => 'El miembro no existe']);
                return;
            }
            
            // Procesar según la tabla
            $resultado = false;
            
            switch ($tabla) {
                case 'informaciongeneral':
                    $resultado = $this->miembroModel->actualizar($id, $datos);
                    break;
                    
                case 'contacto':
                    $resultado = $this->contactoModel->actualizarPorMiembroId($id, $datos);
                    break;
                    
                case 'estudiostrabajo':
                    $resultado = $this->estudiosTrabajoModel->actualizarPorMiembroId($id, $datos);
                    break;
                    
                case 'tallas':
                    $resultado = $this->tallasModel->actualizarPorMiembroId($id, $datos);
                    break;
                    
                case 'saludemergencias':
                    $resultado = $this->saludEmergenciasModel->actualizarPorMiembroId($id, $datos);
                    break;
                    
                case 'carrerabiblica':
                    $resultado = $this->carreraBiblicaModel->actualizarPorMiembroId($id, $datos);
                    break;
                    
                default:
                    echo json_encode(['success' => false, 'message' => 'Tabla no reconocida']);
                    return;
            }
            
            if ($resultado) {
                echo json_encode([
                    'success' => true,
                    'message' => "Sección actualizada correctamente",
                    'tabla' => $tabla
                ]);
            } else {
                echo json_encode([
                    'success' => false,
                    'message' => "Error al actualizar la sección: $tabla"
                ]);
            }
            
        } catch (\Exception $e) {
            error_log("Error en API actualizar sección: " . $e->getMessage());
            echo json_encode([
                'success' => false,
                'message' => "Error: " . $e->getMessage()
            ]);
        }
    }

    private function getFileUploadErrorMessage($error_code) {
        switch ($error_code) {
            case UPLOAD_ERR_INI_SIZE:
                return 'El archivo excede el tamaño máximo permitido en php.ini';
            case UPLOAD_ERR_FORM_SIZE:
                return 'El archivo excede el tamaño máximo permitido en el formulario';
            case UPLOAD_ERR_PARTIAL:
                return 'El archivo fue cargado parcialmente';
            case UPLOAD_ERR_NO_FILE:
                return 'No se seleccionó ningún archivo';
            case UPLOAD_ERR_NO_TMP_DIR:
                return 'Falta la carpeta temporal';
            case UPLOAD_ERR_CANT_WRITE:
                return 'Error al escribir el archivo en el disco';
            case UPLOAD_ERR_EXTENSION:
                return 'La carga fue detenida por una extensión PHP';
            default:
                return 'Error desconocido en la carga: ' . $error_code;
        }
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\Core\Session.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\Core\Session.php

class Session {
    public static function start() {
        // No volver a configurar la sesión si ya está activa
        if (session_status() === PHP_SESSION_ACTIVE) {
            return;
        }
        
        // Configuración básica de seguridad
        ini_set('session.use_only_cookies', 1);
        ini_set('session.use_strict_mode', 1);
        ini_set('session.cookie_httponly', 1);
        
        // Solo habilitar cookies seguras cuando estamos en HTTPS
        if (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on') {
            ini_set('session.cookie_secure', 1);
        }
        
        // Nombre de sesión consistente
        session_name('ENCASASESSID');
        
        // Iniciar la sesión
        session_start();
        
        // Generar token CSRF si no existe
        if (!isset($_SESSION['csrf_token'])) {
            $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
        }
    }
    
    // El resto de métodos...
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\helpers\cors_helper.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\helpers\cors_helper.php

/**
 * Configuración dinámica de CORS para formularios
 * Detecta automáticamente si estamos en túnel o localhost
 */
function setup_cors() {
    // Detectar el entorno
    $is_https = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on';
    $current_host = $_SERVER['HTTP_HOST'];
    $is_tunnel = (strpos($current_host, 'localto.net') !== false || 
                 strpos($current_host, 'loca.lt') !== false || 
                 strpos($current_host, 'serveo.net') !== false);
    
    // Establecer cabeceras CORS apropiadas
    if ($is_tunnel) {
        // Permitir el origen actual en túneles
        $protocol = $is_https ? 'https://' : 'http://';
        $origin = isset($_SERVER['HTTP_ORIGIN']) ? $_SERVER['HTTP_ORIGIN'] : $protocol . $current_host;
        header("Access-Control-Allow-Origin: $origin");
    } else {
        // En localhost ser menos restrictivo
        header("Access-Control-Allow-Origin: *");
    }
    
    // Cabeceras CORS comunes
    header("Access-Control-Allow-Methods: POST, GET, OPTIONS");
    header("Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With");
    header("Access-Control-Allow-Credentials: true");
    
    // Manejar solicitudes preflight OPTIONS
    if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
        header("HTTP/1.1 200 OK");
        exit;
    }
}

/**
 * Genera URLs correctas según el entorno
 */
function form_url($path = '') {
    $current_host = $_SERVER['HTTP_HOST'];
    $is_tunnel = (strpos($current_host, 'localto.net') !== false || 
                 strpos($current_host, 'loca.lt') !== false || 
                 strpos($current_host, 'serveo.net') !== false);
    
    // Construir la base de la URL
    if ($is_tunnel) {
        // En túneles siempre usar HTTPS
        $base_url = "https://$current_host/encasa_database";
    } else {
        // En localhost usar HTTP
        $base_url = "http://$current_host/ENCASA_DATABASE";
    }
    
    // Formatear la URL
    $base_url = rtrim($base_url, '/');
    $path = $path ? '/' . ltrim($path, '/') : '';
    
    return $base_url . $path;
}

// Aplicar CORS automáticamente
setup_cors();


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\helpers\EmailService.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\helpers\EmailService.php
namespace App\Helpers;

use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

class EmailService {
    private $mailer;
    
    /**
     * Constructor: configura el servicio de email
     */
    public function __construct() {
        // Inicializar PHPMailer
        $this->mailer = new PHPMailer(true);
        
        // Cambiar esto:
        if (APP_ENV === 'development') {
            $this->mailer->SMTPDebug = 1; // 1 = errores y mensajes
        }
        
        // Por esto:
        if (APP_ENV === 'development') {
            $this->mailer->SMTPDebug = 0; // 0 = sin depuración
        }
        
        // Esto debería usarse solo en desarrollo
        $this->mailer->SMTPOptions = [
            'ssl' => [
                'verify_peer' => false,
                'verify_peer_name' => false,
                'allow_self_signed' => true
            ]
        ];
        
        // Configurar servidor SMTP
        $this->mailer->isSMTP();
        $this->mailer->Host = SMTP_HOST;
        $this->mailer->SMTPAuth = SMTP_AUTH; // Usar la constante en lugar de hardcodear true
        $this->mailer->Username = SMTP_USER;
        $this->mailer->Password = SMTP_PASS;
        $this->mailer->SMTPSecure = SMTP_SECURE; // Usar la constante en lugar de hardcodear 'tls'
        $this->mailer->Port = SMTP_PORT;
        $this->mailer->CharSet = 'UTF-8';
        
        // Configuración del remitente (usar el mismo que SMTP_USER)
        $this->mailer->setFrom(SMTP_USER, MAIL_FROM_NAME);
    }
    
    /**
     * Envía un código de verificación por email
     * @param string $email Correo del destinatario
     * @param string $name Nombre del destinatario
     * @param string $code Código de verificación
     * @return bool True si se envió correctamente, false en caso contrario
     */
    public function sendVerificationCode($email, $name, $code) {
        try {
            $this->mailer->clearAddresses(); // Limpiar destinatarios previos
            $this->mailer->addAddress($email, $name);
            $this->mailer->isHTML(true);
            $this->mailer->Subject = 'Código de verificación - Iglesia En Casa';
            
            // Contenido del correo
            $body = "
            <div style='font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;'>
                <h2 style='color: #3949ab;'>Iglesia En Casa - Verificación</h2>
                <p>Hola {$name},</p>
                <p>Tu código de verificación es:</p>
                <div style='background-color: #f5f5f5; padding: 15px; text-align: center; font-size: 24px; letter-spacing: 5px; font-weight: bold;'>
                    {$code}
                </div>
                <p>Este código expirará en 1 hora.</p>
                <p>Si no solicitaste este código, puedes ignorar este correo.</p>
                <p>Gracias,<br>Equipo de Iglesia En Casa</p>
            </div>";
            
            $this->mailer->Body = $body;
            $this->mailer->AltBody = "Tu código de verificación es: {$code}. Este código expirará en 1 hora.";
            
            $this->mailer->send();
            
            // Registrar el éxito si existe la función log_info
            if (function_exists('log_info')) {
                log_info("Código de verificación enviado a $email");
            }
            return true;
        } catch (Exception $e) {
            // Registrar error si existe la función log_error
            if (function_exists('log_error')) {
                log_error("Error al enviar correo de verificación: " . $this->mailer->ErrorInfo);
            }
            return false;
        }
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\helpers\functions.php
=============================================================

<?php
/**
 * Funciones auxiliares globales para logging y generación de URLs
 */

if (!function_exists('log_error')) {
    function log_error($message, $context = []) {
        \App\Helpers\Logger::getInstance()->error($message, $context);
    }
}

if (!function_exists('log_warning')) {
    function log_warning($message, $context = []) {
        \App\Helpers\Logger::getInstance()->warning($message, $context);
    }
}

if (!function_exists('log_info')) {
    function log_info($message, $context = []) {
        \App\Helpers\Logger::getInstance()->info($message, $context);
    }
}

if (!function_exists('log_debug')) {
    function log_debug($message, $context = []) {
        \App\Helpers\Logger::getInstance()->debug($message, $context);
    }
}

/**
 * Genera una URL completa para la aplicación
 * @param string $path Ruta relativa
 * @return string URL completa
 */
if (!function_exists('url')) {
    function url($path = '', $force_https = true)
    {
        // Usar APP_URL si está definida
        if (defined('APP_URL')) {
            $baseUrl = APP_URL;
            
            // Si es un túnel y queremos forzar HTTPS, asegurarnos que use https://
            if ($force_https && defined('APP_ENV') && APP_ENV === 'tunnel') {
                $baseUrl = str_replace('http://', 'https://', $baseUrl);
            }
        } else {
            // Si no está definida, detectar el entorno
            $protocol = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https://' : 'http://';
            $host = $_SERVER['HTTP_HOST'] ?? 'localhost';
            
            // Detectar si estamos usando un túnel
            $is_tunnel = strpos($host, 'ngrok-free.app') !== false || 
                       strpos($host, 'ngrok.io') !== false ||
                       strpos($host, 'localto.net') !== false || 
                       strpos($host, 'loca.lt') !== false;
            
            if ($is_tunnel) {
                // Forzar HTTPS para túneles
                $baseUrl = ($force_https ? 'https://' : $protocol) . $host . '/ENCASA_DATABASE';
            } else {
                $baseUrl = 'http://localhost/ENCASA_DATABASE';
            }
        }
        
        // Formatear URL correctamente
        $baseUrl = rtrim($baseUrl, '/');
        $path = ltrim($path, '/');
        
        return $baseUrl . ($path ? '/' . $path : '');
    }
}

/**
 * Genera una URL para recursos estáticos (CSS, JS, imágenes)
 * @param string $path Ruta relativa al archivo dentro de la carpeta /public
 * @return string URL completa al recurso
 */
if (!function_exists('asset')) {
    function asset($path = '')
    {
        return url('public/' . ltrim($path, '/'));
    }
}

// Definir APP_URL como constante si no está definida
if (!defined('APP_URL')) {
    define('APP_URL', url());
}

// Nueva implementación de la función url
function url($path = '') {
    $base_url = 'http://localhost/ENCASA_DATABASE/';
    
    // Si la ruta comienza con 'uploads/', ajustarla para incluir 'public/'
    if (strpos($path, 'uploads/') === 0) {
        $path = 'public/' . $path;
    }
    
    return $base_url . $path;
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\helpers\JWT.php
=============================================================

<?php
namespace App\Helpers;

class JWT {
    private static $secret;
    
    /**
     * Inicializa la clave secreta para JWT
     */
    public static function init($secret = null) {
        if ($secret === null) {
            self::$secret = getenv('JWT_SECRET') ?: 'encasa_secret_key_change_in_production';
        } else {
            self::$secret = $secret;
        }
    }
    
    /**
     * Genera un JWT token
     */
    public static function encode($payload, $expiry = 86400) {
        if (self::$secret === null) {
            self::init();
        }
        
        // Añadir timestamps
        $payload['iat'] = time();
        $payload['exp'] = time() + $expiry;
        
        // Crear las partes del JWT
        $header = self::base64UrlEncode(json_encode([
            'alg' => 'HS256',
            'typ' => 'JWT'
        ]));
        
        $payload = self::base64UrlEncode(json_encode($payload));
        
        // Crear firma
        $signature = self::base64UrlEncode(hash_hmac(
            'sha256',
            "$header.$payload",
            self::$secret,
            true
        ));
        
        return "$header.$payload.$signature";
    }
    
    /**
     * Decodifica y verifica un JWT token
     */
    public static function decode($token) {
        if (self::$secret === null) {
            self::init();
        }
        
        // Dividir el token
        $parts = explode('.', $token);
        
        if (count($parts) !== 3) {
            return false;
        }
        
        list($header, $payload, $signature) = $parts;
        
        // Recrear la firma para verificación
        $recalculatedSignature = self::base64UrlEncode(hash_hmac(
            'sha256',
            "$header.$payload",
            self::$secret,
            true
        ));
        
        // Verificar firma
        if ($signature !== $recalculatedSignature) {
            return false;
        }
        
        // Decodificar el payload
        $payload = json_decode(self::base64UrlDecode($payload), true);
        
        // Verificar expiración
        if (isset($payload['exp']) && $payload['exp'] < time()) {
            return false;
        }
        
        return $payload;
    }
    
    private static function base64UrlEncode($data) {
        return str_replace(['+', '/', '='], ['-', '_', ''], base64_encode($data));
    }
    
    private static function base64UrlDecode($data) {
        $data = str_replace(['-', '_'], ['+', '/'], $data);
        $remainder = strlen($data) % 4;
        
        if ($remainder) {
            $data .= str_repeat('=', 4 - $remainder);
        }
        
        return base64_decode($data);
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\helpers\Logger.php
=============================================================

<?php
namespace App\Helpers;

class Logger {
    private static $instance = null;
    private $logPath;
    private $logLevels = ['ERROR', 'WARNING', 'INFO', 'DEBUG'];
    private $currentLevel = 3; // Por defecto: DEBUG (todos los niveles)

    private function __construct() {
        $this->logPath = dirname(__DIR__) . '/logs/';
        if (!is_dir($this->logPath)) {
            mkdir($this->logPath, 0755, true);
        }
        $env = getenv('APP_ENV') ?: 'development';
        if ($env === 'production') {
            $this->currentLevel = 1; // Solo ERROR y WARNING
        }
    }

    public static function getInstance() {
        if (self::$instance === null) {
            self::$instance = new self();
        }
        return self::$instance;
    }

    public function error($message, $context = []) { $this->log(0, $message, $context); }
    public function warning($message, $context = []) { $this->log(1, $message, $context); }
    public function info($message, $context = []) { $this->log(2, $message, $context); }
    public function debug($message, $context = []) { $this->log(3, $message, $context); }

    private function log($level, $message, $context = []) {
        if ($level > $this->currentLevel) return;

        $date = date('Y-m-d H:i:s');
        $logLevel = $this->logLevels[$level];
        
        $backtrace = debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS, 2);
        $caller = isset($backtrace[1]['class']) ? $backtrace[1]['class'] . '::' . $backtrace[1]['function'] : 'unknown';
        
        $contextStr = !empty($context) ? ' ' . json_encode($context, JSON_UNESCAPED_UNICODE) : '';
        $logMessage = "[$date] [$logLevel] [$caller] $message$contextStr" . PHP_EOL;
        
        $filename = $this->logPath . date('Y-m-d') . '.log';
        file_put_contents($filename, $logMessage, FILE_APPEND);
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\helpers\Router.php
=============================================================

<?php
namespace App\Helpers;

class Router {
    private $routes = [];
    private $params = [];
    private $notFoundCallback;
    
    /**
     * Añade una ruta al sistema
     */
    public function add($route, $controller, $action, $methods = ['GET'], $middleware = []) {
        // Convertir ruta a expresión regular para capturar parámetros
        $route = preg_replace('/\//', '\\/', $route);
        $route = preg_replace('/\{([a-z]+)\}/', '(?P<\1>[a-z0-9-]+)', $route);
        $route = '/^' . $route . '$/i';
        
        $this->routes[] = [
            'route' => $route,
            'controller' => $controller,
            'action' => $action,
            'methods' => $methods,
            'middleware' => $middleware
        ];
    }
    
    /**
     * Registra callback para rutas no encontradas
     */
    public function setNotFound($callback) {
        $this->notFoundCallback = $callback;
    }
    
    /**
     * Método abreviado para rutas GET
     */
    public function get($route, $controllerAction, $middleware = []) {
        if (strpos($controllerAction, '@') !== false) {
            list($controller, $action) = explode('@', $controllerAction);
            $this->add($route, $controller, $action, ['GET'], $middleware);
        } else {
            // Mantener compatibilidad con la forma antigua
            $controller = $controllerAction;
            $action = func_get_arg(2);
            $middleware = func_num_args() > 3 ? func_get_arg(3) : [];
            $this->add($route, $controller, $action, ['GET'], $middleware);
        }
    }
    
    /**
     * Registra una ruta POST
     */
    public function post($route, $controller, $action = null, $middleware = []) {
        // Si el segundo parámetro contiene @, es el formato abreviado Controller@action
        if (is_string($controller) && strpos($controller, '@') !== false) {
            list($controllerName, $actionName) = explode('@', $controller);
            $this->add($route, $controllerName, $actionName, ['POST'], $middleware);
        } else {
            // Usar el modo tradicional con parámetros separados
            $this->add($route, $controller, $action, ['POST'], $middleware);
        }
    }
    
    /**
     * Método abreviado para rutas PUT
     */
    public function put($route, $controller, $action, $middleware = []) {
        $this->add($route, $controller, $action, ['PUT'], $middleware);
    }
    
    /**
     * Método abreviado para rutas DELETE
     */
    public function delete($route, $controller, $action, $middleware = []) {
        $this->add($route, $controller, $action, ['DELETE'], $middleware);
    }
    
    /**
     * Despacha la ruta actual
     */
    public function dispatch() {
        // Obtener la ruta solicitada
        $url = $_SERVER['REQUEST_URI'] ?? '';
        
        // Eliminar la base del proyecto de la URL
        $base = str_replace('/index.php', '', $_SERVER['SCRIPT_NAME']);
        $url = str_replace($base, '', $url);
        
        // Eliminar la barra inicial y parámetros GET
        $url = ltrim($url, '/');
        $url = explode('?', $url)[0];
        
        // Debug para ver qué URL se está procesando
        error_log("URL a procesar: '$url'");
        
        $method = $_SERVER['REQUEST_METHOD'];
        
        // Si se envía _method en un formulario, usar ese método
        if ($method == 'POST' && isset($_POST['_method'])) {
            $method = strtoupper($_POST['_method']);
        }
        
        foreach ($this->routes as $route) {
            if (preg_match($route['route'], $url, $matches)) {
                // Verificar método HTTP
                if (!in_array($method, $route['methods'])) {
                    continue; // Método no permitido, seguir buscando
                }
                
                // Extraer los parámetros de la URL
                foreach ($matches as $key => $value) {
                    if (is_string($key)) {
                        $this->params[$key] = $value;
                    }
                }
                
                // Ejecutar middleware si existe
                foreach ($route['middleware'] as $middleware) {
                    $middlewareClass = "App\\Middleware\\$middleware";
                    if (class_exists($middlewareClass)) {
                        $middlewareObj = new $middlewareClass();
                        $result = $middlewareObj->handle();
                        if (!$result) {
                            // Si el middleware retorna falso, detener la ejecución
                            return;
                        }
                    }
                }
                
                // Cargar el controlador
                $controllerName = "App\\Controllers\\{$route['controller']}Controller";
                if (class_exists($controllerName)) {
                    $controller = new $controllerName();
                    $action = $route['action'];
                    
                    if (method_exists($controller, $action)) {
                        // Ejecutar la acción del controlador
                        // Si esperamos un ID, extraerlo del array de parámetros
                        if ($action === 'ver' || $action === 'editar' || $action === 'actualizar' || $action === 'eliminar') {
                            // Extraer ID del array de parámetros
                            $id = !empty($this->params) ? array_values($this->params)[0] : null;
                            $controller->$action($id);
                        } else {
                            // Para otras acciones que no requieren ID
                            // Extraer parámetros si existen
                            if (!empty($this->params)) {
                                // Convertir parámetros asociativos a indexados para pasarlos como argumentos
                                $params = array_values($this->params);
                                $controller->$action(...$params);
                            } else {
                                // Sin parámetros
                                $controller->$action();
                            }
                        }
                        return;
                    }
                }
                
                // Si llegamos aquí, el controlador o acción no existen
                $this->handleNotFound();
                return;
            }
        }
        
        // No se encontró ninguna ruta
        $this->handleNotFound();
    }
    
    /**
     * Maneja la situación de ruta no encontrada
     */
    private function handleNotFound() {
        if ($this->notFoundCallback) {
            call_user_func($this->notFoundCallback);
        } else {
            header("HTTP/1.0 404 Not Found");
            echo '<h1>404 - Página no encontrada</h1>';
            echo '<p>La página que estás buscando no existe.</p>';
        }
    }
    
    /**
     * Obtiene la URL current
     */
    private function getUrl() {
        $url = isset($_GET['url']) ? $_GET['url'] : '';
        $url = rtrim($url, '/');
        $url = filter_var($url, FILTER_SANITIZE_URL);
        return $url;
    }
    
    /**
     * Obtiene los parámetros de la URL
     */
    public function getParams() {
        return $this->params;
    }
    
    /**
     * Redirige a una URL
     * @param string $url Ruta relativa a la que redirigir
     */
    public static function redirect($url) {
        // Usar la función url() para generar URLs consistentes
        if (function_exists('url')) {
            header('Location: ' . url($url));
        } else {
            // Fallback si la función url() no existe
            $baseUrl = defined('APP_URL') ? APP_URL : '/ENCASA_DATABASE';
            header('Location: ' . rtrim($baseUrl, '/') . '/' . ltrim($url, '/'));
        }
        exit;
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\helpers\Validator.php
=============================================================

<?php
// filepath: /Applications/XAMPP/xamppfiles/htdocs/Encasa_Database/app/helpers/Validator.php
namespace App\Helpers;

class Validator {
    private $errors = [];
    
    public function validate($data, $rules) {
        $this->errors = [];
        
        foreach ($rules as $field => $fieldRules) {
            foreach ($fieldRules as $rule) {
                $ruleParts = explode(':', $rule);
                $ruleName = $ruleParts[0];
                $ruleParam = isset($ruleParts[1]) ? $ruleParts[1] : null;
                
                switch ($ruleName) {
                    case 'required':
                        if (!isset($data[$field]) || trim($data[$field]) === '') {
                            $this->errors[$field][] = "El campo {$field} es obligatorio.";
                        }
                        break;
                        
                    case 'email':
                        if (isset($data[$field]) && !filter_var($data[$field], FILTER_VALIDATE_EMAIL)) {
                            $this->errors[$field][] = "El campo {$field} debe ser un email válido.";
                        }
                        break;
                        
                    case 'min':
                        if (isset($data[$field]) && strlen($data[$field]) < $ruleParam) {
                            $this->errors[$field][] = "El campo {$field} debe tener al menos {$ruleParam} caracteres.";
                        }
                        break;
                }
            }
        }
        
        return empty($this->errors);
    }
    
    public function getErrors() {
        return $this->errors;
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\helpers\View.php
=============================================================

<?php
namespace App\Helpers;

class View {
    /**
     * Renderiza una vista
     */
    public function render($view, $data = []) {
        // Extraer variables para que estén disponibles en la vista
        extract($data);
        
        // Incluir la vista
        $viewPath = VIEW_PATH . '/' . $view . '.php';
        
        if (file_exists($viewPath)) {
            include $viewPath;
        } else {
            throw new \Exception("Vista no encontrada: {$view}");
        }
    }
    
    /**
     * Renderiza una vista con un layout
     */
    public function renderWithLayout($view, $layout = 'default', $data = []) {
        // Extraer variables para que estén disponibles en la vista y el layout
        extract($data);
        
        // Capturar el contenido de la vista
        ob_start();
        $this->render($view, $data);
        $content = ob_get_clean();
        
        // Incluir el layout
        $layoutPath = VIEW_PATH . '/layouts/' . $layout . '.php';
        
        if (file_exists($layoutPath)) {
            include $layoutPath;
        } else {
            throw new \Exception("Layout no encontrado: {$layout}");
        }
    }
    
    /**
     * Incluye una vista parcial
     */
    public static function partial($partial, $data = []) {
        extract($data);
        
        $partialPath = VIEW_PATH . '/partials/' . $partial . '.php';
        
        if (file_exists($partialPath)) {
            include $partialPath;
        } else {
            throw new \Exception("Partial no encontrado: {$partial}");
        }
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\middleware\AdminOnly.php
=============================================================

<?php
// filepath: /Applications/XAMPP/xamppfiles/htdocs/Encasa_Database/app/middleware/AdminOnly.php
namespace App\Middleware;

class AdminOnly extends Middleware {
    public function handle() {
        if (!isset($_SESSION['roles']) || !in_array('Admin', $_SESSION['roles'])) {
            $_SESSION['flash_message'] = 'No tienes permiso para acceder a esta área';
            $_SESSION['flash_type'] = 'danger';
            
            header('Location: ' . APP_URL);
            exit;
        }
        
        return true;
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\middleware\Auth.php
=============================================================

<?php
// filepath: /Applications/XAMPP/xamppfiles/htdocs/Encasa_Database/app/middleware/Auth.php
namespace App\Middleware;

class Auth extends Middleware {
    public function handle() {
        if (!isset($_SESSION['user_id'])) {
            $_SESSION['flash_message'] = 'Debes iniciar sesión para acceder';
            $_SESSION['flash_type'] = 'warning';
            
            // Guardar URL intentada para redirección después del login
            $_SESSION['intended_url'] = $_SERVER['REQUEST_URI'];
            
            header('Location: ' . APP_URL . '/login');
            exit;
        }
        
        return true;
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\middleware\Middleware.php
=============================================================

<?php
// filepath: /Applications/XAMPP/xamppfiles/htdocs/Encasa_Database/app/middleware/Middleware.php
namespace App\Middleware;

abstract class Middleware {
    /**
     * Método que se debe implementar en cada middleware
     */
    abstract public function handle();
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\middleware\RoleMiddleware.php
=============================================================

<?php

namespace App\Middleware;

use App\Models\Usuario;
use App\Models\Rol;

class RoleMiddleware {
    private $requiredLevel;
    
    public function __construct($level) {
        $this->requiredLevel = $level;
    }
    
    public function handle() {
        // Verificar que el usuario está autenticado
        if (!isset($_SESSION['user_id'])) {
            header('Location: ' . APP_URL . '/login');
            exit;
        }
        
        // Obtener información del rol del usuario
        $userModel = new Usuario();
        $user = $userModel->findById($_SESSION['user_id']);
        
        if (!$user) {
            $_SESSION['flash_message'] = 'Sesión inválida';
            $_SESSION['flash_type'] = 'danger';
            header('Location: ' . APP_URL . '/logout');
            exit;
        }
        
        // Cargar el rol
        $rolModel = new Rol();
        $rol = $rolModel->findById($user['rol_id']);
        
        // Verificar si el nivel de acceso es suficiente
        if (!$rol || $rol['nivel_acceso'] < $this->requiredLevel) {
            // Redirect a página de acceso denegado
            header('Location: ' . APP_URL . '/acceso-denegado');
            exit;
        }
        
        return true;
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\models\CarreraBiblica.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\models\CarreraBiblica.php
namespace App\Models;

class CarreraBiblica extends Model {
    protected $table = 'CarreraBiblica';
    protected $fillable = [
        'miembro_id', 'carrera_biblica', 'miembro_de', 'casa_de_palabra_y_vida',
        'cobertura', 'estado', 'anotaciones', 'recorrido_espiritual'
    ];
    
    /**
     * Encuentra la información de carrera bíblica por ID de miembro
     */
    public function findByMiembro($miembroId) {
        $sql = "SELECT * FROM {$this->table} WHERE miembro_id = :miembro_id LIMIT 1";
        $stmt = $this->db->prepare($sql);
        $stmt->execute(['miembro_id' => $miembroId]);
        return $stmt->fetch();
    }
    
    /**
     * Actualiza o crea un registro de carrera bíblica para un miembro
     */
    public function actualizarOCrear($miembroId, $datos) {
        $actual = $this->findByMiembro($miembroId);
        
        if ($actual) {
            return $this->update($actual['id'], $datos);
        } else {
            $datos['miembro_id'] = $miembroId;
            return $this->create($datos);
        }
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\models\Contacto.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\models\Contacto.php
namespace App\Models;

class Contacto extends Model {
    protected $table = 'Contacto';
    protected $fillable = [
        'miembro_id', 'tipo_documento', 'numero_documento', 'telefono', 'pais',
        'ciudad', 'direccion', 'estado_civil', 'correo_electronico',
        'instagram', 'facebook', 'notas', 'familiares'
    ];
    
    /**
     * Encuentra el contacto por ID de miembro
     */
    public function findByMiembro($miembroId) {
        $sql = "SELECT * FROM {$this->table} WHERE miembro_id = :miembro_id LIMIT 1";
        $stmt = $this->db->prepare($sql);
        $stmt->execute(['miembro_id' => $miembroId]);
        return $stmt->fetch();
    }
    
    /**
     * Actualiza o crea un registro de contacto para un miembro
     */
    public function actualizarOCrear($miembroId, $datos) {
        $actual = $this->findByMiembro($miembroId);
        
        if ($actual) {
            return $this->update($actual['id'], $datos);
        } else {
            $datos['miembro_id'] = $miembroId;
            return $this->create($datos);
        }
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\models\EducationModel.php
=============================================================

<?php
namespace App\Models;

use App\Core\Database;

class EducationModel {
    private $db;
    
    public function __construct() {
        $this->db = new Database();
    }
    
    // Obtener datos educativos por país
    public function getEducationDataByCountry($pais) {
        // Structure to hold all education data
        $educationData = [
            'Primaria' => ['instituciones' => []],
            'Bachillerato' => ['instituciones' => []],
            'Técnico' => ['instituciones' => []],
            'Tecnólogo' => ['instituciones' => []],
            'Universitario' => ['instituciones' => []],
            'Especialización' => ['instituciones' => []],
            'Maestría' => ['instituciones' => []],
            'Doctorado' => ['instituciones' => []]
        ];
        
        // Get institutions by country and level
        $sql = "SELECT id, nivel_educativo, nombre FROM instituciones_educativas 
                WHERE pais = ? ORDER BY nivel_educativo, nombre";
        
        $this->db->query($sql);
        $this->db->bind(1, $pais);
        $instituciones = $this->db->resultSet();
        
        foreach ($instituciones as $institucion) {
            $nivel = $institucion['nivel_educativo'];
            
            // Get professions for this institution
            $sqlProfessions = "SELECT id, nombre FROM profesiones 
                              WHERE institucion_id = ? ORDER BY nombre";
            $this->db->query($sqlProfessions);
            $this->db->bind(1, $institucion['id']);
            $profesiones = $this->db->resultSet();
            
            // Add to data structure
            if (isset($educationData[$nivel])) {
                $educationData[$nivel]['instituciones'][] = [
                    'id' => $institucion['id'],
                    'nombre' => $institucion['nombre'],
                    'profesiones' => $profesiones
                ];
            }
        }
        
        return $educationData;
    }
    
    // Guardar nueva institución
    public function saveInstitution($pais, $nivel, $nombre) {
        // Verificar si ya existe
        $sql = "SELECT id FROM instituciones_educativas 
                WHERE pais = ? AND nivel_educativo = ? AND nombre = ?";
        $this->db->query($sql);
        $this->db->bind(1, $pais);
        $this->db->bind(2, $nivel);
        $this->db->bind(3, $nombre);
        $existente = $this->db->single();
        
        if ($existente) {
            return ['id' => $existente['id'], 'nombre' => $nombre, 'existe' => true];
        }
        
        // Insertar nueva institución
        $sql = "INSERT INTO instituciones_educativas (pais, nivel_educativo, nombre) 
                VALUES (?, ?, ?)";
        $this->db->query($sql);
        $this->db->bind(1, $pais);
        $this->db->bind(2, $nivel);
        $this->db->bind(3, $nombre);
        
        if ($this->db->execute()) {
            $newId = $this->db->lastInsertId();
            return ['id' => $newId, 'nombre' => $nombre, 'existe' => false];
        } else {
            return ['error' => 'No se pudo guardar la institución'];
        }
    }
    
    // Guardar nueva profesión
    public function saveProfession($pais, $nivel, $institucionId, $nombre) {
        // Verificar si ya existe
        $sql = "SELECT id FROM profesiones 
                WHERE institucion_id = ? AND nombre = ?";
        $this->db->query($sql);
        $this->db->bind(1, $institucionId);
        $this->db->bind(2, $nombre);
        $existente = $this->db->single();
        
        if ($existente) {
            return ['id' => $existente['id'], 'nombre' => $nombre, 'existe' => true];
        }
        
        // Insertar nueva profesión
        $sql = "INSERT INTO profesiones (institucion_id, nombre) 
                VALUES (?, ?)";
        $this->db->query($sql);
        $this->db->bind(1, $institucionId);
        $this->db->bind(2, $nombre);
        
        if ($this->db->execute()) {
            $newId = $this->db->lastInsertId();
            return ['id' => $newId, 'nombre' => $nombre, 'existe' => false];
        } else {
            return ['error' => 'No se pudo guardar la profesión'];
        }
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\models\EstudiosTrabajo.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\models\EstudiosTrabajo.php
namespace App\Models;

class EstudiosTrabajo extends Model {
    protected $table = 'EstudiosTrabajo';
    protected $fillable = [
        'miembro_id', 'nivel_estudios', 'profesion', 'otros_estudios',
        'empresa', 'direccion_empresa', 'emprendimientos'
    ];
    
    /**
     * Encuentra la información de estudios y trabajo por ID de miembro
     */
    public function findByMiembro($miembroId) {
        $sql = "SELECT * FROM {$this->table} WHERE miembro_id = :miembro_id LIMIT 1";
        $stmt = $this->db->prepare($sql);
        $stmt->execute(['miembro_id' => $miembroId]);
        return $stmt->fetch();
    }
    
    /**
     * Actualiza o crea un registro de estudios/trabajo para un miembro
     */
    public function actualizarOCrear($miembroId, $datos) {
        $actual = $this->findByMiembro($miembroId);
        
        if ($actual) {
            return $this->update($actual['id'], $datos);
        } else {
            $datos['miembro_id'] = $miembroId;
            return $this->create($datos);
        }
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\models\Miembro.php
=============================================================

<?php
namespace App\Models;

class Miembro extends Model {
    protected $table = 'InformacionGeneral';
    protected $fillable = [
        'nombres', 'apellidos', 'celular', 'localidad', 'barrio', 
        'fecha_nacimiento', 'invitado_por', 'conector', 'estado_espiritual',
        'recorrido_espiritual', 'foto', 'habeas_data', 'fecha_ingreso_iglesia',
        'estado_miembro', 'fecha_modificacion'
    ];
    
    /**
     * Obtiene todos los miembros con información básica
     */
    public function getAll($order = 'apellidos', $dir = 'ASC') {
        $sql = "SELECT * FROM {$this->table} ORDER BY {$order} {$dir}";
        $stmt = $this->db->prepare($sql);
        $stmt->execute();
        return $stmt->fetchAll();
    }
    
    /**
     * Busca miembros por criterios
     */
    public function buscar($termino) {
        $termino = "%{$termino}%";
        $sql = "SELECT * FROM {$this->table} 
                WHERE nombres LIKE ? 
                OR apellidos LIKE ? 
                OR celular LIKE ?
                OR barrio LIKE ?
                OR localidad LIKE ?
                ORDER BY apellidos, nombres";
        $stmt = $this->db->prepare($sql);
        $stmt->execute([$termino, $termino, $termino, $termino, $termino]);
        return $stmt->fetchAll();
    }
    
    /**
     * Obtiene un listado básico de miembros para selector
     */
    public function getParaSelector() {
        $sql = "SELECT id, CONCAT(nombres, ' ', apellidos) as nombre_completo 
                FROM {$this->table} 
                ORDER BY apellidos, nombres";
        $stmt = $this->db->prepare($sql);
        $stmt->execute();
        return $stmt->fetchAll();
    }
    
    /**
     * Crea un nuevo miembro con sus datos relacionados
     */
    public function crearCompleto($datos) {
        try {
            $this->db->beginTransaction();
            
            // 1. Crear registro principal en InformacionGeneral
            $miembroId = $this->create($datos['informacion_general']);
            
            if (!$miembroId) {
                $this->db->rollBack();
                return false;
            }
            
            // 2. Crear registro de contacto si hay datos
            if (!empty($datos['contacto'])) {
                $datos['contacto']['miembro_id'] = $miembroId;
                $contactoModel = new Contacto();
                if (!$contactoModel->create($datos['contacto'])) {
                    $this->db->rollBack();
                    return false;
                }
            }
            
            // 3. Crear registro de estudios/trabajo si hay datos
            if (!empty($datos['estudios_trabajo'])) {
                $datos['estudios_trabajo']['miembro_id'] = $miembroId;
                $estudiosModel = new EstudiosTrabajo();
                if (!$estudiosModel->create($datos['estudios_trabajo'])) {
                    $this->db->rollBack();
                    return false;
                }
            }
            
            // 4. Crear registro de tallas si hay datos
            if (!empty($datos['tallas'])) {
                $datos['tallas']['miembro_id'] = $miembroId;
                $tallasModel = new Tallas();
                if (!$tallasModel->create($datos['tallas'])) {
                    $this->db->rollBack();
                    return false;
                }
            }
            
            // 5. Crear registro de carrera bíblica si hay datos
            if (!empty($datos['carrera_biblica'])) {
                $datos['carrera_biblica']['miembro_id'] = $miembroId;
                $carreraModel = new CarreraBiblica();
                if (!$carreraModel->create($datos['carrera_biblica'])) {
                    $this->db->rollBack();
                    return false;
                }
            }
            
            $this->db->commit();
            return $miembroId;
        } catch (\Exception $e) {
            $this->db->rollBack();
            error_log("Error al crear miembro: " . $e->getMessage());
            return false;
        }
    }
    
    /**
     * Obtiene el perfil completo de un miembro
     */
    public function getFullProfile($id)
    {
        try {
            // Asegurar que el ID sea un entero
            $id = (int)$id;
            
            // Registrar para depuración
            error_log("Modelo: Buscando miembro con ID: $id");
            
            // Consulta principal
            $stmt = $this->db->prepare("SELECT * FROM InformacionGeneral WHERE id = ?");
            $stmt->execute([$id]);
            $miembro = $stmt->fetch(\PDO::FETCH_ASSOC);
            
            if (!$miembro) {
                error_log("Modelo: No se encontró miembro con ID: $id");
                return null;
            }
            
            error_log("Modelo: Miembro encontrado, buscando datos relacionados");
            
            // Obtener datos relacionados
            $tablas = ['Contacto', 'EstudiosTrabajo', 'Tallas', 'SaludEmergencias', 'CarreraBiblica'];
            
            foreach ($tablas as $tabla) {
                try {
                    $sql = "SELECT * FROM {$tabla} WHERE miembro_id = ?";
                    $stmt = $this->db->prepare($sql);
                    $stmt->execute([$id]);
                    $datos = $stmt->fetch(\PDO::FETCH_ASSOC);
                    
                    if ($datos) {
                        // Clave en minúsculas para consistencia
                        $miembro[strtolower($tabla)] = $datos;
                    } else {
                        // Asignar array vacío para evitar errores
                        $miembro[strtolower($tabla)] = [];
                        error_log("Modelo: No se encontraron datos en $tabla para miembro ID: $id");
                    }
                } catch (\PDOException $e) {
                    error_log("Modelo: Error al consultar $tabla: " . $e->getMessage());
                    $miembro[strtolower($tabla)] = []; // Array vacío para evitar errores
                }
            }
            
            return $miembro;
        } catch (\Exception $e) {
            error_log("Modelo: Error en getFullProfile: " . $e->getMessage());
            return null;
        }
    }
    
    /**
     * Verifica si un miembro existe en la base de datos
     */
    public function checkMemberExists($id) {
        $sql = "SELECT id FROM {$this->table} WHERE id = :id";
        $stmt = $this->db->prepare($sql);
        $stmt->execute(['id' => $id]);
        return $stmt->rowCount() > 0;
    }
    
    /**
     * Crea un nuevo registro en la tabla de información general
     */
    public function crear($datos) {
        try {
            // Preparar consulta
            $campos = array_keys($datos);
            $valores = array_values($datos);
            
            $campos_str = implode(', ', $campos);
            $placeholders = implode(', ', array_fill(0, count($campos), '?'));
            
            $sql = "INSERT INTO InformacionGeneral ($campos_str) VALUES ($placeholders)";
            
            $stmt = $this->db->prepare($sql);
            $stmt->execute($valores);
            
            return $this->db->lastInsertId();
        } catch (\PDOException $e) {
            error_log("Error al crear miembro: " . $e->getMessage());
            return false;
        }
    }
    
    /**
     * Guarda datos de contacto de un miembro
     */
    public function guardarContacto($datos)
    {
        try {
            // Extraer miembro_id del array
            $miembroId = $datos['miembro_id'];
            
            // Verificar si ya existe un registro para este miembro
            $stmt = $this->db->prepare("SELECT COUNT(*) FROM Contacto WHERE miembro_id = ?");
            $stmt->execute([$miembroId]);
            $existe = (bool)$stmt->fetchColumn();

            if ($existe) {
                // Actualizar registro existente
                $campos = [];
                $valores = [];
                
                foreach ($datos as $campo => $valor) {
                    if ($campo !== 'miembro_id') {
                        $campos[] = "$campo = ?";
                        $valores[] = $valor;
                    }
                }
                
                if (empty($campos)) {
                    return false; // No hay campos para actualizar
                }
                
                $valores[] = $miembroId; // Para la condición WHERE
                
                $sql = "UPDATE Contacto SET " . implode(', ', $campos) . " WHERE miembro_id = ?";
                $stmt = $this->db->prepare($sql);
                return $stmt->execute($valores);
            } else {
                // Insertar nuevo registro
                $campos = array_keys($datos);
                $placeholders = array_fill(0, count($campos), '?');
                
                $sql = "INSERT INTO Contacto (" . implode(', ', $campos) . ") VALUES (" . implode(', ', $placeholders) . ")";
                $stmt = $this->db->prepare($sql);
                return $stmt->execute(array_values($datos));
            }
        } catch (\PDOException $e) {
            error_log("Error al guardar datos de contacto: " . $e->getMessage());
            return false;
        }
    }
    
    /**
     * Actualiza la información de un miembro
     */
    public function actualizar($id, $datos)
    {
        try {
            // Asegurar que el ID sea un entero
            $id = (int)$id;
            
            // Verificar primero si el miembro existe
            $checkSql = "SELECT id FROM {$this->table} WHERE id = ?";
            $checkStmt = $this->db->prepare($checkSql);
            $checkStmt->execute([$id]);
            
            if ($checkStmt->rowCount() === 0) {
                error_log("Error en actualizar(): El miembro con ID $id no existe");
                return false;
            }
            
            // Construir la consulta de actualización
            $setClausulas = [];
            $valores = [];
            
            foreach ($datos as $campo => $valor) {
                // Solo incluir campos permitidos
                if (in_array($campo, $this->fillable)) {
                    $setClausulas[] = "$campo = ?";
                    $valores[] = $valor;
                    error_log("Campo a actualizar: $campo = $valor");
                } else {
                    error_log("Campo ignorado (no en fillable): $campo");
                }
            }
            
            if (empty($setClausulas)) {
                error_log("Error en actualizar(): No hay campos válidos para actualizar");
                return false;
            }
            
            // Añadir ID al final de los valores
            $valores[] = $id;
            
            $sql = "UPDATE {$this->table} SET " . implode(', ', $setClausulas) . " WHERE id = ?";
            error_log("SQL de actualización: " . $sql);
            error_log("Valores para actualizar: " . implode(", ", $valores));
            
            $stmt = $this->db->prepare($sql);
            $resultado = $stmt->execute($valores);
            
            error_log("Resultado de actualización de miembro ID $id: " . ($resultado ? "éxito" : "fallido"));
            return $resultado;
        } catch (\PDOException $e) {
            error_log("Error en actualizar(): " . $e->getMessage());
            return false;
        }
    }
    
    /**
     * Guarda o actualiza los datos de estudios y trabajo de un miembro
     * 
     * @param int $miembroId ID del miembro
     * @param array $datos Datos de estudios y trabajo
     * @return bool Resultado de la operación
     */
    public function guardarEstudiosTrabajo($miembroId, $datos)
    {
        try {
            // Verificar si ya existe un registro para este miembro
            $stmt = $this->db->prepare("SELECT COUNT(*) FROM EstudiosTrabajo WHERE miembro_id = ?");
            $stmt->execute([$miembroId]);
            $existe = (bool)$stmt->fetchColumn();

            if ($existe) {
                // Actualizar registro existente
                $sql = "UPDATE EstudiosTrabajo SET 
                    nivel_estudios = ?, 
                    profesion = ?, 
                    otros_estudios = ?, 
                    empresa = ?, 
                    direccion_empresa = ?, 
                    emprendimientos = ?
                    WHERE miembro_id = ?";
                
                $stmt = $this->db->prepare($sql);
                return $stmt->execute([
                    $datos['nivel_estudios'] ?? null,
                    $datos['profesion'] ?? null,
                    $datos['otros_estudios'] ?? null,
                    $datos['empresa'] ?? null,
                    $datos['direccion_empresa'] ?? null,
                    $datos['emprendimientos'] ?? null,
                    $miembroId
                ]);
            } else {
                // Insertar nuevo registro
                $sql = "INSERT INTO EstudiosTrabajo (
                    miembro_id, nivel_estudios, profesion, otros_estudios, 
                    empresa, direccion_empresa, emprendimientos
                ) VALUES (?, ?, ?, ?, ?, ?, ?)";
                
                $stmt = $this->db->prepare($sql);
                return $stmt->execute([
                    $miembroId,
                    $datos['nivel_estudios'] ?? null,
                    $datos['profesion'] ?? null,
                    $datos['otros_estudios'] ?? null,
                    $datos['empresa'] ?? null,
                    $datos['direccion_empresa'] ?? null,
                    $datos['emprendimientos'] ?? null
                ]);
            }
        } catch (\PDOException $e) {
            error_log("Error al guardar datos de estudios y trabajo: " . $e->getMessage());
            return false;
        }
    }
    
    /**
     * Guarda o actualiza las tallas de un miembro
     * 
     * @param array $datos Datos de tallas
     * @return bool Resultado de la operación
     */
    public function guardarTallas($datos)
    {
        try {
            // Extraer miembro_id del array
            $miembroId = $datos['miembro_id'];
            
            // Verificar si ya existe un registro para este miembro
            $stmt = $this->db->prepare("SELECT COUNT(*) FROM Tallas WHERE miembro_id = ?");
            $stmt->execute([$miembroId]);
            $existe = (bool)$stmt->fetchColumn();

            if ($existe) {
                // Actualizar registro existente
                $campos = [];
                $valores = [];
                
                foreach ($datos as $campo => $valor) {
                    if ($campo !== 'miembro_id') {
                        $campos[] = "$campo = ?";
                        $valores[] = $valor;
                    }
                }
                
                if (empty($campos)) {
                    return false; // No hay campos para actualizar
                }
                
                $valores[] = $miembroId; // Para la condición WHERE
                
                $sql = "UPDATE Tallas SET " . implode(', ', $campos) . " WHERE miembro_id = ?";
                $stmt = $this->db->prepare($sql);
                return $stmt->execute($valores);
            } else {
                // Insertar nuevo registro
                $campos = array_keys($datos);
                $placeholders = array_fill(0, count($campos), '?');
                
                $sql = "INSERT INTO Tallas (" . implode(', ', $campos) . ") VALUES (" . implode(', ', $placeholders) . ")";
                $stmt = $this->db->prepare($sql);
                return $stmt->execute(array_values($datos));
            }
        } catch (\PDOException $e) {
            error_log("Error al guardar datos de tallas: " . $e->getMessage());
            return false;
        }
    }

    /**
     * Guarda o actualiza los datos de carrera bíblica de un miembro
     * 
     * @param array $datos Datos de carrera bíblica
     * @return bool Resultado de la operación
     */
    public function guardarCarreraBiblica($datos)
    {
        try {
            // Extraer miembro_id del array
            $miembroId = $datos['miembro_id'];
            
            // Verificar si ya existe un registro para este miembro
            $stmt = $this->db->prepare("SELECT COUNT(*) FROM CarreraBiblica WHERE miembro_id = ?");
            $stmt->execute([$miembroId]);
            $existe = (bool)$stmt->fetchColumn();

            if ($existe) {
                // Actualizar registro existente
                $campos = [];
                $valores = [];
                
                foreach ($datos as $campo => $valor) {
                    if ($campo !== 'miembro_id') {
                        $campos[] = "$campo = ?";
                        $valores[] = $valor;
                    }
                }
                
                if (empty($campos)) {
                    return false; // No hay campos para actualizar
                }
                
                $valores[] = $miembroId; // Para la condición WHERE
                
                $sql = "UPDATE CarreraBiblica SET " . implode(', ', $campos) . " WHERE miembro_id = ?";
                $stmt = $this->db->prepare($sql);
                return $stmt->execute($valores);
            } else {
                // Insertar nuevo registro
                $campos = array_keys($datos);
                $placeholders = array_fill(0, count($campos), '?');
                
                $sql = "INSERT INTO CarreraBiblica (" . implode(', ', $campos) . ") VALUES (" . implode(', ', $placeholders) . ")";
                $stmt = $this->db->prepare($sql);
                return $stmt->execute(array_values($datos));
            }
        } catch (\PDOException $e) {
            error_log("Error al guardar datos de carrera bíblica: " . $e->getMessage());
            return false;
        }
    }

    /**
     * Verifica si un ID de miembro existe en la base de datos
     */
    public function existeId($id)
    {
        try {
            $id = (int)$id;
            $sql = "SELECT COUNT(*) FROM {$this->table} WHERE id = ?";
            $stmt = $this->db->prepare($sql);
            $stmt->execute([$id]);
            return (int)$stmt->fetchColumn() > 0;
        } catch (\PDOException $e) {
            error_log("Error al verificar ID: " . $e->getMessage());
            return false;
        }
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\models\MiembroModel.php
=============================================================

<?php

class MiembroModel {
    private $db;
    
    public function __construct($database) {
        $this->db = $database;
    }

    /**
     * Actualiza la información de un miembro
     */
    public function actualizar($id, $datos)
    {
        try {
            // Preparar los campos a actualizar - solo para la tabla informaciongeneral
            $camposPermitidos = [
                'nombres', 'apellidos', 'celular', 'localidad', 'barrio',
                'fecha_nacimiento', 'invitado_por', 'conector',
                'recorrido_espiritual', 'estado_espiritual', 
                'fecha_ingreso_iglesia', 'habeas_data', 'estado_miembro'
            ];
            
            $updates = [];
            $values = [];
            
            // Procesar solo los campos permitidos
            foreach ($camposPermitidos as $campo) {
                if (isset($datos[$campo])) {
                    $updates[] = "$campo = ?";
                    $values[] = $datos[$campo];
                }
            }
            
            // Si hay campos para actualizar
            if (!empty($updates)) {
                // Agregar el ID al final de los valores
                $values[] = $id;
                
                // Construir la consulta SQL
                $sql = "UPDATE informaciongeneral SET " . implode(', ', $updates) . " WHERE id = ?";
                
                // Preparar y ejecutar la consulta
                $stmt = $this->db->prepare($sql);
                $resultado = $stmt->execute($values);
                
                // Registrar la consulta para depuración
                $valoresToLog = $values;
                array_pop($valoresToLog); // Quitar el ID para mejor legibilidad
                error_log("SQL ejecutado: " . $sql . " | Valores: " . implode(", ", $valoresToLog) . " | ID: $id");
                error_log("Resultado de actualización: " . ($resultado ? "Exitoso" : "Fallido") . " | Filas afectadas: " . $stmt->rowCount());
                
                return $resultado;
            }
            
            return false;
        } catch (\PDOException $e) {
            error_log("Error en MiembroModel::actualizar: " . $e->getMessage());
            throw new \Exception("Error al actualizar el miembro: " . $e->getMessage());
        }
    }

    /**
     * Obtiene un miembro por ID
     */
    public function obtenerPorId($id) {
        try {
            // CORREGIDO: Usar nombre de tabla correcto
            $stmt = $this->db->prepare("SELECT * FROM informaciongeneral WHERE id = ?");
            $stmt->execute([$id]);
            return $stmt->fetch();
        } catch (\PDOException $e) {
            error_log("Error al obtener miembro por ID: " . $e->getMessage());
            return false;
        }
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\models\Model.php
=============================================================

<?php
namespace App\Models;

abstract class Model {
    protected $db;
    protected $table;
    protected $fillable = [];
    
    public function __construct() {
        $database = \Database::getInstance(); // Usamos el namespace global
        $this->db = $database->getConnection();
    }
    
    /**
     * Encuentra un registro por su ID
     */
    public function findById($id) {
        $query = "SELECT * FROM {$this->table} WHERE id = :id LIMIT 1";
        $stmt = $this->db->prepare($query);
        $stmt->bindValue(':id', $id);
        $stmt->execute();
        return $stmt->fetch();
    }
    
    /**
     * Obtiene todos los registros
     */
    public function getAll() {
        $query = "SELECT * FROM {$this->table}";
        $stmt = $this->db->prepare($query);
        $stmt->execute();
        return $stmt->fetchAll();
    }
    
    /**
     * Crea un nuevo registro
     */
    public function create(array $data) {
        // Filtrar solo los campos permitidos
        $data = $this->filterFields($data);
        
        if (empty($data)) {
            return false;
        }
        
        $fields = array_keys($data);
        $placeholders = array_map(function($field) {
            return ':' . $field;
        }, $fields);
        
        $query = "INSERT INTO {$this->table} (" . implode(', ', $fields) . ") 
                  VALUES (" . implode(', ', $placeholders) . ")";
        
        $stmt = $this->db->prepare($query);
        
        foreach ($data as $key => $value) {
            $stmt->bindValue(':' . $key, $value);
        }
        
        $stmt->execute();
        return $this->db->lastInsertId();
    }
    
    /**
     * Actualiza un registro existente
     */
    public function update($id, $data) {
        $fields = [];
        foreach ($data as $key => $value) {
            $fields[] = "{$key} = :{$key}";
        }
        
        $query = "UPDATE {$this->table} SET " . implode(', ', $fields) . " WHERE id = :id";
        $stmt = $this->db->prepare($query);
        
        foreach ($data as $key => $value) {
            $stmt->bindValue(":{$key}", $value);
        }
        
        $stmt->bindValue(':id', $id);
        return $stmt->execute();
    }
    
    /**
     * Elimina un registro
     */
    public function delete($id) {
        $query = "DELETE FROM {$this->table} WHERE id = :id";
        $stmt = $this->db->prepare($query);
        $stmt->bindValue(':id', $id);
        return $stmt->execute();
    }
    
    /**
     * Filtra los campos según las reglas de fillable y guarded
     */
    protected function filterFields(array $data) {
        if (!empty($this->fillable)) {
            return array_intersect_key($data, array_flip($this->fillable));
        }
        
        return $data;
    }
    
    /**
     * Encuentra registros por condición
     */
    public function findWhere($field, $value) {
        $query = "SELECT * FROM {$this->table} WHERE {$field} = :value";
        $stmt = $this->db->prepare($query);
        $stmt->bindValue(':value', $value);
        $stmt->execute();
        return $stmt->fetchAll();
    }
    
    /**
     * Encuentra un único registro por condición
     */
    public function findOneWhere($field, $value) {
        $query = "SELECT * FROM {$this->table} WHERE {$field} = :value LIMIT 1";
        $stmt = $this->db->prepare($query);
        $stmt->bindValue(':value', $value);
        $stmt->execute();
        return $stmt->fetch();
    }
    
    /**
     * Cuenta registros totales
     */
    public function count() {
        $query = "SELECT COUNT(*) as count FROM {$this->table}";
        $stmt = $this->db->prepare($query);
        $stmt->execute();
        $result = $stmt->fetch();
        return (int) $result['count'];
    }
    
    /**
     * Ejecuta una consulta personalizada
     */
    public function query($sql, $params = []) {
        $stmt = $this->db->prepare($sql);
        $stmt->execute($params);
        return $stmt;
    }
    
    /**
     * Obtiene una fila de la base de datos
     * 
     * @param string $sql Consulta SQL
     * @param array $params Parámetros para la consulta
     * @return array|null Fila encontrada o null
     */
    protected function getRow($sql, $params = []) {
        $stmt = $this->db->prepare($sql);
        $stmt->execute($params);
        return $stmt->fetch(\PDO::FETCH_ASSOC);
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\models\Permiso.php
=============================================================

<?php

namespace App\Models;

class Permiso extends Model {
    protected $table = 'Permisos';
    protected $fillable = ['nombre', 'descripcion', 'categoria'];
    
    /**
     * Obtiene todos los permisos agrupados por categoría
     */
    public function getAllByCategory() {
        $sql = "SELECT * FROM {$this->table} ORDER BY categoria, nombre";
        $stmt = $this->db->prepare($sql);
        $stmt->execute();
        $permisos = $stmt->fetchAll();
        
        $result = [];
        foreach ($permisos as $permiso) {
            $categoria = $permiso['categoria'];
            if (!isset($result[$categoria])) {
                $result[$categoria] = [];
            }
            $result[$categoria][] = $permiso;
        }
        
        return $result;
    }
    
    /**
     * Verifica si un usuario tiene un permiso específico
     */
    public function usuarioTienePermiso($userId, $permisoNombre) {
        $sql = "SELECT COUNT(*) FROM Permisos p 
                JOIN RolesPermisos rp ON p.id = rp.permiso_id 
                JOIN Roles r ON r.id = rp.rol_id
                JOIN Usuarios u ON u.rol_id = r.id
                WHERE u.id = ? AND p.nombre = ?";
        
        $stmt = $this->db->prepare($sql);
        $stmt->execute([$userId, $permisoNombre]);
        return (int)$stmt->fetchColumn() > 0;
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\models\Rol.php
=============================================================

<?php
namespace App\Models;

class Rol extends Model {
    protected $table = 'Roles';
    protected $fillable = ['nombre', 'descripcion', 'nivel_acceso'];
    
    /**
     * Obtiene todos los permisos asociados a este rol
     */
    public function getPermisos($rolId) {
        $sql = "SELECT p.* FROM Permisos p 
                JOIN RolesPermisos rp ON p.id = rp.permiso_id 
                WHERE rp.rol_id = ?";
                
        $stmt = $this->db->prepare($sql);
        $stmt->execute([$rolId]);
        return $stmt->fetchAll();
    }
    
    /**
     * Verifica si el rol tiene un permiso específico
     */
    public function tienePermiso($rolId, $permisoNombre) {
        $sql = "SELECT COUNT(*) FROM Permisos p 
                JOIN RolesPermisos rp ON p.id = rp.permiso_id 
                WHERE rp.rol_id = ? AND p.nombre = ?";
                
        $stmt = $this->db->prepare($sql);
        $stmt->execute([$rolId, $permisoNombre]);
        return (int)$stmt->fetchColumn() > 0;
    }
    
    /**
     * Asigna un permiso al rol
     */
    public function asignarPermiso($rolId, $permisoId) {
        $sql = "INSERT IGNORE INTO RolesPermisos (rol_id, permiso_id) VALUES (?, ?)";
        $stmt = $this->db->prepare($sql);
        return $stmt->execute([$rolId, $permisoId]);
    }
    
    /**
     * Revoca un permiso del rol
     */
    public function revocarPermiso($rolId, $permisoId) {
        $sql = "DELETE FROM RolesPermisos WHERE rol_id = ? AND permiso_id = ?";
        $stmt = $this->db->prepare($sql);
        return $stmt->execute([$rolId, $permisoId]);
    }
    
    /**
     * Elimina todos los permisos de un rol
     */
    public function eliminarTodosPermisos($rolId) {
        $sql = "DELETE FROM RolesPermisos WHERE rol_id = ?";
        $stmt = $this->db->prepare($sql);
        return $stmt->execute([$rolId]);
    }
    
    /**
     * Obtiene los usuarios asignados a un rol
     */
    public function getUsuarios($rolId) {
        $sql = "SELECT u.* FROM Usuarios u WHERE u.rol_id = ?";
        $stmt = $this->db->prepare($sql);
        $stmt->execute([$rolId]);
        return $stmt->fetchAll();
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\models\SaludEmergencias.php
=============================================================

<?php

namespace App\Models;

class SaludEmergencias {
    private $db;
    
    public function __construct() {
        $this->db = \Database::getInstance()->getConnection();
    }
    
    public function actualizarPorMiembroId($miembroId, $datos) {
        // Verificar si ya existe un registro
        $stmt = $this->db->prepare("SELECT id FROM SaludEmergencias WHERE miembro_id = ?");
        $stmt->execute([$miembroId]);
        $existente = $stmt->fetch(\PDO::FETCH_ASSOC);
        
        if ($existente) {
            // Actualizar registro existente
            $campos = [];
            $valores = [];
            
            foreach ($datos as $campo => $valor) {
                $campos[] = "$campo = ?";
                $valores[] = $valor;
            }
            
            $valores[] = $miembroId; // Para el WHERE
            
            $sql = "UPDATE SaludEmergencias SET " . implode(', ', $campos) . " WHERE miembro_id = ?";
            $stmt = $this->db->prepare($sql);
            return $stmt->execute($valores);
        } else {
            // Crear nuevo registro
            $datos['miembro_id'] = $miembroId;
            
            $campos = array_keys($datos);
            $placeholders = array_fill(0, count($campos), '?');
            
            $sql = "INSERT INTO SaludEmergencias (" . implode(', ', $campos) . ") VALUES (" . implode(', ', $placeholders) . ")";
            $stmt = $this->db->prepare($sql);
            return $stmt->execute(array_values($datos));
        }
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\models\Tallas.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\models\Tallas.php
namespace App\Models;

class Tallas extends Model {
    protected $table = 'Tallas';
    protected $fillable = [
        'miembro_id', 'talla_camisa', 'talla_camiseta', 'talla_pantalon',
        'talla_zapatos'
    ];
    
    /**
     * Encuentra la información de tallas por ID de miembro
     */
    public function findByMiembro($miembroId) {
        $sql = "SELECT * FROM {$this->table} WHERE miembro_id = :miembro_id LIMIT 1";
        $stmt = $this->db->prepare($sql);
        $stmt->execute(['miembro_id' => $miembroId]);
        return $stmt->fetch();
    }
    
    /**
     * Actualiza o crea un registro de tallas para un miembro
     */
    public function actualizarOCrear($miembroId, $datos) {
        $actual = $this->findByMiembro($miembroId);
        
        if ($actual) {
            return $this->update($actual['id'], $datos);
        } else {
            $datos['miembro_id'] = $miembroId;
            return $this->create($datos);
        }
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\models\Usuario.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\models\Usuario.php
namespace App\Models;

class Usuario extends Model {
    protected $table = 'usuarios';
    // Actualizar $fillable para que coincida con la estructura de la tabla
    protected $fillable = [
        'username', 
        'email', 
        'password', 
        'nombre_completo', 
        'miembro_id', 
        'rol_id',
        'ultimo_acceso', 
        'estado',
        'intentos_fallidos',
        'token_reset'
    ];
    
    /**
     * Encuentra un usuario por su nombre de usuario
     */
    public function findByUsername($username) {
        return $this->findOneWhere('username', $username);
    }
    
    /**
     * Encuentra un usuario por su correo electrónico
     */
    public function findByEmail($email) {
        return $this->findOneWhere('email', $email);
    }
    
    /**
     * Encuentra un usuario por email o nombre de usuario
     * @param string $emailOrUsername Email o nombre de usuario
     * @return array|bool El usuario encontrado o false
     */
    public function findByEmailOrUsername($emailOrUsername) {
        $query = "SELECT * FROM {$this->table} WHERE email = ? OR username = ? LIMIT 1";
        $stmt = $this->db->prepare($query);
        $stmt->execute([$emailOrUsername, $emailOrUsername]);
        
        $result = $stmt->fetch();
        return $result ? $result : false;
    }
    
    /**
     * Encuentra un registro por una condición específica
     */
    public function findOneWhere($field, $value) {
        $query = "SELECT * FROM {$this->table} WHERE {$field} = :value LIMIT 1";
        $stmt = $this->db->prepare($query);
        $stmt->bindValue(':value', $value);
        $stmt->execute();
        return $stmt->fetch();
    }
    
    /**
     * Encuentra un usuario por su ID
     */
    public function findById($id) {
        $query = "SELECT * FROM {$this->table} WHERE id = ? LIMIT 1";
        $stmt = $this->db->prepare($query);
        $stmt->execute([$id]);
        
        return $stmt->fetch();
    }

    /**
     * Autentica un usuario por su nombre de usuario/email y contraseña
     */
    public function authenticate($username, $password) {
        echo "<div style='background:#f8f9fa;padding:10px;margin:10px 0;border-radius:5px;'>";
        echo "<h4>Depuración de autenticación:</h4>";
        
        $user = $this->findByUsername($username);
        echo "<p>Buscando por username: " . ($user ? "Encontrado" : "No encontrado") . "</p>";
        
        if (!$user) {
            // Intentar con email
            echo "<p>Buscando por email...</p>";
            $user = $this->findByEmail($username);
            echo "<p>Resultado búsqueda por email: " . ($user ? "Encontrado" : "No encontrado") . "</p>";
        }
        
        if (!$user) {
            echo "<p>Usuario no encontrado</p>";
            echo "</div>";
            return false;
        }
        
        // Verificamos si la contraseña está hasheada correctamente
        echo "<p>Usuario encontrado, ID: {$user['id']}, Username: {$user['username']}</p>";
        echo "<p>Hash almacenado: {$user['password']}</p>";
        
        $passwordMatch = password_verify($password, $user['password']);
        echo "<p>Contraseña introducida: $password</p>";
        echo "<p>¿Contraseña coincide?: " . ($passwordMatch ? "SÍ" : "NO") . "</p>";
        
        echo "</div>";
        
        if (!$passwordMatch) {
            return false;
        }
        
        // Actualizar último acceso (no último_login)
        $this->update($user['id'], [
            'ultimo_acceso' => date('Y-m-d H:i:s')
        ]);
        
        return $user;
    }
    
    /**
     * Hashea una contraseña
     */
    public function hashPassword($password) {
        return password_hash($password, PASSWORD_DEFAULT);
    }
    
    /**
     * Verifica si una contraseña coincide con su hash
     */
    public function verifyPassword($password, $hash) {
        return password_verify($password, $hash);
    }
    
    /**
     * Crea un nuevo usuario con contraseña hasheada
     */
    public function register($data) {
        // Log para depuración
        error_log("Intentando registrar usuario: " . $data['username']);
        
        // Verificar si el usuario ya existe
        if ($this->findByUsername($data['username'])) {
            error_log("Usuario ya existe: " . $data['username']);
            return false;
        }
        
        // Verificar si el email ya existe
        if (!empty($data['email']) && $this->findByEmail($data['email'])) {
            error_log("Email ya existe: " . $data['email']);
            return false;
        }
        
        // Hashear la contraseña
        $data['password'] = $this->hashPassword($data['password']);
        
        // Asegurar que tiene campos obligatorios
        if (!isset($data['miembro_id'])) {
            error_log("Falta miembro_id para el usuario: " . $data['username']);
            return false;
        }
        
        if (!isset($data['rol_id'])) {
            error_log("Falta rol_id para el usuario: " . $data['username']);
            return false;
        }
        
        // Crear el usuario
        try {
            $id = $this->create($data);
            error_log("Usuario creado con ID: $id");
            return $id;
        } catch (\PDOException $e) {
            error_log("Error al crear usuario: " . $e->getMessage());
            return false;
        }
    }
    
    /**
     * Obtiene los roles del usuario
     */
    public function getRoles($userId) {
        $sql = "SELECT r.* FROM RolesUsuario ru
                JOIN Roles r ON ru.rol_id = r.id
                WHERE ru.usuario_id = :user_id";
                
        $stmt = $this->db->prepare($sql);
        $stmt->bindValue(':user_id', $userId);
        $stmt->execute();
        
        return $stmt->fetchAll();
    }
    
    /**
     * Verifica si un usuario tiene un rol específico
     */
    public function hasRole($userId, $roleName) {
        $sql = "SELECT COUNT(*) as count FROM RolesUsuario ru
                JOIN Roles r ON ru.rol_id = r.id
                WHERE ru.usuario_id = :user_id AND r.nombre = :role_name";
                
        $stmt = $this->db->prepare($sql);
        $stmt->bindValue(':user_id', $userId);
        $stmt->bindValue(':role_name', $roleName);
        $stmt->execute();
        
        $result = $stmt->fetch();
        return (int) $result['count'] > 0;
    }

    /**
     * Obtiene todos los usuarios
     */
    public function getAll() {
        $query = "SELECT * FROM {$this->table}";
        $stmt = $this->db->prepare($query);
        $stmt->execute();
        return $stmt->fetchAll();
    }

    /**
     * Actualiza un usuario
     */
    public function update($id, $data) {
        $fields = [];
        $values = [];
        
        foreach ($data as $key => $value) {
            $fields[] = "{$key} = ?";
            $values[] = $value;
        }
        
        // Añadir el ID al final del array de valores
        $values[] = $id;
        
        $query = "UPDATE {$this->table} SET " . implode(', ', $fields) . " WHERE id = ?";
        $stmt = $this->db->prepare($query);
        $stmt->execute($values);
        
        return $stmt->rowCount() > 0;
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\models\VerificationCode.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\models\VerificationCode.php
namespace App\Models;

class VerificationCode extends Model {
    protected $table = 'Verification_Codes';
    
    /**
     * Genera un código aleatorio de verificación
     * @return string Código de 6 dígitos
     */
    public static function generateCode() {
        return str_pad(rand(1, 999999), 6, '0', STR_PAD_LEFT);
    }
    
    /**
     * Crea un nuevo código de verificación para un usuario
     * @param int $userId ID del usuario
     * @param string $type Tipo de verificación (email_verification por defecto)
     * @return string El código generado
     */
    public function createForUser($userId, $type = 'email_verification') {
        $code = self::generateCode();
        $expiresAt = date('Y-m-d H:i:s', time() + 3600); // Expira en 1 hora
        
        $query = "INSERT INTO {$this->table} (user_id, code, type, expires_at, used) 
                 VALUES (?, ?, ?, ?, 0)";
        $stmt = $this->db->prepare($query);
        $stmt->execute([$userId, $code, $type, $expiresAt]);
        
        return $code;
    }
    
    /**
     * Verifica si un código es válido
     * @param int $userId ID del usuario
     * @param string $code Código a verificar
     * @param string $type Tipo de verificación
     * @return bool True si el código es válido, false en caso contrario
     */
    public function verifyCode($userId, $code, $type = 'email_verification') {
        $now = date('Y-m-d H:i:s');
        $query = "SELECT * FROM {$this->table} 
                 WHERE user_id = ? AND code = ? AND type = ? 
                 AND expires_at > ? AND used = 0
                 ORDER BY created_at DESC LIMIT 1";
                 
        $stmt = $this->db->prepare($query);
        $stmt->execute([$userId, $code, $type, $now]);
        $result = $stmt->fetch();
        
        if (!$result) {
            return false;
        }
        
        // Marcar el código como usado
        $updateQuery = "UPDATE {$this->table} SET used = 1 WHERE id = ?";
        $updateStmt = $this->db->prepare($updateQuery);
        $updateStmt->execute([$result['id']]);
        
        return true;
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\admin\roles\index.php
=============================================================

<?php 
require_once APP_PATH . '/views/partials/header.php';
require_once APP_PATH . '/views/partials/navbar.php';
?>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Gestión de Roles</h1>
        <a href="<?= APP_URL ?>/admin/roles/crear" class="btn btn-primary">
            <i class="fas fa-plus-circle"></i> Nuevo Rol
        </a>
    </div>
    
    <?php if(isset($_SESSION['flash_message'])): ?>
    <div class="alert alert-<?= $_SESSION['flash_type'] ?? 'info' ?> alert-dismissible fade show">
        <?= $_SESSION['flash_message'] ?>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <?php unset($_SESSION['flash_message']); unset($_SESSION['flash_type']); endif; ?>
    
    <div class="card shadow">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Nombre</th>
                            <th>Descripción</th>
                            <th>Nivel de Acceso</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach($roles as $rol): ?>
                        <tr>
                            <td><?= $rol['id'] ?></td>
                            <td><?= htmlspecialchars($rol['nombre']) ?></td>
                            <td><?= htmlspecialchars($rol['descripcion']) ?></td>
                            <td><?= $rol['nivel_acceso'] ?></td>
                            <td>
                                <a href="<?= APP_URL ?>/admin/roles/editar/<?= $rol['id'] ?>" class="btn btn-sm btn-info">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="<?= APP_URL ?>/admin/roles/permisos/<?= $rol['id'] ?>" class="btn btn-sm btn-warning">
                                    <i class="fas fa-key"></i>
                                </a>
                                <button class="btn btn-sm btn-danger" onclick="confirmarEliminar(<?= $rol['id'] ?>)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function confirmarEliminar(id) {
    if (confirm('¿Estás seguro de que deseas eliminar este rol?')) {
        window.location.href = '<?= APP_URL ?>/admin/roles/eliminar/' + id;
    }
}
</script>

<?php require_once APP_PATH . '/views/partials/footer.php'; ?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\admin\roles\permisos.php
=============================================================

<?php
require_once APP_PATH . '/views/partials/header.php';
require_once APP_PATH . '/views/partials/navbar.php';
?>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Permisos del Rol: <?= htmlspecialchars($rol['nombre']) ?></h1>
        <a href="<?= APP_URL ?>/admin/roles" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver a Roles
        </a>
    </div>
    
    <?php if(isset($_SESSION['flash_message'])): ?>
    <div class="alert alert-<?= $_SESSION['flash_type'] ?? 'info' ?> alert-dismissible fade show">
        <?= $_SESSION['flash_message'] ?>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <?php unset($_SESSION['flash_message']); unset($_SESSION['flash_type']); endif; ?>
    
    <div class="card shadow">
        <div class="card-body">
            <form action="<?= APP_URL ?>/admin/roles/permisos/<?= $rol['id'] ?>" method="post">
                <div class="row">
                    <?php foreach($permisos as $permiso): ?>
                    <div class="col-md-4 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="permisos[]" 
                                value="<?= $permiso['id'] ?>" id="permiso_<?= $permiso['id'] ?>"
                                <?= in_array($permiso['id'], $permisosRol) ? 'checked' : '' ?>>
                            <label class="form-check-label" for="permiso_<?= $permiso['id'] ?>">
                                <?= htmlspecialchars($permiso['nombre']) ?>
                                <small class="d-block text-muted"><?= htmlspecialchars($permiso['descripcion']) ?></small>
                            </label>
                        </div>
                    </div>
                    <?php endforeach; ?>
                </div>
                <div class="text-end mt-3">
                    <button type="submit" class="btn btn-primary">Guardar Permisos</button>
                </div>
            </form>
        </div>
    </div>
</div>

<?php require_once APP_PATH . '/views/partials/footer.php'; ?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\auth\forgot-password.php
=============================================================

<?php require_once APP_PATH . '/views/partials/header.php'; ?>

<div class="container">
    <div class="row justify-content-center mt-5">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow">
                <div class="card-body p-4">
                    <h2 class="text-center mb-4">Recuperar Contraseña</h2>
                    
                    <?php if(isset($_SESSION['flash_message'])): ?>
                    <div class="alert alert-<?= $_SESSION['flash_type'] ?? 'info' ?> alert-dismissible fade show">
                        <?= $_SESSION['flash_message'] ?>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    <?php unset($_SESSION['flash_message']); unset($_SESSION['flash_type']); endif; ?>
                    
                    <p class="text-muted mb-4">Ingresa tu dirección de correo electrónico y te enviaremos un enlace para restablecer tu contraseña.</p>
                    
                    <form action="<?= APP_URL ?>/auth/reset-password-request" method="post">
                        <div class="mb-3">
                            <label for="email" class="form-label">Correo Electrónico</label>
                            <input type="email" class="form-control" id="email" name="email" required autocomplete="email">
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Enviar Enlace de Recuperación</button>
                        </div>
                    </form>
                    
                    <div class="text-center mt-3">
                        <a href="<?= APP_URL ?>/login">Volver al Inicio de Sesión</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<?php require_once APP_PATH . '/views/partials/footer.php'; ?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\auth\login.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\views\auth\login.php
?>
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h2 class="my-2">Iniciar Sesión</h2>
        </div>
        <div class="card-body">
          <?php if (isset($_SESSION['flash_message'])): ?>
            <div class="alert alert-<?= $_SESSION['flash_type'] ?? 'info' ?>">
              <?= $_SESSION['flash_message'] ?>
              <?php if (isset($_SESSION['flash_action'])): ?>
                <div class="mt-2">
                  <?= $_SESSION['flash_action'] ?>
                </div>
              <?php endif; ?>
            </div>
            <?php 
              // Limpiar mensajes flash después de mostrarlos
              unset($_SESSION['flash_message']); 
              unset($_SESSION['flash_type']);
              unset($_SESSION['flash_action']);
            ?>
          <?php endif; ?>

          <?php if (isset($error)): ?>
            <div class="alert alert-danger">
              <?= $error ?>
              <?php if (isset($_SESSION['pending_verification'])): ?>
                <div class="mt-2">
                  <a href="<?= url('auth/resendCode') ?>" class="btn btn-sm btn-primary">Reenviar código</a>
                </div>
              <?php endif; ?>
            </div>
          <?php endif; ?>
          
          <form action="<?= url('auth/login', true) ?>" method="post" autocomplete="on">
            <!-- Asegurarnos de usar HTTPS -->
            <input type="hidden" name="secure_form" value="1">
            
            <div class="mb-3">
              <label for="email_or_username" class="form-label">Email o nombre de usuario</label>
              <input type="text" class="form-control" id="email_or_username" name="email_or_username" 
                     autocomplete="username" required autofocus>
            </div>
            
            <div class="mb-3">
              <label for="password" class="form-label">Contraseña</label>
              <input type="password" class="form-control" id="password" name="password" 
                     autocomplete="current-password" required>
            </div>
            
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary">Iniciar Sesión</button>
            </div>
          </form>
          
          <div class="text-center mt-3">
            <a href="<?= url('registro') ?>">¿No tienes cuenta? Regístrate</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\auth\register.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\views\auth\register.php
?>
<div class="row justify-content-center">
  <div class="col-md-8 col-lg-6">
    <div class="card shadow">
      <div class="card-body">
        <h3 class="card-title text-center mb-4">Registro de Usuario</h3>
        
        <?php if(isset($errors)): ?>
        <div class="alert alert-danger">
          <ul class="mb-0">
            <?php foreach($errors as $error): ?>
            <li><?= $error ?></li>
            <?php endforeach; ?>
          </ul>
        </div>
        <?php endif; ?>
        
        <form action="<?= APP_URL ?>/auth/registro" method="post">
          <!-- Nombre completo -->
          <div class="mb-3">
            <label for="nombre_completo" class="form-label">Nombre completo</label>
            <input type="text" class="form-control" id="nombre_completo" name="nombre_completo" required>
          </div>
          
          <!-- Nombre de usuario -->
          <div class="mb-3">
            <label for="username" class="form-label">Nombre de usuario</label>
            <input type="text" class="form-control" id="username" name="username" required>
          </div>
          
          <!-- Correo electrónico -->
          <div class="mb-3">
            <label for="email" class="form-label">Correo electrónico</label>
            <input type="email" class="form-control" id="email" name="email" required>
          </div>
          
          <!-- Contraseña -->
          <div class="mb-3">
            <label for="password" class="form-label">Contraseña</label>
            <input type="password" class="form-control" id="password" name="password" required>
            <div class="form-text">Mínimo 6 caracteres</div>
          </div>
          
          <!-- Confirmación de contraseña -->
          <div class="mb-3">
            <label for="password_confirmation" class="form-label">Confirmar Contraseña</label>
            <input type="password" class="form-control" id="password_confirmation" name="password_confirmation" required>
          </div>
          
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary">Registrarse</button>
          </div>
        </form>
        
        <div class="text-center mt-3">
          <a href="<?= APP_URL ?>/login">¿Ya tienes cuenta? Iniciar sesión</a>
        </div>
      </div>
    </div>
  </div>
</div>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\auth\reset-password.php
=============================================================

<?php require_once APP_PATH . '/views/partials/header.php'; ?>

<div class="container">
    <div class="row justify-content-center mt-5">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow">
                <div class="card-body p-4">
                    <h2 class="text-center mb-4">Cambiar Contraseña</h2>
                    
                    <?php if(isset($_SESSION['flash_message'])): ?>
                    <div class="alert alert-<?= $_SESSION['flash_type'] ?? 'info' ?> alert-dismissible fade show">
                        <?= $_SESSION['flash_message'] ?>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    <?php unset($_SESSION['flash_message']); unset($_SESSION['flash_type']); endif; ?>
                    
                    <form action="<?= APP_URL ?>/auth/reset-password" method="post">
                        <input type="hidden" name="token" value="<?= $token ?>">
                        
                        <div class="mb-3">
                            <label for="password" class="form-label">Nueva Contraseña</label>
                            <input type="password" class="form-control" id="password" name="password" required minlength="6">
                        </div>
                        
                        <div class="mb-3">
                            <label for="password_confirmation" class="form-label">Confirmar Contraseña</label>
                            <input type="password" class="form-control" id="password_confirmation" name="password_confirmation" required minlength="6">
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Cambiar Contraseña</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<?php require_once APP_PATH . '/views/partials/footer.php'; ?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\auth\verify-login.php
=============================================================

<?php ?>
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h3 class="mb-0">Verificación de Inicio de Sesión</h3>
        </div>
        <div class="card-body">
          <?php if (isset($error)): ?>
            <div class="alert alert-danger">
              <?= $error ?>
            </div>
          <?php endif; ?>
          
          <p>Para proteger tu cuenta, hemos enviado un código de verificación al correo:</p>
          <p class="font-weight-bold"><?= htmlspecialchars($email) ?></p>
          
          <form action="<?= APP_URL ?>/auth/verify-login" method="post">
            <div class="mb-4">
              <label for="code" class="form-label">Código de verificación</label>
              <input type="text" class="form-control form-control-lg text-center" 
                     name="code" id="code" maxlength="6" 
                     style="font-size: 24px; letter-spacing: 8px;"
                     placeholder="------" required autofocus>
              <div class="form-text">Ingresa el código de 6 dígitos enviado a tu correo.</div>
            </div>
            
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary btn-lg">Verificar y Continuar</button>
            </div>
          </form>
          
          <div class="text-center mt-3">
            <p>¿No recibiste el código? <a href="<?= APP_URL ?>/auth/resend-login-code">Reenviar código</a></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Mejorar la experiencia de usuario para el campo de código
  document.getElementById('code').addEventListener('input', function(e) {
    // Permitir solo dígitos
    this.value = this.value.replace(/[^0-9]/g, '');
  });
</script>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\auth\verify.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\views\auth\verify.php
?>
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h2 class="my-2">Verificación de tu cuenta</h2>
        </div>
        <div class="card-body">
          <?php if (isset($error)): ?>
            <div class="alert alert-danger">
              <?= $error ?>
            </div>
          <?php endif; ?>
          
          <p>Hemos enviado un código de verificación al correo <strong><?= $email ?></strong></p>
          <p>Ingresa el código de 6 dígitos para verificar tu cuenta:</p>
          
          <form action="<?= APP_URL ?>/auth/verify" method="post">
            <div class="mb-4">
              <div class="verification-code-container">
                <input type="text" class="form-control text-center fw-bold" 
                       name="code" id="code" maxlength="6" 
                       style="font-size: 24px; letter-spacing: 8px;"
                       placeholder="------" required autofocus>
              </div>
            </div>
            
            <div class="d-grid mb-3">
              <button type="submit" class="btn btn-primary btn-lg">Verificar Cuenta</button>
            </div>
          </form>
          
          <div class="text-center mt-3">
            <p>¿No recibiste el código? <a href="<?= APP_URL ?>/auth/resendCode">Reenviar código</a></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.getElementById('code').addEventListener('input', function(e) {
    // Permitir solo dígitos
    this.value = this.value.replace(/[^0-9]/g, '');
  });
</script>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\errors\404.php
=============================================================

<?php
// filepath: /Applications/XAMPP/xamppfiles/htdocs/Encasa_Database/app/views/errors/404.php
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>404 - Página no encontrada | <?= APP_NAME ?></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6 text-center">
                <h1 class="display-1">404</h1>
                <p class="lead">Página no encontrada</p>
                <p>La página que estás buscando no existe o ha sido movida.</p>
                <a href="<?= APP_URL ?>" class="btn btn-primary">Volver al inicio</a>
            </div>
        </div>
    </div>
</body>
</html>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\errors\acceso-denegado.php
=============================================================

<?php
 require_once APP_PATH . '/views/partials/header.php';
?>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card border-danger shadow">
                <div class="card-header bg-danger text-white">
                    <h3 class="mb-0">Acceso Denegado</h3>
                </div>
                <div class="card-body text-center">
                    <i class="fas fa-exclamation-triangle text-danger fa-5x mb-4"></i>
                    <h4>No tienes permisos suficientes para acceder a esta página</h4>
                    <p class="text-muted">Por favor, contacta con el administrador si consideras que deberías tener acceso.</p>
                    
                    <div class="mt-4">
                        <a href="<?= APP_URL ?>/" class="btn btn-primary">
                            <i class="fas fa-home"></i> Volver al Inicio
                        </a>
                        <a href="<?= APP_URL ?>/logout" class="btn btn-outline-secondary ml-2">
                            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<?php require_once APP_PATH . '/views/partials/footer.php'; ?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\errors\general.php
=============================================================

<?php ?>
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h3>Error <?= $code ?></h3>
                </div>
                <div class="card-body">
                    <p class="card-text"><?= $message ?: 'Ha ocurrido un error al procesar tu solicitud.' ?></p>
                    <a href="<?= url('') ?>" class="btn btn-primary">Volver al inicio</a>
                </div>
            </div>
        </div>
    </div>
</div>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\home\index.php
=============================================================

<?php
// filepath: /Applications/XAMPP/xamppfiles/htdocs/Encasa_Database/app/views/home/index.php
?>
<div class="jumbotron bg-light p-5 rounded mb-4">
    <h1 class="display-4">¡Bienvenido a Iglesia En Casa!</h1>
    <p class="lead">Sistema de gestión de información para la comunidad</p>
    <hr class="my-4">
    
    <?php if (isset($user) && $user): ?>
        <p class="mb-4">Hola, <strong><?= htmlspecialchars($user['nombre_completo'] ?? $user['username']) ?></strong>. Bienvenido al sistema de gestión.</p>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Miembros</h5>
                        <p class="card-text">Gestiona la información de los miembros de la iglesia.</p>
                    </div>
                    <div class="card-footer bg-transparent border-0">
                        <a href="<?= APP_URL ?>/miembros" class="btn btn-primary">Ver miembros</a>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Ministerios</h5>
                        <p class="card-text">Administra los ministerios y sus participantes.</p>
                    </div>
                    <div class="card-footer bg-transparent border-0">
                        <a href="<?= APP_URL ?>/ministerios" class="btn btn-primary">Ver ministerios</a>
                    </div>
                </div>
            </div>
        </div>
    <?php else: ?>
        <p class="mb-4">Este sistema te permite gestionar la información de la Iglesia En Casa.</p>
        <div class="d-grid gap-2 d-md-block">
            <a class="btn btn-primary btn-lg" href="<?= APP_URL ?>/login">Iniciar sesión</a>
            <a class="btn btn-outline-primary btn-lg" href="<?= APP_URL ?>/registro">Registrarse</a>
        </div>
    <?php endif; ?>
</div>

<?php if (!isset($user) || !$user): ?>
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">¿Qué es Iglesia En Casa?</h5>
            </div>
            <div class="card-body">
                <p class="card-text">Iglesia En Casa es una comunidad cristiana comprometida con compartir el amor de Dios y ayudar a otros a encontrar su propósito.</p>
                <p class="card-text">Este sistema nos permite administrar la información de nuestros miembros y ministerios de manera eficiente.</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Contacto</h5>
            </div>
            <div class="card-body">
                <p class="card-text">Si tienes alguna duda sobre el sistema o deseas más información, no dudes en contactarnos.</p>
                <p class="card-text">Email: contacto@iglesiaencasa.org</p>
                <p class="card-text">Teléfono: (123) 456-7890</p>
            </div>
        </div>
    </div>
</div>
<?php endif; ?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\layouts\auth.php
=============================================================

<?php
// filepath: /Applications/XAMPP/xamppfiles/htdocs/Encasa_Database/app/views/layouts/auth.php
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= isset($title) ? $title . ' - ' . APP_NAME : APP_NAME ?></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="referrer" content="origin">
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="text-center mb-4">
            <h1 class="display-4 mb-3"><?= APP_NAME ?></h1>
            <p class="lead text-muted">Sistema de gestión de información</p>
        </div>
        
        <?php if (isset($_SESSION['flash_message'])): ?>
            <div class="alert alert-<?= $_SESSION['flash_type'] ?? 'info' ?> alert-dismissible fade show">
                <?= $_SESSION['flash_message'] ?>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <?php unset($_SESSION['flash_message'], $_SESSION['flash_type']); ?>
        <?php endif; ?>
        
        <?= $content ?>
        
        <div class="text-center mt-5">
            <p class="text-muted">&copy; <?= date('Y') ?> - <?= APP_NAME ?></p>
            <p><a href="<?= APP_URL ?>">Volver al inicio</a></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\layouts\default.php
=============================================================

<?php
// Comentario actualizado para reflejar la ruta correcta en Windows
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\views\layouts\default.php
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= isset($title) ? $title . ' - ' . APP_NAME : APP_NAME ?></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="<?= url() ?>">Iglesia En Casa</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="<?= url() ?>">Inicio</a>
                    </li>
                    <?php if (isset($_SESSION['user_id'])): ?>
                    <li class="nav-item">
                        <a class="nav-link" href="<?= url('miembros') ?>">Miembros</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="<?= url('ministerios') ?>">Ministerios</a>
                    </li>
                    <?php endif; ?>
                </ul>
                
                <ul class="navbar-nav ms-auto">
                    <?php if (isset($_SESSION['user_id'])): ?>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <?= isset($_SESSION['user_name']) ? htmlspecialchars($_SESSION['user_name']) : 'Usuario' ?>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="<?= url('perfil') ?>">Mi Perfil</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="<?= url('logout') ?>">Cerrar Sesión</a></li>
                        </ul>
                    </li>
                    <?php else: ?>
                    <li class="nav-item">
                        <a class="nav-link" href="<?= url('login') ?>">Iniciar Sesión</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="<?= url('registro') ?>">Registrarse</a>
                    </li>
                    <?php endif; ?>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container my-4">
        <?php if (isset($_SESSION['flash_message'])): ?>
        <div class="alert alert-<?= $_SESSION['flash_type'] ?? 'info' ?> alert-dismissible fade show">
            <?= $_SESSION['flash_message'] ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <?php 
            unset($_SESSION['flash_message'], $_SESSION['flash_type']); 
        endif; 
        ?>
        
        <?= $content ?>
    </main>

    <footer class="bg-dark text-white py-3 mt-4">
        <div class="container text-center">
            &copy; <?= date('Y') ?> - <?= APP_NAME ?>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\miembros\crear.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\views\miembros\crear.php

// Verificar si es modo edición
$esEdicion = isset($miembro) && !empty($miembro);
$titulo = $esEdicion ? 'Editar Miembro' : 'Registrar Nuevo Miembro';

// Variables para acceder fácilmente a los datos relacionados
$contacto = $esEdicion ? ($miembro['contacto'] ?? []) : [];
$estudios = $esEdicion ? ($miembro['estudiostrabajo'] ?? []) : [];
$tallas = $esEdicion ? ($miembro['tallas'] ?? []) : [];
$salud = $esEdicion ? ($miembro['saludemergencias'] ?? []) : [];
$carrera = $esEdicion ? ($miembro['carrerabiblica'] ?? []) : [];
?>

<div class="container mt-4">
    <h1><?= $titulo ?></h1>
    
    <!-- Área para mensajes -->
    <div id="mensajes-area"></div>
    
    <form action="<?= url($esEdicion ? 'miembros/actualizar/'.$miembro['id'] : 'miembros/guardar') ?>" method="POST" enctype="multipart/form-data" id="formMiembro">
        <!-- ID oculto para edición -->
        <?php if($esEdicion): ?>
            <input type="hidden" name="id" value="<?= $miembro['id'] ?>">
        <?php endif; ?>

        <!-- Navegación por pestañas -->
        <ul class="nav nav-tabs mb-4" id="miembroTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="datos-tab" data-bs-toggle="tab" href="#datos" role="tab">
                    <i class="fas fa-user me-1"></i> Información General
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="contacto-tab" data-bs-toggle="tab" href="#contacto" role="tab">
                    <i class="fas fa-address-book me-1"></i> Contacto
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="estudios-tab" data-bs-toggle="tab" href="#estudios" role="tab">
                    <i class="fas fa-graduation-cap me-1"></i> Estudios/Trabajo
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="tallas-tab" data-bs-toggle="tab" href="#tallas" role="tab">
                    <i class="fas fa-tshirt me-1"></i> Tallas
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="salud-tab" data-bs-toggle="tab" href="#salud" role="tab">
                    <i class="fas fa-heartbeat me-1"></i> Salud y Emergencias
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="espiritual-tab" data-bs-toggle="tab" href="#espiritual" role="tab">
                    <i class="fas fa-pray me-1"></i> Carrera Bíblica
                </a>
            </li>
        </ul>

        <div class="tab-content" id="miembroTabContent">
            <!-- Incluir contenido de pestañas desde archivos parciales -->
            <?php include 'partial/informacion_general.php'; ?>
            <?php include 'partial/contacto.php'; ?>
            <?php include 'partial/estudios.php'; ?>
            <?php include 'partial/tallas.php'; ?>
            <?php include 'partial/salud.php'; ?>
            <?php include 'partial/carrera.php'; ?>
        </div>

        <!-- Campos ocultos para fechas de modificación -->
        <input type="hidden" name="fecha_modificacion" value="<?php echo date('Y-m-d H:i:s'); ?>">
        <!-- Cambiar nombre del campo para coincidir con la columna de la BD -->
        <input type="hidden" name="fecha_registro_sistema" value="<?php echo date('Y-m-d H:i:s'); ?>">

        <!-- Botones de acción generales -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save me-1"></i> <?= $esEdicion ? 'Actualizar' : 'Registrar' ?> Miembro Completo
            </button>
            <a href="<?= url('miembros') ?>" class="btn btn-secondary btn-lg">
                <i class="fas fa-times me-1"></i> Cancelar
            </a>
        </div>
        
        <!-- Botones de prueba para cada tabla -->
        <div class="mt-4 mb-3">
            <h5>Herramientas de prueba (guardar tabla por tabla):</h5>
            <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-outline-primary btn-probar-tabla" data-tabla="miembro">
                    <i class="fas fa-user me-1"></i> Probar Información General
                </button>
                <button type="button" class="btn btn-outline-primary btn-probar-tabla" data-tabla="contacto">
                    <i class="fas fa-address-book me-1"></i> Probar Contacto
                </button>
                <button type="button" class="btn btn-outline-primary btn-probar-tabla" data-tabla="estudiostrabajo">
                    <i class="fas fa-graduation-cap me-1"></i> Probar Estudios/Trabajo
                </button>
                <button type="button" class="btn btn-outline-primary btn-probar-tabla" data-tabla="tallas">
                    <i class="fas fa-tshirt me-1"></i> Probar Tallas
                </button>
                <button type="button" class="btn btn-outline-primary btn-probar-tabla" data-tabla="saludemergencias">
                    <i class="fas fa-heartbeat me-1"></i> Probar Salud
                </button>
                <button type="button" class="btn btn-outline-primary btn-probar-tabla" data-tabla="carrerabiblica">
                    <i class="fas fa-pray me-1"></i> Probar Carrera Bíblica
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Cargar archivos JavaScript -->
<script src="<?= url('assets/js/miembros/location-data.js') ?>"></script>
<script src="<?= url('assets/js/miembros/geo-data.js') ?>"></script>
<script src="<?= url('assets/js/miembros/form-handlers.js') ?>"></script>
<script src="<?= url('assets/js/formulario-estudios.js') ?>"></script>
<script src="<?= url('assets/js/tabla-por-tabla.js') ?>"></script>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\miembros\editar.php
=============================================================

<?php
// Verificar si es modo edición
$esEdicion = true;
$titulo = 'Editar Miembro';

// Variables para acceder fácilmente a los datos relacionados
$contacto = $miembro['contacto'] ?? [];
$estudios = $miembro['estudiostrabajo'] ?? [];
$tallas = $miembro['tallas'] ?? [];
$salud = $miembro['saludemergencias'] ?? [];
$carrera = $miembro['carrerabiblica'] ?? [];
?>

<div class="container mt-4">
    <h1><?= $titulo ?></h1>
    
    <!-- Área para mensajes -->
    <div id="mensajes-area"></div>
    
    <!-- Asegúrate de que el formulario tenga el enctype correcto -->
    <form id="formMiembro" action="<?= url('miembros/actualizar/'.$miembro['id']) ?>" method="POST" enctype="multipart/form-data">
        <!-- ID oculto para edición -->
        <input type="hidden" name="id" value="<?= htmlspecialchars($miembro['id']) ?>">

        <!-- Navegación por pestañas -->
        <ul class="nav nav-tabs mb-4" id="miembroTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="datos-tab" data-bs-toggle="tab" href="#datos" role="tab">
                    <i class="fas fa-user me-1"></i> Información General
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="contacto-tab" data-bs-toggle="tab" href="#contacto" role="tab">
                    <i class="fas fa-address-book me-1"></i> Contacto
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="estudios-tab" data-bs-toggle="tab" href="#estudios" role="tab">
                    <i class="fas fa-graduation-cap me-1"></i> Estudios/Trabajo
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="tallas-tab" data-bs-toggle="tab" href="#tallas" role="tab">
                    <i class="fas fa-tshirt me-1"></i> Tallas
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="salud-tab" data-bs-toggle="tab" href="#salud" role="tab">
                    <i class="fas fa-heartbeat me-1"></i> Salud y Emergencias
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="carrera-tab" data-bs-toggle="tab" href="#carrera" role="tab">
                    <i class="fas fa-pray me-1"></i> Carrera Bíblica
                </a>
            </li>
        </ul>

        <div class="tab-content" id="miembroTabContent">
            <!-- Incluir contenido de pestañas desde archivos parciales -->
            <?php include 'partial/informacion_general.php'; ?>
            <?php include 'partial/contacto.php'; ?>
            <?php include 'partial/estudios.php'; ?>
            <?php include 'partial/tallas.php'; ?>
            <?php include 'partial/salud.php'; ?>
            <?php include 'partial/carrera.php'; ?>
        </div>

        <!-- Campos ocultos para fechas de modificación -->
        <input type="hidden" name="fecha_modificacion" value="<?php echo date('Y-m-d H:i:s'); ?>">

        <!-- Botones de acción generales -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <button type="submit" class="btn btn-primary btn-lg" id="btnGuardar">
                <i class="fas fa-save me-1"></i> Actualizar Miembro
            </button>
            <a href="<?= url('miembros') ?>" class="btn btn-secondary btn-lg">
                <i class="fas fa-times me-1"></i> Cancelar
            </a>
        </div>
    </form>
</div>

<!-- Añade este script ANTES de los demás scripts -->
<script src="<?= url('assets/js/miembros/MiembrosController.js') ?>"></script>

<!-- Scripts existentes -->
<script src="<?= url('assets/js/miembros/location-data.js') ?>"></script>
<script src="<?= url('assets/js/miembros/geo-data.js') ?>"></script>
<script src="<?= url('assets/js/miembros/form-handlers.js') ?>"></script>
<script src="<?= url('assets/js/formulario-estudios.js') ?>"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar el controlador de miembros con ID correcto
    const miembrosController = new MiembrosController('formMiembro', {
        successRedirect: '<?= url("miembros/{$miembro['id']}") ?>',
        errorRedirect: '<?= url("miembros/editar/{$miembro['id']}") ?>'
    });
    
    // Verificar si el formulario existe antes de agregar el event listener
    const form = document.getElementById('formMiembro');
    
    if (form) {
        // En el evento submit del formulario
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Verificar si hay un archivo para subir
            const fileInput = form.querySelector('input[type="file"]');
            if (fileInput && fileInput.files.length > 0) {
                console.log("Archivo seleccionado:", fileInput.files[0].name);
            } else {
                console.log("No se ha seleccionado ningún archivo");
            }
            
            const formData = new FormData(form);
            
            // Usar el controlador si está definido, o hacer el fetch directamente
            if (typeof miembrosController !== 'undefined') {
                miembrosController.submitForm(formData)
                    .then(data => {
                        if (!data.success) {
                            alert("Error: " + data.message);
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });
            } else {
                console.warn("MiembrosController no disponible, usando fetch directo");
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = data.redirect || '<?= url("miembros/{$miembro['id']}") ?>';
                    } else {
                        alert("Error: " + data.message);
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                });
            }
        });
    } else {
        console.error("Formulario #formMiembro no encontrado en la página");
    }
});
</script>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\miembros\index.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\views\miembros\index.php
?>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Directorio de Miembros</h1>
        <a href="<?= APP_URL ?>/miembros/crear" class="btn btn-primary">
            <i class="fas fa-plus-circle"></i> Nuevo Miembro
        </a>
    </div>
    
    <?php if (isset($_SESSION['flash_message'])): ?>
        <div class="alert alert-<?= $_SESSION['flash_type'] ?? 'info' ?> alert-dismissible fade show">
            <?= $_SESSION['flash_message'] ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <?php 
        unset($_SESSION['flash_message']);
        unset($_SESSION['flash_type']);
        ?>
    <?php endif; ?>
    
    <!-- Formulario de búsqueda -->
    <div class="card mb-4">
        <div class="card-body">
            <form action="<?= APP_URL ?>/miembros" method="get" class="row g-3">
                <div class="col-md-8">
                    <input type="text" name="busqueda" class="form-control" 
                           placeholder="Buscar por nombre, apellido, celular, localidad..." 
                           value="<?= htmlspecialchars($busqueda ?? '') ?>">
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="card shadow">
        <div class="card-body">
            <?php if (empty($miembros)): ?>
                <div class="alert alert-info">
                    <?= !empty($busqueda) ? 'No se encontraron resultados para tu búsqueda.' : 'No hay miembros registrados todavía.' ?>
                </div>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre completo</th>
                                <th>Celular</th>
                                <th>Localidad</th>
                                <th>Estado espiritual</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($miembros as $miembro): ?>
                                <tr>
                                    <td><?= $miembro['id'] ?></td>
                                    <td><?= htmlspecialchars($miembro['nombres'] . ' ' . $miembro['apellidos']) ?></td>
                                    <td><?= htmlspecialchars($miembro['celular'] ?? 'No registrado') ?></td>
                                    <td><?= htmlspecialchars($miembro['localidad'] ?? 'No registrada') ?></td>
                                    <td><?= htmlspecialchars($miembro['estado_espiritual'] ?? 'No registrado') ?></td>
                                    <td>
                                        <a href="<?= APP_URL ?>/miembros/<?= $miembro['id'] ?>" class="btn btn-sm btn-info" title="Ver detalles">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginación -->
                <?php if ($totalPaginas > 1): ?>
                    <nav aria-label="Navegación de páginas">
                        <ul class="pagination justify-content-center">
                            <?php if ($pagina > 1): ?>
                                <li class="page-item">
                                    <a class="page-link" href="<?= APP_URL ?>/miembros?pagina=<?= $pagina - 1 ?><?= !empty($busqueda) ? '&busqueda=' . urlencode($busqueda) : '' ?>">
                                        &laquo; Anterior
                                    </a>
                                </li>
                            <?php endif; ?>
                            
                            <?php for ($i = 1; $i <= $totalPaginas; $i++): ?>
                                <li class="page-item <?= $i === $pagina ? 'active' : '' ?>">
                                    <a class="page-link" href="<?= APP_URL ?>/miembros?pagina=<?= $i ?><?= !empty($busqueda) ? '&busqueda=' . urlencode($busqueda) : '' ?>">
                                        <?= $i ?>
                                    </a>
                                </li>
                            <?php endfor; ?>
                            
                            <?php if ($pagina < $totalPaginas): ?>
                                <li class="page-item">
                                    <a class="page-link" href="<?= APP_URL ?>/miembros?pagina=<?= $pagina + 1 ?><?= !empty($busqueda) ? '&busqueda=' . urlencode($busqueda) : '' ?>">
                                        Siguiente &raquo;
                                    </a>
                                </li>
                            <?php endif; ?>
                        </ul>
                    </nav>
                <?php endif; ?>
            <?php endif; ?>
        </div>
    </div>
</div>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\miembros\ver.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\app\views\miembros\ver.php

// IMPORTANTE: Primero detectar el ID de la URL 
$uri = $_SERVER['REQUEST_URI'];
$debug_id = null;
if (preg_match('#/miembros/(\d+)#', $uri, $matches)) {
    $debug_id = (int)$matches[1];
    error_log("ID detectado en URL: {$debug_id}");
}

// Verificar si los datos del miembro corresponden al ID de la URL
if ($debug_id && (!isset($miembro['id']) || $miembro['id'] != $debug_id)) {
    error_log("ID del miembro en datos ({$miembro['id']}) no coincide con ID en URL ({$debug_id})");
    
    // Forzar la obtención de datos correctos (solución de emergencia)
    require_once __DIR__ . '/../../models/Miembro.php';
    $model = new \App\Models\Miembro();
    $miembro = $model->getFullProfile($debug_id);
    
    error_log("Datos forzados obtenidos: " . json_encode(array_keys($miembro)));
}

// Añadir comentario de depuración
echo "<!-- DEBUG: ID URL: {$debug_id} | ID miembro: {$miembro['id']} -->";
// Añadir esta línea de depuración temporal
echo "<!-- DEBUG: " . htmlspecialchars(json_encode($miembro)) . " -->";
?>
<?php 
// Verificar que tenemos datos del miembro
if (!isset($miembro) || !is_array($miembro)) {
    echo '<div class="alert alert-danger">Error: No se encontraron datos del miembro</div>';
    return;
}
?>

<div class="container mt-4">
    <!-- Reemplazar la sección actual de botones -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><?= htmlspecialchars($miembro['nombres'] . ' ' . $miembro['apellidos']) ?></h1>
        <div class="btn-group" role="group">
            <a href="<?= url('miembros/editar/'.$miembro['id']) ?>" class="btn btn-primary me-2">
                <i class="fas fa-edit"></i> Editar
            </a>
            <a href="<?= url('miembros/eliminar/'.$miembro['id']) ?>" class="btn btn-danger" 
               onclick="return confirm('¿Está seguro que desea eliminar este miembro? Esta acción no se puede deshacer.');">
                <i class="fas fa-trash"></i> Eliminar
            </a>
            <a href="<?= url('miembros') ?>" class="btn btn-secondary ms-2">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <!-- Información de perfil en pestañas -->
    <ul class="nav nav-tabs" id="perfilTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="general-tab" data-bs-toggle="tab" href="#general" role="tab">Información General</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="contacto-tab" data-bs-toggle="tab" href="#contacto" role="tab">Contacto</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="estudios-tab" data-bs-toggle="tab" href="#estudios" role="tab">Estudios/Trabajo</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="tallas-tab" data-bs-toggle="tab" href="#tallas" role="tab">Tallas</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="salud-tab" data-bs-toggle="tab" href="#salud" role="tab">Salud</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="carrera-tab" data-bs-toggle="tab" href="#carrera" role="tab">Carrera Bíblica</a>
        </li>
    </ul>

    <div class="tab-content mt-4">
        <!-- Pestaña de Información General -->
        <div class="tab-pane fade show active" id="general" role="tabpanel">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <!-- Foto del miembro -->
                    <div class="card">
                        <div class="card-body text-center">
                            <?php if(!empty($miembro['foto'])): 
                                $imagen_url = url('public/uploads/miembros/'.$miembro['foto']);
                                $ruta_fisica = __DIR__ . '/../../../public/uploads/miembros/'.$miembro['foto'];
                                $existe_archivo = file_exists($ruta_fisica);
                            ?>
                                <!-- Eliminar toda la información de depuración y mantener solo la imagen -->
                                <img src="<?= $imagen_url ?>" class="img-fluid rounded" alt="Foto de perfil">
                            <?php else: ?>
                                <div class="p-5 bg-light rounded text-center">
                                    <i class="fas fa-user fa-4x text-secondary"></i>
                                    <p class="mt-2">Sin foto</p>
                                </div>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5>Información Personal</h5>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <tbody>
                                    <tr>
                                        <th width="35%">ID:</th>
                                        <td><?= htmlspecialchars($miembro['id']) ?></td>
                                    </tr>
                                    <tr>
                                        <th>Nombres:</th>
                                        <td><?= htmlspecialchars($miembro['nombres']) ?></td>
                                    </tr>
                                    <tr>
                                        <th>Apellidos:</th>
                                        <td><?= htmlspecialchars($miembro['apellidos']) ?></td>
                                    </tr>
                                    <tr>
                                        <th>Celular:</th>
                                        <td><?= htmlspecialchars($miembro['celular'] ?? 'No registrado') ?></td>
                                    </tr>
                                    <tr>
                                        <th>Localidad:</th>
                                        <td><?= htmlspecialchars($miembro['localidad'] ?? 'No registrada') ?></td>
                                    </tr>
                                    <tr>
                                        <th>Barrio:</th>
                                        <td><?= htmlspecialchars($miembro['barrio'] ?? 'No registrado') ?></td>
                                    </tr>
                                    <tr>
                                        <th>Fecha de Nacimiento:</th>
                                        <td><?= $miembro['fecha_nacimiento'] ? date('d/m/Y', strtotime($miembro['fecha_nacimiento'])) : 'No registrada' ?></td>
                                    </tr>
                                    <tr>
                                        <th>Fecha de Ingreso a la Iglesia:</th>
                                        <td><?= $miembro['fecha_ingreso_iglesia'] ? date('d/m/Y', strtotime($miembro['fecha_ingreso_iglesia'])) : 'No registrada' ?></td>
                                    </tr>
                                    <tr>
                                        <th>Fecha de Registro en Sistema:</th>
                                        <td><?= date('d/m/Y H:i', strtotime($miembro['fecha_registro_sistema'])) ?></td>
                                    </tr>
                                    <tr>
                                        <th>Estado Espiritual:</th>
                                        <td><?= htmlspecialchars($miembro['estado_espiritual'] ?? 'No registrado') ?></td>
                                    </tr>
                                    <tr>
                                        <th>Conector:</th>
                                        <td><?= htmlspecialchars($miembro['conector'] ?? 'No registrado') ?></td>
                                    </tr>
                                    <tr>
                                        <th>Invitado por:</th>
                                        <td>
                                            <?php if(!empty($miembro['invitado_por'])): ?>
                                                <?php 
                                                // Recuperar datos del invitador
                                                $db = \Database::getInstance()->getConnection();
                                                $stmt = $db->prepare("SELECT nombres, apellidos FROM InformacionGeneral WHERE id = ?");
                                                $stmt->execute([$miembro['invitado_por']]);
                                                $invitador = $stmt->fetch(PDO::FETCH_ASSOC);
                                                
                                                if($invitador): ?>
                                                <a href="<?= url('miembros/'.$miembro['invitado_por']) ?>">
                                                    <?= htmlspecialchars($invitador['nombres'] . ' ' . $invitador['apellidos']) ?>
                                                </a>
                                                <?php else: ?>
                                                    Miembro #<?= $miembro['invitado_por'] ?> (No encontrado)
                                                <?php endif; ?>
                                            <?php else: ?>
                                                No registrado
                                            <?php endif; ?>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Habeas Data:</th>
                                        <td><?= !empty($miembro['habeas_data']) ? '<i class="fas fa-check-circle text-success"></i> Aceptado' : '<i class="fas fa-times-circle text-danger"></i> No aceptado' ?></td>
                                    </tr>
                                    <tr>
                                        <th>Estado del Miembro:</th>
                                        <td>
                                            <?php
                                            // Colorea el estado según la categoría
                                            $estado = htmlspecialchars($miembro['estado_miembro'] ?? 'Por Validar Estado');
                                            $color_clase = '';
                                            
                                            // Contacto inicial (rojo/morado)
                                            if (in_array($estado, ['Primer contacto', 'Conectado', 'Primer intento', 'Segundo intento', 
                                                                'Tercero intento', 'Intento llamada telefónica', 'Intento 2 llamada telefónica', 
                                                                'Intento 3 llamada telefónica', 'No interesado'])) {
                                                $color_clase = 'bg-danger-subtle';
                                            }
                                            // Desayunos (azul claro)
                                            else if (in_array($estado, ['No confirma desayuno', 'Confirmado a Desayuno', 'Desayuno Asistido'])) {
                                                $color_clase = 'bg-info-subtle';
                                            }
                                            // Miembros (verde)
                                            else if (in_array($estado, ['Miembro activo', 'Miembro inactivo', 'Miembro ausente', 
                                                                     'Congregado sin desayuno', 'Visitante'])) {
                                                $color_clase = 'bg-success-subtle';
                                            }
                                            // Líderes (azul)
                                            else if (in_array($estado, ['Líder Activo', 'Líder Inactivo', 'Líder ausente'])) {
                                                $color_clase = 'bg-primary-subtle';
                                            }
                                            // Reconexión (verde/amarillo)
                                            else if (in_array($estado, ['Reconectado', 'Intento de reconexión', 'Etapa 1 reconexión (1 mes)',
                                                                     'Etapa 2 reconexión (3 mes)', 'Etapa 3 reconexión final (6 mes)'])) {
                                                $color_clase = 'bg-warning-subtle';
                                            }
                                            // Ministerios (amarillo)
                                            else if (in_array($estado, ['Vencedores Kids', 'Legado', 'No es legado'])) {
                                                $color_clase = 'bg-warning-subtle';
                                            }
                                            // Otras (naranja)
                                            else {
                                                $color_clase = 'bg-secondary-subtle';
                                            }
                                            ?>
                                            <span class="badge rounded-pill <?= $color_clase ?> text-dark px-3 py-2"><?= $estado ?></span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <?php if(isset($miembro['recorrido_espiritual']) && !empty($miembro['recorrido_espiritual'])): ?>
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5>Recorrido Espiritual</h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text"><?= nl2br(htmlspecialchars($miembro['recorrido_espiritual'])) ?></p>
                        </div>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>

        <!-- Pestaña de Contacto -->
        <div class="tab-pane fade" id="contacto" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Información de Contacto</h5>
                    <?php if(isset($miembro['contacto'])): ?>
                        <table class="table table-striped">
                            <tbody>
                                <tr>
                                    <th width="35%">Tipo Documento:</th>
                                    <td><?= htmlspecialchars($miembro['contacto']['tipo_documento'] ?? 'No registrado') ?></td>
                                </tr>
                                <tr>
                                    <th>Número Documento:</th>
                                    <td><?= htmlspecialchars($miembro['contacto']['numero_documento'] ?? 'No registrado') ?></td>
                                </tr>
                                <tr>
                                    <th>Teléfono:</th>
                                    <td><?= htmlspecialchars($miembro['contacto']['telefono'] ?? 'No registrado') ?></td>
                                </tr>
                                <tr>
                                    <th>Correo Electrónico:</th>
                                    <td><?= htmlspecialchars($miembro['contacto']['correo_electronico'] ?? 'No registrado') ?></td>
                                </tr>
                                <tr>
                                    <th>País:</th>
                                    <td><?= htmlspecialchars($miembro['contacto']['pais'] ?? 'No registrado') ?></td>
                                </tr>
                                <tr>
                                    <th>Ciudad:</th>
                                    <td><?= htmlspecialchars($miembro['contacto']['ciudad'] ?? 'No registrada') ?></td>
                                </tr>
                                <tr>
                                    <th>Dirección:</th>
                                    <td><?= htmlspecialchars($miembro['contacto']['direccion'] ?? 'No registrada') ?></td>
                                </tr>
                                <tr>
                                    <th>Estado Civil:</th>
                                    <td><?= htmlspecialchars($miembro['contacto']['estado_civil'] ?? 'No registrado') ?></td>
                                </tr>
                            </tbody>
                        </table>
                    <?php else: ?>
                        <div class="alert alert-info">No hay información de contacto disponible.</div>
                    <?php endif; ?>
                </div>
            </div>
        </div>

        <!-- Pestaña de Estudios/Trabajo -->
        <div class="tab-pane fade" id="estudios" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Información Académica y Laboral</h5>
                    <?php if(isset($miembro['estudiostrabajo'])): ?>
                        <table class="table table-striped">
                            <tbody>
                                <tr>
                                    <th width="35%">Nivel de Estudios:</th>
                                    <td><?= htmlspecialchars($miembro['estudiostrabajo']['nivel_estudios'] ?? 'No registrado') ?></td>
                                </tr>
                                <tr>
                                    <th>Profesión:</th>
                                    <td><?= htmlspecialchars($miembro['estudiostrabajo']['profesion'] ?? 'No registrada') ?></td>
                                </tr>
                                <tr>
                                    <th>Otros Estudios:</th>
                                    <td><?= htmlspecialchars($miembro['estudiostrabajo']['otros_estudios'] ?? 'No registrados') ?></td>
                                </tr>
                                <tr>
                                    <th>Empresa:</th>
                                    <td><?= htmlspecialchars($miembro['estudiostrabajo']['empresa'] ?? 'No registrada') ?></td>
                                </tr>
                                <tr>
                                    <th>Dirección Empresa:</th>
                                    <td><?= htmlspecialchars($miembro['estudiostrabajo']['direccion_empresa'] ?? 'No registrada') ?></td>
                                </tr>
                                <tr>
                                    <th>Emprendimientos:</th>
                                    <td><?= htmlspecialchars($miembro['estudiostrabajo']['emprendimientos'] ?? 'No registrados') ?></td>
                                </tr>
                            </tbody>
                        </table>
                    <?php else: ?>
                        <div class="alert alert-info">No hay información de estudios y trabajo disponible.</div>
                    <?php endif; ?>
                </div>
            </div>
        </div>

        <!-- Pestaña de Tallas -->
        <div class="tab-pane fade" id="tallas" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Información de Tallas</h5>
                    <?php if(isset($miembro['tallas'])): ?>
                        <table class="table table-striped">
                            <tbody>
                                <tr>
                                    <th width="35%">Talla Camisa:</th>
                                    <td><?= htmlspecialchars($miembro['tallas']['talla_camisa'] ?? 'No registrada') ?></td>
                                </tr>
                                <tr>
                                    <th>Talla Camiseta:</th>
                                    <td><?= htmlspecialchars($miembro['tallas']['talla_camiseta'] ?? 'No registrada') ?></td>
                                </tr>
                                <tr>
                                    <th>Talla Pantalón:</th>
                                    <td><?= htmlspecialchars($miembro['tallas']['talla_pantalon'] ?? 'No registrada') ?></td>
                                </tr>
                                <tr>
                                    <th>Talla Zapatos:</th>
                                    <td><?= htmlspecialchars($miembro['tallas']['talla_zapatos'] ?? 'No registrada') ?></td>
                                </tr>
                            </tbody>
                        </table>
                    <?php else: ?>
                        <div class="alert alert-info">No hay información de tallas disponible.</div>
                    <?php endif; ?>
                </div>
            </div>
        </div>

        <!-- Pestaña de Salud y Emergencias -->
        <div class="tab-pane fade" id="salud" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Información de Salud y Emergencias</h5>
                    <?php if(isset($miembro['saludemergencias'])): ?>
                        <h6 class="mb-3">Información Médica</h6>
                        <table class="table table-striped mb-4">
                            <tbody>
                                <tr>
                                    <th width="35%">Tipo de Sangre (RH):</th>
                                    <td><?= htmlspecialchars($miembro['saludemergencias']['rh'] ?? 'No registrado') ?></td>
                                </tr>
                                <tr>
                                    <th>EPS:</th>
                                    <td><?= htmlspecialchars($miembro['saludemergencias']['eps'] ?? 'No registrada') ?></td>
                                </tr>
                            </tbody>
                        </table>

                        <h6 class="mb-3">Contactos de Emergencia</h6>
                        <table class="table table-striped">
                            <tbody>
                                <tr>
                                    <th width="35%">Contacto Principal:</th>
                                    <td><?= htmlspecialchars($miembro['saludemergencias']['acudiente1'] ?? 'No registrado') ?></td>
                                </tr>
                                <tr>
                                    <th>Teléfono Contacto Principal:</th>
                                    <td><?= htmlspecialchars($miembro['saludemergencias']['telefono1'] ?? 'No registrado') ?></td>
                                </tr>
                                <tr>
                                    <th>Contacto Secundario:</th>
                                    <td><?= htmlspecialchars($miembro['saludemergencias']['acudiente2'] ?? 'No registrado') ?></td>
                                </tr>
                                <tr>
                                    <th>Teléfono Contacto Secundario:</th>
                                    <td><?= htmlspecialchars($miembro['saludemergencias']['telefono2'] ?? 'No registrado') ?></td>
                                </tr>
                            </tbody>
                        </table>
                    <?php else: ?>
                        <div class="alert alert-info">No hay información de salud y emergencias disponible.</div>
                    <?php endif; ?>
                </div>
            </div>
        </div>

        <!-- Pestaña de Carrera Bíblica -->
        <div class="tab-pane fade" id="carrera" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Información de Carrera Bíblica</h5>
                    <?php if(isset($miembro['carrerabiblica'])): ?>
                        <table class="table table-striped">
                            <tbody>
                                <tr>
                                    <th width="35%">Estado:</th>
                                    <td><?= htmlspecialchars($miembro['carrerabiblica']['estado'] ?? 'No registrado') ?></td>
                                </tr>
                                <tr>
                                    <th>Carrera Bíblica:</th>
                                    <td><?= htmlspecialchars($miembro['carrerabiblica']['carrera_biblica'] ?? 'No registrada') ?></td>
                                </tr>
                                <tr>
                                    <th>Miembro de:</th>
                                    <td><?= htmlspecialchars($miembro['carrerabiblica']['miembro_de'] ?? 'No registrado') ?></td>
                                </tr>
                                <tr>
                                    <th>Casa de Palabra y Vida:</th>
                                    <td><?= htmlspecialchars($miembro['carrerabiblica']['casa_de_palabra_y_vida'] ?? 'No registrada') ?></td>
                                </tr>
                                <tr>
                                    <th>Cobertura:</th>
                                    <td><?= htmlspecialchars($miembro['carrerabiblica']['cobertura'] ?? 'No registrada') ?></td>
                                </tr>
                                <?php if(!empty($miembro['carrerabiblica']['anotaciones'])): ?>
                                <tr>
                                    <th>Anotaciones:</th>
                                    <td><?= nl2br(htmlspecialchars($miembro['carrerabiblica']['anotaciones'])) ?></td>
                                </tr>
                                <?php endif; ?>
                            </tbody>
                        </table>
                    <?php else: ?>
                        <div class="alert alert-info">No hay información de carrera bíblica disponible.</div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="eliminarMiembroModal" tabindex="-1" aria-labelledby="eliminarMiembroModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="eliminarMiembroModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar a <strong><?= htmlspecialchars($miembro['nombres'] . ' ' . $miembro['apellidos']) ?></strong>?</p>
                <p class="text-danger"><strong>Atención:</strong> Esta acción no se puede deshacer y eliminará todos los datos asociados al miembro.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a href="<?= url('miembros/eliminar/'.$miembro['id']) ?>" class="btn btn-danger">
                    Eliminar Definitivamente
                </a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Script para activar la eliminación de miembro
    const btnConfirmarEliminar = document.getElementById('btnConfirmarEliminar');
    
    btnConfirmarEliminar.addEventListener('click', function() {
        // Deshabilitar botón para evitar múltiples clics
        btnConfirmarEliminar.disabled = true;
        btnConfirmarEliminar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Eliminando...';
        
        // Enviar solicitud para eliminar el miembro
        fetch('<?= url('miembros/eliminar/'.$miembro['id']) ?>', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Mostrar mensaje temporal de éxito
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success';
                alertDiv.textContent = 'Miembro eliminado correctamente';
                document.body.insertBefore(alertDiv, document.body.firstChild);
                
                // Redireccionar después de un segundo
                setTimeout(() => {
                    window.location.href = '<?= url('miembros') ?>';
                }, 1000);
            } else {
                alert('Error: ' + (data.message || 'No se pudo eliminar el miembro'));
                btnConfirmarEliminar.disabled = false;
                btnConfirmarEliminar.innerHTML = 'Eliminar Miembro';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la solicitud');
            btnConfirmarEliminar.disabled = false;
            btnConfirmarEliminar.innerHTML = 'Eliminar Miembro';
        });
    });
    
    // Activar las pestañas de Bootstrap
    var tabTriggerList = [].slice.call(document.querySelectorAll('#perfilTabs a'))
    tabTriggerList.forEach(function(tabTriggerEl) {
        new bootstrap.Tab(tabTriggerEl)
    });
});
</script>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\miembros\partial\carrera.php
=============================================================

<div class="tab-pane fade" id="carrera" role="tabpanel">
    <div class="card shadow-sm">
        <div class="card-body">
            <!-- Formación espiritual -->
            <h5 class="card-title">Carrera Bíblica y Formación</h5>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="carrera_biblica" class="form-label">Carrera Bíblica</label>
                    <select class="form-select" id="carrera_biblica" name="carrera[carrera_biblica]">
                        <option value="">-- Seleccione --</option>
                        <option value="Nuevo Creyente" <?= isset($carrera['carrera_biblica']) && $carrera['carrera_biblica'] == 'Nuevo Creyente' ? 'selected' : '' ?>>Nuevo Creyente</option>
                        <option value="Consolidación" <?= isset($carrera['carrera_biblica']) && $carrera['carrera_biblica'] == 'Consolidación' ? 'selected' : '' ?>>Consolidación</option>
                        <option value="Discipulado Básico" <?= isset($carrera['carrera_biblica']) && $carrera['carrera_biblica'] == 'Discipulado Básico' ? 'selected' : '' ?>>Discipulado Básico</option>
                        <option value="Discipulado Avanzado" <?= isset($carrera['carrera_biblica']) && $carrera['carrera_biblica'] == 'Discipulado Avanzado' ? 'selected' : '' ?>>Discipulado Avanzado</option>
                        <option value="Formación Ministerial" <?= isset($carrera['carrera_biblica']) && $carrera['carrera_biblica'] == 'Formación Ministerial' ? 'selected' : '' ?>>Formación Ministerial</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="miembro_de" class="form-label">Miembro de</label>
                    <select class="form-select" id="miembro_de" name="carrera[miembro_de]">
                        <option value="">-- Seleccione --</option>
                        <option value="Congregación" <?= isset($carrera['miembro_de']) && $carrera['miembro_de'] == 'Congregación' ? 'selected' : '' ?>>Congregación</option>
                        <option value="Grupo de Crecimiento" <?= isset($carrera['miembro_de']) && $carrera['miembro_de'] == 'Grupo de Crecimiento' ? 'selected' : '' ?>>Grupo de Crecimiento</option>
                        <option value="Equipo de Servicio" <?= isset($carrera['miembro_de']) && $carrera['miembro_de'] == 'Equipo de Servicio' ? 'selected' : '' ?>>Equipo de Servicio</option>
                        <option value="Liderazgo" <?= isset($carrera['miembro_de']) && $carrera['miembro_de'] == 'Liderazgo' ? 'selected' : '' ?>>Liderazgo</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="casa_de_palabra_y_vida" class="form-label">Casa de Palabra y Vida</label>
                    <input type="text" class="form-control" id="casa_de_palabra_y_vida" name="carrera[casa_de_palabra_y_vida]" value="<?= isset($carrera['casa_de_palabra_y_vida']) ? $carrera['casa_de_palabra_y_vida'] : '' ?>">
                    <div class="form-text">Nombre de la casa o grupo al que pertenece</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="cobertura" class="form-label">Cobertura</label>
                    <input type="text" class="form-control" id="cobertura" name="carrera[cobertura]" value="<?= isset($carrera['cobertura']) ? $carrera['cobertura'] : '' ?>">
                    <div class="form-text">Líder espiritual que brinda cobertura</div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="estado" class="form-label">Estado</label>
                    <select class="form-select" id="estado" name="carrera[estado]">
                        <option value="">-- Seleccione --</option>
                        <option value="Activo" <?= isset($carrera['estado']) && $carrera['estado'] == 'Activo' ? 'selected' : '' ?>>Activo</option>
                        <option value="Inactivo" <?= isset($carrera['estado']) && $carrera['estado'] == 'Inactivo' ? 'selected' : '' ?>>Inactivo</option>
                        <option value="En Proceso" <?= isset($carrera['estado']) && $carrera['estado'] == 'En Proceso' ? 'selected' : '' ?>>En Proceso</option>
                        <option value="Visitante" <?= isset($carrera['estado']) && $carrera['estado'] == 'Visitante' ? 'selected' : '' ?>>Visitante</option>
                    </select>
                </div>
            </div>
            
            <!-- Anotaciones y recorrido espiritual -->
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="anotaciones" class="form-label">Anotaciones</label>
                    <textarea class="form-control" id="anotaciones" name="carrera[anotaciones]" rows="2"><?= isset($carrera['anotaciones']) ? $carrera['anotaciones'] : '' ?></textarea>
                    <div class="form-text">Notas breves sobre su participación y desarrollo</div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="recorrido_espiritual" class="form-label">Recorrido Espiritual</label>
                    <textarea class="form-control" id="recorrido_espiritual" name="carrera[recorrido_espiritual]" rows="3"><?= isset($carrera['recorrido_espiritual']) ? $carrera['recorrido_espiritual'] : '' ?></textarea>
                    <div class="form-text">Historia de fe y crecimiento espiritual del miembro</div>
                </div>
            </div>
        </div>
    </div>
</div>



=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\miembros\partial\contacto.php
=============================================================

<div class="tab-pane fade" id="contacto" role="tabpanel">
    <div class="card shadow-sm">
        <div class="card-body">
            <!-- Documentos de Identidad -->
            <h5 class="card-title">Documentos de Identidad</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="tipo_documento" class="form-label">Tipo de Documento</label>
                    <select class="form-select" id="tipo_documento" name="contacto[tipo_documento]">
                        <option value="">-- Seleccione --</option>
                        <option value="CC" <?= isset($contacto['tipo_documento']) && $contacto['tipo_documento'] == 'CC' ? 'selected' : '' ?>>Cédula de Ciudadanía</option>
                        <option value="TI" <?= isset($contacto['tipo_documento']) && $contacto['tipo_documento'] == 'TI' ? 'selected' : '' ?>>Tarjeta de Identidad</option>
                        <option value="CE" <?= isset($contacto['tipo_documento']) && $contacto['tipo_documento'] == 'CE' ? 'selected' : '' ?>>Cédula de Extranjería</option>
                        <option value="PP" <?= isset($contacto['tipo_documento']) && $contacto['tipo_documento'] == 'PP' ? 'selected' : '' ?>>Pasaporte</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="numero_documento" class="form-label">Número de Documento</label>
                    <input type="text" class="form-control" id="numero_documento" name="contacto[numero_documento]" value="<?= isset($contacto['numero_documento']) ? $contacto['numero_documento'] : '' ?>">
                </div>
            </div>
            
            <!-- Teléfono -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="telefono" class="form-label">Teléfono</label>
                    <input type="tel" class="form-control" id="telefono" name="contacto[telefono]" value="<?= isset($contacto['telefono']) ? $contacto['telefono'] : '' ?>">
                </div>
            </div>
            
            <!-- Ubicación geográfica -->
            <h5 class="card-title mt-3">Dirección y Ubicación</h5>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="pais" class="form-label">País</label>
                    <select class="form-select" id="pais" name="contacto[pais]" data-valor="<?= isset($contacto['pais']) ? htmlspecialchars($contacto['pais'], ENT_QUOTES) : '' ?>">
                        <option value="">-- Seleccione un país --</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="estado_departamento" class="form-label">Estado/Departamento</label>
                    <select class="form-select" id="estado_departamento" name="contacto[estado_departamento]" data-valor="<?= isset($contacto['estado_departamento']) ? htmlspecialchars($contacto['estado_departamento'], ENT_QUOTES) : '' ?>" disabled>
                        <option value="">-- Seleccione primero un país --</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="ciudad" class="form-label">Ciudad</label>
                    <select class="form-select" id="ciudad" name="contacto[ciudad]" data-valor="<?= isset($contacto['ciudad']) ? htmlspecialchars($contacto['ciudad'], ENT_QUOTES) : '' ?>" disabled>
                        <option value="">-- Seleccione primero un estado/departamento --</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="direccion" class="form-label">Dirección Completa</label>
                    <input type="text" class="form-control" id="direccion" name="contacto[direccion]" value="<?= isset($contacto['direccion']) ? $contacto['direccion'] : '' ?>">
                </div>
            </div>
            
            <!-- Correo electrónico -->
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="correo_electronico" class="form-label">Correo Electrónico</label>
                    <input type="email" class="form-control" id="correo_electronico" name="contacto[correo_electronico]" value="<?= isset($contacto['correo_electronico']) ? $contacto['correo_electronico'] : '' ?>">
                </div>
            </div>
            
            <!-- Redes sociales -->
            <h5 class="card-title mt-3">Redes Sociales</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="instagram" class="form-label"><i class="fab fa-instagram text-danger"></i> Instagram</label>
                    <input type="text" class="form-control" id="instagram" name="contacto[instagram]" value="<?= isset($contacto['instagram']) ? $contacto['instagram'] : '' ?>" placeholder="@usuario">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="facebook" class="form-label"><i class="fab fa-facebook text-primary"></i> Facebook</label>
                    <input type="text" class="form-control" id="facebook" name="contacto[facebook]" value="<?= isset($contacto['facebook']) ? $contacto['facebook'] : '' ?>" placeholder="Usuario o URL">
                </div>
            </div>
            
            <!-- Notas -->
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="notas" class="form-label">Notas</label>
                    <textarea class="form-control" id="notas" name="contacto[notas]" rows="2"><?= isset($contacto['notas']) ? $contacto['notas'] : '' ?></textarea>
                    <div class="form-text">Información adicional de contacto</div>
                </div>
            </div>
            
            <!-- Familiares -->
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="familiares" class="form-label">Familiares</label>
                    <textarea class="form-control" id="familiares" name="contacto[familiares]" rows="3"><?= isset($contacto['familiares']) ? $contacto['familiares'] : '' ?></textarea>
                    <div class="form-text">Información sobre familiares y relaciones</div>
                </div>
            </div>

            <!-- Estado Civil -->
            <div class="mb-3">
                <label for="contacto[estado_civil]" class="form-label">Estado Civil</label>
                <select class="form-select" id="contacto_estado_civil" name="contacto[estado_civil]">
                    <option value="">Seleccione...</option>
                    <option value="Soltero/a" <?= (isset($contacto['estado_civil']) && $contacto['estado_civil'] == 'Soltero/a') ? 'selected' : '' ?>>Soltero/a</option>
                    <option value="Casado/a" <?= (isset($contacto['estado_civil']) && $contacto['estado_civil'] == 'Casado/a') ? 'selected' : '' ?>>Casado/a</option>
                    <option value="Divorciado/a" <?= (isset($contacto['estado_civil']) && $contacto['estado_civil'] == 'Divorciado/a') ? 'selected' : '' ?>>Divorciado/a</option>
                    <option value="Viudo/a" <?= (isset($contacto['estado_civil']) && $contacto['estado_civil'] == 'Viudo/a') ? 'selected' : '' ?>>Viudo/a</option>
                    <option value="Unión libre" <?= (isset($contacto['estado_civil']) && $contacto['estado_civil'] == 'Unión libre') ? 'selected' : '' ?>>Unión libre</option>
                    <option value="Separado/a" <?= (isset($contacto['estado_civil']) && $contacto['estado_civil'] == 'Separado/a') ? 'selected' : '' ?>>Separado/a</option>
                </select>
            </div>
        </div>
    </div>
</div>



=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\miembros\partial\desactivar_tabla_por_tabla.php
=============================================================



// Desactivar temporalmente hasta que solucionemos el problema principal
document.addEventListener('DOMContentLoaded', function() {
    // Buscar todos los botones de guardar tabla por tabla y desactivarlos
    const botonesGuardarTabla = document.querySelectorAll('.guardar-tabla');
    if (botonesGuardarTabla.length > 0) {
        botonesGuardarTabla.forEach(btn => {
            btn.style.display = 'none'; // Ocultar botones
        });
    }
});


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\miembros\partial\estudios.php
=============================================================

<div class="tab-pane fade" id="estudios" role="tabpanel">
    <div class="card shadow-sm">
        <div class="card-body">
            <!-- Formación académica -->
            <h5 class="card-title">Formación Académica</h5>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="estudios_nivel_estudios" class="form-label">Nivel Educativo</label>
                    <select class="form-select" id="estudios_nivel_estudios" name="estudios[nivel_estudios]">
                        <option value="">Seleccione...</option>
                        <option value="Primaria" <?= (isset($estudios['nivel_estudios']) && $estudios['nivel_estudios'] == 'Primaria') ? 'selected' : '' ?>>Primaria</option>
                        <option value="Secundaria" <?= (isset($estudios['nivel_estudios']) && $estudios['nivel_estudios'] == 'Secundaria') ? 'selected' : '' ?>>Secundaria</option>
                        <option value="Técnico" <?= (isset($estudios['nivel_estudios']) && $estudios['nivel_estudios'] == 'Técnico') ? 'selected' : '' ?>>Técnico</option>
                        <option value="Tecnólogo" <?= (isset($estudios['nivel_estudios']) && $estudios['nivel_estudios'] == 'Tecnólogo') ? 'selected' : '' ?>>Tecnólogo</option>
                        <option value="Universitario" <?= (isset($estudios['nivel_estudios']) && $estudios['nivel_estudios'] == 'Universitario') ? 'selected' : '' ?>>Universitario</option>
                        <option value="Postgrado" <?= (isset($estudios['nivel_estudios']) && $estudios['nivel_estudios'] == 'Postgrado') ? 'selected' : '' ?>>Postgrado</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="institucion_educativa_select" class="form-label">Institución Educativa</label>
                    <select class="form-select" id="institucion_educativa_select" name="estudios[institucion_educativa_select]" disabled>
                        <option value="">-- Seleccione primero un nivel educativo --</option>
                    </select>
                    
                    <div id="institucion_personalizada_container" style="display:none; margin-top:10px;">
                        <input type="text" class="form-control" id="institucion_personalizada" 
                               placeholder="Nombre de la nueva institución" name="estudios[institucion_personalizada]">
                        <div class="form-text">La nueva institución será guardada en la base de datos</div>
                    </div>
                    
                    <!-- Campo oculto para almacenar la institución final (sea seleccionada o personalizada) -->
                    <input type="hidden" id="institucion_educativa" name="estudios[institucion_educativa]" 
                           value="<?= isset($estudios['institucion_educativa']) ? $estudios['institucion_educativa'] : '' ?>">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="profesion_select" class="form-label">Profesión/Carrera</label>
                    <select class="form-select" id="profesion_select" name="estudios[profesion_select]" disabled>
                        <option value="">-- Seleccione primero una institución --</option>
                    </select>
                    
                    <div id="profesion_personalizada_container" style="display:none; margin-top:10px;">
                        <input type="text" class="form-control" id="profesion_personalizada" 
                               placeholder="Nombre de la nueva profesión" name="estudios[profesion_personalizada]">
                        <div class="form-text">La nueva profesión será guardada en la base de datos</div>
                    </div>
                    
                    <!-- Campo oculto para almacenar la profesión final (sea seleccionada o personalizada) -->
                    <input type="hidden" id="profesion" name="estudios[profesion]" 
                           value="<?= isset($estudios['profesion']) ? $estudios['profesion'] : '' ?>">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="otros_estudios" class="form-label">Otros Estudios</label>
                    <textarea class="form-control" id="otros_estudios" name="estudios[otros_estudios]" rows="3"><?= isset($estudios['otros_estudios']) ? $estudios['otros_estudios'] : '' ?></textarea>
                    <div class="form-text">Incluya cursos adicionales, certificaciones, idiomas u otro tipo de formación complementaria</div>
                </div>
            </div>
            
            <!-- Información laboral -->
            <h5 class="card-title mt-3">Información Laboral</h5>
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="empresa" class="form-label">Empresa o Lugar de Trabajo</label>
                    <input type="text" class="form-control" id="empresa" name="estudios[empresa]" value="<?= isset($estudios['empresa']) ? $estudios['empresa'] : '' ?>">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="direccion_empresa" class="form-label">Dirección de la Empresa</label>
                    <input type="text" class="form-control" id="direccion_empresa" name="estudios[direccion_empresa]" value="<?= isset($estudios['direccion_empresa']) ? $estudios['direccion_empresa'] : '' ?>">
                    <div class="form-text">Indique la dirección completa del lugar donde trabaja actualmente</div>
                </div>
            </div>
            
            <!-- Emprendimientos -->
            <h5 class="card-title mt-3">Emprendimientos</h5>
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="emprendimientos" class="form-label">Proyectos o Emprendimientos</label>
                    <textarea class="form-control" id="emprendimientos" name="estudios[emprendimientos]" rows="3"><?= isset($estudios['emprendimientos']) ? $estudios['emprendimientos'] : '' ?></textarea>
                    <div class="form-text">Describa brevemente proyectos personales, emprendimientos o negocios propios</div>
                </div>
            </div>
        </div>
    </div>
</div>




<script src="<?= url('assets/js/education-data.js') ?>"></script>
<script src="<?= url('assets/js/formulario-estudios.js') ?>"></script>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\miembros\partial\informacion_general.php
=============================================================

<div class="tab-pane fade show active" id="datos" role="tabpanel">
    <div class="card shadow-sm">
        <div class="card-body">
            <!-- Foto del miembro (ahora al principio) -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <label for="foto" class="form-label">Foto</label>
                    <div class="input-group">
                        <input type="file" class="form-control" id="foto" name="foto" accept="image/*">
                        <label class="input-group-text" for="foto">Seleccionar</label>
                    </div>
                    <?php if($esEdicion && !empty($miembro['foto'])): ?>
                    <div class="mt-2">
                        <div class="d-flex align-items-center">
                            <img src="<?= url('uploads/miembros/'.$miembro['foto']) ?>" alt="Foto de <?= htmlspecialchars($miembro['nombres']) ?>" class="img-thumbnail me-2" style="max-height: 100px;">
                            <div>
                                <p class="mb-1">Foto actual</p>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="eliminar_foto" name="eliminar_foto" value="1">
                                    <label class="form-check-label text-danger" for="eliminar_foto">
                                        Eliminar foto actual
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <?php endif; ?>
                </div>
            </div>

            <!-- Nombres y apellidos -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="nombres" class="form-label">Nombres <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="nombres" name="nombres" 
                           value="<?= $esEdicion ? $miembro['nombres'] : '' ?>" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="apellidos" class="form-label">Apellidos <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="apellidos" name="apellidos" 
                           value="<?= $esEdicion ? $miembro['apellidos'] : '' ?>" required>
                </div>
            </div>

            <!-- Celular y fecha nacimiento -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="celular" class="form-label">Celular <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control" id="celular" name="celular" 
                           value="<?= $esEdicion ? $miembro['celular'] : '' ?>" placeholder="+57..." required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="fecha_nacimiento" class="form-label">Fecha de Nacimiento</label>
                    <input type="date" class="form-control" id="fecha_nacimiento" name="fecha_nacimiento" 
                           value="<?= $esEdicion ? $miembro['fecha_nacimiento'] : '' ?>">
                </div>
            </div>

            <!-- Localidad y barrio -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="localidad" class="form-label">Localidad</label>
                    <select class="form-select" id="localidad" name="localidad" data-valor="<?= $esEdicion ? htmlspecialchars($miembro['localidad'] ?? '', ENT_QUOTES) : '' ?>">
                        <option value="">-- Seleccione una localidad --</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="barrio" class="form-label">Barrio</label>
                    <select class="form-select" id="barrio" name="barrio" data-valor="<?= $esEdicion ? htmlspecialchars($miembro['barrio'] ?? '', ENT_QUOTES) : '' ?>">
                        <option value="">-- Seleccione primero una localidad --</option>
                    </select>
                    
                    <div id="barrio_personalizado_container" style="display:none; margin-top:10px;">
                        <input type="text" class="form-control" id="barrio_personalizado" 
                               placeholder="Escriba el nombre del barrio">
                        <div class="form-text">Este barrio se guardará para futura referencia</div>
                    </div>
                </div>
            </div>

            <!-- Invitado por y conector/canal -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="invitado_por" class="form-label">Invitado Por</label>
                    <select class="form-select" id="invitado_por" name="invitado_por">
                        <option value="">-- Seleccione --</option>
                        <?php if (isset($miembros) && is_array($miembros)): ?>
                            <?php foreach ($miembros as $invitador): ?>
                                <option value="<?= $invitador['id'] ?>" <?= $esEdicion && isset($miembro['invitado_por']) && $miembro['invitado_por'] == $invitador['id'] ? 'selected' : '' ?>>
                                    <?= htmlspecialchars($invitador['nombres'].' '.$invitador['apellidos']) ?>
                                </option>
                            <?php endforeach; ?>
                        <?php endif; ?>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="conector" class="form-label">Conector/Canal</label>
                    <select class="form-select" id="conector" name="conector">
                        <option value="">-- Seleccione --</option>
                        <option value="Redes Sociales" <?= $esEdicion && isset($miembro['conector']) && $miembro['conector'] == 'Redes Sociales' ? 'selected' : '' ?>>Redes Sociales</option>
                        <option value="Familiar" <?= $esEdicion && isset($miembro['conector']) && $miembro['conector'] == 'Familiar' ? 'selected' : '' ?>>Familiar</option>
                        <option value="Amigo" <?= $esEdicion && isset($miembro['conector']) && $miembro['conector'] == 'Amigo' ? 'selected' : '' ?>>Amigo</option>
                        <option value="Compañero de Trabajo" <?= $esEdicion && isset($miembro['conector']) && $miembro['conector'] == 'Compañero de Trabajo' ? 'selected' : '' ?>>Compañero de Trabajo</option>
                        <option value="Visita Espontánea" <?= $esEdicion && isset($miembro['conector']) && $miembro['conector'] == 'Visita Espontánea' ? 'selected' : '' ?>>Visita Espontánea</option>
                        <option value="Evento" <?= $esEdicion && isset($miembro['conector']) && $miembro['conector'] == 'Evento' ? 'selected' : '' ?>>Evento</option>
                        <option value="Volanteo" <?= $esEdicion && isset($miembro['conector']) && $miembro['conector'] == 'Volanteo' ? 'selected' : '' ?>>Volanteo</option>
                        <option value="Otro" <?= $esEdicion && isset($miembro['conector']) && !in_array($miembro['conector'], ['Redes Sociales', 'Familiar', 'Amigo', 'Compañero de Trabajo', 'Visita Espontánea', 'Evento', 'Volanteo']) ? 'selected' : '' ?>>Otro</option>
                    </select>
                </div>
            </div>

            <!-- Estado espiritual y fecha ingreso iglesia -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="estado_espiritual" class="form-label">Estado Espiritual</label>
                    <select class="form-select" id="estado_espiritual" name="estado_espiritual">
                        <option value="Nuevo" <?= (!$esEdicion || ($esEdicion && isset($miembro['estado_espiritual']) && $miembro['estado_espiritual'] == 'Nuevo')) ? 'selected' : '' ?>>Nuevo</option>
                        <option value="Visitante" <?= $esEdicion && isset($miembro['estado_espiritual']) && $miembro['estado_espiritual'] == 'Visitante' ? 'selected' : '' ?>>Visitante</option>
                        <option value="Simpatizante" <?= $esEdicion && isset($miembro['estado_espiritual']) && $miembro['estado_espiritual'] == 'Simpatizante' ? 'selected' : '' ?>>Simpatizante</option>
                        <option value="Discípulo" <?= $esEdicion && isset($miembro['estado_espiritual']) && $miembro['estado_espiritual'] == 'Discípulo' ? 'selected' : '' ?>>Discípulo</option>
                        <option value="Servidor" <?= $esEdicion && isset($miembro['estado_espiritual']) && $miembro['estado_espiritual'] == 'Servidor' ? 'selected' : '' ?>>Servidor</option>
                        <option value="Líder" <?= $esEdicion && isset($miembro['estado_espiritual']) && $miembro['estado_espiritual'] == 'Líder' ? 'selected' : '' ?>>Líder</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="fecha_ingreso_iglesia" class="form-label">Fecha de Ingreso a la Iglesia</label>
                    <input type="date" class="form-control" id="fecha_ingreso_iglesia" name="fecha_ingreso_iglesia" value="<?= $esEdicion && isset($miembro['fecha_ingreso_iglesia']) ? $miembro['fecha_ingreso_iglesia'] : '' ?>">
                </div>
            </div>

            <!-- Estado del miembro -->
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="estado_miembro" class="form-label">Estado del Miembro</label>
                    <select class="form-select" id="estado_miembro" name="estado_miembro">
                        <option value="Por Validar Estado" <?= (!$esEdicion || ($esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Por Validar Estado')) ? 'selected' : '' ?>>Por Validar Estado</option>
                        
                        <optgroup label="Contacto Inicial">
                            <option value="Primer contacto" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Primer contacto' ? 'selected' : '' ?>>Primer contacto</option>
                            <option value="Conectado" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Conectado' ? 'selected' : '' ?>>Conectado</option>
                            <option value="Primer intento" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Primer intento' ? 'selected' : '' ?>>Primer intento</option>
                            <option value="Segundo intento" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Segundo intento' ? 'selected' : '' ?>>Segundo intento</option>
                            <option value="Tercero intento" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Tercero intento' ? 'selected' : '' ?>>Tercero intento</option>
                            <option value="Intento llamada telefónica" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Intento llamada telefónica' ? 'selected' : '' ?>>Intento llamada telefónica</option>
                            <option value="Intento 2 llamada telefónica" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Intento 2 llamada telefónica' ? 'selected' : '' ?>>Intento 2 llamada telefónica</option>
                            <option value="Intento 3 llamada telefónica" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Intento 3 llamada telefónica' ? 'selected' : '' ?>>Intento 3 llamada telefónica</option>
                            <option value="No interesado" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'No interesado' ? 'selected' : '' ?>>No interesado</option>
                        </optgroup>
                        
                        <optgroup label="Desayunos">
                            <option value="No confirma desayuno" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'No confirma desayuno' ? 'selected' : '' ?>>No confirma desayuno</option>
                            <option value="Confirmado a Desayuno" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Confirmado a Desayuno' ? 'selected' : '' ?>>Confirmado a Desayuno</option>
                            <option value="Desayuno Asistido" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Desayuno Asistido' ? 'selected' : '' ?>>Desayuno Asistido</option>
                        </optgroup>
                        
                        <optgroup label="Miembros">
                            <option value="Miembro activo" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Miembro activo' ? 'selected' : '' ?>>Miembro activo</option>
                            <option value="Miembro inactivo" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Miembro inactivo' ? 'selected' : '' ?>>Miembro inactivo</option>
                            <option value="Miembro ausente" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Miembro ausente' ? 'selected' : '' ?>>Miembro ausente</option>
                            <option value="Congregado sin desayuno" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Congregado sin desayuno' ? 'selected' : '' ?>>Congregado sin desayuno</option>
                            <option value="Visitante" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Visitante' ? 'selected' : '' ?>>Visitante</option>
                        </optgroup>
                        
                        <optgroup label="Líderes">
                            <option value="Líder Activo" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Líder Activo' ? 'selected' : '' ?>>Líder Activo</option>
                            <option value="Líder inactivo" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Líder inactivo' ? 'selected' : '' ?>>Líder inactivo</option>
                            <option value="Líder ausente" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Líder ausente' ? 'selected' : '' ?>>Líder ausente</option>
                        </optgroup>
                        
                        <optgroup label="Reconexión">
                            <option value="Reconectado" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Reconectado' ? 'selected' : '' ?>>Reconectado</option>
                            <option value="Intento de reconexión" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Intento de reconexión' ? 'selected' : '' ?>>Intento de reconexión</option>
                            <option value="Etapa 1 reconexión (1 mes)" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Etapa 1 reconexión (1 mes)' ? 'selected' : '' ?>>Etapa 1 reconexión (1 mes)</option>
                            <option value="Etapa 2 reconexión (3 mes)" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Etapa 2 reconexión (3 mes)' ? 'selected' : '' ?>>Etapa 2 reconexión (3 mes)</option>
                            <option value="Etapa 3 reconexión final (6 mes)" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Etapa 3 reconexión final (6 mes)' ? 'selected' : '' ?>>Etapa 3 reconexión final (6 mes)</option>
                        </optgroup>
                        
                        <optgroup label="Ministerios">
                            <option value="Vencedores Kids" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Vencedores Kids' ? 'selected' : '' ?>>Vencedores Kids</option>
                            <option value="Legado" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Legado' ? 'selected' : '' ?>>Legado</option>
                            <option value="Micro Legado" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Micro Legado' ? 'selected' : '' ?>>Micro Legado</option>
                        </optgroup>
                        
                        <optgroup label="Otras">
                            <option value="Nulo" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Nulo' ? 'selected' : '' ?>>Nulo</option>
                            <option value="Delegado a acompañante" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Delegado a acompañante' ? 'selected' : '' ?>>Delegado a acompañante</option>
                            <option value="Datos no autorizados" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Datos no autorizados' ? 'selected' : '' ?>>Datos no autorizados</option>
                            <option value="Datos incorrectos" <?= $esEdicion && isset($miembro['estado_miembro']) && $miembro['estado_miembro'] == 'Datos incorrectos' ? 'selected' : '' ?>>Datos incorrectos</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <!-- Recorrido espiritual -->
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="recorrido_espiritual" class="form-label">Recorrido Espiritual</label>
                    <textarea class="form-control" id="recorrido_espiritual" name="recorrido_espiritual" rows="4"><?= $esEdicion && isset($miembro['recorrido_espiritual']) ? $miembro['recorrido_espiritual'] : '' ?></textarea>
                    <div class="form-text">Describe el recorrido y experiencia espiritual de la persona</div>
                </div>
            </div>
            
            <?php if($esEdicion): ?>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="fecha_registro_sistema" class="form-label">Fecha de Registro en Sistema</label>
                    <input type="text" class="form-control" id="fecha_registro_sistema" 
                           value="<?= date('d/m/Y H:i', strtotime($miembro['fecha_registro_sistema'])) ?>" readonly>
                    <div class="form-text">Este campo se genera automáticamente</div>
                </div>
            </div>
            <?php endif; ?>

            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="habeas_data" name="habeas_data" 
                       value="1" <?= $esEdicion && isset($miembro['habeas_data']) && $miembro['habeas_data'] ? 'checked' : '' ?>>
                <label class="form-check-label" for="habeas_data">
                    Acepto tratamiento de datos personales según la política de privacidad
                </label>
            </div>
        </div>
    </div>
</div>



=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\miembros\partial\salud.php
=============================================================

<div class="tab-pane fade" id="salud" role="tabpanel">
    <div class="card shadow-sm">
        <div class="card-body">
            <!-- Información médica básica -->
            <h5 class="card-title">Información Médica Básica</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="rh" class="form-label">Grupo Sanguíneo</label>
                    <select class="form-select" id="rh" name="salud[rh]">
                        <option value="">-- Seleccione --</option>
                        <option value="A+" <?= isset($salud['rh']) && $salud['rh'] == 'A+' ? 'selected' : '' ?>>A+</option>
                        <option value="A-" <?= isset($salud['rh']) && $salud['rh'] == 'A-' ? 'selected' : '' ?>>A-</option>
                        <option value="B+" <?= isset($salud['rh']) && $salud['rh'] == 'B+' ? 'selected' : '' ?>>B+</option>
                        <option value="B-" <?= isset($salud['rh']) && $salud['rh'] == 'B-' ? 'selected' : '' ?>>B-</option>
                        <option value="AB+" <?= isset($salud['rh']) && $salud['rh'] == 'AB+' ? 'selected' : '' ?>>AB+</option>
                        <option value="AB-" <?= isset($salud['rh']) && $salud['rh'] == 'AB-' ? 'selected' : '' ?>>AB-</option>
                        <option value="O+" <?= isset($salud['rh']) && $salud['rh'] == 'O+' ? 'selected' : '' ?>>O+</option>
                        <option value="O-" <?= isset($salud['rh']) && $salud['rh'] == 'O-' ? 'selected' : '' ?>>O-</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="eps" class="form-label">EPS / Seguro Médico</label>
                    <input type="text" class="form-control" id="eps" name="salud[eps]" value="<?= isset($salud['eps']) ? $salud['eps'] : '' ?>">
                </div>
            </div>
            
            <!-- Contactos de emergencia -->
            <h5 class="card-title mt-3">Contactos de Emergencia</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="acudiente1" class="form-label">Acudiente Principal</label>
                    <input type="text" class="form-control" id="acudiente1" name="salud[acudiente1]" value="<?= isset($salud['acudiente1']) ? $salud['acudiente1'] : '' ?>">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="telefono1" class="form-label">Teléfono Principal</label>
                    <input type="tel" class="form-control" id="telefono1" name="salud[telefono1]" value="<?= isset($salud['telefono1']) ? $salud['telefono1'] : '' ?>">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="acudiente2" class="form-label">Acudiente Secundario</label>
                    <input type="text" class="form-control" id="acudiente2" name="salud[acudiente2]" value="<?= isset($salud['acudiente2']) ? $salud['acudiente2'] : '' ?>">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="telefono2" class="form-label">Teléfono Secundario</label>
                    <input type="tel" class="form-control" id="telefono2" name="salud[telefono2]" value="<?= isset($salud['telefono2']) ? $salud['telefono2'] : '' ?>">
                </div>
            </div>
        </div>
    </div>
</div>



=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\miembros\partial\tallas.php
=============================================================

<div class="tab-pane fade" id="tallas" role="tabpanel">
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title">Tallas de Ropa</h5>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="talla_camisa" class="form-label">Talla Camisa</label>
                    <select class="form-select" id="talla_camisa" name="tallas[talla_camisa]">
                        <option value="">Seleccione...</option>
                        <option value="XS" <?= (isset($tallas['talla_camisa']) && $tallas['talla_camisa'] == 'XS') ? 'selected' : '' ?>>XS</option>
                        <option value="S" <?= (isset($tallas['talla_camisa']) && $tallas['talla_camisa'] == 'S') ? 'selected' : '' ?>>S</option>
                        <option value="M" <?= (isset($tallas['talla_camisa']) && $tallas['talla_camisa'] == 'M') ? 'selected' : '' ?>>M</option>
                        <option value="L" <?= (isset($tallas['talla_camisa']) && $tallas['talla_camisa'] == 'L') ? 'selected' : '' ?>>L</option>
                        <option value="XL" <?= (isset($tallas['talla_camisa']) && $tallas['talla_camisa'] == 'XL') ? 'selected' : '' ?>>XL</option>
                        <option value="XXL" <?= (isset($tallas['talla_camisa']) && $tallas['talla_camisa'] == 'XXL') ? 'selected' : '' ?>>XXL</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="talla_camiseta" class="form-label">Talla de Camiseta</label>
                    <select class="form-select" id="talla_camiseta" name="tallas[talla_camiseta]">
                        <option value="">-- Seleccione --</option>
                        <option value="XS" <?= isset($tallas['talla_camiseta']) && $tallas['talla_camiseta'] == 'XS' ? 'selected' : '' ?>>XS</option>
                        <option value="S" <?= isset($tallas['talla_camiseta']) && $tallas['talla_camiseta'] == 'S' ? 'selected' : '' ?>>S</option>
                        <option value="M" <?= isset($tallas['talla_camiseta']) && $tallas['talla_camiseta'] == 'M' ? 'selected' : '' ?>>M</option>
                        <option value="L" <?= isset($tallas['talla_camiseta']) && $tallas['talla_camiseta'] == 'L' ? 'selected' : '' ?>>L</option>
                        <option value="XL" <?= isset($tallas['talla_camiseta']) && $tallas['talla_camiseta'] == 'XL' ? 'selected' : '' ?>>XL</option>
                        <option value="XXL" <?= isset($tallas['talla_camiseta']) && $tallas['talla_camiseta'] == 'XXL' ? 'selected' : '' ?>>XXL</option>
                        <option value="XXXL" <?= isset($tallas['talla_camiseta']) && $tallas['talla_camiseta'] == 'XXXL' ? 'selected' : '' ?>>XXXL</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="talla_pantalon" class="form-label">Talla de Pantalón</label>
                    <select class="form-select" id="talla_pantalon" name="tallas[talla_pantalon]">
                        <option value="">-- Seleccione --</option>
                        <option value="28" <?= isset($tallas['talla_pantalon']) && $tallas['talla_pantalon'] == '28' ? 'selected' : '' ?>>28</option>
                        <option value="30" <?= isset($tallas['talla_pantalon']) && $tallas['talla_pantalon'] == '30' ? 'selected' : '' ?>>30</option>
                        <option value="32" <?= isset($tallas['talla_pantalon']) && $tallas['talla_pantalon'] == '32' ? 'selected' : '' ?>>32</option>
                        <option value="34" <?= isset($tallas['talla_pantalon']) && $tallas['talla_pantalon'] == '34' ? 'selected' : '' ?>>34</option>
                        <option value="36" <?= isset($tallas['talla_pantalon']) && $tallas['talla_pantalon'] == '36' ? 'selected' : '' ?>>36</option>
                        <option value="38" <?= isset($tallas['talla_pantalon']) && $tallas['talla_pantalon'] == '38' ? 'selected' : '' ?>>38</option>
                        <option value="40" <?= isset($tallas['talla_pantalon']) && $tallas['talla_pantalon'] == '40' ? 'selected' : '' ?>>40</option>
                        <option value="42" <?= isset($tallas['talla_pantalon']) && $tallas['talla_pantalon'] == '42' ? 'selected' : '' ?>>42</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="talla_zapatos" class="form-label">Talla de Zapatos</label>
                    <select class="form-select" id="talla_zapatos" name="tallas[talla_zapatos]">
                        <option value="">-- Seleccione --</option>
                        <?php for($i=34; $i<=46; $i++): ?>
                            <option value="<?= $i ?>" <?= isset($tallas['talla_zapatos']) && $tallas['talla_zapatos'] == $i ? 'selected' : '' ?>><?= $i ?></option>
                        <?php endfor; ?>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>



=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\partials\header.php
=============================================================

<?php
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= $title ?? 'Iglesia En Casa' ?></title>
    
    <!-- Solución temporal: Tailwind desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tus estilos existentes -->
    <link rel="stylesheet" href="<?= APP_URL ?>/app/public/css/styles.css">
    
    <!-- Bootstrap CSS (opcional - puedes eliminarlo cuando migres completamente a Tailwind) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <?php if (isset($page_specific_css)): ?>
    <!-- CSS específico de página -->
    <link rel="stylesheet" href="<?= APP_URL ?>/css/pages/<?= $page_specific_css ?>.css">
    <?php endif; ?>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Contenido principal de la página se insertará aquí -->


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\views\partials\navbar.php
=============================================================

<?php
// Añadir a tu barra de navegación

 if (isset($_SESSION['user_id'])): ?>
<div class="ml-auto">
    <a href="<?= APP_URL ?>/logout" class="btn btn-outline-light btn-sm">
        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
    </a>
</div>
<?php endif; ?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\database\permisos.php
=============================================================

<?php

require_once __DIR__ . '/../app/config/database.php';

try {
    $db = Database::getInstance()->getConnection();
    
    // Crear tabla de Permisos
    $db->exec("
        CREATE TABLE IF NOT EXISTS Permisos (
            id INT AUTO_INCREMENT PRIMARY KEY,
            nombre VARCHAR(50) NOT NULL UNIQUE,
            descripcion VARCHAR(255) NOT NULL,
            categoria VARCHAR(50) NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )
    ");
    
    // Crear tabla pivot RolesPermisos
    $db->exec("
        CREATE TABLE IF NOT EXISTS RolesPermisos (
            rol_id INT,
            permiso_id INT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (rol_id, permiso_id),
            FOREIGN KEY (rol_id) REFERENCES Roles(id) ON DELETE CASCADE,
            FOREIGN KEY (permiso_id) REFERENCES Permisos(id) ON DELETE CASCADE
        )
    ");
    
    // Insertar permisos básicos
    $permisos = [
        // Miembros
        ['ver_miembros', 'Ver listado de miembros', 'Miembros'],
        ['crear_miembro', 'Crear nuevos miembros', 'Miembros'],
        ['editar_miembro', 'Editar información de miembros', 'Miembros'],
        ['eliminar_miembro', 'Eliminar miembros del sistema', 'Miembros'],
        
        // Ministerios
        ['ver_ministerios', 'Ver listado de ministerios', 'Ministerios'],
        ['crear_ministerio', 'Crear nuevos ministerios', 'Ministerios'],
        ['editar_ministerio', 'Editar información de ministerios', 'Ministerios'],
        ['eliminar_ministerio', 'Eliminar ministerios', 'Ministerios'],
        
        // Sistema
        ['gestionar_roles', 'Gestionar roles y permisos', 'Sistema'],
        ['ver_logs', 'Ver registros del sistema', 'Sistema'],
        ['configurar_sistema', 'Configurar parámetros del sistema', 'Sistema']
    ];
    
    $stmt = $db->prepare("INSERT IGNORE INTO Permisos (nombre, descripcion, categoria) VALUES (?, ?, ?)");
    
    foreach ($permisos as $permiso) {
        $stmt->execute($permiso);
    }
    
    // Asignar todos los permisos al rol Admin (rol_id = 1)
    $db->exec("
        INSERT IGNORE INTO RolesPermisos (rol_id, permiso_id)
        SELECT 1, id FROM Permisos
    ");
    
    echo "✅ Tablas de permisos creadas y datos iniciales insertados correctamente\n";
    
} catch (PDOException $e) {
    echo "❌ Error: " . $e->getMessage() . "\n";
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\database\seed.php
=============================================================

<?php

require_once __DIR__ . '/../app/config/database.php';

class DatabaseSeeder {
    private $db;
    
    public function __construct() {
        $this->db = Database::getInstance()->getConnection();
    }
    
    public function seed() {
        try {
            $this->db->beginTransaction();
            
            $this->seedRoles();
            $this->seedInformacionGeneral();
            $this->seedContacto();
            $this->seedMinisterios();
            $this->seedMiembrosMinisterios();
            $this->seedUsuarios();
            
            $this->db->commit();
            return true;
        } catch (Exception $e) {
            $this->db->rollBack();
            $this->logError($e->getMessage());
            return false;
        }
    }
    
    private function seedRoles() {
        $roles = [
            ['Admin', 'Administrador del sistema', 5],
            ['Líder', 'Líder de ministerio', 4],
            ['Coordinador', 'Coordinador de área', 3],
            ['Servidor', 'Servidor en ministerio', 2],
            ['Miembro', 'Miembro regular', 1]
        ];
        
        $stmt = $this->db->prepare("INSERT INTO Roles (nombre, descripcion, nivel_permiso) VALUES (?, ?, ?)");
        
        foreach ($roles as $role) {
            $stmt->execute($role);
        }
    }
    
    private function seedInformacionGeneral() {
        $miembros = [
            ['Juan', 'Pérez', '+573101234567', 'Kennedy', 'Patio Bonito', '1985-06-15', NULL, 'Invitación directa'],
            ['María', 'López', '+573119876543', 'Suba', 'Rincón', '1990-03-22', NULL, 'Familiar'],
            ['Carlos', 'Rodríguez', '+573157894561', 'Chapinero', 'La Soledad', '1982-11-07', NULL, 'Redes sociales'],
            ['Ana', 'Martínez', '+573203216547', 'Usaquén', 'Santa Bárbara', '1988-09-30', NULL, 'Amigo'],
            ['Pedro', 'González', '+573174563210', 'Fontibón', 'Modelia', '1979-04-18', NULL, 'Familiar']
        ];
        
        $stmt = $this->db->prepare("
            INSERT INTO InformacionGeneral 
            (nombres, apellidos, celular, localidad, barrio, fecha_nacimiento, invitado_por, conector) 
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ");
        
        foreach ($miembros as $index => $miembro) {
            // Para el primer registro no tendrá invitado_por
            if ($index === 0) {
                $miembro[6] = NULL;
            } else {
                // Los demás fueron invitados por el primero
                $miembro[6] = 1;
            }
            $stmt->execute($miembro);
        }
    }
    
    private function seedContacto() {
        $contactos = [
            [1, 'CC', '1023456789', '6013456789', 'Colombia', 'Bogotá', 'Cra 15 #45-67', 'Casado', 'juan.perez@email.com'],
            [2, 'CC', '1034567890', '6014567890', 'Colombia', 'Bogotá', 'Calle 80 #23-45', 'Soltera', 'maria.lopez@email.com'],
            [3, 'CC', '1045678901', '6015678901', 'Colombia', 'Bogotá', 'Av 68 #34-56', 'Casado', 'carlos.rodriguez@email.com'],
            [4, 'CE', '1056789012', '6016789012', 'Colombia', 'Bogotá', 'Cra 7 #56-78', 'Casada', 'ana.martinez@email.com'],
            [5, 'CC', '1067890123', '6017890123', 'Colombia', 'Bogotá', 'Calle 100 #67-89', 'Soltero', 'pedro.gonzalez@email.com']
        ];
        
        $stmt = $this->db->prepare("
            INSERT INTO Contacto 
            (miembro_id, tipo_documento, numero_documento, telefono, pais, ciudad, direccion, estado_civil, correo_electronico) 
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        ");
        
        foreach ($contactos as $contacto) {
            $stmt->execute($contacto);
        }
    }
    
    private function seedMinisterios() {
        $ministerios = [
            ['Alabanza', 'Ministerio de música y adoración', 1],
            ['Niños', 'Ministerio de atención a niños', 2],
            ['Jóvenes', 'Ministerio juvenil', 3],
            ['Matrimonios', 'Ministerio para parejas casadas', 4],
            ['Servicio', 'Ministerio de apoyo logístico', 5]
        ];
        
        $stmt = $this->db->prepare("
            INSERT INTO Ministerios 
            (nombre, descripcion, lider_id) 
            VALUES (?, ?, ?)
        ");
        
        foreach ($ministerios as $ministerio) {
            $stmt->execute($ministerio);
        }
    }
    
    private function seedMiembrosMinisterios() {
        $miembrosMinisterios = [
            [1, 1, 1, '2022-01-15', NULL],
            [2, 2, 2, '2022-02-20', NULL],
            [3, 3, 2, '2022-03-10', NULL],
            [4, 4, 2, '2022-04-05', NULL],
            [5, 5, 2, '2022-05-12', NULL],
            [1, 3, 3, '2022-06-18', NULL],
            [2, 4, 3, '2022-07-22', NULL],
            [3, 5, 3, '2022-08-30', NULL]
        ];
        
        $stmt = $this->db->prepare("
            INSERT INTO MiembrosMinisterios 
            (miembro_id, ministerio_id, rol_id, fecha_inicio, fecha_fin) 
            VALUES (?, ?, ?, ?, ?)
        ");
        
        foreach ($miembrosMinisterios as $mm) {
            $stmt->execute($mm);
        }
    }
    
    private function seedUsuarios() {
        $usuarios = [
            [1, 'admin', password_hash('admin123', PASSWORD_DEFAULT), 1],
            [2, 'maria', password_hash('maria123', PASSWORD_DEFAULT), 2],
            [3, 'carlos', password_hash('carlos123', PASSWORD_DEFAULT), 3],
            [4, 'ana', password_hash('ana123', PASSWORD_DEFAULT), 4],
            [5, 'pedro', password_hash('pedro123', PASSWORD_DEFAULT), 5]
        ];
        
        $stmt = $this->db->prepare("
            INSERT INTO Usuarios 
            (miembro_id, nombre_usuario, password_hash, rol_id) 
            VALUES (?, ?, ?, ?)
        ");
        
        foreach ($usuarios as $usuario) {
            $stmt->execute($usuario);
        }
    }
    
    private function logError($message) {
        $logFile = __DIR__ . '/../app/logs/seed_errors.log';
        $directory = dirname($logFile);
        
        if (!is_dir($directory)) {
            mkdir($directory, 0755, true);
        }
        
        $timestamp = date('Y-m-d H:i:s');
        $logMessage = "[$timestamp] Error de seeding: $message" . PHP_EOL;
        file_put_contents($logFile, $logMessage, FILE_APPEND);
    }
}

// Ejecutar el seeder
$seeder = new DatabaseSeeder();
if ($seeder->seed()) {
    echo "Base de datos poblada correctamente." . PHP_EOL;
} else {
    echo "Error al poblar la base de datos. Revisa los logs." . PHP_EOL;
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\database\setup_database.php
=============================================================

<?php

try {
    // Conectar sin especificar una base de datos
    $pdo = new PDO("mysql:host=localhost", "root", "");
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    // Crear la base de datos si no existe
    $pdo->exec("CREATE DATABASE IF NOT EXISTS IglesiaEnCasa CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci");
    
    echo "✅ Base de datos 'IglesiaEnCasa' verificada/creada correctamente\n";
    
    // Seleccionar la base de datos
    $pdo->exec("USE IglesiaEnCasa");
    
    // Crear tabla de Roles si no existe (necesaria para el script permisos.php)
    $pdo->exec("
        CREATE TABLE IF NOT EXISTS Roles (
            id INT AUTO_INCREMENT PRIMARY KEY,
            nombre VARCHAR(50) NOT NULL UNIQUE,
            descripcion VARCHAR(255) NOT NULL,
            nivel_acceso INT NOT NULL DEFAULT 1,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )
    ");
    
    // Insertar rol de administrador si no existe
    $stmt = $pdo->prepare("INSERT IGNORE INTO Roles (id, nombre, descripcion, nivel_acceso) VALUES (1, 'Administrador', 'Control total del sistema', 100)");
    $stmt->execute();
    
    echo "✅ Tabla de Roles creada y rol de administrador verificado\n";
    
} catch (PDOException $e) {
    echo "❌ Error: " . $e->getMessage() . "\n";
    exit(1);
}

echo "\n✅ Configuración de base de datos completada. Ahora puedes ejecutar otros scripts.\n";


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\database\update_usuarios.php
=============================================================

<?php
// database/update_usuarios.php
require_once __DIR__ . '/../app/config/database.php';

try {
    $db = Database::getInstance()->getConnection();
    
    // Añadir campos necesarios para JWT y reset de contraseña
    $db->exec("
        ALTER TABLE Usuarios 
        ADD COLUMN remember_token VARCHAR(255) NULL,
        ADD COLUMN token_reset VARCHAR(255) NULL,
        ADD COLUMN token_expira DATETIME NULL
    ");
    
    echo "✅ Campos para JWT y reset de contraseña añadidos a la tabla Usuarios\n";
    
} catch (PDOException $e) {
    if (strpos($e->getMessage(), "Duplicate column name") !== false) {
        echo "ℹ️ Las columnas ya existen en la tabla Usuarios\n";
    } else {
        echo "❌ Error: " . $e->getMessage() . "\n";
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\tests\check_members.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\tests\check_member.php
require_once __DIR__ . '/../app/config/config.php';
require_once __DIR__ . '/../app/config/database.php';

// ID a verificar (puedes cambiarlo por GET)
$id = isset($_GET['id']) ? (int)$_GET['id'] : 2;

echo "<h1>Verificación de miembro con ID: {$id}</h1>";

try {
    // Obtener conexión directa
    $database = Database::getInstance();
    $db = $database->getConnection();
    
    // Consulta directa para verificar información general
    $stmt = $db->prepare("SELECT * FROM InformacionGeneral WHERE id = :id");
    $stmt->execute(['id' => $id]);
    $miembro = $stmt->fetch();
    
    if (!$miembro) {
        echo "<div style='color:red'>No se encontró ningún miembro con ID {$id} en la base de datos.</div>";
    } else {
        echo "<h2>Datos básicos del miembro:</h2>";
        echo "<pre>";
        print_r($miembro);
        echo "</pre>";
        
        // Verificar tablas relacionadas
        echo "<h2>Datos relacionados:</h2>";
        
        // Contacto
        $stmt = $db->prepare("SELECT * FROM Contacto WHERE miembro_id = :id");
        $stmt->execute(['id' => $id]);
        $contacto = $stmt->fetch();
        echo "<h3>Contacto:</h3>";
        echo "<pre>";
        print_r($contacto ?: "No hay datos de contacto");
        echo "</pre>";
        
        // EstudiosTrabajo
        $stmt = $db->prepare("SELECT * FROM EstudiosTrabajo WHERE miembro_id = :id");
        $stmt->execute(['id' => $id]);
        $estudios = $stmt->fetch();
        echo "<h3>Estudios y Trabajo:</h3>";
        echo "<pre>";
        print_r($estudios ?: "No hay datos de estudios");
        echo "</pre>";
        
        // Tallas
        $stmt = $db->prepare("SELECT * FROM Tallas WHERE miembro_id = :id");
        $stmt->execute(['id' => $id]);
        $tallas = $stmt->fetch();
        echo "<h3>Tallas:</h3>";
        echo "<pre>";
        print_r($tallas ?: "No hay datos de tallas");
        echo "</pre>";
        
        // CarreraBiblica
        $stmt = $db->prepare("SELECT * FROM CarreraBiblica WHERE miembro_id = :id");
        $stmt->execute(['id' => $id]);
        $carrera = $stmt->fetch();
        echo "<h3>Carrera Bíblica:</h3>";
        echo "<pre>";
        print_r($carrera ?: "No hay datos de carrera bíblica");
        echo "</pre>";
        
        echo "<p>Enlaces de prueba:</p>";
        echo "<ul>";
        echo "<li><a href='" . APP_URL . "/miembros/{$id}' target='_blank'>Ver en sistema (miembros/{$id})</a></li>";
        echo "<li><a href='check_member.php?id=" . ($id+1) . "'>Verificar miembro " . ($id+1) . "</a></li>";
        echo "<li><a href='check_member.php?id=" . ($id-1) . "'>Verificar miembro " . ($id-1) . "</a></li>";
        echo "</ul>";
    }
} catch (PDOException $e) {
    echo "<div style='color:red'>Error en la base de datos: " . $e->getMessage() . "</div>";
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\tests\debug.php
=============================================================

<?php
// filepath: /Applications/XAMPP/xamppfiles/htdocs/Encasa_Database/debug.php

// Configuración
define('BASE_PATH', __DIR__);
define('APP_PATH', BASE_PATH . '/app');
define('CONFIG_PATH', APP_PATH . '/config');

// Cargar autoloader
require_once CONFIG_PATH . '/config.php';
require_once CONFIG_PATH . '/database.php';
require_once CONFIG_PATH . '/autoload.php';

// Crear instancia del modelo Usuario
$userModel = new \App\Models\Usuario();

// Función para mostrar resultados
function showResult($title, $data) {
    echo "<h3>$title</h3>";
    echo "<pre>";
    print_r($data);
    echo "</pre>";
    echo "<hr>";
}

// 1. Mostrar todos los usuarios
$users = $userModel->getAll();
foreach ($users as &$user) {
    // Ocultar contraseña completa
    $user['password'] = substr($user['password'], 0, 15) . '...';
}
showResult("Usuarios registrados", $users);

// 2. Crear un usuario de prueba (descomentar si necesitas crear uno)
/*
$newUser = [
    'username' => 'testuser',
    'email' => 'test@example.com',
    'password' => '123456',
    'nombre_completo' => 'Usuario de Prueba',
    'activo' => 1
];

$userID = $userModel->register($newUser);
showResult("Resultado de creación de usuario", $userID ? "Usuario creado con ID: $userID" : "Error al crear usuario");
*/

// Descomentar esta sección para crear un usuario nuevo
$newUser = [
    'username' => 'admin2',
    'email' => 'admin2@ejemplo.com',
    'password' => 'password123',
    'nombre_completo' => 'Administrador 2',
    'activo' => 1
];

$userID = $userModel->register($newUser);
showResult("Resultado de creación de usuario", $userID ? "Usuario creado con ID: $userID" : "Error al crear usuario");

// 3. Probar autenticación con un usuario existente
$testAuth = $userModel->authenticate('rafa.gzfr@gmail.com', 'Amor2025+'); // cambia por credenciales reales
showResult("Prueba de autenticación", $testAuth ? "Autenticación exitosa" : "Autenticación fallida");

// 4. Ver registro específico
if (!empty($users)) {
    $firstUser = $users[0];
    $userId = $firstUser['id'];
    $user = $userModel->findById($userId);
    showResult("Usuario con ID $userId", $user);
}

// 1. Primero, cambia la contraseña
$userId = 1;
$newPassword = 'Amor2025+';

$stmt = $userModel->db->prepare("UPDATE Usuarios SET password = :password WHERE id = :id");
$stmt->bindValue(':password', $userModel->hashPassword($newPassword));
$stmt->bindValue(':id', $userId);
$result = $stmt->execute();

showResult("Cambio de contraseña para usuario ID $userId", 
    $result ? "Contraseña actualizada correctamente" : "Error al actualizar contraseña");

// 2. Luego, prueba la autenticación con la nueva contraseña
$testAuth = $userModel->authenticate('rafa.gzfr@gmail.com', 'Amor2025+');
showResult("Prueba de autenticación", $testAuth ? "Autenticación exitosa" : "Autenticación fallida");
?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\tests\debug_miembro.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\debug_miembro.php

// Script para verificar directamente un miembro en la base de datos
require_once __DIR__ . '/app/config/config.php';
require_once __DIR__ . '/app/config/database.php';

// ID a verificar (opcional por GET)
$id = isset($_GET['id']) ? (int)$_GET['id'] : 2;

echo "<h1>Depuración de Miembro ID: {$id}</h1>";

try {
    // Conexión directa a la base de datos
    $db = Database::getInstance()->getConnection();
    
    // Consulta básica para obtener datos del miembro
    $stmt = $db->prepare("SELECT * FROM InformacionGeneral WHERE id = ?");
    $stmt->execute([$id]);
    $miembro = $stmt->fetch();
    
    if ($miembro) {
        echo "<h2>Miembro encontrado:</h2>";
        echo "<pre>";
        print_r($miembro);
        echo "</pre>";
        
        // Mostrar datos relacionados
        $tablas = ['Contacto', 'EstudiosTrabajo', 'Tallas', 'CarreraBiblica'];
        
        foreach ($tablas as $tabla) {
            $stmt = $db->prepare("SELECT * FROM {$tabla} WHERE miembro_id = ?");
            $stmt->execute([$id]);
            $datos = $stmt->fetch();
            
            echo "<h3>Datos de {$tabla}:</h3>";
            echo "<pre>";
            print_r($datos ?: "No hay datos relacionados");
            echo "</pre>";
        }
        
        echo "<p><a href='" . APP_URL . "/miembros/{$id}' target='_blank'>Ver en el sistema</a></p>";
    } else {
        echo "<p style='color:red'>No se encontró ningún miembro con ID {$id}</p>";
    }
} catch (Exception $e) {
    echo "<p style='color:red'>Error: " . $e->getMessage() . "</p>";
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\tests\debug_users.php
=============================================================

<?php
// Archivo temporal para depuración: /Applications/XAMPP/xamppfiles/htdocs/Encasa_Database/debug_users.php

// Incluir configuración básica
require_once 'index.php';

// Obtener instancia del modelo
$userModel = new \App\Models\Usuario();

// Mostrar todos los usuarios
echo "<h2>Usuarios registrados:</h2>";
$users = $userModel->getAll();

echo "<pre>";
foreach ($users as $user) {
    // Ocultar la contraseña completa por seguridad
    $user['password'] = substr($user['password'], 0, 10) . '...';
    print_r($user);
}
echo "</pre>";


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\tests\JWTTest.php
=============================================================

<?php

// Incluir el autoloader
require_once __DIR__ . '/../app/config/config.php';
require_once __DIR__ . '/../app/helpers/JWT.php';

use App\Helpers\JWT;

// Clase de pruebas simple
class JWTTest {
    
    public function testEncodeAndDecode() {
        // Configurar una clave secreta específica para las pruebas
        JWT::init('test_secret_key');
        
        // Crear un payload
        $payload = [
            'user_id' => 123,
            'username' => 'testuser'
        ];
        
        // Codificar el token
        $token = JWT::encode($payload, 60); // 60 segundos de expiración
        
        // Verificar que el token se creó y tiene el formato correcto
        echo "Token Creado: ";
        $tokenParts = explode('.', $token);
        echo (count($tokenParts) === 3) ? "PASÓ ✓" : "FALLÓ ✗";
        echo "\n";
        
        // Decodificar el token
        $decoded = JWT::decode($token);
        
        // Verificar que la decodificación fue exitosa
        echo "Decodificación: ";
        echo ($decoded !== false) ? "PASÓ ✓" : "FALLÓ ✗";
        echo "\n";
        
        // Verificar que el payload se mantiene intacto
        echo "Verificación de user_id: ";
        echo ($decoded['user_id'] === 123) ? "PASÓ ✓" : "FALLÓ ✗";
        echo "\n";
        
        echo "Verificación de username: ";
        echo ($decoded['username'] === 'testuser') ? "PASÓ ✓" : "FALLÓ ✗";
        echo "\n";
    }
    
    public function testExpiredToken() {
        // Configurar una clave secreta
        JWT::init('test_secret_key');
        
        // Crear un payload con expiración inmediata
        $payload = ['test' => 'data'];
        
        // Codificar el token con expiración de 1 segundo
        $token = JWT::encode($payload, 1);
        
        // Esperar 2 segundos para que expire
        sleep(2);
        
        // Intentar decodificar el token expirado
        $decoded = JWT::decode($token);
        
        // Verificar que la decodificación falla
        echo "Verificación de expiración: ";
        echo ($decoded === false) ? "PASÓ ✓" : "FALLÓ ✗";
        echo "\n";
    }
    
    public function testInvalidToken() {
        // Configurar una clave secreta
        JWT::init('test_secret_key');
        
        // Token malformado
        $token = "header.payload.invalid_signature";
        
        // Intentar decodificar
        $decoded = JWT::decode($token);
        
        // Verificar que la decodificación falla
        echo "Verificación de token inválido: ";
        echo ($decoded === false) ? "PASÓ ✓" : "FALLÓ ✗";
        echo "\n";
    }
    
    public function runTests() {
        $this->testEncodeAndDecode();
        $this->testExpiredToken();
        $this->testInvalidToken();
    }
}

// Ejecutar pruebas
$test = new JWTTest();
$test->runTests();


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\tests\LoggerTest.php
=============================================================

<?php

// Incluir el autoloader
require_once __DIR__ . '/../app/config/config.php';
require_once __DIR__ . '/../app/helpers/Logger.php';
require_once __DIR__ . '/../app/helpers/functions.php';

use App\Helpers\Logger;

// Clase de pruebas simple
class LoggerTest {
    public $logFile; // Cambiar de private a public
    
    public function __construct() {
        $this->logFile = dirname(__DIR__) . '/app/logs/' . date('Y-m-d') . '.log';
    }
    
    // Añadir este método getter
    public function getLogFile() {
        return $this->logFile;
    }
    
    public function testSingleton() {
        $instance1 = Logger::getInstance();
        $instance2 = Logger::getInstance();
        
        // Verificar que ambas instancias son el mismo objeto
        echo "Prueba Singleton: ";
        echo ($instance1 === $instance2) ? "PASÓ ✓" : "FALLÓ ✗";
        echo "\n";
    }
    
    public function testLogLevels() {
        // Limpiar archivo de log para la prueba
        if (file_exists($this->logFile)) {
            $initialSize = filesize($this->logFile);
        } else {
            $initialSize = 0;
        }
        
        // Registrar mensajes en diferentes niveles
        log_error("Mensaje de error de prueba");
        log_warning("Mensaje de advertencia de prueba");
        log_info("Mensaje informativo de prueba");
        log_debug("Mensaje de depuración de prueba");
        
        // Verificar que se escribieron los logs
        clearstatcache();
        $newSize = file_exists($this->logFile) ? filesize($this->logFile) : 0;
        
        echo "Prueba Logging: ";
        echo ($newSize > $initialSize) ? "PASÓ ✓" : "FALLÓ ✗";
        echo "\n";
        
        // Verificar contenido
        $content = file_get_contents($this->logFile);
        
        echo "Contenido Error: ";
        echo (strpos($content, "ERROR") !== false) ? "PASÓ ✓" : "FALLÓ ✗";
        echo "\n";
        
        echo "Contenido Warning: ";
        echo (strpos($content, "WARNING") !== false) ? "PASÓ ✓" : "FALLÓ ✗";
        echo "\n";
    }
    
    public function runTests() {
        $this->testSingleton();
        $this->testLogLevels();
    }
}

// Ejecutar pruebas
$test = new LoggerTest();
$test->runTests();

echo "\nPruebas completadas. Verifica el archivo de log en: " . $test->logFile;


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\tests\login-test.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\login-test.php

// Mostrar errores
ini_set('display_errors', 1);
error_reporting(E_ALL);

echo "Inicio del script<br>";

// Configuración inicial
require_once __DIR__ . '/app/config/config.php';
echo "Config cargado<br>";

require_once __DIR__ . '/app/helpers/functions.php';
echo "Helpers cargados<br>";

// Autoload con diagnóstico
spl_autoload_register(function($className) {
    $classFile = str_replace('\\', '/', $className) . '.php';
    $filepath = __DIR__ . '/' . $classFile;
    
    echo "Intentando cargar: $filepath<br>";
    
    if (file_exists($filepath)) {
        require_once $filepath;
        echo "Clase $className cargada<br>";
    } else {
        echo "Clase $className no encontrada<br>";
    }
});

try {
    // Cargar controlador directamente
    echo "Intentando crear instancia de AuthController<br>";
    $controller = new App\Controllers\AuthController();
    echo "Instancia creada<br>";
    $controller->login();
} catch (Exception $e) {
    echo "Error: " . $e->getMessage();
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\tests\ModelsTest.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\tests\ModelsTest.php
require_once __DIR__ . '/../app/config/config.php';
require_once __DIR__ . '/../app/config/database.php'; // Agregar esta línea
require_once __DIR__ . '/../app/models/Model.php';
require_once __DIR__ . '/../app/models/Miembro.php';
require_once __DIR__ . '/../app/models/Contacto.php';
require_once __DIR__ . '/../app/models/EstudiosTrabajo.php';
require_once __DIR__ . '/../app/models/Tallas.php';
require_once __DIR__ . '/../app/models/CarreraBiblica.php';

use App\Models\Miembro;
use App\Models\Contacto;
use App\Models\EstudiosTrabajo;
use App\Models\Tallas;
use App\Models\CarreraBiblica;

// Prueba de modelos
echo "<h1>Prueba de modelos para Miembros</h1>";

// Instanciar modelos
$miembroModel = new Miembro();
$contactoModel = new Contacto();
$estudiosModel = new EstudiosTrabajo();
$tallasModel = new Tallas();
$carreraModel = new CarreraBiblica();

echo "<pre>";
echo "Modelos cargados correctamente:";
echo "\nMiembro: " . (class_exists('App\Models\Miembro') ? 'OK' : 'ERROR');
echo "\nContacto: " . (class_exists('App\Models\Contacto') ? 'OK' : 'ERROR');
echo "\nEstudiosTrabajo: " . (class_exists('App\Models\EstudiosTrabajo') ? 'OK' : 'ERROR');
echo "\nTallas: " . (class_exists('App\Models\Tallas') ? 'OK' : 'ERROR');
echo "\nCarreraBiblica: " . (class_exists('App\Models\CarreraBiblica') ? 'OK' : 'ERROR');
echo "</pre>";

// Prueba: obtener todos los miembros
echo "<h2>Listado de miembros existentes:</h2>";
$miembros = $miembroModel->getAll();
if (empty($miembros)) {
    echo "<p>No hay miembros registrados aún.</p>";
} else {
    echo "<table border='1' style='border-collapse: collapse; width: 100%;'>";
    echo "<tr><th>ID</th><th>Nombre</th><th>Apellido</th><th>Celular</th><th>Localidad</th></tr>";
    foreach ($miembros as $miembro) {
        echo "<tr>";
        echo "<td>{$miembro['id']}</td>";
        echo "<td>{$miembro['nombres']}</td>";
        echo "<td>{$miembro['apellidos']}</td>";
        echo "<td>{$miembro['celular']}</td>";
        echo "<td>{$miembro['localidad']}</td>";
        echo "</tr>";
    }
    echo "</table>";
}

echo "<h2>Estado de las tablas relacionadas:</h2>";
echo "<pre>";
echo "Contacto: " . ($contactoModel ? 'Modelo cargado' : 'Error');
echo "\nEstudiosTrabajo: " . ($estudiosModel ? 'Modelo cargado' : 'Error');
echo "\nTallas: " . ($tallasModel ? 'Modelo cargado' : 'Error');
echo "\nCarreraBiblica: " . ($carreraModel ? 'Modelo cargado' : 'Error');
echo "</pre>";

echo "<p>Fase 1 completada: Modelos básicos implementados.</p>";


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\tests\phpinfo.php
=============================================================

<?php phpinfo(); ?>


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\tests\test.php
=============================================================

<?php

echo "Prueba de servidor funcionando";


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\tests\test_miembro.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\test_miembro.php

require_once __DIR__ . '/app/config/config.php';
require_once __DIR__ . '/app/config/database.php';
require_once __DIR__ . '/app/models/Model.php';
require_once __DIR__ . '/app/models/Miembro.php';

$id = isset($_GET['id']) ? (int)$_GET['id'] : 2;

echo "<h1>Prueba de miembro ID: {$id}</h1>";

try {
    // Inicializar modelo
    $miembroModel = new \App\Models\Miembro();
    
    // Verificar existencia
    $exists = $miembroModel->checkMemberExists($id);
    echo "<p>¿Existe el miembro?: " . ($exists ? 'SÍ' : 'NO') . "</p>";
    
    if ($exists) {
        // Obtener perfil
        $miembro = $miembroModel->getFullProfile($id);
        
        echo "<h2>Datos del perfil:</h2>";
        echo "<pre>";
        print_r($miembro);
        echo "</pre>";
        
        echo "<p>URL de perfil: <a href='" . APP_URL . "/miembros/{$id}' target='_blank'>Ver perfil en sistema</a></p>";
    }
} catch (Exception $e) {
    echo "<p style='color:red'>Error: " . $e->getMessage() . "</p>";
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\tests\test_router.php
=============================================================



=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\tools\replace_urls.php
=============================================================

<?php
// filepath: c:\xampp\htdocs\ENCASA_DATABASE\tools\replace_urls.php

// Activar manejo de errores
ini_set('display_errors', 1);
error_reporting(E_ALL);

// Función para registrar mensajes
function log_message($message, $type = 'INFO') {
    echo "[$type] $message\n";
}

// Verificar si la función url() existe
if (!function_exists('url')) {
    log_message("Creando función url() para pruebas", "SETUP");
    function url($path) {
        return "URL_BASE/$path";
    }
}

// Define directorios a escanear
$directories = [
    __DIR__ . '/../app/views',
    __DIR__ . '/../app/Controllers'
];

$count = 0;
$files = 0;
$errors = 0;

// Verificar que los directorios existen
foreach ($directories as $index => $directory) {
    if (!is_dir($directory)) {
        log_message("El directorio no existe: $directory", "ERROR");
        unset($directories[$index]);
        $errors++;
    } else {
        log_message("Escaneando directorio: $directory", "INFO");
    }
}

// Proceder solo si hay directorios válidos
if (empty($directories)) {
    log_message("No hay directorios válidos para escanear", "ERROR");
    exit(1);
}

// Modo de prueba (sin modificar archivos) - cambia a false para aplicar cambios
$test_mode = false;

foreach ($directories as $directory) {
    try {
        $it = new RecursiveDirectoryIterator($directory);
        $it = new RecursiveIteratorIterator($it);
        $it = new RegexIterator($it, '/\.php$/');
        
        foreach ($it as $file) {
            try {
                log_message("Procesando: " . $file, "INFO");
                
                // Verificar permisos de lectura
                if (!is_readable($file)) {
                    log_message("No se puede leer el archivo: $file", "ERROR");
                    $errors++;
                    continue;
                }
                
                $content = file_get_contents($file);
                if ($content === false) {
                    log_message("Error al leer el archivo: $file", "ERROR");
                    $errors++;
                    continue;
                }
                
                $original = $content;
                
                // Reemplazar patrones simples primero
                $simple_patterns = [
                    '<?= APP_URL ?>/miembros' => '<?= url("miembros") ?>',
                    '<?= APP_URL ?>/public' => '<?= url("public") ?>',
                    '<?= APP_URL ?>/assets' => '<?= url("assets") ?>',
                    '<?= APP_URL ?>/usuarios' => '<?= url("usuarios") ?>'
                ];
                
                foreach ($simple_patterns as $pattern => $replacement) {
                    $content = str_replace($pattern, $replacement, $content);
                }
                
                // Verificar si hubo cambios
                if ($content !== $original) {
                    $changes = substr_count($original, 'APP_URL') - substr_count($content, 'APP_URL');
                    log_message("Se encontraron $changes cambios en: $file", "SUCCESS");
                    
                    // Aplicar cambios si no estamos en modo de prueba
                    if (!$test_mode) {
                        if (!is_writable($file)) {
                            log_message("No se puede escribir en el archivo: $file", "ERROR");
                            $errors++;
                            continue;
                        }
                        
                        if (file_put_contents($file, $content) !== false) {
                            $count += $changes;
                            $files++;
                            log_message("Archivo actualizado: $file", "SUCCESS");
                        } else {
                            log_message("Error al escribir en el archivo: $file", "ERROR");
                            $errors++;
                        }
                    } else {
                        log_message("Cambios simulados (modo prueba): no se modificó el archivo", "TEST");
                        $count += $changes;
                        $files++;
                    }
                } else {
                    log_message("Sin cambios en: $file", "INFO");
                }
            } catch (Exception $e) {
                log_message("Error procesando archivo {$file->getPathname()}: " . $e->getMessage(), "ERROR");
                $errors++;
            }
        }
    } catch (Exception $e) {
        log_message("Error al procesar directorio $directory: " . $e->getMessage(), "ERROR");
        $errors++;
    }
}

// Resumen final
echo "\n=== RESUMEN ===\n";
echo "Modo: " . ($test_mode ? "PRUEBA (no se modificaron archivos)" : "REAL (archivos modificados)") . "\n";
echo "Reemplazadas $count ocurrencias de APP_URL en $files archivos\n";
echo "Ocurrieron $errors errores durante el proceso\n";

if ($test_mode) {
    echo "\nEste fue un test. Para aplicar los cambios, cambia \$test_mode = true a \$test_mode = false\n";
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\postcss.config.js
=============================================================

module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\tailwind.config.js
=============================================================

/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./app/views/**/*.php",
    "./resources/**/*.js",
    "./resources/**/*.css"  // Añadir esta línea
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#f0f9ff',
          100: '#e0f2fe',
          200: '#bae6fd',
          300: '#7dd3fc',
          400: '#38bdf8',
          500: '#0ea5e9',
          600: '#0284c7',
          700: '#0369a1',
          800: '#075985',
          900: '#0c4a6e',
        },
        secondary: {
          50: '#f0fdfa',
          100: '#ccfbf1',
          200: '#99f6e4',
          300: '#5eead4',
          400: '#2dd4bf',
          500: '#14b8a6',
          600: '#0d9488',
          700: '#0f766e',
          800: '#115e59',
          900: '#134e4a',
        }
      },
    },
  },
  plugins: [
    require('@tailwindcss/forms'),
  ],
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\public\js\app.js
=============================================================



=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\public\js\controllers\FormController.js
=============================================================



=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\app\public\js\controllers\MiembrosController.js
=============================================================



=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\assets\js\formulario-estudios.js
=============================================================

// Asegúrate de que estos eventos estén configurados en el archivo
document.addEventListener('DOMContentLoaded', function() {
    // Para institución educativa
    const institucionSelect = document.getElementById('institucion_educativa_select');
    const institucionPersonalizada = document.getElementById('institucion_personalizada');
    const institucionFinal = document.getElementById('institucion_educativa');
    
    if (institucionSelect) {
        institucionSelect.addEventListener('change', function() {
            if (this.value) {
                institucionFinal.value = this.value;
            }
        });
    }
    
    if (institucionPersonalizada) {
        institucionPersonalizada.addEventListener('input', function() {
            institucionFinal.value = this.value;
        });
    }
    
    // Para profesión
    const profesionSelect = document.getElementById('profesion_select');
    const profesionPersonalizada = document.getElementById('profesion_personalizada');
    const profesionFinal = document.getElementById('profesion');
    
    if (profesionSelect) {
        profesionSelect.addEventListener('change', function() {
            if (this.value) {
                profesionFinal.value = this.value;
            }
        });
    }
    
    if (profesionPersonalizada) {
        profesionPersonalizada.addEventListener('input', function() {
            profesionFinal.value = this.value;
        });
    }
    
    // Para el formulario completo
    const form = document.getElementById('formMiembro');
    if (form) {
        form.addEventListener('submit', function() {
            // Asegurarse de que los campos finales tengan los valores correctos antes de enviar
            if (institucionPersonalizada && institucionPersonalizada.style.display !== 'none' && institucionPersonalizada.value) {
                institucionFinal.value = institucionPersonalizada.value;
            } else if (institucionSelect && institucionSelect.value) {
                institucionFinal.value = institucionSelect.value;
            }
            
            if (profesionPersonalizada && profesionPersonalizada.style.display !== 'none' && profesionPersonalizada.value) {
                profesionFinal.value = profesionPersonalizada.value;
            } else if (profesionSelect && profesionSelect.value) {
                profesionFinal.value = profesionSelect.value;
            }
        });
    }
});


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\assets\js\tabla-por-tabla.js
=============================================================

/**
 * Manejador para enviar los datos de cada tabla individual
 */
const TablaProcessor = {
    
    /**
     * Inicializa los manejadores de eventos para los botones de prueba
     */
    init: function() {
        console.log('TablaProcessor inicializando...');
        
        // Registrar listeners para cada botón de prueba
        document.querySelectorAll('.btn-probar-tabla').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const tabla = this.getAttribute('data-tabla');
                const formulario = document.getElementById('formMiembro');
                const miembroId = document.querySelector('input[name="id"]')?.value || null;
                
                TablaProcessor.enviarTabla(tabla, miembroId, formulario);
            });
        });
        
        console.log('TablaProcessor inicializado');
    },
    
    /**
     * Envía los datos de una tabla específica al servidor
     */
    enviarTabla: function(tabla, miembroId, formulario) {
        // Mostrar indicador de carga
        const boton = document.querySelector(`button[data-tabla="${tabla}"]`);
        if (!boton) {
            console.error('No se encontró el botón para la tabla:', tabla);
            return;
        }
        
        const textoOriginal = boton.innerHTML;
        boton.disabled = true;
        boton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
        
        // Crear FormData con solo los datos relevantes para esta tabla
        const formData = new FormData(formulario);
        const tablaData = new FormData();
        
        // Si es edición, incluir el ID
        if (miembroId) {
            tablaData.append('id', miembroId);
        }
        
        // Añadir solo los campos correspondientes a esta tabla
        for (let pair of formData.entries()) {
            // Filtrar campos según la tabla seleccionada
            if (this.perteneceATabla(pair[0], tabla)) {
                tablaData.append(pair[0], pair[1]);
            }
        }
        
        // Incluir la foto si estamos en la tabla principal y hay una foto seleccionada
        if (tabla === 'miembro' && formData.has('foto')) {
            const fotoInput = formulario.querySelector('input[name="foto"]');
            if (fotoInput && fotoInput.files && fotoInput.files.length > 0) {
                tablaData.append('foto', fotoInput.files[0]);
            }
        }
        
        console.log(`Enviando datos de tabla: ${tabla}`);
        
        // Determinar la URL según si es creación o edición
        const baseUrl = miembroId ? 
            `/ENCASA_DATABASE/miembros/actualizar/${miembroId}/tabla/${tabla}` : 
            `/ENCASA_DATABASE/miembros/guardar/tabla/${tabla}`;
        
        // Enviar la solicitud AJAX
        fetch(baseUrl, {
            method: 'POST',
            body: tablaData
        })
        .then(response => {
            // Verificar primero si la respuesta es de tipo JSON
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(data.message || `Error HTTP: ${response.status}`);
                    }
                    return data;
                });
            } else {
                // Si no es JSON, obtenemos el texto para depuración
                return response.text().then(text => {
                    console.error('Respuesta no JSON:', text);
                    throw new Error('La respuesta del servidor no es JSON válido');
                });
            }
        })
        .then(data => {
            if (data.success) {
                // Mostrar mensaje de éxito
                this.mostrarMensaje(`Tabla "${tabla}" guardada correctamente`, 'success');
                
                // Si es una operación de creación y recibimos un ID, actualizar el formulario
                if (!miembroId && data.miembro_id) {
                    // Crear campo oculto de ID si no existe
                    if (!document.querySelector('input[name="id"]')) {
                        const idInput = document.createElement('input');
                        idInput.type = 'hidden';
                        idInput.name = 'id';
                        idInput.value = data.miembro_id;
                        formulario.appendChild(idInput);
                    } else {
                        document.querySelector('input[name="id"]').value = data.miembro_id;
                    }
                }
            } else {
                // Mostrar mensaje de error
                this.mostrarMensaje(`Error: ${data.message || 'No se pudo guardar la tabla'}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            this.mostrarMensaje(`Error al procesar la solicitud: ${error.message}`, 'danger');
        })
        .finally(() => {
            // Restaurar el botón
            boton.disabled = false;
            boton.innerHTML = textoOriginal;
        });
    },
    
    /**
     * Determina si un campo del formulario pertenece a la tabla especificada
     */
    perteneceATabla: function(fieldName, tabla) {
        // Mapeo de campos por tabla
        const mapeoTablas = {
            'miembro': ['nombres', 'apellidos', 'celular', 'localidad', 'barrio', 'fecha_nacimiento', 
                      'fecha_ingreso_iglesia', 'estado_espiritual', 'conector', 'invitado_por', 
                      'habeas_data', 'estado_miembro', 'foto'],
            'contacto': fieldName.startsWith('contacto['),
            'estudiostrabajo': fieldName.startsWith('estudios['),
            'tallas': fieldName.startsWith('tallas['),
            'saludemergencias': fieldName.startsWith('salud['),
            'carrerabiblica': fieldName.startsWith('carrera[')
        };
        
        if (mapeoTablas[tabla] === true) {
            return true;
        } else if (Array.isArray(mapeoTablas[tabla])) {
            return mapeoTablas[tabla].includes(fieldName);
        }
        
        return false;
    },
    
    /**
     * Muestra un mensaje al usuario
     */
    mostrarMensaje: function(mensaje, tipo = 'success') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${tipo} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insertar al principio del formulario o en un área designada para mensajes
        const mensajesArea = document.getElementById('mensajes-area');
        if (mensajesArea) {
            mensajesArea.appendChild(alertDiv);
        } else {
            const formulario = document.getElementById('formMiembro');
            formulario.insertBefore(alertDiv, formulario.firstChild);
        }
        
        // Desaparecer automáticamente después de 5 segundos
        setTimeout(() => {
            alertDiv.classList.remove('show');
            setTimeout(() => alertDiv.remove(), 300);
        }, 5000);
    }
};

// Inicializar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    TablaProcessor.init();
    
    // Mapeo de tablas a sus campos específicos
    const tablasCampos = {
        'informaciongeneral': ['nombres', 'apellidos', 'celular', 'localidad', 'barrio', 'fecha_nacimiento', 'estado_espiritual', 'recorrido_espiritual', 'tipo_miembro'],
        'contacto': ['tipo_documento', 'numero_documento', 'telefono', 'correo_electronico', 'pais', 'ciudad', 'direccion', 'estado_civil'],
        'estudiostrabajo': ['nivel_educativo', 'profesion', 'ocupacion', 'empresa', 'cargo'],
        'tallas': ['camisa', 'pantalon', 'calzado'],
        'saludemergencias': ['tipo_sangre', 'alergias', 'medicamentos', 'contacto_emergencia', 'telefono_emergencia'],
        'carrerabiblica': ['nivel_actual', 'cursos_completados', 'fecha_ultimo_curso']
    };

    // Manejador para botones de guardar por sección
    document.querySelectorAll('.btn-probar-tabla').forEach(button => {
        button.addEventListener('click', function() {
            // Obtener el nombre de la tabla de data-tabla
            const tabla = this.getAttribute('data-tabla');
            
            // Verificar si es una tabla válida
            if (!tabla || !tablasCampos[tabla]) {
                console.error(`Error: Tabla "${tabla}" no reconocida`);
                mostrarMensaje(`Error: Tabla "${tabla}" no definida en el sistema`, 'danger');
                return;
            }
            
            // Obtener el ID del miembro del formulario principal
            const idMiembro = document.querySelector('input[name="id"]').value;
            if (!idMiembro) {
                mostrarMensaje('Error: No se pudo identificar el ID del miembro', 'danger');
                return;
            }
            
            // Mostrar indicador de carga
            this.disabled = true;
            const textoOriginal = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';
            
            // Recopilar datos según la tabla
            const formData = new FormData();
            formData.append('id', idMiembro);
            formData.append('tabla', tabla);
            
            // Agregar campos específicos de la tabla
            const campos = tablasCampos[tabla];
            campos.forEach(campo => {
                const input = document.querySelector(`[name="${campo}"], [name="${tabla}[${campo}]"]`);
                if (input) {
                    if (input.type === 'checkbox') {
                        formData.append(`datos[${campo}]`, input.checked ? '1' : '0');
                    } else {
                        formData.append(`datos[${campo}]`, input.value);
                    }
                }
            });
            
            // Enviar petición
            fetch(`${APP_URL}/api/actualizar-seccion`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                this.disabled = false;
                this.innerHTML = textoOriginal;
                
                if (data.success) {
                    mostrarMensaje(`Sección "${tabla}" actualizada correctamente`, 'success');
                } else {
                    mostrarMensaje(data.message || `Error al guardar la sección "${tabla}"`, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.disabled = false;
                this.innerHTML = textoOriginal;
                mostrarMensaje(`Error al procesar la solicitud: ${error.message}`, 'danger');
            });
        });
    });
    
    // Función para mostrar mensajes
    function mostrarMensaje(mensaje, tipo = 'success') {
        const contenedor = document.createElement('div');
        contenedor.className = `alert alert-${tipo} alert-dismissible fade show`;
        contenedor.style.position = 'fixed';
        contenedor.style.top = '20px';
        contenedor.style.right = '20px';
        contenedor.style.zIndex = '9999';
        contenedor.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(contenedor);
        
        setTimeout(() => {
            contenedor.classList.remove('show');
            setTimeout(() => contenedor.remove(), 300);
        }, 5000);
    }
});

function guardarTablaIndividual(tabla) {
    if (typeof baseUrl === 'undefined' || typeof miembroId === 'undefined') {
        console.error("Error: Variables baseUrl o miembroId no definidas");
        mostrarMensaje('danger', "Error de configuración: No se puede determinar la URL o ID del miembro");
        return;
    }

    // Asegúrate de que el nombre de la tabla sea el correcto
    const nombreTablaCorrecta = tabla === 'miembro' ? 'informaciongeneral' : tabla;
    
    // URL para guardar (CORREGIDA)
    const url = `${baseUrl}/miembros/actualizar/${miembroId}/tabla/${nombreTablaCorrecta}`;
    
    // Verificar si el formulario existe
    const formulario = document.querySelector(`#form-${tabla}`);
    if (!formulario) {
        console.error(`No se encontró el formulario #form-${tabla}`);
        mostrarMensaje('danger', `Error: No se encontró el formulario para ${tabla}`);
        return;
    }

    // Recopilar datos y enviar
    const formData = new FormData(formulario);
    
    // Mapear nombres de campos si es necesario
    if (tabla === 'tallas') {
        if (formData.has('camisa')) {
            formData.set('talla_camisa', formData.get('camisa'));
            formData.delete('camisa');
        }
        // Otros mapeos de nombres
    }
    
    // Realizar petición AJAX
    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Error del servidor: ${text.substring(0, 200)}...`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            mostrarMensaje('success', data.message || `Datos de ${tabla} actualizados correctamente`);
        } else {
            mostrarMensaje('danger', data.message || `Error al guardar ${tabla}`);
        }
    })
    .catch(error => {
        console.error("Error al guardar:", error);
        mostrarMensaje('danger', `Error: ${error.message}`);
    });
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\assets\js\miembros\form-handlers.js
=============================================================

/**
 * Manejo de formularios y eventos de la página de miembros
 */

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar todas las funcionalidades del formulario
    inicializarEventos();
    inicializarSelectores();
    configurarSubmit();
});

/**
 * Inicializa los eventos para los elementos del formulario
 */
function inicializarEventos() {
    // === Eventos para localidad y barrio ===
    const selectLocalidad = document.getElementById('localidad');
    const selectBarrio = document.getElementById('barrio');

    if (selectLocalidad) {
        selectLocalidad.addEventListener('change', function() {
            cargarBarrios(this.value);
            // Resetear campo personalizado
            const barrioPersonalizado = document.getElementById('barrio_personalizado');
            if (barrioPersonalizado) barrioPersonalizado.value = '';
        });
    }

    if (selectBarrio) {
        selectBarrio.addEventListener('change', manejarBarrioPersonalizado);
    }

    // === Eventos para país, estado/departamento y ciudad ===
    const selectPais = document.getElementById('pais');
    const selectEstadoDepto = document.getElementById('estado_departamento');
    const selectCiudad = document.getElementById('ciudad');

    if (selectPais) {
        selectPais.addEventListener('change', function() {
            if (this.value === "otro") {
                manejarPaisPersonalizado();
            } else {
                cargarEstadosDepartamentos(this.value);
            }
        });
    }

    if (selectEstadoDepto) {
        selectEstadoDepto.addEventListener('change', function() {
            if (this.value === "otro") {
                manejarEstadoDeptoPersonalizado();
            } else {
                cargarCiudades(selectPais.value, this.value);
            }
        });
    }

    if (selectCiudad) {
        selectCiudad.addEventListener('change', function() {
            if (this.value === "otro") {
                manejarCiudadPersonalizada();
            }
        });
    }

    // === Configurar las pestañas Bootstrap para preservar el estado ===
    const tabEl = document.querySelectorAll('a[data-bs-toggle="tab"]');
    if (tabEl.length > 0) {
        tabEl.forEach(tab => {
            tab.addEventListener('shown.bs.tab', function (event) {
                localStorage.setItem('activeTab', event.target.getAttribute('href'));
            });
        });

        // Restaurar la pestaña activa si existe
        const activeTab = localStorage.getItem('activeTab');
        if (activeTab) {
            const tab = document.querySelector(`a[href="${activeTab}"]`);
            if (tab) {
                new bootstrap.Tab(tab).show();
            }
        }
    }
}

/**
 * Inicializa los selectores de ubicación y geografía
 */
function inicializarSelectores() {
    // Inicializar selectores geográficos
    if (typeof cargarPaises === 'function') {
        cargarPaises();
    }

    // Inicializar selectores de localidad/barrio
    if (typeof cargarLocalidades === 'function') {
        cargarLocalidades();
    }
}

/**
 * Configura la validación y envío del formulario
 */
function configurarSubmit() {
    const formMiembro = document.getElementById('formMiembro');
    if (!formMiembro) return;

    formMiembro.addEventListener('submit', function(e) {
        // Manejar barrio personalizado
        const selectBarrio = document.getElementById('barrio');
        if (selectBarrio && selectBarrio.value === "otro") {
            const barrioPersonalizado = document.getElementById('barrio_personalizado');
            if (barrioPersonalizado && barrioPersonalizado.value.trim()) {
                // Crear un campo oculto con el valor real del barrio
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'barrio';
                hiddenInput.value = barrioPersonalizado.value.trim();
                this.appendChild(hiddenInput);
            }
        }

        // Validación personalizada puede agregarse aquí
        // if (!validarFormulario()) {
        //     e.preventDefault();
        //     return false;
        // }
    });
}

/**
 * Función para validación personalizada del formulario
 * @returns {boolean} True si el formulario es válido
 */
function validarFormulario() {
    // Implementar validaciones personalizadas aquí
    // Ejemplo:
    const nombres = document.getElementById('nombres');
    const apellidos = document.getElementById('apellidos');
    const celular = document.getElementById('celular');
    
    let isValid = true;
    
    // Validar campos obligatorios
    if (!nombres || nombres.value.trim() === '') {
        mostrarError(nombres, 'El nombre es obligatorio');
        isValid = false;
    }
    
    if (!apellidos || apellidos.value.trim() === '') {
        mostrarError(apellidos, 'Los apellidos son obligatorios');
        isValid = false;
    }
    
    if (!celular || celular.value.trim() === '') {
        mostrarError(celular, 'El celular es obligatorio');
        isValid = false;
    }
    
    return isValid;
}

/**
 * Muestra un mensaje de error para un campo
 * @param {HTMLElement} elemento - El elemento con error
 * @param {string} mensaje - El mensaje de error
 */
function mostrarError(elemento, mensaje) {
    // Remover mensaje de error previo si existe
    const errorPrevio = elemento.parentElement.querySelector('.invalid-feedback');
    if (errorPrevio) {
        errorPrevio.remove();
    }
    
    // Agregar clase de error
    elemento.classList.add('is-invalid');
    
    // Crear y agregar mensaje de error
    const errorDiv = document.createElement('div');
    errorDiv.className = 'invalid-feedback';
    errorDiv.textContent = mensaje;
    elemento.parentElement.appendChild(errorDiv);
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\assets\js\miembros\geo-data.js
=============================================================

/**
 * Datos y funciones para manejar países, estados/departamentos y ciudades
 */

// Datos de países, departamentos y ciudades
const paisesData = {
    "Colombia": {
        "Amazonas": ["Leticia", "Puerto Nariño", "El Encanto", "La Chorrera", "La Pedrera", "La Victoria", "Mirití-Paraná", "Puerto Alegría", "Puerto Arica", "Santander", "Tarapacá"],
        "Antioquia": ["Medellín", "Bello", "Envigado", "Itagüí", "Rionegro", "Sabaneta", "Apartadó", "Turbo", "Caucasia", "Copacabana", "La Estrella", "Santa Fe de Antioquia"],
        "Arauca": ["Arauca", "Arauquita", "Cravo Norte", "Fortul", "Puerto Rondón", "Saravena", "Tame"],
        "Atlántico": ["Barranquilla", "Soledad", "Malambo", "Sabanalarga", "Baranoa", "Puerto Colombia", "Galapa", "Santo Tomás"],
        "Bogotá D.C.": ["Bogotá"],
        "Bolívar": ["Cartagena", "Magangué", "El Carmen de Bolívar", "Turbaco", "Arjona", "San Juan Nepomuceno", "María La Baja", "Mompós"],
        "Boyacá": ["Tunja", "Duitama", "Sogamoso", "Chiquinquirá", "Paipa", "Moniquirá", "Puerto Boyacá", "Samacá"],
        "Caldas": ["Manizales", "La Dorada", "Chinchiná", "Villamaría", "Anserma", "Riosucio", "Manzanares", "Pensilvania"],
        "Caquetá": ["Florencia", "San Vicente del Caguán", "Puerto Rico", "El Doncello", "Belén de Los Andaquíes", "Albania", "Solano", "Solita"],
        "Casanare": ["Yopal", "Aguazul", "Villanueva", "Tauramena", "Paz de Ariporo", "Monterrey", "Maní", "Hato Corozal"],
        "Cauca": ["Popayán", "Santander de Quilichao", "Puerto Tejada", "Patía", "Bolívar", "Cajibío", "El Tambo", "Miranda"],
        "Cesar": ["Valledupar", "Aguachica", "Agustín Codazzi", "Bosconia", "El Copey", "El Paso", "La Jagua de Ibirico", "San Alberto"],
        "Chocó": ["Quibdó", "Istmina", "Tadó", "Bahía Solano", "Acandí", "Condoto", "El Carmen de Atrato", "Riosucio"],
        "Córdoba": ["Montería", "Cereté", "Lorica", "Montelíbano", "Planeta Rica", "Sahagún", "Tierralta", "Valencia"],
        "Cundinamarca": ["Soacha", "Facatativá", "Zipaquirá", "Fusagasugá", "Chía", "Mosquera", "Madrid", "Funza", "Cajicá", "Girardot"],
        "Guainía": ["Inírida"],
        "Guaviare": ["San José del Guaviare", "Calamar", "El Retorno", "Miraflores"],
        "Huila": ["Neiva", "Pitalito", "Garzón", "La Plata", "Campoalegre", "Palermo", "San Agustín", "Gigante"],
        "La Guajira": ["Riohacha", "Maicao", "Uribia", "San Juan del Cesar", "Villanueva", "Barrancas", "Fonseca", "Dibulla"],
        "Magdalena": ["Santa Marta", "Ciénaga", "Fundación", "Plato", "Pivijay", "El Banco", "Aracataca", "Zona Bananera"],
        "Meta": ["Villavicencio", "Acacías", "Granada", "Puerto López", "La Macarena", "Cumaral", "Puerto Gaitán", "San Martín"],
        "Nariño": ["Pasto", "Tumaco", "Ipiales", "La Unión", "Samaniego", "Túquerres", "Barbacoas", "Sandoná"],
        "Norte de Santander": ["Cúcuta", "Ocaña", "Pamplona", "Villa del Rosario", "Los Patios", "El Zulia", "Tibú", "Abrego"],
        "Putumayo": ["Mocoa", "Puerto Asís", "Puerto Guzmán", "Orito", "Valle del Guamuez", "San Francisco", "Villagarzón", "Santiago"],
        "Quindío": ["Armenia", "Calarcá", "Montenegro", "Quimbaya", "La Tebaida", "Circasia", "Filandia", "Salento"],
        "Risaralda": ["Pereira", "Dosquebradas", "Santa Rosa de Cabal", "La Virginia", "Quinchía", "Belén de Umbría", "Apía", "Santuario"],
        "San Andrés y Providencia": ["San Andrés", "Providencia"],
        "Santander": ["Bucaramanga", "Floridablanca", "Girón", "Piedecuesta", "Barrancabermeja", "San Gil", "Barbosa", "Socorro"],
        "Sucre": ["Sincelejo", "Corozal", "San Marcos", "Majagual", "San Onofre", "San Benito Abad", "Sampués", "Tolú"],
        "Tolima": ["Ibagué", "Espinal", "Mariquita", "Chaparral", "Líbano", "Honda", "Flandes", "Melgar"],
        "Valle del Cauca": ["Cali", "Buenaventura", "Palmira", "Tuluá", "Cartago", "Buga", "Jamundí", "Yumbo"],
        "Vaupés": ["Mitú", "Carurú", "Taraira"],
        "Vichada": ["Puerto Carreño", "La Primavera", "Santa Rosalía", "Cumaribo"]
    },
    "México": {
        "Aguascalientes": ["Aguascalientes", "Calvillo", "Jesús María", "Pabellón de Arteaga", "Rincón de Romos"],
        "Baja California": ["Tijuana", "Mexicali", "Ensenada", "Tecate", "Rosarito"],
        "Baja California Sur": ["La Paz", "Los Cabos", "Comondú", "Loreto", "Mulegé"],
        "Ciudad de México": ["Ciudad de México"],
        "Jalisco": ["Guadalajara", "Zapopan", "Tlaquepaque", "Tonalá", "Puerto Vallarta"],
        "Nuevo León": ["Monterrey", "Guadalupe", "San Nicolás", "Apodaca", "Santa Catarina"]
    },
    "Estados Unidos": {
        "California": ["Los Ángeles", "San Francisco", "San Diego", "Sacramento", "Oakland"],
        "Florida": ["Miami", "Orlando", "Tampa", "Jacksonville", "Fort Lauderdale"],
        "Nueva York": ["Nueva York", "Buffalo", "Rochester", "Syracuse", "Albany"],
        "Texas": ["Houston", "Dallas", "Austin", "San Antonio", "El Paso"]
    },
    "España": {
        "Andalucía": ["Sevilla", "Málaga", "Granada", "Córdoba", "Cádiz"],
        "Cataluña": ["Barcelona", "Girona", "Lleida", "Tarragona"],
        "Madrid": ["Madrid", "Alcalá de Henares", "Aranjuez", "Móstoles", "Alcorcón"]
    },
    "Argentina": {
        "Buenos Aires": ["Buenos Aires", "La Plata", "Mar del Plata", "Bahía Blanca"],
        "Córdoba": ["Córdoba", "Villa María", "Río Cuarto", "Carlos Paz"],
        "Santa Fe": ["Rosario", "Santa Fe", "Venado Tuerto", "Rafaela"]
    }
};

/**
 * Función para cargar los países en el dropdown
 */
function cargarPaises() {
    const selectPais = document.getElementById('pais');
    if (!selectPais) return;
    
    // Limpiar opciones existentes
    selectPais.innerHTML = '<option value="">-- Seleccione un país --</option>';
    
    // Agregar cada país como una opción
    Object.keys(paisesData).forEach(pais => {
        const option = document.createElement('option');
        option.value = pais;
        option.textContent = pais;
        selectPais.appendChild(option);
    });
    
    // Agregar opción para país personalizado
    const otroOption = document.createElement('option');
    otroOption.value = "otro";
    otroOption.textContent = "-- Otro país --";
    selectPais.appendChild(otroOption);
    
    // Obtener el país guardado (si existe)
    const paisGuardado = selectPais.dataset.valor || '';
    
    if (paisGuardado) {
        // Si el país guardado existe en la lista, seleccionarlo
        if (Object.keys(paisesData).includes(paisGuardado)) {
            selectPais.value = paisGuardado;
        } else if (paisGuardado.trim() !== '') {
            // Si es un valor personalizado, crear la opción y seleccionarla
            const option = document.createElement('option');
            option.value = paisGuardado;
            option.textContent = paisGuardado + " (personalizado)";
            selectPais.insertBefore(option, otroOption);
            selectPais.value = paisGuardado;
        }
        // Cargar los estados/departamentos correspondientes
        cargarEstadosDepartamentos(paisGuardado);
    } else {
        // Si no hay país guardado, seleccionar Colombia por defecto
        selectPais.value = "Colombia";
        cargarEstadosDepartamentos("Colombia");
    }
}

/**
 * Función para cargar los estados/departamentos según el país seleccionado
 */
function cargarEstadosDepartamentos(pais) {
    const selectEstadoDepto = document.getElementById('estado_departamento');
    if (!selectEstadoDepto) return;
    
    // Limpiar opciones existentes
    selectEstadoDepto.innerHTML = '<option value="">-- Seleccione un estado/departamento --</option>';
    
    if (!pais || pais === "otro") {
        selectEstadoDepto.disabled = true;
        const ciudadSelect = document.getElementById('ciudad');
        if (ciudadSelect) {
            ciudadSelect.disabled = true;
            ciudadSelect.innerHTML = '<option value="">-- Seleccione primero un estado/departamento --</option>';
        }
        return;
    }
    
    selectEstadoDepto.disabled = false;
    
    // Si el país existe en nuestros datos, cargar sus estados/departamentos
    if (paisesData[pais]) {
        Object.keys(paisesData[pais]).forEach(estadoDepto => {
            const option = document.createElement('option');
            option.value = estadoDepto;
            option.textContent = estadoDepto;
            selectEstadoDepto.appendChild(option);
        });
    }
    
    // Agregar opción para estado/departamento personalizado
    const otroOption = document.createElement('option');
    otroOption.value = "otro";
    otroOption.textContent = "-- Otro (especificar) --";
    selectEstadoDepto.appendChild(otroOption);
    
    // Obtener el estado/departamento guardado (si existe)
    const estadoDeptoGuardado = selectEstadoDepto.dataset.valor || '';
    
    if (estadoDeptoGuardado) {
        // Si el estado/departamento guardado existe en la lista, seleccionarlo
        if (paisesData[pais] && Object.keys(paisesData[pais]).includes(estadoDeptoGuardado)) {
            selectEstadoDepto.value = estadoDeptoGuardado;
        } else if (estadoDeptoGuardado.trim() !== '') {
            // Si es un valor personalizado, crear la opción y seleccionarla
            const option = document.createElement('option');
            option.value = estadoDeptoGuardado;
            option.textContent = estadoDeptoGuardado + " (personalizado)";
            selectEstadoDepto.insertBefore(option, otroOption);
            selectEstadoDepto.value = estadoDeptoGuardado;
        }
        // Cargar las ciudades correspondientes
        cargarCiudades(pais, estadoDeptoGuardado);
    }
}

/**
 * Función para cargar ciudades según el estado/departamento seleccionado
 */
function cargarCiudades(pais, estadoDepto) {
    const selectCiudad = document.getElementById('ciudad');
    if (!selectCiudad) return;
    
    // Limpiar opciones existentes
    selectCiudad.innerHTML = '<option value="">-- Seleccione una ciudad --</option>';
    
    if (!estadoDepto || estadoDepto === "otro") {
        selectCiudad.disabled = true;
        return;
    }
    
    selectCiudad.disabled = false;
    
    // Si el país y estado/departamento existen en nuestros datos, cargar sus ciudades
    if (paisesData[pais] && paisesData[pais][estadoDepto]) {
        paisesData[pais][estadoDepto].forEach(ciudad => {
            const option = document.createElement('option');
            option.value = ciudad;
            option.textContent = ciudad;
            selectCiudad.appendChild(option);
        });
    }
    
    // Agregar opción para ciudad personalizada
    const otroOption = document.createElement('option');
    otroOption.value = "otro";
    otroOption.textContent = "-- Otra (especificar) --";
    selectCiudad.appendChild(otroOption);
    
    // Obtener la ciudad guardada (si existe)
    const ciudadGuardada = selectCiudad.dataset.valor || '';
    
    if (ciudadGuardada) {
        // Si la ciudad guardada existe en la lista, seleccionarla
        if (paisesData[pais] && paisesData[pais][estadoDepto] && 
            paisesData[pais][estadoDepto].includes(ciudadGuardada)) {
            selectCiudad.value = ciudadGuardada;
        } else if (ciudadGuardada.trim() !== '') {
            // Si es un valor personalizado, crear la opción y seleccionarla
            const option = document.createElement('option');
            option.value = ciudadGuardada;
            option.textContent = ciudadGuardada + " (personalizado)";
            selectCiudad.insertBefore(option, otroOption);
            selectCiudad.value = ciudadGuardada;
        }
    }
}

/**
 * Maneja la selección de "Otro país"
 */
function manejarPaisPersonalizado() {
    const selectPais = document.getElementById('pais');
    if (selectPais && selectPais.value === "otro") {
        const nuevoPais = prompt("Ingrese el nombre del país:");
        if (nuevoPais && nuevoPais.trim() !== "") {
            // Crear nueva opción y seleccionarla
            const option = document.createElement('option');
            option.value = nuevoPais;
            option.textContent = nuevoPais + " (personalizado)";
            
            // Insertar antes de la opción "Otro"
            selectPais.insertBefore(option, selectPais.lastChild);
            selectPais.value = nuevoPais;
            
            // Habilitar el selector de estados/departamentos para entrada manual
            const estadoDeptSelect = document.getElementById('estado_departamento');
            if (estadoDeptSelect) {
                estadoDeptSelect.disabled = false;
                estadoDeptSelect.innerHTML = '<option value="">-- Seleccione un estado/departamento --</option>' +
                                           '<option value="otro">-- Otro (especificar) --</option>';
            }
            
            // Resetear el selector de ciudades
            const ciudadSelect = document.getElementById('ciudad');
            if (ciudadSelect) {
                ciudadSelect.disabled = true;
                ciudadSelect.innerHTML = '<option value="">-- Seleccione primero un estado/departamento --</option>';
            }
        } else {
            selectPais.value = ""; // Restablecer si se canceló
        }
    }
}

/**
 * Maneja la selección de "Otro estado/departamento"
 */
function manejarEstadoDeptoPersonalizado() {
    const selectEstadoDepto = document.getElementById('estado_departamento');
    if (selectEstadoDepto && selectEstadoDepto.value === "otro") {
        const nuevoEstadoDepto = prompt("Ingrese el nombre del estado o departamento:");
        if (nuevoEstadoDepto && nuevoEstadoDepto.trim() !== "") {
            // Crear nueva opción y seleccionarla
            const option = document.createElement('option');
            option.value = nuevoEstadoDepto;
            option.textContent = nuevoEstadoDepto + " (personalizado)";
            
            // Insertar antes de la opción "Otro"
            selectEstadoDepto.insertBefore(option, selectEstadoDepto.lastChild);
            selectEstadoDepto.value = nuevoEstadoDepto;
            
            // Habilitar el selector de ciudades para entrada manual
            const ciudadSelect = document.getElementById('ciudad');
            if (ciudadSelect) {
                ciudadSelect.disabled = false;
                ciudadSelect.innerHTML = '<option value="">-- Seleccione una ciudad --</option>' +
                                       '<option value="otro">-- Otra (especificar) --</option>';
            }
        } else {
            selectEstadoDepto.value = ""; // Restablecer si se canceló
        }
    }
}

/**
 * Maneja la selección de "Otra ciudad"
 */
function manejarCiudadPersonalizada() {
    const selectCiudad = document.getElementById('ciudad');
    if (selectCiudad && selectCiudad.value === "otro") {
        const nuevaCiudad = prompt("Ingrese el nombre de la ciudad:");
        if (nuevaCiudad && nuevaCiudad.trim() !== "") {
            // Crear nueva opción y seleccionarla
            const option = document.createElement('option');
            option.value = nuevaCiudad;
            option.textContent = nuevaCiudad + " (personalizado)";
            
            // Insertar antes de la opción "Otro"
            selectCiudad.insertBefore(option, selectCiudad.lastChild);
            selectCiudad.value = nuevaCiudad;
        } else {
            selectCiudad.value = ""; // Restablecer si se canceló
        }
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\assets\js\miembros\location-data.js
=============================================================

/**
 * Datos y funciones para manejar localidades y barrios de Bogotá
 */

// Datos de las localidades y barrios de Bogotá
const localidadesBarrios = {
    "Usaquén": ["Cedritos", "Santa Bárbara", "Unicentro", "Verbenal", "San Cristóbal Norte", "Toberín", "Usaquén", "Country Club", "Santa Ana"],
    "Chapinero": ["Chapinero Central", "Chicó", "La Cabrera", "El Nogal", "El Refugio", "Rosales", "Quinta Camacho", "Chapinero Alto", "Pardo Rubio"],
    "Santa Fe": ["La Candelaria", "Las Nieves", "Las Cruces", "Egipto", "Centro Administrativo", "La Macarena", "El Dorado", "Sagrado Corazón"],
    "San Cristóbal": ["San Blas", "20 de Julio", "La Victoria", "Sosiego", "Altamira", "Juan Rey", "La Gloria", "Los Libertadores"],
    "Usme": ["Comuneros", "Alfonso López", "Danubio Azul", "El Virrey", "Yomasa", "Santa Librada", "Gran Yomasa", "Chuniza"],
    "Tunjuelito": ["Tunjuelito", "Venecia", "San Carlos", "Abraham Lincoln", "San Benito", "El Carmen", "Samore"],
    "Bosa": ["Bosa Central", "El Recreo", "Porvenir", "Olarte", "La Estación", "El Apogeo", "San Pablo", "La Libertad"],
    "Kennedy": ["Kennedy Central", "Castilla", "Timiza", "Patio Bonito", "Américas", "Bavaria", "Carvajal", "Marsella", "Mandalay"],
    "Fontibón": ["Fontibón Centro", "Modelia", "Capellanía", "Hayuelos", "Aeropuerto El Dorado", "Salitre Occidental", "Granjas de Techo"],
    "Engativá": ["Engativá Centro", "Las Ferias", "Minuto de Dios", "Boyacá Real", "Santa Cecilia", "Bolivia", "Álamos", "Jardín Botánico"],
    "Suba": ["Niza", "La Alhambra", "Prado", "Spring", "Suba Centro", "El Rincón", "Tibabuyes", "Club Los Lagartos", "Ciudad Jardín Norte"],
    "Barrios Unidos": ["12 de Octubre", "Los Alcázares", "Park Way", "La Castellana", "Andes", "Rionegro", "Colombia", "San Fernando"],
    "Teusaquillo": ["Teusaquillo", "La Soledad", "Palermo", "Galerías", "Quinta Paredes", "Ciudad Universitaria", "Salitre Oriental", "Pablo VI"],
    "Los Mártires": ["Santa Isabel", "La Sabana", "El Listón", "Samper Mendoza", "Ricaurte", "Voto Nacional", "La Estanzuela", "Eduardo Santos"],
    "Antonio Nariño": ["Restrepo", "Ciudad Jardín", "Villa Mayor", "La Fragua", "Policarpa", "Santander", "Caracas"],
    "Puente Aranda": ["Ciudad Montes", "Muzu", "San Rafael", "Puente Aranda", "Salazar Gómez", "Zona Industrial", "Cundinamarca", "Primavera"],
    "La Candelaria": ["La Catedral", "Centro Administrativo", "Santa Bárbara", "La Concordia", "Las Aguas", "Egipto", "Belén", "Nueva Santa Fe"],
    "Rafael Uribe Uribe": ["Quiroga", "San José", "Marco Fidel Suárez", "Marruecos", "Diana Turbay", "Gustavo Restrepo", "Olaya", "Inglés"],
    "Ciudad Bolívar": ["Vista Hermosa", "Lucero", "Ismael Perdomo", "Jerusalem", "San Francisco", "Candelaria La Nueva", "Sierra Morena", "Arborizadora"],
    "Sumapaz": ["Nazareth", "San Juan de Sumapaz", "La Unión", "Tunal Alto", "Betania", "Nueva Granada", "San José"]
};

/**
 * Función para cargar las localidades en el dropdown
 */
function cargarLocalidades() {
    const selectLocalidad = document.getElementById('localidad');
    if (!selectLocalidad) return;
    
    // Limpiar opciones existentes
    selectLocalidad.innerHTML = '<option value="">-- Seleccione una localidad --</option>';
    
    // Agregar cada localidad como una opción
    Object.keys(localidadesBarrios).forEach(localidad => {
        const option = document.createElement('option');
        option.value = localidad;
        option.textContent = localidad;
        selectLocalidad.appendChild(option);
    });
    
    // Obtener la localidad guardada (si existe)
    const localidadGuardada = selectLocalidad.dataset.valor || '';
    
    if (localidadGuardada) {
        // Si la localidad guardada existe en la lista, seleccionarla
        if (Object.keys(localidadesBarrios).includes(localidadGuardada)) {
            selectLocalidad.value = localidadGuardada;
        } else if (localidadGuardada.trim() !== '') {
            // Si es un valor personalizado, crear la opción y seleccionarla
            const option = document.createElement('option');
            option.value = localidadGuardada;
            option.textContent = localidadGuardada + " (personalizado)";
            selectLocalidad.appendChild(option);
            selectLocalidad.value = localidadGuardada;
        }
        // Cargar los barrios correspondientes
        cargarBarrios(localidadGuardada);
    } else {
        // Si no hay localidad guardada, seleccionar "Engativá" por defecto
        const defaultLocalidad = "Engativá";
        selectLocalidad.value = defaultLocalidad;
        cargarBarrios(defaultLocalidad);
    }
}

/**
 * Función para cargar los barrios según la localidad seleccionada
 */
function cargarBarrios(localidad) {
    const selectBarrio = document.getElementById('barrio');
    if (!selectBarrio) return;
    
    // Limpiar opciones existentes
    selectBarrio.innerHTML = '<option value="">-- Seleccione un barrio --</option>';
    
    // Si no hay localidad seleccionada, no hacer nada más
    if (!localidad) return;
    
    // Agregar cada barrio de la localidad como una opción
    const barrios = localidadesBarrios[localidad] || [];
    barrios.forEach(barrio => {
        const option = document.createElement('option');
        option.value = barrio;
        option.textContent = barrio;
        selectBarrio.appendChild(option);
    });
    
    // Agregar opción para barrio personalizado
    const otroOption = document.createElement('option');
    otroOption.value = "otro";
    otroOption.textContent = "-- Otro barrio --";
    selectBarrio.appendChild(otroOption);
    
    // Obtener el barrio guardado (si existe)
    const barrioGuardado = selectBarrio.dataset.valor || '';
    
    if (barrioGuardado) {
        // Si el barrio guardado existe en la lista, seleccionarlo
        if (barrios.includes(barrioGuardado)) {
            selectBarrio.value = barrioGuardado;
        } else if (barrioGuardado.trim() !== '') {
            // Si es un barrio personalizado, crear la opción y seleccionarla
            selectBarrio.value = "otro";
            // Mostrar el campo de barrio personalizado
            document.getElementById('barrio_personalizado_container').style.display = 'block';
            document.getElementById('barrio_personalizado').value = barrioGuardado;
        }
    }
}

/**
 * Maneja la selección de "Otro barrio"
 */
function manejarBarrioPersonalizado() {
    const selectBarrio = document.getElementById('barrio');
    const container = document.getElementById('barrio_personalizado_container');
    
    if (selectBarrio.value === "otro") {
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\public\assets\js\education-data.js
=============================================================

/**
 * Sistema de gestión de información educativa
 * Este archivo maneja la carga dinámica de instituciones educativas y carreras
 * según el país seleccionado y nivel educativo
 */

const EducationManager = {
    // Almacena las instituciones y carreras cargadas por país
    educationData: {},
    
    // Inicializar el sistema
    init: function() {
        // Conectar con los selectores del formulario
        const nivelSelect = document.getElementById('nivel_estudios');
        const institucionSelect = document.getElementById('institucion_educativa_select');
        const profesionSelect = document.getElementById('profesion_select');
        const paisSelect = document.getElementById('pais'); // De la pestaña contacto
        
        // Eventos para los campos existentes
        if (nivelSelect) {
            nivelSelect.addEventListener('change', this.onNivelChange.bind(this));
        }
        
        if (institucionSelect) {
            institucionSelect.addEventListener('change', this.onInstitucionChange.bind(this));
        }
        
        if (paisSelect) {
            paisSelect.addEventListener('change', function() {
                // Cuando cambie el país en la pestaña contacto, actualizamos
                // las opciones relevantes en la pestaña estudios
                const paisSeleccionado = paisSelect.value;
                if (paisSeleccionado) {
                    this.loadCountryEducationData(paisSeleccionado);
                }
            }.bind(this));
        }
        
        // Configurar campos personalizados
        this.setupCustomFields();
        
        // Cargar datos del país seleccionado inicialmente (si existe)
        if (paisSelect && paisSelect.value) {
            this.loadCountryEducationData(paisSelect.value);
        }
    },
    
    // Cuando cambia el nivel educativo
    onNivelChange: function(event) {
        const nivelSeleccionado = event.target.value;
        const paisSeleccionado = document.getElementById('pais')?.value;
        
        if (!paisSeleccionado || !nivelSeleccionado) {
            this.resetInstituciones();
            return;
        }
        
        this.loadInstituciones(paisSeleccionado, nivelSeleccionado);
    },
    
    // Cuando cambia la institución
    onInstitucionChange: function(event) {
        const institucionSeleccionada = event.target.value;
        const nivelSeleccionado = document.getElementById('nivel_estudios')?.value;
        const paisSeleccionado = document.getElementById('pais')?.value;
        
        if (institucionSeleccionada === 'custom') {
            // Mostrar campo para agregar nueva institución
            document.getElementById('institucion_personalizada_container').style.display = 'block';
            this.resetProfesiones();
            return;
        } else {
            document.getElementById('institucion_personalizada_container').style.display = 'none';
        }
        
        if (!paisSeleccionado || !nivelSeleccionado || !institucionSeleccionada) {
            this.resetProfesiones();
            return;
        }
        
        this.loadProfesiones(paisSeleccionado, nivelSeleccionado, institucionSeleccionada);
    },
    
    // Configurar los campos personalizados para nuevas instituciones y carreras
    setupCustomFields: function() {
        const profesionSelect = document.getElementById('profesion_select');
        if (profesionSelect) {
            profesionSelect.addEventListener('change', function(event) {
                if (event.target.value === 'custom') {
                    document.getElementById('profesion_personalizada_container').style.display = 'block';
                } else {
                    document.getElementById('profesion_personalizada_container').style.display = 'none';
                }
            });
        }
    },
    
    // Carga los datos educativos específicos de un país
    loadCountryEducationData: function(pais) {
        if (this.educationData[pais]) {
            // Ya tenemos los datos cargados
            return;
        }
        
        // Realizar petición AJAX para obtener los datos del país
        fetch(`${APP_URL}/api/education-data/${pais}`)
            .then(response => response.json())
            .then(data => {
                this.educationData[pais] = data;
                
                // Si ya hay un nivel seleccionado, cargar las instituciones
                const nivelSeleccionado = document.getElementById('nivel_estudios')?.value;
                if (nivelSeleccionado) {
                    this.loadInstituciones(pais, nivelSeleccionado);
                }
            })
            .catch(error => {
                console.error('Error cargando datos educativos:', error);
            });
    },
    
    // Cargar instituciones según nivel educativo
    loadInstituciones: function(pais, nivel) {
        const institucionSelect = document.getElementById('institucion_educativa_select');
        if (!institucionSelect) return;
        
        // Resetear el selector
        institucionSelect.innerHTML = '<option value="">-- Seleccione una institución --</option>';
        
        // Si no tenemos datos para este país, no podemos continuar
        if (!this.educationData[pais] || !this.educationData[pais][nivel]) {
            institucionSelect.disabled = true;
            return;
        }
        
        // Agregar las instituciones disponibles
        const instituciones = this.educationData[pais][nivel].instituciones || [];
        instituciones.forEach(institucion => {
            const option = document.createElement('option');
            option.value = institucion.id;
            option.textContent = institucion.nombre;
            institucionSelect.appendChild(option);
        });
        
        // Agregar opción para personalizar
        const customOption = document.createElement('option');
        customOption.value = 'custom';
        customOption.textContent = '-- Agregar nueva institución --';
        institucionSelect.appendChild(customOption);
        
        institucionSelect.disabled = false;
        this.resetProfesiones();
    },
    
    // Cargar profesiones según institución
    loadProfesiones: function(pais, nivel, institucionId) {
        const profesionSelect = document.getElementById('profesion_select');
        if (!profesionSelect) return;
        
        // Resetear el selector
        profesionSelect.innerHTML = '<option value="">-- Seleccione una profesión --</option>';
        
        // Si no tenemos datos, no podemos continuar
        if (!this.educationData[pais] || !this.educationData[pais][nivel]) {
            profesionSelect.disabled = true;
            return;
        }
        
        // Buscar la institución seleccionada
        const institucion = this.educationData[pais][nivel].instituciones.find(i => i.id === institucionId);
        if (!institucion || !institucion.profesiones) {
            profesionSelect.disabled = true;
            return;
        }
        
        // Agregar las profesiones disponibles
        institucion.profesiones.forEach(profesion => {
            const option = document.createElement('option');
            option.value = profesion.id;
            option.textContent = profesion.nombre;
            profesionSelect.appendChild(option);
        });
        
        // Agregar opción para personalizar
        const customOption = document.createElement('option');
        customOption.value = 'custom';
        customOption.textContent = '-- Agregar nueva profesión --';
        profesionSelect.appendChild(customOption);
        
        profesionSelect.disabled = false;
    },
    
    // Resetear el selector de instituciones
    resetInstituciones: function() {
        const institucionSelect = document.getElementById('institucion_educativa_select');
        if (institucionSelect) {
            institucionSelect.innerHTML = '<option value="">-- Seleccione primero un nivel educativo --</option>';
            institucionSelect.disabled = true;
        }
        this.resetProfesiones();
    },
    
    // Resetear el selector de profesiones
    resetProfesiones: function() {
        const profesionSelect = document.getElementById('profesion_select');
        if (profesionSelect) {
            profesionSelect.innerHTML = '<option value="">-- Seleccione primero una institución --</option>';
            profesionSelect.disabled = true;
        }
        
        // Ocultar campos personalizados
        const profesionPersonalizada = document.getElementById('profesion_personalizada_container');
        if (profesionPersonalizada) {
            profesionPersonalizada.style.display = 'none';
        }
    },
    
    // Guardar una nueva institución
    saveNewInstitution: function(pais, nivel, nombreInstitucion) {
        // Esta función enviaría una solicitud AJAX para guardar la nueva institución
        // y devolvería un ID para la nueva institución
        return fetch(`${APP_URL}/api/education-data/save-institution`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                pais: pais,
                nivel: nivel,
                nombre: nombreInstitucion
            })
        })
        .then(response => response.json());
    },
    
    // Guardar una nueva profesión
    saveNewProfession: function(pais, nivel, institucionId, nombreProfesion) {
        // Esta función enviaría una solicitud AJAX para guardar la nueva profesión
        return fetch(`${APP_URL}/api/education-data/save-profession`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                pais: pais,
                nivel: nivel,
                institucionId: institucionId,
                nombre: nombreProfesion
            })
        })
        .then(response => response.json());
    }
};

// Inicializar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    EducationManager.init();
});


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\public\assets\js\formulario-estudios.js
=============================================================

/**
 * Script para manejar el envío del formulario con las opciones seleccionadas
 * o personalizadas de instituciones y profesiones
 */
document.addEventListener('DOMContentLoaded', function() {
    // Capturar el formulario
    const form = document.querySelector('form');
    
    if (form) {
        form.addEventListener('submit', function(event) {
            // Procesar la institución educativa (seleccionada o personalizada)
            const institucionSelect = document.getElementById('institucion_educativa_select');
            const institucionPersonalizada = document.getElementById('institucion_personalizada');
            const institucionFinal = document.getElementById('institucion_educativa');
            
            if (institucionSelect && institucionSelect.value === 'custom' && institucionPersonalizada) {
                // El usuario está agregando una nueva institución
                institucionFinal.value = institucionPersonalizada.value;
            } else if (institucionSelect && institucionSelect.options[institucionSelect.selectedIndex]) {
                // El usuario seleccionó una institución existente
                institucionFinal.value = institucionSelect.options[institucionSelect.selectedIndex].text;
            }
            
            // Procesar la profesión (seleccionada o personalizada)
            const profesionSelect = document.getElementById('profesion_select');
            const profesionPersonalizada = document.getElementById('profesion_personalizada');
            const profesionFinal = document.getElementById('profesion');
            
            if (profesionSelect && profesionSelect.value === 'custom' && profesionPersonalizada) {
                // El usuario está agregando una nueva profesión
                profesionFinal.value = profesionPersonalizada.value;
            } else if (profesionSelect && profesionSelect.options[profesionSelect.selectedIndex]) {
                // El usuario seleccionó una profesión existente
                profesionFinal.value = profesionSelect.options[profesionSelect.selectedIndex].text;
            }
            
            // Continuar con el envío normal del formulario
            return true;
        });
    }
});


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\public\assets\js\miembros\education-data.js
=============================================================

/**
 * Datos para estudios y educación
 */
const educationData = {
    // Datos relacionados con educación
};


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\public\assets\js\miembros\MiembrosController.js
=============================================================

/**
 * Controlador para el procesamiento de formularios de miembros
 */
class MiembrosController {
    /**
     * Constructor del controlador
     * @param {string} formId - ID del formulario a controlar
     * @param {Object} options - Opciones de configuración
     */
    constructor(formId, options = {}) {
        this.formId = formId;
        this.options = {
            successRedirect: '',
            errorRedirect: '',
            ...options
        };
        this.initialize();
    }
    
    /**
     * Inicializar el controlador
     */
    initialize() {
        console.log(`MiembrosController inicializado para el formulario #${this.formId}`);
        // Cualquier inicialización adicional
    }
    
    /**
     * Procesa el envío del formulario
     * @param {FormData} formData - Datos del formulario
     * @returns {Promise} Promesa con el resultado del envío
     */
    async submitForm(formData) {
        try {
            const response = await fetch(document.getElementById(this.formId).action, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                if (this.options.successRedirect) {
                    window.location.href = this.options.successRedirect;
                }
                return data;
            } else {
                console.error("Error en el servidor:", data.message);
                return data;
            }
        } catch (error) {
            console.error("Error al enviar formulario:", error);
            throw error;
        }
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\public\js\app.js
=============================================================

/**
 * Inicialización de controladores
 */
document.addEventListener('DOMContentLoaded', function() {
    // Detectar formularios de miembros
    if (document.getElementById('editForm')) {
        // Obtener el ID del miembro de la URL
        const path = window.location.pathname;
        const matches = path.match(/\/miembros\/editar\/(\d+)/);
        const miembroId = matches ? matches[1] : '';
        
        if (miembroId) {
            new MiembrosController('editForm', {
                url: `/ENCASA_DATABASE/miembros/actualizar/${miembroId}`,
                method: 'POST',
                redirect: true
            });
        }
    }
    
    // Otros inicializadores aquí...
});


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\public\js\tabla-por-tabla.js
=============================================================

function guardarTablaIndividual(tabla) {
    if (typeof baseUrl === 'undefined' || typeof miembroId === 'undefined') {
        console.error("Error: Variables baseUrl o miembroId no definidas");
        mostrarMensaje('danger', "Error de configuración");
        return;
    }

    // Construir la URL correctamente
    const url = `${baseUrl}/miembros/actualizar/${miembroId}/tabla/${tabla}`;
    console.log("Enviando petición a:", url);
    
    const formId = `form-${tabla}`;
    const formulario = document.getElementById(formId);
    
    if (!formulario) {
        console.error(`Formulario #${formId} no encontrado`);
        mostrarMensaje('danger', `Error: Formulario no encontrado`);
        return;
    }
    
    const formData = new FormData(formulario);
    
    // Mostrar datos que se están enviando (para depuración)
    console.log("Datos enviados:", Object.fromEntries(formData));
    
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                console.error("Error en la respuesta:", text);
                try {
                    // Intentar parsear como JSON por si acaso
                    return JSON.parse(text);
                } catch (e) {
                    // Si no es JSON, lanzar error con el texto
                    throw new Error(`Error del servidor: ${text.substring(0, 100)}...`);
                }
            });
        }
        return response.json();
    })
    .then(data => {
        console.log("Respuesta:", data);
        if (data.success) {
            mostrarMensaje('success', data.message || "Datos actualizados correctamente");
        } else {
            mostrarMensaje('danger', data.message || "Error al actualizar datos");
        }
    })
    .catch(error => {
        console.error("Error en la petición:", error);
        mostrarMensaje('danger', error.message || "Error de comunicación con el servidor");
    });
}

function mostrarMensaje(tipo, mensaje) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${tipo} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    `;
    
    // Insertar al inicio del contenedor principal
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-ocultar después de 5 segundos
    setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => alertDiv.remove(), 500);
    }, 5000);
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\public\js\controllers\FormController.js
=============================================================

/**
 * Controlador base para manejar formularios
 */
class FormController {
    constructor(formId, options = {}) {
        this.formElement = document.getElementById(formId);
        this.submitButton = document.querySelector(`#${formId} [type="submit"]`) || 
                           document.getElementById('btnGuardar');
        this.options = Object.assign({
            method: 'POST',
            redirect: true,
            showMessages: true,
        }, options);
        
        this.initialize();
    }
    
    initialize() {
        if (this.formElement) {
            this.formElement.addEventListener('submit', this.handleSubmit.bind(this));
            
            // Si hay un botón específico (no submit) para el envío
            if (this.submitButton && this.submitButton.type !== 'submit') {
                this.submitButton.addEventListener('click', this.handleSubmit.bind(this));
            }
        }
    }
    
    handleSubmit(event) {
        event.preventDefault();
        
        if (this.beforeSubmit() === false) {
            return false;
        }
        
        this.showLoading();
        
        const formData = new FormData(this.formElement);
        const url = this.options.url || this.formElement.getAttribute('action');
        
        fetch(url, {
            method: this.options.method,
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => {
            if (response.redirected) {
                // Si el servidor redirige, seguimos la redirección
                window.location.href = response.url;
                return null;
            } else {
                return response.json().catch(() => response.text());
            }
        })
        .then(data => {
            this.hideLoading();
            
            if (data === null) return; // Ya se redirigió
            
            if (typeof data === 'object' && data.success) {
                this.onSuccess(data);
            } else if (typeof data === 'object' && data.errors) {
                this.onErrors(data.errors);
            } else if (typeof data === 'object' && !data.success) {
                this.onError(data.message || 'Ha ocurrido un error');
            } else {
                // Intentar detectar si es HTML de la página de éxito
                if (typeof data === 'string' && data.includes('<title>')) {
                    this.onSuccess({message: 'Operación completada con éxito'});
                } else {
                    this.onError('Ocurrió un error inesperado');
                }
            }
        })
        .catch(error => {
            this.hideLoading();
            this.onError('Error de conexión: ' + error.message);
            console.error('Error:', error);
        });
    }
    
    // Métodos que pueden ser sobrescritos por controladores hijos
    beforeSubmit() {
        // Validaciones existentes...
        
        // Depuración - ver qué datos se están enviando
        const formData = new FormData(this.formElement);
        console.log('Datos a enviar:');
        for (let [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
        }
        
        return true; // Permitir continuar por defecto
    }
    
    onSuccess(data) {
        if (this.options.showMessages) {
            this.showMessage(data.message || 'Operación completada con éxito', 'success');
        }
        
        if (this.options.redirect && data.redirect) {
            setTimeout(() => {
                window.location.href = data.redirect;
            }, 1500);
        }
    }
    
    onErrors(errors) {
        if (this.options.showMessages) {
            this.showMessage(
                Array.isArray(errors) ? errors.join('<br>') : errors,
                'danger'
            );
        }
        
        // Marcar campos con error
        if (typeof errors === 'object') {
            for (const field in errors) {
                const input = this.formElement.querySelector(`[name="${field}"]`);
                if (input) {
                    input.classList.add('is-invalid');
                    
                    // Agregar mensaje de error
                    const feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    feedback.textContent = errors[field];
                    input.parentNode.appendChild(feedback);
                }
            }
        }
    }
    
    onError(message) {
        if (this.options.showMessages) {
            this.showMessage(message, 'danger');
        }
    }
    
    // Métodos de utilidad
    showMessage(message, type = 'info') {
        // Crear un elemento de alerta
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insertar al inicio del formulario
        this.formElement.prepend(alert);
        
        // Auto-ocultar después de 5 segundos
        setTimeout(() => {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 300);
        }, 5000);
    }
    
    showLoading() {
        if (this.submitButton) {
            this.submitButton.disabled = true;
            this.submitButtonOriginalText = this.submitButton.innerHTML;
            this.submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
        }
    }
    
    hideLoading() {
        if (this.submitButton && this.submitButtonOriginalText) {
            this.submitButton.disabled = false;
            this.submitButton.innerHTML = this.submitButtonOriginalText;
        }
    }
}


=============================================================
ARCHIVO: C:\xampp\htdocs\ENCASA_DATABASE\public\js\controllers\MiembrosController.js
=============================================================

/**
 * Controlador específico para formularios de miembros
 */
class MiembrosController extends FormController {
    constructor(formId, options = {}) {
        super(formId, options);
        
        // Pestañas del formulario
        this.tabs = document.querySelectorAll('a[data-bs-toggle="tab"]');
        this.initializeTabs();
    }
    
    initializeTabs() {
        // Implementar navegación entre pestañas
        this.tabs.forEach(tab => {
            tab.addEventListener('shown.bs.tab', (e) => {
                const id = e.target.id.replace('-tab', '');
                const url = new URL(window.location.href);
                url.searchParams.set('tab', id);
                history.replaceState({}, '', url);
            });
        });
    }
    
    beforeSubmit() {
        // Registrar todos los valores que se están enviando para diagnóstico
        const formData = new FormData(this.form);
        console.log("Enviando datos del formulario:");
        for (let [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
        }
        
        // Validación básica
        let isValid = true;
        
        // Validar campos obligatorios
        const requiredFields = ['nombres', 'apellidos'];
        for (let field of requiredFields) {
            const inputField = this.form.querySelector(`[name="${field}"]`);
            if (!inputField || !inputField.value.trim()) {
                this.highlightError(inputField, `El campo ${field} es obligatorio`);
                isValid = false;
            }
        }
        
        return isValid;
    }
    
    highlightError(field, message) {
        if (!field) return;
        
        field.classList.add('is-invalid');
        
        // Agregar mensaje de error si no existe
        let feedback = field.parentNode.querySelector('.invalid-feedback');
        if (!feedback) {
            feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            field.parentNode.appendChild(feedback);
        }
        
        feedback.textContent = message;
    }
    
    // Añadir función para depurar actualizaciones
    debugSubmit() {
        const formData = new FormData(this.form);
        console.table(Array.from(formData.entries()));
    }
    
    onSuccess(data) {
        // Mostrar mensaje de éxito
        this.showMessage(data.message || 'Miembro actualizado correctamente', 'success');
        
        // Redirigir después de un breve retraso
        setTimeout(() => {
            window.location.href = data.redirect || `/ENCASA_DATABASE/miembros/${data.id || ''}`;
        }, 1500);
   }
    
    confirmSubmit() {
        const formData = new FormData(this.formElement);
        let message = "¿Confirmar los siguientes cambios?\n\n";
        message += `Nombre: ${formData.get('nombres')}\n`;
        message += `Apellidos: ${formData.get('apellidos')}\n`;
        // etc.
        
        return confirm(message);
    }
    
    // Añadir este método a la clase MiembrosController
    onSubmitForm(e) {
        e.preventDefault();
        
        // Evitar envíos múltiples
        if (this.isSubmitting) return;
        this.isSubmitting = true;
        
        // Validación
        if (!this.beforeSubmit()) {
            this.isSubmitting = false;
            return false;
        }
        
        // Mostrar indicador de carga
        const submitBtn = this.form.querySelector('[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
        
        // Crear FormData con todos los campos
        const formData = new FormData(this.form);
        
        // Agregar encabezados AJAX
        const fetchOptions = {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            },
            body: formData
        };
        
        console.log('Enviando formulario con datos:', this.debugFormData(formData));
        
        // Enviar solicitud
        fetch(this.form.action, fetchOptions)
            .then(response => {
                return response.text().then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('Respuesta no es JSON válido:', text);
                        throw new Error('La respuesta del servidor no es JSON válido');
                    }
                });
            })
            .then(data => {
                this.isSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                
                if (data.success) {
                    this.onSuccess(data);
                } else {
                    this.onError(data);
                }
            })
            .catch(error => {
                console.error('Error en envío:', error);
                this.isSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                this.showMessage('Error: ' + error.message, 'danger');
            });
    }

    // Método para depurar FormData
    debugFormData(formData) {
        const object = {};
        formData.forEach((value, key) => {
            if (object[key]) {
                if (!Array.isArray(object[key])) {
                    object[key] = [object[key]];
                }
                object[key].push(value);
            } else {
                object[key] = value;
            }
        });
        return object;
    }
}


